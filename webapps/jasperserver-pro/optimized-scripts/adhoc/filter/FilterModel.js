define(["require","underscore","jquery","backbone","bundle!AdHocFiltersBundle","settings!decimalFormatSymbols","common/util/parse/NumberUtils","adhoc/filter/filterModelTrait/dateRangeFilterModelTrait","adhoc/filter/filterModelTrait/listFilterModelTrait","adhoc/filter/filterModelTrait/literalFilterModelTrait","adhoc/filter/filterModelTrait/rangeFilterModelTrait","adhoc/filter/filterModelTrait/readOnlyFilterModelTrait","adhoc/filter/enum/filterDataTypes","adhoc/filter/enum/filterExpressionTypes","adhoc/filter/enum/filterOperators","adhoc/filter/factory/filterModelValidationFactory","adhoc/filter/factory/filterModelExpressionTypeFactory","adhoc/filter/factory/filterModelDefaultValueFactory","adhoc/filter/format/OlapFilterValueFormatter","components/singleSelect/dataprovider/DataProviderNew","components/singleSelect/dataprovider/ValueFormattingDataProvider","settings!adhocFilterSettings","adhoc/filter/validation/backboneValidationExtensions"],function(e){"use strict";function t(e){return e===y.TIMESTAMP||e===y.DATE}function i(e){return e===y.BOOLEAN}function a(e){return e===y.TIME}function r(e){return e===y.STRING}function s(e){return e===y.INTEGER||e===y.DECIMAL||e===y.LONG||e===y.NUMERIC}var l=e("underscore"),n=e("jquery"),o=e("backbone"),u=e("bundle!AdHocFiltersBundle"),d=e("settings!decimalFormatSymbols"),h=e("common/util/parse/NumberUtils"),f=new h(d),p=e("adhoc/filter/filterModelTrait/dateRangeFilterModelTrait"),c=e("adhoc/filter/filterModelTrait/listFilterModelTrait"),T=e("adhoc/filter/filterModelTrait/literalFilterModelTrait"),E=e("adhoc/filter/filterModelTrait/rangeFilterModelTrait"),A=e("adhoc/filter/filterModelTrait/readOnlyFilterModelTrait"),y=e("adhoc/filter/enum/filterDataTypes"),N=e("adhoc/filter/enum/filterExpressionTypes"),_=e("adhoc/filter/enum/filterOperators"),m=e("adhoc/filter/factory/filterModelValidationFactory"),v=e("adhoc/filter/factory/filterModelExpressionTypeFactory"),g=e("adhoc/filter/factory/filterModelDefaultValueFactory"),D=e("adhoc/filter/format/OlapFilterValueFormatter"),V=e("components/singleSelect/dataprovider/DataProviderNew"),S=e("components/singleSelect/dataprovider/ValueFormattingDataProvider"),O=e("settings!adhocFilterSettings");e("adhoc/filter/validation/backboneValidationExtensions");var M={};M[N.LITERAL]=T,M[N.LIST]=c,M[N.DATE_RANGE]=p,M[N.RANGE]=E,M[N.READ_ONLY]=A;var L={DATA_CHOOSER_NO_PROMPT:"ADH_1215_DYNAMIC_FILTER_UNEDITABLE_TITLE",SLICE_COMPLEX_KEEPONLY:"ADH_1208_DYNAMIC_FILTER_KEEP",SLICE_COMPLEX_EXCLUDE:"ADH_1209_DYNAMIC_FILTER_EXCLUDE"},R=o.Model.extend({initialize:function(e,t){this.service=t.service,this.isOlap=t.isOlap,O=l.defaults(O||{},{availableItemsPageSizeOlap:"999",availableItemsPageSize:"999"}),this.dataProvider=new V({pageSize:this.isOlap?+O.availableItemsPageSizeOlap:+O.availableItemsPageSize,request:new S({request:l.bind(this._requestValues,this),format:this.isOlap?new D(this.get("isFirstLevelInHierarchyAll")).format:null}).getData,controlGetTotal:!0,saveLastCriteria:!0}),this.removeAvailableData(),this.removeMinMaxValues(),this.on("change:operatorName",this._onOperatorNameChange),this.on("change:expressionType",this._onExpressionTypeChange),this._updateModelBehavior()},_requestValues:function(e){var t=this.get("showLoading");return this.service.fetchValues(this.get("name"),e,t)},setShowLoading:function(e){this.set("showLoading",e,{silent:!0})},removeAvailableData:function(){this.dataProvider.clear()},removeMinMaxValues:function(){this._minMaxValuesDeferred=null,this.minValue=null,this.maxValue=null},fetchDataForChangeFilterType:function(){return this.dataProvider.getData({offset:0,limit:1})},fetchMinMaxValues:function(){var e=this;return this._minMaxValuesDeferred||(this._minMaxValuesDeferred=this.service.getMaxMinValues(this.get("name")).done(function(t){var i=t.maxMin;e.minValue=i[0],e.maxValue=i[1]})),this._minMaxValuesDeferred},loadAdditionalServerData:function(e){var t=this;return this.additionalServerDataDeferred(e).done(function(){t._setValue()})},additionalServerDataDeferred:function(e){var t=new n.Deferred;return t.resolve(),this.isString()&&l.include([_.IN,_.NOT_IN,_.EQUALS,_.NOT_EQUAL],this.get("operatorName"))?e||(t=n.when(this.fetchDataForChangeFilterType())):(this.isNumber()||this.isDate()||this.isTime())&&(l.include([_.IN,_.NOT_IN],this.get("operatorName"))?e||(t=n.when(this.fetchDataForChangeFilterType())):l.include([_.LESS,_.LESS_OR_EQUAL,_.GREATER,_.GREATER_OR_EQUAL,_.BETWEEN,_.NOT_BETWEEN,_.BETWEEN_DATES,_.NOT_BETWEEN_DATES],this.get("operatorName"))&&(t=n.when(this.fetchMinMaxValues()))),t},_onOperatorNameChange:function(){var e=this.previousAttributes();"undefined"!=typeof e.operatorName&&e.operatorName===_.IN&&this.get("operatorName")!==_.IS_ANY_VALUE&&this.get("isAnyValue")&&this.set("isAnyValue",!1,{silent:!0});var t=v(this.get("filterDataType"),this.get("operatorName"));this.set("expressionType",t,{silent:!0}),this.trigger("change:expressionType",this,this.get("expressionType"))},saveValue:function(){return this.service.update(this.get("id"),this.toExpression())},_onExpressionTypeChange:function(){var e=this;this._updateModelBehavior(),this.loadAdditionalServerData().done(function(){e.trigger("operationChange",e)})},_updateModelBehavior:function(){this._updateInstanceWithTrait(),this._updateInstanceWithValidation()},_setValue:function(){if(!this.isReadOnly()){var e=this.previousAttributes();if(!l.isEmpty(e)&&this._isDefaultValueSelected(e))this._setDefaultValue();else{var t=this.get("value"),i=[_.EQUALS,_.NOT_EQUAL],a=[_.CONTAINS,_.NOT_CONTAINS,_.STARTS_WITH,_.NOT_STARTS_WITH,_.ENDS_WITH,_.NOT_ENDS_WITH],r=[_.IN,_.NOT_IN];l.include(a,e.operatorName)&&l.include(i,this.get("operatorName"))?this._setDefaultValue():(this.isString()||this.isBoolean())&&l.include(i,e.operatorName)&&l.include(r,this.get("operatorName"))?this.set({value:[t]},{silent:!0,validate:!0}):e.expressionType===N.LIST&&this.get("expressionType")===N.LITERAL?this.set({value:l.isArray(t)?t[0]:t},{silent:!0,validate:!0}):e.expressionType===N.LIST&&l.include([N.RANGE,N.DATE_RANGE],this.get("expressionType"))?this.set({value:[t[0],t[t.length-1]]},{silent:!0,validate:!0}):l.include([_.EQUALS,_.NOT_EQUAL],e.operatorName)&&l.include([N.RANGE,N.DATE_RANGE],this.get("expressionType"))?this.set({value:[t,t]},{silent:!0,validate:!0}):l.include([_.GREATER,_.GREATER_OR_EQUAL],e.operatorName)&&l.include([N.RANGE,N.DATE_RANGE],this.get("expressionType"))?this.set({value:[t,this.maxValue]},{silent:!0,validate:!0}):l.include([_.LESS,_.LESS_OR_EQUAL],e.operatorName)&&l.include([N.RANGE,N.DATE_RANGE],this.get("expressionType"))?this.set({value:[this.minValue,t]},{silent:!0,validate:!0}):l.include([N.RANGE,N.DATE_RANGE],e.expressionType)&&this.get("expressionType")===N.LIST?this._setDefaultValue():l.include([N.RANGE,N.DATE_RANGE],e.expressionType)&&l.include([_.EQUALS,_.NOT_EQUAL,_.GREATER,_.GREATER_OR_EQUAL],this.get("operatorName"))?this.set({value:t[0]},{silent:!0,validate:!0}):l.include([N.RANGE,N.DATE_RANGE],e.expressionType)&&l.include([_.LESS,_.LESS_OR_EQUAL],this.get("operatorName"))&&this.set({value:t[t.length-1]},{silent:!0,validate:!0}),this.isValid(!0)||this._setDefaultValue()}}},_getDefaultValue:function(){return g(this.get("filterDataType"),this.get("operatorName"),this.isOlap,this.additionalModelDataForDefaultValue())},_setDefaultValue:function(){this.set(this._getDefaultValue(),{silent:!0}),this.isValid(!0)},_isDefaultValueSelected:function(e){var t=g(this.get("filterDataType"),e.operatorName,this.isOlap,this.additionalModelDataForDefaultValue()),i={value:e.value,isAnyValue:e.isAnyValue};return R.valueObjectsAreEqual(i,t)},additionalModelDataForDefaultValue:function(){var e=[];if(this.dataProvider.dataCacheTotal>0){var t=this.dataProvider.dataCache.slice(0,this.dataProvider.pageSize);e=l.map(t,function(e){return e.value})}return{min:this.minValue,max:this.maxValue,values:e,allValuesLoaded:this.dataProvider.dataCacheTotal<=this.dataProvider.pageSize}},set:function(e,t,i){var a;return null==e?this:("object"==typeof e?(a=e,i=t):(a={})[e]=t,i||(i={}),a=R.normalizeAttributes(a),o.Model.prototype.set.call(this,a,i))},_updateInstanceWithTrait:function(){return l.extend(this,M[this.get("expressionType")])},_updateInstanceWithValidation:function(){this.validation=m(this.get("filterDataType"),this.get("operatorName"))},toExpression:function(){var e=this.get("operatorName");(this.isTime()||this.isNumber())&&(e===_.BETWEEN?e=_.IN:e===_.NOT_BETWEEN&&(e=_.NOT_IN)),this.get("isAnyValue")&&(e=_.IS_ANY_VALUE);var t={type:this.get("operatorType"),name:e,operands:[{type:this.get("filterLabelType"),name:this.get("name")}]};return this.get("isAnyValue")||[].push.apply(t.operands,this._rValue()),[t]},_rValue:function(){var e=this._expressionRValue();return l.isArray(e)?e:[e]},isDate:function(){return t(this.get("filterDataType"))},isBoolean:function(){return i(this.get("filterDataType"))},isTime:function(){return a(this.get("filterDataType"))},isString:function(){return r(this.get("filterDataType"))},isNumber:function(){return s(this.get("filterDataType"))},isReadOnly:function(){return!this.get("editable")}},{normalizeAttributes:function(e){var i=l.clone(e);if(i.hasOwnProperty("expressionAsString")&&delete i.expressionAsString,i.hasOwnProperty("editable")&&(i.editable||(i.filterDataType=y.READ_ONLY,i.operatorName=_.READ_ONLY,i.label=u[L[e.source]||L.DATA_CHOOSER_NO_PROMPT],i.isComplex="complex"===e.name.toLowerCase())),l.isUndefined(i.isAnyValue)&&i.hasOwnProperty("operatorName")&&(i.operatorName===_.IS_ANY_VALUE?(i.isAnyValue=!0,i.operatorName=t(i.filterDataType)?_.BETWEEN_DATES:_.IN):i.isAnyValue=!1),i.hasOwnProperty("operatorName")&&i.hasOwnProperty("filterDataType")){var a=v(i.filterDataType,i.operatorName);l.isUndefined(i.expressionType)&&(i.expressionType=a),a===N.LITERAL&&i.hasOwnProperty("value")&&l.isArray(i.value)&&1===i.value.length&&(i.value=i.value[0])}return i},_isArraysEquals:function(e,t){if(e.length!=t.length)return!1;var i,a={};for(i=0;i<e.length;i++)a[e[i]]=!0;for(i=0;i<t.length;i++)if(!a[t[i]])return!1;return!0},valueObjectsAreEqual:function(e,t){if("undefined"==typeof e.isAnyValue&&t.isAnyValue===!0||"undefined"==typeof t.isAnyValue&&e.isAnyValue===!0||"undefined"!=typeof e.isAnyValue&&"undefined"!=typeof t.isAnyValue&&e.isAnyValue!==t.isAnyValue)return!1;var i=e.value,a=t.value;if(l.isArray(i)&&l.isArray(a))return this._isArraysEquals(i,a);if(l.isArray(i)||l.isArray(a))return!1;var r=f.parseNumber(i),s=f.parseNumber(a);return"undefined"==typeof r&&"undefined"==typeof s?i==a:r==s}});return l.extend(R.prototype,o.Validation.mixin),R});