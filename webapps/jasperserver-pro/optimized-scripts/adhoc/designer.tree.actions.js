define(["require","underscore","adhoc/designer"],function(e){var r=e("underscore"),t=e("adhoc/designer");return t.moveToMeasuresOrAttributes=function(e){if(e){var d=Object.isArray(e)?e:[e];e=d.first();var a=e.getTreeId(),i=t[a].getRootNode(),n=0===a.indexOf("dimension")?t.measuresTree:t.dimensionsTree;r.each(d,function(e){t.mergeToDestTree(t.copyParentStructure(e,n),n.getRootNode());for(var r=e;r!=i&&0===r.childs.length;){var d=r.parent;d.removeChild(r),r=d}}),n.resortTree(),n.renderTree(),n.openAndSelectNode(e.param.uri)}},t.addNodeToTree=function(e,r){var t=r.processNode(e);t.isloaded=!0,t.editable=!1,r.rootNode.addChild(t),t.refreshStyle()},t.removeNodeFromTree=function(e){if(!e.parent)throw"The parent node is undefined";var r=e.parent,t=e.param.extra.isMeasure;r.removeChild(e),0===r.childs.length&&!t&&r.parent&&r.parent.removeChild(r)},t.copyParentStructure=function(e,r){if(e&&r){for(var d=dynamicTree.trees[e.getTreeId()],a=r===t.measuresTree,i=localContext.metaNodeBuilder?localContext.metaNodeBuilder:t.metaNodeBuilder,n=r.processNode(i(e,a)),o=e.parent,s=null;o&&o!=d.getRootNode();)s=r.processNode(i(o,a)),s.addChild(n),n=s,o=o.parent;return n}},t.mergeToDestTree=function(e,r){if(r){var d=dynamicTree.trees[r.getTreeId()],a=d.findNodeChildByMetaName(r,e.param.id);null!=a?e.hasChilds()&&e.childs.each(function(e){t.mergeToDestTree(e,a)}):(t.markNodeAsLoaded(e),r.addChild(e))}},t.metaNodeBuilder=function(e,r){var d={id:e.param.id,label:e.name,type:e.param.type,uri:e.param.uri,order:e.orderNumber};if(e.param.extra){var a=Object.extend({},e.param.extra);d.extra=Object.extend(a,{id:e.param.id,isMeasure:r,dimensionId:r?t.MEASURES:e.param.id})}return d},t.markNodeAsLoaded=function(e){e.isloaded=!0,e.isParent()&&e.childs.each(function(e){t.markNodeAsLoaded(e)})},t.getAllLeaves=function(e,r){var t=arguments[2]||[];if(!e){if(!r)return t;if(e=r.getRootNode(),!e)return t}if(!e.hasChilds())return t.push(e),t;for(var d=0;d<e.childs.length;d++)this.getAllLeaves(e.childs[d],null,t);return t},t.getFirstLeaf=function(e){if(!e)return null;var r=e;if(!e.childs||0===e.childs.length)return r;for(var t=0;t<e.childs.length;t++)if(r=this.getFirstLeaf(e.childs[t]))return r},t.getNodeByEvent=function(e){return this.measuresTree.getTreeNodeByEvent(e)||this.dimensionsTree.getTreeNodeByEvent(e)},t});