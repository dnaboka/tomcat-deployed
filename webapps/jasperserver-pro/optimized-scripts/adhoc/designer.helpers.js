define(["require","adhoc/designer","adhoc/designer/aggregateFieldLabelFactory","underscore"],function(e){var t=e("adhoc/designer"),n=e("adhoc/designer/aggregateFieldLabelFactory"),i=e("underscore");return t.setDragStartState=function(e,n,i,a){var r=[Event.pointerX(a),Event.pointerY(a)],s=i.element,o=i.element=new Element("LI").update(s.innerHTML);o.classNames().set(s.classNames()),o.writeAttribute("fieldname",t.getFieldName()),o.setStyle({"z-index":s.getStyle("z-index")}),o.hide(),s.parentNode.appendChild(o),Element.clonePosition(o,s),Position.absolutize(o),s.remove(),dynamicTree.Tree.prototype.setDragStartState.apply(e,Array.prototype.slice.call(arguments,1)),i.draw(r),o.show()},t.deSelectAllPressedNavMuttons=function(){var e=$$("UL#navigationOptions li");e&&e.each(function(e){buttonManager.out($(e),function(e){return $(e).down(layoutModule.LIST_ITEM_WRAP_PATTERN)})})},t.hideAllDialogsAndMenus=function(){actionModel.hideMenu();var e=Object.values(this.dialogESCFunctions);e.each(function(e){var t=$(e);t&&dialogs.popup.hide(t)}.bind(this))},t.initPreventBrowserSelection=function(e){disableSelectionWithoutCursorStyle($(e))},t.initEnableBrowserSelection=function(e){enableSelection($(e))},t.isNoDataToDisplay=function(){return localContext.getMode()===designerBase.TABLE?jQuery("#nothingToDisplay").is(":visible"):void 0},t.checkMaxRowsLimit=function(){if(localContext.state.hitMaxRows&&!this.isNoDataToDisplay()){var e=rowLimitMessage.replace("{0}",localContext.state.maxDataRowsCount);dialogs.systemConfirm.show(e,5e3)}},t.isOnlyFieldsSelected=function(){var e=function(e){return e.hasChilds()};return null==this.getSelectedTreeNodes().detect(e)},t.showButtonMenuMouseOut=function(e){actionModel.hideMenu(),Event.stopObserving($(e),"mouseleave",t.showButtonMenuMouseOut)},t.isSelectedFieldCustom=function(){if(1==selObjects.length){var e=designerBase.getSelectedObject();if(e.model)return e.model.isCustomField;var n=t.findFieldByName(t.getNameForSelected(e));return n&&n.isCustomField}},t.isSelectFieldsAllowed=function(){return isDomainType},t.isDeleteAllowed=function(){if(1!=selObjects.length)return!1;var e=designerBase.getSelectedObject()?designerBase.getSelectedObject().param.id:null,n=t.findFieldByName(e);return null!=n&&n.isCustomField&&!n.isUsed&&!t.isInUse(e)},t.isUsedInRowsOrColumns=function(e){return i.find(localContext.state.fieldsInUse,function(t){return t===e})},t.canMoveToDimensions=function(){var e=selObjects.find(function(e){var n=t.findFieldByName(t.getNameForSelected(e));return n&&n.isCustomField&&n.aggregateField}),n=selObjects.find(function(e){return e.param.id===designerBase.SPACER_NAME||!(e.param.extra&&e.param.extra.isMeasure)||e.param.extra&&t.isUsedInRowsOrColumns(e.param.extra.id)});return!n&&!e},t.canMoveToMeasures=function(){var e=selObjects.find(function(e){return e.param?e.param.id===designerBase.SPACER_NAME||e.param.extra&&e.param.extra.isMeasure||e.param.extra&&t.isUsedInRowsOrColumns(e.param.extra.id):!1});return!e},t.getMessage=function(e,n){var i=t.messages[e];return i?new Template(i).evaluate(n?n:{}):""},t.registerTemplate=function(e,t){if(!e||!t)throw"Some of required params to register template are missing";return e[t]||(e[t]=i.template(jQuery("#"+t).html(),null,{evaluate:/\{\{([\s\S]+?)\}\}/g,interpolate:/\{\{=([\s\S]+?)\}\}/g,escape:/\{\{-([\s\S]+?)\}\}/g})),e[t]},t.createTemplate=function(e){if(!e)throw"Some of required params to register template are missing";var t=i.templateSettings;i.templateSettings={evaluate:/\{\{([\s\S]+?)\}\}/g,interpolate:/\{\{=([\s\S]+?)\}\}/g,escape:/\{\{-([\s\S]+?)\}\}/g};var n=i.template(jQuery("#"+e).html());return i.templateSettings=t,n},t.hideOnePanel=function(){if(0===window.orientation){var e,t=document.getElementById("filters"),n=document.getElementById("fields"),i=jQuery("#filter-container").find("div.panel.pane.filter").filter(":visible").length,a=t.className.indexOf("minimized")>=0;a||(e=i?n:t,layoutModule.minimize(e))}},t.defaultFieldJSONBuilder=function(e){return{dimensionId:e.param.extra.dimensionId,name:e.param.extra.id}},t.getListOfSelectedFields=function(e){var n=t.getSelectedTreeNodes();if(this.isOlapMode())return e=Object.isFunction(e)?e:t.defaultFieldJSONBuilder,n.collect(function(t){if(t.isParent()){var n=t.childs.detect(function(e){return localContext.canAddFilter(e)});return n.collect(e)}return localContext.canAddFilter(t)?e(t):null}).compact().flatten();for(var a=[],r=0;r<n.length;r++){var s=n[r];if(s.isParent()){for(var o=s.childs,l=0;l<o.length;l++){var u=o[l].param.id;localContext.canAddFilter(o[l])&&a.push(u)}if(0===a.length)continue}else{if(!localContext.canAddFilter(s))continue;a.push(s.param.id)}}return i.map(a,function(e){return{name:e}})},t.generateAvailableSummaryCalculationsMenu=function(e,t,a){var r=i.chain(localContext.state.fieldAvailableSummaries[e]).filter(function(e){return"None"!==e}).sortBy().value();r.unshift("None"),t.children=i.map(r,function(e){return actionModel.createMenuElement("optionAction",i.extend({text:n.localizeAggregation(e),actionArgs:[e],isSelectedTestArgs:[e]},a))})},t.getMissingFieldsCanvasMessage=function(e){var n=i.reduce(e.allColumns,function(t,n){return i.contains(e.unresolvedMetadataReferences,n.name)?(t=t?t+", ":"",t+(n.defaultDisplayName||n.name)):t},""),a=t.getMessage("adhoc.inuse.designer.canvas.error.message");return a=a.replace("{0}",n)},t});