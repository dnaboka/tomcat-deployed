define(["require","bundle!adhoc_messages","adhoc/designer"],function(e){var t=e("bundle!adhoc_messages"),a=e("adhoc/designer");return a.addFieldToCanvas=function(){localContext.getMode()===designerBase.TABLE?AdHocTable.addFieldAsColumn():localContext.getMode()===designerBase.CROSSTAB?localContext.addFieldAsLastMeasure():localContext.getMode()===designerBase.CHART&&localContext.addFieldAsMeasure()},a.checkIfFieldIsNumeric=function(e){var t=a.findFieldByName(e);return null!=t&&"Numeric"==t.type},a.checkIfAllSelectedAreNumeric=function(){for(var e=null,t=null,l=0;l<selObjects.length;l++)if(t=selObjects[l],t&&(selectionCategory.area===designerBase.AVAILABLE_FIELDS_AREA?e=t.param.id:selectionCategory.area===designerBase.COLUMN_LEVEL&&(e=t.header.getAttribute("data-fieldName")),!a.checkIfFieldIsNumeric(e)))return!1;return!0},a.collectFields=function(e,t,a){for(var l=[],n=0;n<e.length;n++){var r=e[n];r.isParent()&&t?l=l.concat(this.collectFields(r.childs,t,a)):a?a(r.param.id)&&l.push(r.param.id):l.push(r.param.id)}return l},a.getAllFields=function(){return isNotNullORUndefined(localContext.state.allColumns)?localContext.state.allColumns:[]},a.findFieldByName=function(e){var t=null;return localContext.state.allColumns&&localContext.state.allColumns.each(function(a){if(a.name&&a.name==e)throw t=a,$break}),t},a.getNameForSelected=function(e){return selectionCategory.area===designerBase.AVAILABLE_FIELDS_AREA?e?e.param.id:"":e.chartMeasureId?e.chartMeasureId:selectionCategory.area===designerBase.COLUMN_LEVEL?e.header.getAttribute("data-fieldName"):selectionCategory.area===designerBase.GROUP_LEVEL?e.fieldName:selectionCategory.area===designerBase.ROW_GROUP_MENU_LEVEL||selectionCategory.area===designerBase.COLUMN_GROUP_MENU_LEVEL?e.name:selectionCategory.area===designerBase.SUMMARY_LEVEL?e.model.name:selectionCategory.area===designerBase.LEGEND_MENU_LEVEL?e.legendName:void 0},a.getFieldName=function(){var e=designerBase.getSelectedObject();return e?this.getNameForSelected(e):""},a.getFieldIndexByName=function(e){if(isNotNullORUndefined(localContext.state.allColumns))for(var t=localContext.state.allColumns.length,a=0;t>a;a++){var l=localContext.state.allColumns[a];if(l.name==e)return a}return-1},a.moveToDimensions=function(){if(selObjects.first()){var e=selObjects.clone();a.moveToMeasuresOrAttributes(e);var t=e.collect(function(e){return e.param.id}).join(",");a.changeFieldAttributeOrMeasure(t,"attribute")}},a.moveToMeasures=function(){if(selObjects.first()){var e=selObjects.clone();a.moveToMeasuresOrAttributes(e);var t=e.collect(function(e){return e.param.id}).join(",");a.changeFieldAttributeOrMeasure(t,"measures")}},a.selectFromAvailableFields=function(e,t){e||this.addSelectedObject(e,t,!1,!0);var a=this.isMultiSelect(e,designerBase.AVAILABLE_FIELDS_AREA);selectionCategory.area=designerBase.AVAILABLE_FIELDS_AREA;var l=this.isAlreadySelected(t);this.addSelectedObject(e,t,a,l),actionModel.setSelected(_.map(dynamicTree.trees[t.getTreeId()].selectedNodes,function(e){return e.param.extra}))},a.updateFieldsInUse=function(e){[].push.apply(localContext.state.fieldsInUse,e)},a.removeFromFieldsInUse=function(e){localContext.state.fieldsInUse&&(localContext.state.fieldsInUse=_.difference(localContext.state.fieldsInUse,e))},a.isInUse=function(e){var t=_.find(localContext.state.fieldsInUse,function(t){return t===e});return t||a.hasDependencyOnIt(e)},a.isInError=function(e){var t=_.find(localContext.state.unresolvedMetadataReferences,function(t){return t===e});return t},a.createCalculatedField=function(){adhocCalculatedFields.createField("DIMENSION")},a.createCalculatedMeasure=function(){adhocCalculatedFields.createField("MEASURE")},a.editCalculatedField=function(){adhocCalculatedFields.updateField()},a.deleteCalculatedField=function(){var e=designerBase.getSelectedObject(),l=jQuery("#"+a.DELETE_CALCULATED_FIELD_CONFIRMATION_DIALOG.DIALOG_ID);dialogs.popupConfirm.show(l[0],!1,{message:t.ADH_436_CALCULATED_FIELD_REMOVE_CONFIRM+' "'+e.name.unescapeHTML()+'".',okButtonSelector:"#"+a.DELETE_CALCULATED_FIELD_CONFIRMATION_DIALOG.OK_BUTTON_ID,cancelButtonSelector:"#"+a.DELETE_CALCULATED_FIELD_CONFIRMATION_DIALOG.CANCEL_BUTTON_ID}).done(adhocCalculatedFields.deleteField.bind(adhocCalculatedFields))},a.isPercentOfParentCalcSelected=function(e){return a.isAggregateSelected(e)},a.isAggregateSelected=function(e){if(e||(e=designerBase.getSelectedObject()),e){var t=a.getNameForSelected(e),l=a.findFieldByName(t);return l&&l.aggregateField}return!1},a.isPercentOfParentCalc=function(e){var t=a.findFieldByName(e);return t&&t.aggregateField},a.hasDependencyOnIt=function(e){var t=a.findFieldByName(e);return t&&t.isUsed},a.updateAllFieldLabels=function(){if(isDesignView){var e=a,t=[e.dimensionsTree,e.measuresTree];_.each(t,function(t){_.each(e.getAllLeaves(null,t),function(t){var l=e.findFieldByName(t.param.id);l&&l.isCustomField&&(a.updateTreeFieldLabel(t,l.defaultDisplayName),t.param.cssClass=e.isInUse(t.param.id)?"calculatedField dependency":"calculatedField",t.refreshStyle())}),t.renderTree()})}},a.updateTreeFieldLabel=function(e,t){e.name=t.replace(/\\'/g,"'"),e.param.label=t.replace(/\\'/g,"'")},a});