define(["require","underscore","bundle!jasperserver_messages","bundle!adhoc_messages","adhoc/calculatedFields/CalculatedFieldsController","adhoc/calculatedFields/CalculatedFieldsService"],function(e){var a,t=e("underscore"),l=t.extend(e("bundle!jasperserver_messages"),e("bundle!adhoc_messages")),d=e("adhoc/calculatedFields/CalculatedFieldsController"),o=e("adhoc/calculatedFields/CalculatedFieldsService");return window.adhocCalculatedFields={DIALOG_ID:"calcFieldMeasure",FIELDS_CONTAINER_ID:"#calculatedFields-container",calcFieldsService:new o({clientKey:clientKey}),showDialog:function(e){a=$(this.DIALOG_ID),a.down("button.doneButton").observe("click",e.applyField.bind(e)),a.down("button.cancelButton").observe("click",function(){e.stop(),this.closeDialog()}.bind(this)),dialogs.popup.show(a),a.style.marginTop="0",a.style.top="15px"},closeDialog:function(){Event.stopObserving(a.down("button.doneButton")),Event.stopObserving(a.down("button.cancelButton")),dialogs.popup.hide(a)},setDialogLabels:function(e,t){var d=e?{dialogHeader:t?"ADH_401_DIALOG_HEADER_EDIT_CUSTOM_MEASURE":"ADH_401_DIALOG_HEADER_NEW_CUSTOM_MEASURE",okButtonLabel:t?"button.save":"ADH_430_BUTTON_CREATE_MEASURE"}:{dialogHeader:t?"ADH_401_DIALOG_HEADER_EDIT_CUSTOM_FIELD":"ADH_401_DIALOG_HEADER_NEW_CUSTOM_FIELD",okButtonLabel:t?"button.save":"ADH_430_BUTTON_CREATE_FIELD"};$(a.down(".header.mover > .title")).update(l[d.dialogHeader]),$(a.down(".footer button.doneButton span.wrap")).update(l[d.okButtonLabel])},createField:function(e){var a=new d({element:this.FIELDS_CONTAINER_ID,service:this.calcFieldsService});a.listenTo(a,"field:loaded",this.setDialogLabels.bind(this)),a.listenTo(a,"field:applied",function(e){a.stop(),this.closeDialog(),this.createCustomFieldCallback(e)}.bind(this)),this.showDialog(a),a.start({editingMode:!1,kind:e})},updateField:function(){var e=designerBase.getSelectedObject(),a=e.model?e.model.fieldName:adhocDesigner.getNameForSelected(e);if(null==a)throw'The field "'+a+'" is not found.';var t=new d({element:this.FIELDS_CONTAINER_ID,service:this.calcFieldsService});t.listenTo(t,"field:loaded",this.setDialogLabels.bind(this)),t.listenTo(t,"field:applied",function(e){t.stop(),this.closeDialog(),this.updateCustomFieldCallback(e)}.bind(this)),this.showDialog(t),t.start({editingMode:!0,selectedFieldName:a})},deleteField:function(){var e=designerBase.getSelectedObject(),a=adhocDesigner.getNameForSelected(e);if(adhocDesigner.isInUse(a))throw"The field in use.";var l=function(t){this.deleteCustomFieldCallback(a,e,t),adhocDesigner.enableCanUndoRedo()}.bind(adhocCalculatedFields);this.calcFieldsService.remove(a).done(t.bind(function(e,a,t){if(204===t.status)throw"Field not found.";adhocCalculatedFields._updateState(l)},this))},createCustomFieldCallback:function(e){var a="MEASURE"===e.kind;dialogs.systemConfirm.show(l[a?"ADH_435_CALCULATED_MEASURE_ADDED":"ADH_435_CALCULATED_FIELD_ADDED"],5e3),adhocCalculatedFields._updateState(function(t){var l=localContext.state.allColumns.length;if(adhocDesigner.updateState(t),adhocDesigner.enableCanUndoRedo(),localContext.state.allColumns.length>l){var d=e.name,o=adhocDesigner.getFieldIndexByName(d),i=adhocDesigner.findFieldByName(d).type,s={id:d,label:e.display,type:"com.jaspersoft.jasperserver.api.metadata.common.domain.NewNode",uri:"/"+d,cssClass:"calculatedField",order:o,extra:{id:d,name:d,isMeasure:a,dimensionId:a?adhocDesigner.MEASURES:d,dataType:i}},n=a?"measuresTree":"dimensionsTree";adhocDesigner.addNodeToTree(s,adhocDesigner[n]),adhocDesigner.updateAllFieldLabels(),adhocDesigner[n+"Search"].setKeyword("")}})},updateCustomFieldCallback:function(e){var a="MEASURE"===e.kind;dialogs.systemConfirm.show(l[a?"ADH_435_CALCULATED_MEASURE_UPDATED":"ADH_435_CALCULATED_FIELD_UPDATED"],5e3),adhocCalculatedFields._updateState(function(a){adhocDesigner.updateState(a),adhocDesigner.enableCanUndoRedo(),adhocDesigner.isInUse(e.name)&&(localContext.updateViewCallback(a),adhocDesigner.filtersController.setFilters(a,{reset:!0})),adhocDesigner.updateAllFieldLabels()})},deleteCustomFieldCallback:function(e,a,t){var d=a.param.extra.isMeasure;dialogs.systemConfirm.show(l[d?"ADH_435_CALCULATED_MEASURE_DELETED":"ADH_435_CALCULATED_FIELD_DELETED"],5e3);var o=localContext.state.allColumns.length;adhocDesigner.updateState(t),adhocDesigner.enableCanUndoRedo(),localContext.state.allColumns.length<o&&a&&(adhocDesigner.removeNodeFromTree(a),adhocDesigner.updateAllFieldLabels())},_updateState:function(e){designerBase.sendRequest(adhocDesigner.getControllerPrefix()+"_recompileQueryAndLoadState",[],function(a){e(a)})}},window.adhocCalculatedFields});