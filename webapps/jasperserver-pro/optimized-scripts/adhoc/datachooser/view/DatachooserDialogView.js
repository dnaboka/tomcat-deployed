define(["require","underscore","jquery","common/component/dialog/Dialog","common/component/dialog/AlertDialog","common/component/panel/Panel","common/component/tree/Tree","common/component/tree/TreeDataLayer","common/component/panel/trait/tabbedPanelTrait","common/component/tree/plugin/TooltipPlugin","common/component/tree/plugin/SearchPlugin","common/component/tree/plugin/InfiniteScrollPlugin","common/component/tree/plugin/NoSearchResultsMessagePlugin","jrs.configs","bi/repository/enum/repositoryResourceTypes","bundle!adhoc_messages","bundle!CommonBundle","common/util/browserDetection","text!adhoc/datachooser/template/datachooserDialogTemplate.htm","text!adhoc/datachooser/template/dataChooserTreeLeafTemplate.htm","text!adhoc/datachooser/template/tooltip/sidebarTreeLeafTooltipTemplate.htm","text!adhoc/datachooser/template/datachooserTabTemplate.htm"],function(e){"use strict";function t(e){switch(e.value.resourceType){case d.REPORT_UNIT:e.cssClass="topic";break;case d.DOMAIN_TOPIC:e.cssClass="domain topic";break;case d.SEMANTIC_LAYER_DATA_SOURCE:e.cssClass="domain";break;case d.OLAP_CUBE:e.cssClass="olap"}return e}var o=e("underscore"),r=e("jquery"),i=e("common/component/dialog/Dialog"),a=e("common/component/dialog/AlertDialog"),s=(e("common/component/panel/Panel"),e("common/component/tree/Tree")),n=e("common/component/tree/TreeDataLayer"),l=e("common/component/panel/trait/tabbedPanelTrait"),c=e("common/component/tree/plugin/TooltipPlugin"),h=e("common/component/tree/plugin/SearchPlugin"),u=e("common/component/tree/plugin/InfiniteScrollPlugin"),p=e("common/component/tree/plugin/NoSearchResultsMessagePlugin"),m=e("jrs.configs").contextPath,d=e("bi/repository/enum/repositoryResourceTypes"),T=e("bundle!adhoc_messages"),g=e("bundle!CommonBundle"),_=e("common/util/browserDetection"),D=e("text!adhoc/datachooser/template/datachooserDialogTemplate.htm"),C=e("text!adhoc/datachooser/template/dataChooserTreeLeafTemplate.htm"),f=e("text!adhoc/datachooser/template/tooltip/sidebarTreeLeafTooltipTemplate.htm"),y=e("text!adhoc/datachooser/template/datachooserTabTemplate.htm"),b="reportType",O=22,E="decorate",A="embeddedDesigner",R="list",I=5e3,S="&recursive=true",v="&recursive=false",L=m+"/rest_v2/api/resources?{{= id != '@fakeRoot' ? 'folderUri=' + id : ''}}",N="&type="+d.DOMAIN_TOPIC+"&type="+d.TOPIC+"&type="+d.SEMANTIC_LAYER_DATA_SOURCE,P="&type="+d.SECURE_MONDRIAN_CONNECTION+"&type="+d.MONDRIAN_CONNECTION+"&type="+d.XMLA_CONNECTION,w="&offset={{= offset }}&limit={{= limit }}&forceTotalCount=true&forceFullPage=true",U=L+v+"&containerType="+d.FOLDER,H=L+S+w,x=[d.MONDRIAN_CONNECTION,d.SECURE_MONDRIAN_CONNECTION,d.XMLA_CONNECTION];return i.extend({events:{resize:"onResizeHeight"},onResizeHeight:function(){this.$contentContainer.height(this.$el.height()-this._resizableContainerShiftHeight),this.listTreeView.rootLevel.list.$el.height(this.$el.height()-this._resizableContainerShiftHeight-6),this.hierarhicalTreeView.rootLevel.list.$el.css("height","100%")},constructor:function(e){e||(e={}),this._dfdRenderSerachFormTo=r.Deferred();var a=this._getParameterByName(b);a=a||"crosstab",this.reportType="chart"===a?"ichart":a,this.decorate=this._getParameterByName(E)||"yes",this.isEmbeddedDesigner=this._getParameterByName(A);var _=U+N;_+="table"===this.reportType?w:P+w;var R={attachTo:this.$el,i18n:T,contentTemplate:f},S=s.use(c,R).use(u).create(),v=o.union([d.TOPIC,d.DOMAIN_TOPIC,d.SEMANTIC_LAYER_DATA_SOURCE],x),L=s.use(c,R).use(p).use(h,{additionalParams:{type:"table"===this.reportType?o.first(v,3):v},dfdRenderTo:this._dfdRenderSerachFormTo}).create(),B={treeNodeProcessor:{processItem:function(e){return e._node=o.contains(o.union([d.FOLDER],x),e.value.resourceType),e}},i18nItemProcessor:{processItem:function(e){return e.i18n=g,e}},filterPublicFolderProcessor:{processItem:function(e){return"/public"!==e.value.uri?e:void 0}},filterTempFolderProcessor:{processItem:function(e){return e.value.uri.match(/\/temp\//)||e.value.uri.match(/\/temp$/)?void 0:e}},filterEmptyFoldersProcessor:{processItem:function(e){return"folder"!==e.value.resourceType||""!==e.value._links.content?e:void 0}},cssClassItemProcessor:{processItem:t}},k=new n({requestType:"POST",dataUriTemplate:m+"/rest_v2/connections",processors:[B.i18nItemProcessor,B.cssClassItemProcessor],levelDataId:"uri",getDataArray:function(e,t,o){return e&&e[d.RESOURCE_LOOKUP]?e[d.RESOURCE_LOOKUP]:[]}}),z=function(e){var t=o.contains(x,e.resource.resourceType);if(t){var r=o.clone(this.customDataLayers.olapDataLayer);return o.extend(r,{accept:"application/repository."+e.resource.resourceType+".metadata+json",contentType:"application/repository."+e.resource.resourceType+"+json",data:JSON.stringify(e.resource)}),r}return this.customDataLayers&&this.customDataLayers[e.id]?this.customDataLayers[e.id]:this.defaultDataLayer};this.hierarhicalTreeView=S.instance({itemsTemplate:C,listItemHeight:O,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,bufferSize:I,additionalCssClasses:"folders",dataUriTemplate:_,levelDataId:"uri",customDataLayers:{"/":o.extend(new n({dataUriTemplate:m+"/flow.html?_flowId=searchFlow&method=getNode&provider=repositoryExplorerTreeFoldersProvider&uri=/&depth=1",processors:o.chain(B).omit("filterPublicFolderProcessor").values().value(),getDataArray:function(e){e=JSON.parse(r(e).text());var t=o.find(e.children,function(e){return"/public"===e.uri}),i=[{id:"@fakeRoot",label:e.label,uri:"/",resourceType:"folder",_links:{content:"@fakeContentLink"}}];return t&&i.push({id:"/public",label:t.label,uri:"/public",resourceType:"folder",_links:{content:"@fakeContentLink"}}),i}}),{accept:"text/html",dataType:"text"}),olapDataLayer:k},processors:o.values(B),getDataArray:function(e,t,o){return e&&e[d.RESOURCE_LOOKUP]?e[d.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,o){return+o.getResponseHeader("Total-Count")},getDataLayer:z}),this.listTreeView=L.instance({rootLevelHeight:o.bind(this.getContentHeight,this),itemsTemplate:C,listItemHeight:O,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,dataUriTemplate:H,levelDataId:"uri",cache:{searchKey:"searchString",pageSize:100},processors:[{processItem:function(e){return e._node=o.contains(x,e.value.resourceType),e}},B.i18nItemProcessor,B.cssClassItemProcessor,B.filterTempFolderProcessor],customDataLayers:{olapDataLayer:k},getDataLayer:z,getDataArray:function(e,t,o){return e&&e[d.RESOURCE_LOOKUP]?e[d.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,o){return+o.getResponseHeader("Total-Count")}}),i.prototype.constructor.call(this,{template:D,modal:!0,resizable:!0,additionalCssClasses:"sourceDialogNew",title:T.ADH_108_DATA_CHOOSER_DIALOG_TITLE,traits:[l],tabHeaderContainerSelector:".tabHeaderContainer",tabContainerClass:"tabContainer control groupBox treeBox",optionTemplate:y,toggleClass:"down",tabs:[{label:T.ADH_108_DATA_CHOOSER_FOLDERS_TAB,action:"tree",content:this.hierarhicalTreeView,exposeAction:!0,additionalCssClasses:"action square small",i18n:T},{label:T.ADH_108_DATA_CHOOSER_LIST_TAB,action:"list",content:this.listTreeView,exposeAction:!0,additionalCssClasses:"action square small",i18n:T}],buttons:[{label:T.ADH_016_BUTTON_OK,action:"apply",primary:!0},{label:T.ADH_010_BUTTON_CANCEL,action:"cancel",primary:!1}]}),this.disableButton("apply"),this.on("button:apply",o.bind(this._onSelectDataDialogOkButtonClick,this)),this.on("button:cancel",o.bind(this._onSelectDataDialogCancelButtonClick,this))},initialize:function(e){var t=function(e){var t=o.find(this.buttons.options,function(e){return"apply"===e.model.attributes.action}).$el,r=e&&o.isArray(e)&&e[0],i=r?e[0].uri:void 0,a=r?e[0].resourceType:void 0;return r||i||a?(a!==d.FOLDER?this.$(".itemDescription").text(r.description||""):this.$(".itemDescription").empty(),a===d.SEMANTIC_LAYER_DATA_SOURCE?t.find(".wrap").text(T.ADH_108_DATA_CHOOSER_DOMAIN_LABEL):t.find(".wrap").text(T.ADH_016_BUTTON_OK),o.contains(o.union([d.FOLDER],x),a)?(delete this.resourceData,void this.disableButton("apply")):(this.resourceData={},a===d.OLAP_CUBE?(this.resourceData.resourceUri=i.substring(0,i.lastIndexOf("/")),this.resourceData.cube=i.substring(i.lastIndexOf("/")+1),this.resourceData.reportType="olap_"+this.reportType):(this.resourceData.resourceUri=i,this.resourceData.reportType=this.reportType),this.resourceData.event=this._getAdHocFlowEvent(a),this.resourceData.flowExecutionKey=flowExecutionKey,void this.enableButton("apply"))):(this.disableButton("apply"),void this.$(".itemDescription").empty())};this.errorDialog=new a,this.listenTo(this.hierarhicalTreeView,"selection:change",t),this.listenTo(this.listTreeView,"selection:change",t),this.listenTo(this.hierarhicalTreeView,"levelRenderError",o.bind(this._onLevelRenderError,this.errorDialog)),this.listenTo(this.listTreeView,"levelRenderError",o.bind(this._onLevelRenderError,this.errorDialog)),this.listenTo(this.hierarhicalTreeView,"item:dblclick",this._onSelectDataDialogOkButtonClick),this.listenTo(this.listTreeView,"item:dblclick",this._onSelectDataDialogOkButtonClick),this.listenTo(this.listTreeView.rootLevel,"ready",this.onResizeHeight,this),this.listenTo(this.hierarhicalTreeView.rootLevel,"ready",this.onResizeHeight,this),this.listenTo(this.listTreeView.searchForm,"search",this._onSearch),this.listenTo(this.listTreeView.searchForm,"clear",this._resetItemSelection),this.on("tab:tree tab:list",this._resetItemSelection,this),i.prototype.initialize.apply(this,arguments)},getContentHeight:function(){return this.$el.height()-this._resizableContainerShiftHeight},render:function(){return i.prototype.render.apply(this,arguments),this._dfdRenderSerachFormTo.resolve(this.$tabHeaderContainer),this.openTab(R),this},open:function(){var e=this;e._resizableContainerShiftHeight=6,i.prototype.open.apply(this,arguments);var t=o.bind(function(){this.$contentContainer.find(".tabContainer").css({height:"inherit","overflow-y":"auto"})},this);_.isIE8()||_.isIE9()?setTimeout(t,1):t(),this.$el.children().not(".subcontainer").not(".ui-resizable-e").not(".ui-resizable-se").each(function(){e._resizableContainerShiftHeight+=e.$(this).outerHeight(!0)}),this.$contentContainer.height(this.$el.height()-this._resizableContainerShiftHeight)},close:function(){this.hierarhicalTreeView&&(this.hierarhicalTreeView.collapse("@fakeRoot",{silent:!0}),this.hierarhicalTreeView.collapse("/public",{silent:!0}),this.hierarhicalTreeView.resetSelection()),i.prototype.close.apply(this,arguments)},_onSearch:function(){this.openTab(R),this.disableButton("apply")},_resetItemSelection:function(){this.hierarhicalTreeView.resetSelection(),this.listTreeView.resetSelection(),this.$(".itemDescription").empty()},_getAdHocFlowEvent:function(e){var t="";return e==d.REPORT_UNIT||e==d.DOMAIN_TOPIC?t="startAdHocWithTopic":e==d.SEMANTIC_LAYER_DATA_SOURCE?t="startQueryBuilder":e===d.OLAP_CUBE&&(t="startAdhocForOlap"),t},_onSelectDataDialogOkButtonClick:function(){this.resourceData&&(document.location="flow.html?_flowId=adhocFlow&realm="+encodeURIComponent(encodeURIComponent(this.resourceData.resourceUri))+"&_flowExecutionKey="+this.resourceData.flowExecutionKey+"&reportType="+this.resourceData.reportType+"&embeddedDesigner="+this.isEmbeddedDesigner+"&decorate="+this.decorate+"&_eventId="+this.resourceData.event+(this.resourceData.cube?"&cube="+this.resourceData.cube:""))},_onLevelRenderError:function(e,t,o){t=JSON.parse(t);var r=t.message;t.parameters&&(r=t.parameters[0].substring(t.parameters[0].indexOf(": ")+2,t.parameters[0].indexOf("\n"))),this.setMessage(r),this.open(),o.$el.removeClass(o.loadingClass).addClass(o.openClass)},_onSelectDataDialogCancelButtonClick:function(){this.close(),this.isEmbeddedDesigner&&-1===document.referrer.indexOf("login.html")&&r(document).trigger("adhocDesigner:cancel")},_getParameterByName:function(e){var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),o=t.exec(location.search);return null==o?"":decodeURIComponent(o[1].replace(/\+/g," "))}})});