define(["require","jquery","underscore","underscore.string","bundle!all","backbone.marionette","backbone.validation","logCollectors/model/LogCollectorModel","bi/repository/enum/repositoryResourceTypes","bi/repository/dialog/resourceChooser/RepositoryChooserDialogFactory","text!logCollectors/templates/createLogCollector.htm"],function(e){"use strict";var o=e("jquery"),r=e("underscore"),t=e("underscore.string"),s=e("bundle!all"),i=e("backbone.marionette"),l=e("backbone.validation"),a=e("logCollectors/model/LogCollectorModel"),n=e("bi/repository/enum/repositoryResourceTypes"),c=e("bi/repository/dialog/resourceChooser/RepositoryChooserDialogFactory"),d=e("text!logCollectors/templates/createLogCollector.htm");return i.ItemView.extend({initialize:function(e){this.options=e||{},this.prepareNewModel()},prepareNewModel:function(){this.unbindValidation(),this.model=new a(r.cloneDeep(a.prototype.defaults),r.extend({},this.options,{parse:!0})),this.reportChooserDialog&&(this.reportChooserDialog.remove(),this.reportChooserDialog=null),this.bindValidation()},render:function(){this.setElement(r.template(d,r.extend({},this.model.attributes,{i18n:s})))},events:{"keyup input[type='text'], input[type='password'], textarea, select":"updateModelProperty","change input[type='text'], input[type='password'], input[type='checkbox'], textarea, select":"updateModelProperty","click button[name=resourceUriBrowseButton]":"onBrowseButtonClick","click button[name=save]":"onSaveButtonClick","click button[name=cancel]":"onCancelButtonClick"},onShow:function(){this.$el.find("[name=name]").focus()},bindValidation:function(){l.bind(this,{valid:this.fieldIsValid,invalid:this.fieldIsInvalid,forceUpdate:!0,selector:"name"})},unbindValidation:function(){l.unbind(this)},fieldIsValid:function(e,o,r){var t=e.$("["+r+"="+o+"]").parent();t.removeClass("error"),t.find(".message.warning").text("")},fieldIsInvalid:function(e,o,r,t){var s=e.$("["+t+"="+o+"]");s.focus();var i=s.parent();i.addClass("error"),i.find(".message.warning").text(r.toString())},updateModelProperty:function(e){var r=o(e.target),t={},s=r.attr("name");t[s]="checkbox"===r.attr("type")?r.is(":checked"):o.trim(r.val()),"userId"===s&&this.fieldIsValid(this,"userId","name"),this.model.set(t),this.model.validate(t)},getReportChooserDialog:function(){if(this.reportChooserDialog)return this.reportChooserDialog;var e=c.getDialog("item");return this.reportChooserDialog=new e({resourcesTypeToSelect:[n.REPORT_UNIT,n.ADHOC_DATA_VIEW]}),this.listenTo(this.reportChooserDialog,"close",function(){var e;if(this.reportChooserDialog.selectedResource){e=this.reportChooserDialog.selectedResource.resourceUri;var o=this.$el.find("[name=resourceUri]").val(e);this.model.set("resourceUri",e),o.trigger("change")}}),this.reportChooserDialog},onBrowseButtonClick:function(){this.getReportChooserDialog().open()},onSaveButtonClick:function(){if(this.model.isValid(!0)){var e=this;this.model.save().done(function(){var o=e.model.toJSON();e.trigger("logCollectorHasBeenCreated",o)}).fail(r.bind(this._saveErrorCallback,this))}},onCancelButtonClick:function(){this.trigger("cancelButtonClick")},_saveErrorCallback:function(e){var o=!1;try{o=JSON.parse(e.responseText)}catch(r){}var i=this;o.errorDescriptor&&(o=o.errorDescriptor);var l="";o&&o.parameters?l=o.parameters[0]:-1!==o.message.indexOf("com.jaspersoft.ji.diagnostic.")&&(l=o.message),l=l.replace("com.jaspersoft.ji.diagnostic.",""),"Verbosity"===l&&(l="verbosity"),("collector"===l||"Name"===l)&&(l="name"),("reportURI"==l||"URI"==l)&&(l="resourceUri");var a="";if("mandatory.parameter.error"===o.errorCode)a=s["logCollectors.form.parameterIsMissing"];else if("illegal.parameter.value.error"===o.errorCode)a="userId"===l?s["logCollectors.form.userNameIsWrong"]:"resourceUri"===l?s["logCollectors.form.resourceNotFound"].replace("{0}",o.parameters[1]):s["logCollectors.form.parameterIsWrong"];else if("resource.already.exists"===o.errorCode)l="name",a=s["logCollectors.form.nameExists"];else if("access.denied"===o.errorCode)a=s["jsp.accessDenied.errorMsg"],l="resourceUri";else if("resource.not.found"===o.errorCode){var n=o.parameters[0];o.parameters[0].length>50&&(n='"'+t.truncate(o.parameters[0],50)+'"'),a=s["logCollectors.form.resourceNotFound"].replace("{0}",n),l="resourceUri"}else"unsupported.resource.type"===o.errorCode?(a=s["logCollectors.form.resourceNotSupported"],l="resourceUri"):"unsupported.olap.based.resource.type"===o.errorCode&&(a=s["logCollectors.form.unsupported.olap.based.resource.type"],l="resourceUri");return l?void this.fieldIsInvalid(i,l,a,"name"):void this._displayErrorPopup(a||!1,o,e)},_displayErrorPopup:function(e,o,r){var t;t=s["logCollectors.form.failedToSave"],e?t+="<br/>"+s["logCollectors.form.theReasonIs"]+": "+e:o[0]&&o[0].errorCode?t+="<br/>"+s["logCollectors.form.theReasonIs"]+": "+o[0].errorCode:o.message&&(t+="<br/>"+s["logCollectors.form.theReasonIs"]+": "+o.message),t+="<br/><br/>"+s["logCollectors.form.fullResponseFromServerIs"]+": "+r.responseText,dialogs.errorPopup.show(t)}})});