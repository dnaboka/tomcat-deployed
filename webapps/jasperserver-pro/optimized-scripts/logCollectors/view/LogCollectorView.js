define(["require","jquery","underscore","bundle!all","backbone","jrs.configs","backbone.validation","common/component/dialog/AlertDialog","logCollectors/enum/collectorStatusEnum","logCollectors/model/LogCollectorModel","common/component/dialog/ConfirmationDialog","text!logCollectors/templates/logCollector.htm"],function(e){"use strict";var t=e("jquery"),o=e("underscore"),n=e("bundle!all"),i=e("backbone"),a=e("jrs.configs"),s=e("backbone.validation"),r=e("common/component/dialog/AlertDialog"),l=e("logCollectors/enum/collectorStatusEnum"),d=e("logCollectors/model/LogCollectorModel"),c=e("common/component/dialog/ConfirmationDialog"),u=e("text!logCollectors/templates/logCollector.htm");return i.View.extend({events:{"keyup input, textarea, select":"updateModelProperty","change input, textarea, select":"updateModelProperty","change [name=verbosity]":"verbosityChange","click [name=stopIcon]":"stopIconClick","click [name=downloadIcon]":"downloadIconClick","click [name=deleteIcon]":"deleteIconClick"},constructor:function(e){var o=t.extend(!0,[],arguments);e=t.extend(!0,{},e),o[0]=e,i.View.apply(this,o)},initialize:function(e){this.options=e,this._updatingModeData={inProgress:!1,timeoutHandler:!1,startTimestamp:0,updateNumber:0,secondsToWaitForShutdown:300},this.model=new d(e.collectorModelFromServer,o.extend({},e,{parse:!0})),s.bind(this,{valid:this.fieldIsValid,invalid:this.fieldIsInvalid,forceUpdate:!0,selector:"name"}),this.listenTo(this.model,"change:verbosity change:status",this.updateUI),this.listenTo(this.model,"change:status",this.statusChange),this.listenTo(this.model,"server_communication_error",this.showServerCommunicationError),this.model.isInShuttingDownMode()&&this._startUpdateProcess()},getErrorDialog:function(){return this.errorDialog?this.errorDialog:this.errorDialog=new r},updateModelProperty:function(e){var o=t(e.target),n={},i=o.attr("realName")||o.attr("name");n[i]="checkbox"===o.attr("type")?o.is(":checked"):t.trim(o.val()),this.model.set(n),this.model.validate(n)},render:function(){return this.setElement(o.template(u,o.extend({},this.model.attributes,{i18n:n,collectorStatusEnum:l}))),this},updateUI:function(e){this.undelegateEvents();var i=o.extend({},this.model.attributes,{i18n:n,collectorStatusEnum:l});e&&(i=o.extend(i,e));var a=t(o.template(u,i));this.$el.find("[name=verbosity]").replaceWith(a.find("[name=verbosity]")),this.$el.find("[name=status]").replaceWith(a.find("[name=status]")),this.$el.find("[name=icons]").children().remove(),this.$el.find("[name=icons]").append(a.find("[name=icons]").children()),this.$el.attr("status",this.model.get("status").toLowerCase()),this.delegateEvents()},fieldIsValid:function(e,t,o){var n=e.$("["+o+'="'+t+'"]').parent();n.removeClass("error"),n.find(".message.warning").text("")},fieldIsInvalid:function(e,t,o,n){if(o!==!0){var i=e.$("["+n+'="'+t+'"]').parent();i.addClass("error"),i.find(".message.warning").text(o)}},verbosityChange:function(){var e=this;this.model.save().fail(function(){e.showServerCommunicationError()})},statusChange:function(){this.trigger("modelStatusChange")},showServerCommunicationError:function(){var e=this.getErrorDialog();e.setMessage(n["logCollectors.alert.server.communication.error"]),e.open()},_startUpdateProcess:function(){this._updatingModeData.inProgress!==!0&&(this._updatingModeData.inProgress=!0,this._updatingModeData.startTimestamp=Math.floor((new Date).getTime()/1e3),this._updatingModeData.updateNumber=0,this._scheduleModelUpdate())},_scheduleModelUpdate:function(){this._updatingModeData.updateNumber++;var e=5;this._updatingModeData.updateNumber<5&&(e=1),this._updatingModeData.timeoutHandler=setTimeout(o.bind(this.updateItsModelFromServer,this),1e3*e)},_stopUpdateProcess:function(){this._updatingModeData.inProgress!==!1&&(clearTimeout(this._updatingModeData.timeoutHandler),this._updatingModeData.timeoutHandler=!1,this._updatingModeData.updateNumber=0,this._updatingModeData.inProgress=!1)},updateItsModelFromServer:function(){this.model.fetch().done(o.bind(function(){if(this.model.isInShuttingDownMode()){var e=Math.floor((new Date).getTime()/1e3);if(e-this._updatingModeData.startTimestamp>this._updatingModeData.secondsToWaitForShutdown)return void this._stopUpdateProcess();this._scheduleModelUpdate()}else this._stopUpdateProcess(),this.trigger("stopped")},this)).fail(o.bind(function(){this._stopUpdateProcess()},this))},stopIconClick:function(){if(this.model.isInRunningMode()){var e=this,t=this.model.sendStopSignal();if(!t)return;this.model.set({status:l.SHUTTING_DOWN}),t.fail(function(){e.showServerCommunicationError()}).done(function(){e._startUpdateProcess()})}},downloadIconClick:function(){if(this.model.isInStoppedMode()){var e=a.contextPath+"/rest_v2/diagnostic/collectors/"+this.model.get("id")+"/content",n=document.createElement("iframe");n.src=e,n.style.display="none",t(n).on("load",o.bind(this._onDownloadIframeLoad,this,n)),t("body").append(n)}},_onDownloadIframeLoad:function(e){if(e.contentWindow||e.contentDocument){var n=(e.contentWindow||e.contentDocument).document,i=!1;n.getElementsByTagName("errorDescriptor").length>0&&(i=!0),t("body > *",n).length>0&&(i=!0),i===!0&&this.showServerCommunicationError()}else setTimeout(function(){o.bind(this._onDownloadIframeLoad,this,e)},1e3)},deleteIconClick:function(){if(!this.model.isInShuttingDownMode()){var e=this,t=n["logCollectors.confirm.deleteOne"].replace("{name}",this.model.get("name")).replace("{newline}","<br><br>"),o=new c({title:n["logCollectors.confirm.title"],text:t});this.listenTo(o,"button:yes",function(){e.model.destroy({dataType:"text"}).done(function(){e.remove(),e.trigger("removed",e.model.get("id"))}).fail(function(){e.showServerCommunicationError()})}),o.open()}}})});