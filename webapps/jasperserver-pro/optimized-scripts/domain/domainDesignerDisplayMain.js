function DragListener(){this.agents=[],this.currentAgentName=null,this.dragger}function Dragger(e,t,i,a,n,r,d){e=e?e:event,this.originalX=[],this.originalY=[],this.draggingObjs=t,this.dragsX=i,this.dragsY=a,this.sigMove=n,this.dragListener=r,this.cleanUpUtil=d,this.dragListener&&(this.dragListener.dragger=this);for(var o=0;o<t.length;o++)this.originalX[o]=parseInt(t[o].style.left),this.originalY[o]=parseInt(t[o].style.top);this.mouseX=e.clientX,this.mouseY=e.clientY,this.isDragging=!1,this.initDragger(e)}var domain={PROPAGATE_EVENT:"propagateEvent",_messages:{},disabledFolderTooltip:"disabledFolderTooltip",attributesPattern:new RegExp("\\s*attribute\\s*\\(\\s*'[^\\/'\\s][^\\/']*'(?:\\s*,\\s*'[^\\/'\\s][^\\/']*')*\\s*\\)\\s*"),getMessage:function(e,t){var i=this._messages[e];return i?new Template(i).evaluate(t?t:{}):""},setMessage:function(e,t){this._messages[e]=t},treeErrorHandler:function(){throw"exception while loading tree"},submitForm:function(e,t,i){if(t){var a=buildActionUrl(t);i&&i(),$(e).writeAttribute("method","post").writeAttribute("action",a),$(e).submit()}},sendAjaxRequest:function(e,t,i,a){var n=buildActionUrl(e),r={postData:Object.toQueryString(t),callback:i,errorHandler:this._serverErrorHandler,mode:AjaxRequester.prototype.EVAL_JSON};a&&Object.extend(r,a),ajaxTargettedUpdate(n,r)},_serverErrorHandler:function(e,t){return baseErrorHandler(e)},elementClicked:function(e,t){return e&&t?matchAny(e,[t],!0):!1},basicClickHandler:function(e,t,i){var a=null;return t.any(function(t){return a=domain.elementClicked(e,t.key),a?(Object.isFunction(t.value)?t.value(a):Object.isFunction(i)&&i(t.value),!0):void 0})},registerClickHandlers:function(e,t,i){if(domain._bodyClickEventHandlers)return void(i?Array.prototype.unshift:Array.prototype.push).apply(domain._bodyClickEventHandlers,e);domain._bodyClickEventHandlers=e;var a=t?t:"body";$$(a)[0].observe(isSupportsTouch()?"touchstart":"click",function(e){var t=e.element();domain._bodyClickEventHandlers&&domain._bodyClickEventHandlers.each(function(i){var a=i(t);if(a)throw a!==domain.PROPAGATE_EVENT&&Event.stop(e),$break})})},enableButton:function(e,t){"string"==typeof e&&(e=$(e)),e.disabled=t,t?buttonManager.enable(e):buttonManager.disable(e)},setOptionsToSelect:function(e,t){return e&&(e.update(""),t)?(t.each(function(t){var i={value:t.value,title:t.label};t.selected&&(i.selected="selected");var a=new Element("option",i);a.appendChild(document.createTextNode(t.label)),e.appendChild(a)}),e):void 0},getDataIslandId:function(e,t){var i=dynamicTree.trees[e.getTreeId()].getRootNode(),a=function n(e,t){return null===e.parent||e.parent===i?e.param.extra[t]:n(e.parent,t)};return a(e,t)},areNodesFromSameIsland:function(e,t){var i=e.any(function(e){return e.param.extra.isConstant});if(i)return!0;var a=1===e.pluck("parent").uniq().length;return a?!0:1===e.map(function(e){return domain.getDataIslandId(e,t||"itemId")}).uniq().length},NumberFormat:function(e,t){var i="."===e,a=new RegExp("["+e.gsub(/\s/,"\\s")+"]+"),n=new RegExp("["+t.gsub(/\s/,"\\s")+"]+"),r=new RegExp("^-|\\"+t+"?\\d+|\\"+t+"$|\\"+e+"+","g");return{toNumber:function(e){return!e||!i&&/[.]/.test(e)?NaN:Number(e.gsub(n,"").gsub(a,"."))||domain.attributesPattern.test(e)},normalizeNumberEntry:function(i){var a=i.strip(),n=a.match(domain.attributesPattern)||a.match(r);if(!n)return"";for(var d=!1,o=0;o<n.length;o++)n[o].startsWith(e)?d?delete n[o]:(n[o]=e,d=!0):n[o].startsWith(t)&&d&&(n[o]=n[o].substring(1));var s=n.join("");return s},isInteger:function(e){return a.test(e)}}},baseValidator:function(e,t){var i=!0,a="";return e()&&(a=t,i=!1),{isValid:i,errorMessage:a}},maxLengthValidator:function(e,t,i){return domain.baseValidator(function(e,t){return e.length>t}.curry(e,t),i)},minLengthValidator:function(e,t,i){return domain.baseValidator(function(e,t){return e.length<t}.curry(e,t),i)},valueNotEmptyValidator:function(e,t){return domain.baseValidator(function(e){return Object.isArray(e)&&0===e.length||!e||!String(e).strip()}.curry(e),t)},stringIdValidator:function(e,t){return domain.baseValidator(function(e){return!/^[^0-9() .,'"=!+-\/><\/\/:][^() .,'"=!+-\/><\/\/:]*$/.test(e)}.curry(e),t)},numberValidator:function(e,t,i){return domain.baseValidator(isNaN.curry(t.toNumber(e)),i)},numberBoundsValidator:function(e,t,i){return domain.baseValidator(function(e,t){return e===1/0||e===-(1/0)?!0:!(e<=t.max&&e>=t.min)}.curry(e,t),i)},rangeValidator:function(e,t,i){return domain.baseValidator(function(e,t){return!(t>e)}.curry(e,t),i)},dateValidator:function(e,t,i){return domain.baseValidator(function(e,t){return 0===getDateFromFormat(t,e)&&!domain.attributesPattern.test(t)}.curry(t,e),i)},unescapeTree:function e(t){t.hasChilds()&&_.each(t.childs,function(t){e(t)}),t.name=xssUtil.unescape(t.name)}};domain.NodeCopyMoveController=function(){},domain.NodeCopyMoveController.addMethod("copy",function(e,t,i){if(e&&e.length>0&&t){var a=dynamicTree.trees[t.getTreeId()],n=e.collect(function(e){var n=e.param.id,r=this._copyParentStructure(e,a);return r?this._mergeToDestTree(r,t,n,i):null}.bind(this));return t.isloaded=!0,n.without(null)}}),domain.NodeCopyMoveController.addMethod("copySelected",function(e,t){return sourceTree&&t?this.copy(sourceTree.selectedNodes,t):void 0}),domain.NodeCopyMoveController.addMethod("move",function(e,t){if(e&&t){var i=this.copy(e,t);return this.hide(e),i}}),domain.NodeCopyMoveController.addMethod("moveSelected",function(e,t){return e&&t?this.move(e.selectedNodes,t):void 0}),domain.NodeCopyMoveController.addMethod("hide",function(e,t,i){if(e&&e.length>0){t||(t=this._getVisibleChildrenCount),i||(i=function(e,t){e.hide(t)});var a=dynamicTree.trees[e[0].getTreeId()];e.collect(function(e){return e.id}).each(function(e){var n=dynamicTree.nodes[e];i(n,!0);for(var r=n.parent;r&&r!=a.getRootNode()&&!(t(r)>0);)i(r,!1),r.refreshStyle(),r=r.parent}.bind(this))}}),domain.NodeCopyMoveController.addMethod("_handleDuplicatedNode",function(e,t){return e.param.id}),domain.NodeCopyMoveController.addMethod("_markAsLoaded",function(e){e.isloaded=!0,e.isParent()&&e.childs.each(function(e){this._markAsLoaded(e)}.bind(this))}),domain.NodeCopyMoveController.addMethod("_mergeToDestTree",function(e,t,i,a){if(t){var n=dynamicTree.trees[t.getTreeId()];if(a)return i=this._handleDuplicatedNode(e,t),n.findNodeById(i,e);var r=n.findNodeChildByMetaName(t,e.param.id);return null!=r?(r.isHidden()&&r.show(),e.hasChilds()&&(r.disabled&&r.enable(e.tooltip),e.childs.each(function(e){this._mergeToDestTree(e,r)}.bind(this))),n.findNodeById(i,r)):(t.addChild(e),this._markAsLoaded(e),n.findNodeById(i,e))}}),domain.NodeCopyMoveController.addMethod("_copyParentStructure",function(e,t){if(e&&t){var i=dynamicTree.trees[e.getTreeId()];if(e.disabled)return null;for(var a=this._copyNode(e,t,!0),n=e.parent,r=null;n&&n!=i.getRootNode();)r=this._copyNode(n,t,!1),r.addChild(a),a=r,n=n.parent;return a}}),domain.NodeCopyMoveController.addMethod("_buildMetanode",function(e){return deepClone(e.param)}),domain.NodeCopyMoveController.addMethod("_copyNode",function(e,t,i){if(e&&t){var a=t.processNode(this._buildMetanode(e));i&&(e.hasChilds()?e.childs.each(function(e){if(!e.disabled){var e=this._copyNode(e,t,i);e&&a.addChild(e)}}.bind(this)):a.setHasChilds(!1));var n=e.childs.findAll(function(e){return e.disabled});return e.childs.length>0&&n.length==e.childs.length?null:a}}),domain.NodeCopyMoveController.addMethod("_delete",function(e){e&&e.collect(function(e){return e.id}).each(function(e){var t=dynamicTree.nodes[e];t&&t.parent.removeChild(t)})}),domain.NodeCopyMoveController.addMethod("_getVisibleChildrenCount",function(e){var t=e.childs.findAll(function(e){return e.isHidden()});return e.childs.length-t.length}),domain.resetTreeSelectionHandler={_COMMON_ELEMENTS_TO_SAVE_SELECTION:["#pageDimmer","#detail","#standardConfirm"],_getTrees:null,_elementIds:null,_callback:null,_validator:null,init:function(e,t,i,a){domain.resetTreeSelectionHandler._init.bind(domain.resetTreeSelectionHandler,e,t,i,a)()},_init:function(e,t,i,a){this._getTrees=t,this._callback=i,this._validator=a,this._elementIds=this._COMMON_ELEMENTS_TO_SAVE_SELECTION.concat(e),domain.registerClickHandlers([this._removeTreeSelectionClickEventHandler.bind(this)],null,!0)},_removeTreeSelectionClickEventHandler:function(e){if(!matchAny(e,this._elementIds,!0)){var t=!1;return this._getTrees().each(function(e){if(e.selectedNodes&&e.selectedNodes.first())throw t=!0,$break}),t?this._validator&&!this._validator()?!0:(this._getTrees().each(function(e){e._deselectAllNodes()}),this._callback&&this._callback(),!1):!1}}},domain.NodeChangeOrderController=function(){},domain.NodeChangeOrderController.addMethod("findNodeWithSpecificOrder",function(e,t,i){for(var a=e.length-1;a>=0;a--)if(e[a].isSelected()==i&&e[a].orderNumber===t)return e[a];return null}),domain.NodeChangeOrderController.addMethod("findMaxSiblingNode",function(e,t,i){var a=null,n=null;return e.each(function(e){e.isSelected()==t&&(null===a||i==e.orderNumber<a)&&(a=e.orderNumber,n=e)}),n}),domain.NodeChangeOrderController.addMethod("moveNode",function(e,t,i,a){var n=e.orderNumber,r=e.parent.childs,d=null,o=null;i?(d=this.findMaxSiblingNode(r,!1,t,e.param.type),o=d?d.orderNumber:-1,r.each(function(i){i.param.id!==e.param.id&&(t==i.orderNumber>o&&t==i.orderNumber<n||i.orderNumber==o)&&(i.orderNumber=t?i.orderNumber+1:i.orderNumber-1,a&&a(i,i.orderNumber))}),a&&a(e,o),e.orderNumber=o):(o=t?e.orderNumber-1:e.orderNumber+1,d=this.findNodeWithSpecificOrder(r,o,!1),d&&(a&&a(e,o),a&&a(d,n),e.orderNumber=o,d.orderNumber=n))}),domain.NodeChangeOrderController.addMethod("nodeAscSorter",function(e,t){return e.orderNumber-t.orderNumber}),domain.NodeChangeOrderController.addMethod("nodeDescSorter",function(e,t){return t.orderNumber-e.orderNumber}),domain.DisplayNodeChangeOrderController=function(){domain.NodeChangeOrderController.call()},domain.DisplayNodeChangeOrderController.prototype=deepClone(domain.NodeChangeOrderController.prototype),domain.DisplayNodeChangeOrderController.addMethod("findMaxSiblingNode",function(e,t,i,a){var n=null,r=null;return e.each(function(e){e.isSelected()==t&&(null!==n&&i!=e.orderNumber<n||(a?e.param.type!==a:0)||(n=e.orderNumber,r=e))}),r}),define("domain.base",["jquery","underscore","backbone","utils.common"],function(e){return function(){var t;return t||e.domain}}(this)),domain.ItemNode=function(e){dynamicTree.TreeNode.call(this,e),this.Types={Folder:new dynamicTree.TreeNode.Type("ItemGroupType"),Leaf:new dynamicTree.TreeNode.Type("ItemType")},this.nodeHeaderTemplateDomId="list_responsive_collapsible_fields:fields",this._hidden=!1,this.disabled=!1},domain.ItemNode.prototype=deepClone(dynamicTree.TreeNode.prototype),domain.ItemNode.addMethod("hide",function(e){if(e&&this.hasChilds())for(var t=0;t<this.getChildCount();t++)this.childs[t].hide(!0);var i=(this.childs.findAll(function(e){return e.disabled}).length,this.childs.findAll(function(e){return e.isHidden()}).length),a=this.childs.length-i;this.disabled||0!==a?this.getType()===this.Types.Leaf&&(this.deselect(),this.disable(domain.getMessage(domain.disabledFolderTooltip))):(this._hidden=!0,this.deselect(),this.refreshStyle())}),domain.ItemNode.addMethod("show",function(){this._hidden=!1,this._getElement()&&this.refreshStyle(this._getElement())}),domain.ItemNode.addMethod("disable",function(e){e&&(this.tooltip=e),this.disabled=!0,this._getElement()&&this.refreshStyle(this._getElement())}),domain.ItemNode.addMethod("enable",function(e){e&&(this.tooltip=e),this.disabled=!1,this._getElement()&&this.refreshStyle(this._getElement())}),domain.ItemNode.addMethod("refreshStyle",function(e){if(e||(e=this._getElement())){dynamicTree.TreeNode.prototype.refreshStyle.call(this,e),this.isHidden()?e.addClassName(layoutModule.HIDDEN_CLASS):e.removeClassName(layoutModule.HIDDEN_CLASS);var t=e.select("p").first();t&&(this.tooltip?t.title=this.tooltip:t.title="",this.disabled?(buttonManager.disable(t),buttonManager.disable(e)):(buttonManager.enable(t),buttonManager.enable(e)))}}),domain.ItemNode.addMethod("isHidden",function(){return this._hidden}),domain.ItemNode.addMethod("toJSON",function(){var e=this.param.extra,t={id:this.param.id,label:this.name,type:this.param.type};return e&&(t.labelId=e.labelId||"",t.descr=e.descr,t.descrId=e.descrId||"",t.dataType=e.dataType||"",t.resourceId=e.resourceId),this.isParent()&&(t.children=_.chain(this.childs).filter(function(e){return!e.isHidden()}).invoke("toJSON").value()),t}),domain.ItemNode.addMethod("hasVisibleChilds",function(){return this.hasChilds()&&!!this.childs.find(function(e){return!e.isHidden()})}),domain.ItemNode.addMethod("hasEnabledChilds",function(){return this.hasChilds()&&!!this.childs.find(function(e){return!e.disabled})}),domain.ItemNode.addMethod("removeChilds",function(){this.hasChilds()&&this.childs.each(function(e){this.removeChild(e)}.bind(this))}),domain.FieldsCopyMoveController=function(){domain.NodeCopyMoveController(this)},domain.FieldsCopyMoveController.prototype=deepClone(domain.NodeCopyMoveController.prototype),domain.FieldsCopyMoveController.addMethod("_buildMetanode",function(e){var t=deepClone(e.param);return t.label=e.name,t.order=e.orderNumber,t.tooltip=e.tooltip,t}),domain.TwoColumnNode=function(e){dynamicTree.TreeNode.call(this,e),this.Types={Folder:new dynamicTree.TreeNode.Type("ItemGroupType",{}),Leaf:new dynamicTree.TreeNode.Type("ItemType",{})},this.nodeHeaderTemplateDomId="list_responsive:twoColumn"},domain.TwoColumnNode.prototype=deepClone(dynamicTree.TreeNode.prototype),domain.TwoColumnNode.addMethod("_createNode",function(){var e=this.id,t=(dynamicTree.trees[this.getTreeId()],this._getHeaderTemplateElement());t.id=this.NODE_ID_PREFIX+e,this.refreshStyle(t),t.treeNode=this;var i=t.childElements()[0];this.tooltip&&(i.title=this.tooltip);var a=i.childElements()[0];a.id=this.HANDLER_ID_PREFIX+e;var n=i.childElements()[1],r=this.param.extra&&this.param.extra.label?this.param.extra.label:this.name;n.insert(xssUtil.escape(r));var d=i.childElements()[2];d.insert(xssUtil.escape(this.name)),this._element=t}),domain.TwoColumnNode.addMethod("_getTitle",function(){var e=this._getElement().childElements()[0].childElements()[2];return e.cleanWhitespace(),0===e.childNodes.length&&e.appendChild(document.createTextNode("")),e.childNodes[0]}),domain.TwoColumnNode.addMethod("toJSON",function(){var e=this.param.extra,t={id:this.param.id,label:this.name,type:this.param.type,order:this.orderNumber.toString()};return e&&(t.labelId=e.labelId||"",t.dataType=e.dataType||"",t.resourceId=e.resourceId),this.isParent()&&(t.children=_.invoke(this.childs,"toJSON")),t}),domain.TwoColumnNode.addMethod("expandAllChilds",function(){var e=dynamicTree.trees[this.getTreeId()];this.isParent()&&!this.isOpen()&&(e.writeStates(this.id,dynamicTree.TreeNode.State.OPEN),this.refreshNode()),this.hasChilds()&&this.childs.each(function(e){e.expandAllChilds()})}),domain.TablesNode=function(e){dynamicTree.TreeNode.call(this,e),this.Types={Folder:new dynamicTree.TreeNode.Type("level"),Leaf:new dynamicTree.TreeNode.Type("item")},this.nodeHeaderTemplateDomId="list_responsive_collapsible_type_tables:tables"},domain.TablesNode.prototype=deepClone(domain.ItemNode.prototype),domain.TablesNode.addMethod("toJSON",function(){var e=this.param.extra,t={id:this.param.id,label:this.name,type:this.param.type};return e&&(t.originalId=e.originalId,t.datasourceId=e.datasourceId,t.repoId=e.repoId,t.itemId=e.itemId,t.dataSource=e.dataSource,t.table=e.table,this.isParent()?(t.query=e.query,t.dataSetType=e.dataSetType):(t.expression=e.expression,t.islandId=e.islandId,t.isConstant=e.isConstant,t.JavaType=e.JavaType,t.JdbcType=e.JdbcType),e.fieldDbName&&(t.fieldDbName=e.fieldDbName)),this.isParent()&&(t.children=_.chain(this.childs).filter(function(e){return!e.isHidden()}).invoke("toJSON").value()),t}),domain.TablesNode.addVar("CONSTANT_TABLE_ID","constant_fields_level"),domain.TablesNode.addVar("CROSSTABLES_FIELDS_TABLE_ID","crossTablesFieldsLevel"),domain.TablesNode.addVar("INVALID_NODE_CLASS","invalid"),domain.TablesNode.addVar("DATA_ISLAND_CLASS","dataIsland"),domain.TablesNode.addVar("DERIVED_TABLE_CLASS","table derived"),domain.TablesNode.addVar("CONSTANT_TABLE_CLASS","table constant"),domain.TablesNode.addVar("CALCULATED_FIELD_CLASS","field calculated"),domain.TablesNode.addMethod("refreshStyle",function(e){(e||(e=this._getElement()))&&(domain.ItemNode.prototype.refreshStyle.call(this,e),this.param.extra&&"true"===this.param.extra.isInvalid?e.addClassName(this.INVALID_NODE_CLASS):e.removeClassName(this.INVALID_NODE_CLASS),this.param.extra&&this.param.extra.expression&&e.addClassName(this.CALCULATED_FIELD_CLASS),this.param.extra&&this.param.extra.query&&e.addClassName(this.DERIVED_TABLE_CLASS),this.param.id===this.CONSTANT_TABLE_ID&&e.addClassName(this.CONSTANT_TABLE_CLASS),this.param.extra&&this.param.extra.isIsland&&e.addClassName(this.DATA_ISLAND_CLASS))}),domain.TablesNode.addMethod("edit",function(e){e&&"dblclick"!==e.type||domain.ItemNode.prototype.edit.call(this,e)}),domain.TablesCustomNode=function(e){domain.TablesNode.call(this,e),this.nodeHeaderTemplateDomId=e.param.type===this.Types.Folder.name?"list_responsive_collapsible_type_tables:tables":"list_responsive_collapsible_type_tables:fields"},domain.TablesCustomNode.prototype=deepClone(domain.TablesNode.prototype),domain.TablesCopyMoveController=function(){domain.NodeCopyMoveController(this)},domain.TablesCopyMoveController.prototype=deepClone(domain.NodeCopyMoveController.prototype),domain.TablesCopyMoveController.addMethod("_buildMetanode",function(e){var t={id:e.param.id,label:e.name,type:e.param.type,uri:e.param.uri};return e.param.extra&&(t.extra={originalId:e.param.extra.originalId,table:e.param.extra.table,itemId:e.param.extra.itemId,datasourceId:e.param.extra.datasourceId,repoId:e.param.extra.repoId,dataSource:e.param.extra.dataSource,dataSetType:e.param.extra.dataSetType,query:e.param.extra.query},e.param.extra.expression&&(t.extra.expression=e.param.extra.expression),e.param.extra.fieldDbName&&(t.extra.fieldDbName=e.param.extra.fieldDbName),e.isParent()||(t.extra.JavaType=e.param.extra.JavaType,t.extra.JdbcType=e.param.extra.JdbcType,t.extra.sourceItem=e.parent.param.extra.originalId)),t}),domain.TablesCopyMoveController.addMethod("_handleDuplicatedNode",function(e,t){if(e.isParent()){for(var i=1,a=e.param.extra.datasourceId+"."+e.param.extra.itemId+i,n=dynamicTree.trees[t.getTreeId()];n.findNodeChildByMetaName(t,a);)i++,a=e.param.extra.datasourceId+"."+e.param.extra.itemId+i;return e.param.id=a,e.param.extra.itemId+=i,e.name=e.param.extra.itemId,e.param.extra.originalId=e.param.extra.itemId,t.addChild(e),e.isloaded=!0,e.hasChilds()&&e.childs.each(function(t){this._handleDuplicatedNode(t,e)}.bind(this)),a}e.param.id=e.parent.param.id+"."+e.param.extra.itemId,e.param.extra.originalId=e.parent.param.extra.originalId+"."+e.param.extra.itemId}),domain.DerivedTablesNode=function(e){domain.TablesNode.call(this,e),e.param.type===this.Types.Folder.name&&e.param.extra&&e.param.extra.query&&(this.isSelectable=!0)},domain.DerivedTablesNode.prototype=deepClone(domain.TablesNode.prototype),domain.JoinsList=function(e,t){dynamicList.List.call(this,e,t)},domain.JoinsList.prototype=deepClone(dynamicList.List.prototype),domain.JoinsList.addMethod("_changeHandler",function(e){var t=this.getItemByEvent(e);t&&(t._respondOnItemEvents&&!e.isInvoked&&this.fire("item:change",{targetEvent:e,item:t}),e.isInvoked=!0)}),domain.JoinsList.addMethod("_initEvents",function(){dynamicList.List.prototype._initEvents.call(this);var e=this._getElement();jQuery(e).off("change").on("change","select",_.bind(this._changeHandler,this))}),domain.JoinsListItem=function(e){dynamicList.ListItem.call(this,e),this._hidden=!1},domain.JoinsListItem.prototype=deepClone(dynamicList.ListItem.prototype),domain.JoinsListItem.addMethod("hide",function(e){this._hidden=!!e,this.refreshStyle()}),domain.JoinsListItem.addMethod("refreshStyle",function(){dynamicList.ListItem.prototype.refreshStyle.call(this),this._getElement()&&(this._hidden?this._getElement().addClassName(layoutModule.HIDDEN_CLASS):this._getElement().removeClassName(layoutModule.HIDDEN_CLASS))}),domain.JoinsListItem.addMethod("processTemplate",function(e){var t=e.childElements()[0];t.cleanWhitespace();var i=t.childElements()[1],a=t.childElements()[2],n=t.childElements()[3],r=n.childElements()[0],d=r.childElements();return i.update(xssUtil.escape(this._value.left.table.label)+":"+xssUtil.escape(this._value.left.label)),a.update(xssUtil.escape(this._value.right.table.label)+":"+xssUtil.escape(this._value.right.label)),d.each(function(e){e.selected=e.value===this._value.type}.bind(this)),e}),domain.JoinsListItem.addMethod("setJoinType",function(e){this.getValue().type=e;var t=this._getElement();if(t){var i=t.childElements()[0].childElements()[3].childElements()[0];$(i).value=e}}),domain.JoinsListItem.addMethod("toJSON",function(){return{left:this._value.left.id,right:this._value.right.id,type:this._value.type}}),domain.DisplayNode=function(e){domain.ItemNode.call(this,e),this.Types={Folder:new dynamicTree.TreeNode.Type("ItemGroupType"),Leaf:new dynamicTree.TreeNode.Type("ItemType")},this.nodeHeaderTemplateDomId="list_responsive_collapsible_type_sets:sets"},domain.DisplayNode.prototype=deepClone(domain.ItemNode.prototype),domain.DisplayNode.addMethod("toJSON",function(){var e=this.param.extra,t={id:this.param.id,type:this.param.type};return e&&(t.itemId=e.itemId,t.descr=e.descr,t.labelId=e.labelId||"",t.descrId=e.descrId||"",t.resourceId=e.resourceId||""),e&&e.label&&(t.label=e.label),this.isParent()?t.children=_.chain(this.childs).filter(function(e){return!e.isHidden()&&!e._markAsDeleted}).invoke("toJSON").value():(t.dataType=e.dataType,t.dimensionOrMeasure=e.dimensionOrMeasure,t.defaultMask=e.defaultMask,t.defaultAgg=e.defaultAgg),t}),domain.DisplayNode.addVar("INVALID_NODE_CLASS","invalid"),domain.DisplayNode.addMethod("refreshStyle",function(e){(e||(e=this._getElement()))&&(domain.ItemNode.prototype.refreshStyle.call(this,e),this.param.extra&&"true"===this.param.extra.isInvalid?e.addClassName(this.INVALID_NODE_CLASS):e.removeClassName(this.INVALID_NODE_CLASS))}),domain.genericTreeParams={rootUri:"/",showRoot:!1,nodeClass:domain.ItemNode,treeClassName:"",multiSelectEnabled:!0},domain.createItemsTree=function(e){return e=Object.extend(deepClone(domain.genericTreeParams),e),new dynamicTree.TreeSupport(e.treeId,e)},domain.confirmDialog={MODE_OK_CANCEL:"okCancel",MODE_YES_NO:"yesNo",_CONFIRM_DIALOG_DOM_ID:"standardConfirm",_CONFIRM_DIALOG_BODY_DOM_PATTERN:"#standardConfirm > .content > .body",_CONFIRM_DIALOG_OK_BUTTON_ID:"#confirmYes",_CONFIRM_DIALOG_CANCEL_BUTTON_ID:"#confirmNo",_CONFIRM_DIALOG_OK_PATTERN:"#confirmYes > span",_CONFIRM_DIALOG_CANCEL_PATTERN:"#confirmNo > span",_yesMessageHolder:null,_noMessageHolder:null,_dialog:null,_onOk:null,_onCancel:null,_customEventHandler:null,_templateDomId:null,_visible:!1,init:function(){domain.confirmDialog._init.bind(domain.confirmDialog)()},show:function(e,t,i,a,n){domain.confirmDialog._show.bind(domain.confirmDialog,e,t,i,a,n)()},hideForDetails:function(){dialogs.popup.hide(domain.confirmDialog._dialog)},showFromDetails:function(){dialogs.popup.show(domain.confirmDialog._dialog,!0)},visible:function(){return domain.confirmDialog._visible},_init:function(){this._dialog=$(this._CONFIRM_DIALOG_DOM_ID),this._yesMessageHolder=$$(this._CONFIRM_DIALOG_OK_PATTERN).first(),this._noMessageHolder=$$(this._CONFIRM_DIALOG_CANCEL_PATTERN).first(),domain.registerClickHandlers([this._clickEventHandler.bind(this)])},_show:function(e,t,i,a,n){this._onOk=t,this._onCancel=i,this._customEventHandler=a,this._templateDomId=e,n&&n==this.MODE_YES_NO?(this._yesMessageHolder.update(domain.getMessage("yes")),this._noMessageHolder.update(domain.getMessage("no"))):(this._yesMessageHolder.update(domain.getMessage("ok")),this._noMessageHolder.update(domain.getMessage("cancel"))),$(this._templateDomId).removeClassName(layoutModule.HIDDEN_CLASS),dialogs.popup.show(this._dialog,!0),this._visible=!0},_hide:function(e){$(this._templateDomId).addClassName(layoutModule.HIDDEN_CLASS),dialogs.popup.hide(this._dialog),this._visible=!1,e&&e()},_clickEventHandler:function(e){return domain.elementClicked(e,this._CONFIRM_DIALOG_OK_BUTTON_ID)?(this._hide(this._onOk),!0):domain.elementClicked(e,this._CONFIRM_DIALOG_CANCEL_BUTTON_ID)?(this._hide(this._onCancel),!0):this._customEventHandler?this._customEventHandler(e):void 0}},domain.detailsDialog={_DETAIL_DIALOG_DOM_ID:"detail",_DETAIL_DIALOG_CLOSE_BUTTON_ID:"#close",_DETAIL_DIALOG_LIST_DOM_ID:"detailsList",_DETAIL_DIALOG_TEXT_DOM_ID:"detailsText",_LIST_TEMPLATE:"defaultListTemplate",_LIST_ITEM_TEMPLATE:"dynamicListItemTemplate",_dialog:null,_showConfirmAfterClose:!1,_list:null,_listItems:null,init:function(){domain.detailsDialog._init.bind(domain.detailsDialog)()},show:function(e){domain.detailsDialog._show.bind(domain.detailsDialog,e)()},_init:function(){this._dialog=$(this._DETAIL_DIALOG_DOM_ID),domain.registerClickHandlers([this._clickEventHandler.bind(this)])},_show:function(e){domain.confirmDialog.visible()?(domain.confirmDialog.hideForDetails(),this._showConfirmAfterClose=!0):this._showConfirmAfterClose=!1,this._createMessage(e),dialogs.popup.show(this._dialog,!0),$(this._DETAIL_DIALOG_LIST_DOM_ID).parentNode.scrollTop=0},_createMessage:function(e){"string"==typeof e?($(this._DETAIL_DIALOG_LIST_DOM_ID).addClassName(layoutModule.HIDDEN_CLASS),$(this._DETAIL_DIALOG_TEXT_DOM_ID).removeClassName(layoutModule.HIDDEN_CLASS).update(e)):($(this._DETAIL_DIALOG_TEXT_DOM_ID).addClassName(layoutModule.HIDDEN_CLASS),$(this._DETAIL_DIALOG_LIST_DOM_ID).removeClassName(layoutModule.HIDDEN_CLASS),this._items&&(this._list.removeItems(this._items),this._items=null,this._list=null),this._items=e.collect(function(e){return new dynamicList.ListItem({label:e})}),this._list=new dynamicList.List(this._DETAIL_DIALOG_LIST_DOM_ID,{listTemplateDomId:this._LIST_TEMPLATE,itemTemplateDomId:this._LIST_ITEM_TEMPLATE,items:this._items}),this._list.show())},_close:function(){dialogs.popup.hide(this._dialog),this._showConfirmAfterClose&&domain.confirmDialog.showFromDetails()},_clickEventHandler:function(e){return domain.elementClicked(e,this._DETAIL_DIALOG_CLOSE_BUTTON_ID)?(this._close(),!0):void 0}},define("domain.components",["domain.base","dynamicTree.utils","components.list"],function(e){return function(){var t;return t||e.domain}}(this));var toolbarButtonModule={UP:"up",DOWN:"down",OVER:"over",DISABLED:"disabled",PRESSED:"pressed",CONTENT_PREFIX:"toolbar_",MenuClass:"menu vertical dropDown",TOOLBAR_MENU_CLASS:"menu vertical dropDown fitable",ACTION_MODEL_TAG:"adhocActionModel",CAPSULE_PATTERN:"capsule",showButtonMenu:function(e,t){t=jQuery(t);var i=this.CONTENT_PREFIX+t.attr("id"),a="adhocActionModel"==this.ACTION_MODEL_TAG?this.actionModel:this.ACTION_MODEL_TAG;actionModel.showDropDownMenu(e,t,i,this.TOOLBAR_MENU_CLASS,a)},setActionModel:function(e){this.actionModel=e},isToolBarButton:function(e){return e?jQuery(e).hasClass("capsule"):!1},enable:function(e,t){buttonManager.enable(e)},disable:function(e){buttonManager.disable(e)},setButtonState:function(e,t){t?this.enable(e):this.disable(e)}};define("components.toolbarButtons",["jquery","prototype"],function(e){return function(){var t;return t||e.toolbarButtonModule}}(this)),toolbarButtonModule.initialize=function(e){toolbarButtonModule.actionMap=e,jQuery(".toolbar").on("mouseup mouseover mouseout","button",function(e){jQuery(this).prop("disabled")||toolbarButtonModule["mouse"+e.type.substring(5,6).toUpperCase()+e.type.substring(6)+"Handler"](e,this)}),isFirefox()&&jQuery(".toolbar li").each(function(e,t){jQuery(t).css("padding","0 2px")})},toolbarButtonModule.mouseUpHandler=function(e,t){var i=t.className.indexOf("capsule")>=0?toolbarButtonModule.actionMap[t.id]:null;if(i){var a=getAsFunction(i);a(e),e.stopPropagation()}},toolbarButtonModule.mouseOverHandler=function(e,t){t.className.indexOf("capsule")>=0&&t.className.indexOf("mutton")>=0&&!buttonManager.isDisabled(t)&&toolbarButtonModule.showButtonMenu(e.originalEvent,t)},toolbarButtonModule.mouseOutHandler=function(e,t){},define("components.toolbar",["jquery","prototype","utils.common","components.toolbarButtons"],function(e){return function(){var t;return t||e.toolbarButtonModule}}(this)),define("text!domain/template/domainUsedResourcesTemplate.htm",[],function(){return"<table class='usedResources'>\n    <thead>\n        <tr>\n            <th>{{- fieldLabel }}</th>\n            <th>{{- resourceLabel }}</th>\n        </tr>\n    </thead>\n    <tbody>\n        {{ _.each(usedResources, function(usedResource, index) { }}\n        <tr>\n            <td>{{- usedResource.field }}</td>\n            <td><a target='_blank' href='{{- contextPath }}/flow.html?_flowId=adhocFlow&resource={{- encodeURIComponent(usedResource.resource) }}'>{{- usedResource.resource }}</a></td>\n        </tr>\n        {{ }); }}\n    </tbody>\n</table>"}),define("domain/domainUtil",["require","underscore","jrs.configs","text!./template/domainUsedResourcesTemplate.htm"],function(e){"use strict";function t(e){return new RegExp(e.replace(".","\\.").replace("]","\\]").replace("[","\\[").replace("{0}","(\\S+)").replace("{1}","(\\S+)"),"g")}var i=e("underscore"),a=e("jrs.configs"),n=i.template(e("text!./template/domainUsedResourcesTemplate.htm"));return window.domainUtil={getUsedResourcesList:function(e,i){for(var a,n=t(i),r=[];a=n.exec(e);)r.push({field:a[1],resource:a[2]});return r},indexOfNoAccessMessage:function(e,t){return e.indexOf(t)},getUsedResourcesFormattedMessage:function(e,t,i){if(!e.length)return t;var r=i.ITEM_BEING_USED_BY_RESOURCE.split("{0}")[0],d=t.split(r)[0],o=d+n({contextPath:a.contextPath,usedResources:e,resourceLabel:i["resource.label"],fieldLabel:i["field.label"]});return this.indexOfNoAccessMessage(t,i.resourcesWithNoAccess)>-1&&(o+="<br/>"+i.resourcesWithNoAccess),o}},window.domainUtil}),domain.designer={FLOW_ID:"domainDesignerFlow",CREATE_DS_FLOW:"createSLDatasourceFlow",TABLES_VIEW:"domainDesigner_tables",DERIVED_TABLES_VIEW:"domainDesigner_derivedTables",JOINS_VIEW:"domainDesigner_joins",CALC_FIELDS_VIEW:"domainDesigner_calculatedFields",FILTERS_VIEW:"domainDesigner_filters",DISPLAY_VIEW:"domainDesigner_display",ACTION_MODEL_TAG:"domainDesignerActionModel",TREE_DRAG_PATTERN:".draggable",ITEM_KEY_BLACKLIST_REGEX_PATTERN:/[-+='"!#$%^&,<> %:;?{}@()|\*\[\]\/\\]/,ITEM_ID_BLACKLIST_REGEX_PATTERN:/[-+='"!%^&<> %.:;?{}()|\*\[\]\/\\]/,formDomId:"stepDisplayForm",currentPage:null,flowExecutionKey:null,hasSchemas:!1,presentationSelected:!1,unsavedChangesPresent:!1,derivedTableQueryRegex:/^\s*select\s+([^\s]+(\s+|$)){3,}|^\s*\{\s*attribute\s*\('.+'\)\s*\}\s*$/gi,initialize:function(){webHelpModule.setCurrentContext("domain");var e=localContext.domainInitOptions;this.flowExecutionKey=e.flowExecutionKey,this.unsavedChangesPresent=e.unsavedChangesPresent,this.allowDesignerCloseWithValidationErrors=e.allowDesignerCloseWithValidationErrors;var t=e.dataSourceId;if(!t&&e.dataSourcesList&&e.dataSourcesList.first()&&(t=e.dataSourcesList.first().id),!t)return void this.redirectToCreateDomain();this.presentationSelected=e.presentationSelected;var i=e.datasourcesProperties[t]?e.datasourcesProperties[t].schemas:null;this.hasSchemas=i&&i.first(),domain.registerClickHandlers([this.flowControlsClickEventHandler.bind(this),this.stopEventForToolbarButtonsClickEventHandler.bind(this)]),domain.confirmDialog.init(),domain.detailsDialog.init(),this.currentPage=document.body.identify();var a=this.pageInitFactory[this.currentPage]();this.initModule(a,e)},initModule:function(e,t){e&&(e.fillForm&&(dd.fillForm=e.fillForm.bind(e)),e.getValidationPostData&&(dd.getValidationPostData=e.getValidationPostData.bind(e)),e.getCheckDesignValidator&&(dd.getCheckDesignValidator=e.getCheckDesignValidator.bind(e)),e.exportEnabled&&(dd.exportEnabled=e.exportEnabled.bind(e)),e.exportBundleStub&&(dd.exportBundleStub=e.exportBundleStub.bind(e)),
dd.initToolbar(e.toolbarActionMap),e.init.bind(e)(t))},initToolbar:function(e){this.toolbarActionMap=Object.extend(this.toolbarActionMap,e),toolbarButtonModule.ACTION_MODEL_TAG=this.ACTION_MODEL_TAG,toolbarButtonModule.initialize(this.toolbarActionMap)},redirectToCreateDomain:function(){document.location=buildActionUrl({flowId:this.CREATE_DS_FLOW})},fillForm:function(){},getValidationPostData:function(){return{}},getCheckDesignValidator:function(){return dd.checkDesignValidator},flowControlsClickEventHandler:function(e){var t=!1;return this.flowControlsEventMap.each(function(i){if(domain.elementClicked(e,i.key)){var a=i.value;if(t=!0,this.currentPage===a.returnOnPage)throw $break;a.flowExecutionKey=this.flowExecutionKey;var n=function(){delete a.returnOnPage,delete a.performValidation,a.flowId=this.FLOW_ID,domain.submitForm(this.formDomId,a,this.fillForm)},r="#done"===i.key&&this.allowDesignerCloseWithValidationErrors;throw a.performValidation?this.getCheckDesignValidator().validate(r,n.bind(this)):n.bind(this)(),$break}}.bind(this)),t},stopEventForToolbarButtonsClickEventHandler:function(e){var t=!1;return $H(this.toolbarActionMap).each(function(i){if(domain.elementClicked(e,"#"+i.key))throw t=!0,$break}.bind(this)),t},checkDesign:function(e,t){var i={flowExecutionKey:this.flowExecutionKey,eventId:"validateSchema"};domain.sendAjaxRequest(i,this.getValidationPostData(),e,t)},checkForEmptySets:function(e){var t={flowExecutionKey:this.flowExecutionKey,eventId:"checkForEmptySets"};domain.sendAjaxRequest(t,{},e)},deleteEmptySets:function(e,t){var i={flowExecutionKey:this.flowExecutionKey,eventId:"deleteEmptySets"},a={emptySets:Object.toJSON(e)};domain.sendAjaxRequest(i,a,t)},exportToXml:function(e){var t={flowExecutionKey:this.flowExecutionKey,eventId:"exportToXML"};this.hasSchemas&&(t.exportSchemaPrefix=!!e),domain.submitForm(this.formDomId,t,null)},generateAndDownloadBundles:function(e,t,i,a){var n={flowExecutionKey:this.flowExecutionKey,eventId:"bundle"},r={generateDescrKey:!!e,generateLabelKey:!!t},d=function(e){"success"===e&&(i&&a?a.done(this.downloadBundleStubs.bind(this)):this.downloadBundleStubs(),i&&i())};domain.sendAjaxRequest(n,r,d.bind(this))},downloadBundleStubs:function(){var e={flowExecutionKey:this.flowExecutionKey,eventId:"downloadBundleStubs"};domain.submitForm(this.formDomId,e,null)},validateForCalcFields:function(e,t,i){var a={flowExecutionKey:this.flowExecutionKey,eventId:"validateDeletedTablesForCalcFields"},n={deletedTablesIds:e,isRealTables:t};domain.sendAjaxRequest(a,n,i)},changeTableAlias:function(e,t,i){var a={};a[e]=t;var n={flowExecutionKey:dd.flowExecutionKey,eventId:"changeTableAlias"},r={aliasChangesMap:Object.toJSON(a)};domain.sendAjaxRequest(n,r,i)},createTreeNodesMap:function(e){var t=function(e,i){e&&(i[e.param.id]=e,e.isParent()&&e.childs.each(function(e){t(e,i)}))};e.treeMap={},e.getRootNode().childs.each(function(i){t(i,e.treeMap)})},deleteNodesFromTreeById:function(e,t,i){if(e&&e.first()){var a=function(e){return e.childs.length},n=function(e){return e.parent.removeChild(e)},r=function(e){delete t.treeMap[e.param.id],e.isParent()&&e.childs.each(r)};e.each(function(e){var d=t.treeMap[e];d&&(i.hide([d],a,n),r(d))}.bind(this))}},getTablesUsedForFilters:function(e,t){if(!t.first())return[];var i=t.findAll(function(t){if(!e)return!1;var i=t.param.extra.itemId;return e&&e[i]&&e[i].itemId===i});return i.collect(function(e){return e.param.extra.itemId})},insertAtCaret:function(e,t,i){if(document.selection){if(i||(i=document.selection.createRange()),i.parentElement()!=e)return e.value+=t,!1;e.focus(),i.text=t,i.collapse(!1),i.select()}else if(Object.isNumber(e.selectionStart)&&e.selectionStart>=0){var a=e.getValue(),n=e.selectionStart,r=e.selectionEnd;e.setValue(a.substr(0,n)+t+a.substr(r)),e.focus(),e.setSelectionRange(n,n+t.length)}else e.value+=t},emptyValidator:function(e){return{isValid:e&&e.strip(),errorMessage:domain.getMessage("field.empty")}},itemKeyValidator:function(e,t){return{isValid:!t||null==t.match(dd.ITEM_KEY_BLACKLIST_REGEX_PATTERN),errorMessage:domain.getMessage(e)}},itemIdValidator:function(e,t){return{isValid:!t||null==t.match(dd.ITEM_ID_BLACKLIST_REGEX_PATTERN),errorMessage:domain.getMessage(e?e:"id.invalid")}},itemIdNotStartFromNumberValidator:function(e){return{isValid:!e||null==e.match(/^[0-9]/),errorMessage:domain.getMessage("id.startFromNumber")}},escapeJsonValidator:function(e){return{isValid:!e||!e.match(/[\?]+/g),errorMessage:domain.getMessage("field.invalid")}}};var dd=domain.designer;dd.confirmAndLeave=function(){return dd.isUnsavedChangesPresent()?confirm(domain.getMessage("exitMessage")):!0},dd.setUnsavedChangesPresent=function(e){dd.unsavedChangesPresent=!!e},dd.isUnsavedChangesPresent=function(){return dd.unsavedChangesPresent},dd.toolbarActionMap={checkDesign:"dd.validateDesign",exportSchema:"dd.exportSchema",exportBundleStub:"dd.exportBundleStub"},dd.toolbarEnableMap={exportSchema:function(){return dd.exportEnabled()},exportBundleStub:function(){return dd.exportEnabled()}},dd.updateToolBarButtons=function(){$H(dd.toolbarEnableMap).each(function(e){toolbarButtonModule.setButtonState(e.key,e.value())})},dd.exportSchema=function(){dd.exportSchemaValidator.validate(dd.exportToXml.bind(dd))},dd.isPresentationSelected=function(){return dd.presentationSelected},dd.exportBundleStub=function(){dd.exportBundlesValidator.validate(dd.generateAndDownloadBundles.bind(dd))},dd.exportEnabled=function(){return dd.presentationSelected},dd.validateDesign=function(){dd.getCheckDesignValidator().validate(!1)},dd.pageInitFactory={domainDesigner_tables:function(){return dd_tables},domainDesigner_derivedTables:function(){return dd_derivedTables},domainDesigner_joins:function(){return dd_joins},domainDesigner_calculatedFields:function(){return dd_calcFields},domainDesigner_filters:function(){return dd_filters},domainDesigner_display:function(){return dd_display}},dd.flowControlsEventMap=$H({"#tablesTab":{returnOnPage:dd.TABLES_VIEW,eventId:"tables"},"#derivedTablesTab":{returnOnPage:dd.DERIVED_TABLES_VIEW,eventId:"query"},"#joinsTab":{returnOnPage:dd.JOINS_VIEW,eventId:"joins"},"#calcFieldsTab":{returnOnPage:dd.CALC_FIELDS_VIEW,eventId:"calcFields"},"#preFiltersTab":{returnOnPage:dd.FILTERS_VIEW,eventId:"filters"},"#displayTab":{returnOnPage:dd.DISPLAY_VIEW,eventId:"design"},"#done":{eventId:"done",performValidation:!0},"#cancelButton":{eventId:"cancel"}}),define("domain.designer",["domain.components","components.toolbar","domain/domainUtil"],function(e){return function(){var t;return t||e.dd}}(this)),dd.checkDesignValidator={_INVALID_DESIGN_TEMPLATE_DOM_ID:"invalidDesignConfirmMessage",_INVALID_DESIGN_LINK_ID:"#designDetails",_DONE_BUTTON_ID:"done",_callback:null,_errorMessage:null,_showConfirmation:null,validate:function(e,t){dd.checkDesignValidator._validate.bind(dd.checkDesignValidator,e,t)()},_validate:function(e,t){this._callback=t,this._showConfirmation=e,dd.emptySetsValidator.validate(this._emptySetsCallback.bind(this))},_emptySetsCallback:function(e){"empty"===e&&domain.enableButton(this._DONE_BUTTON_ID,!1),dd.checkDesign.bind(dd,this._checkDesignCallback.bind(this))()},_checkDesignCallback:function(e){if("success"===e)this._callback?this._callback():dialogs.systemConfirm.show(domain.getMessage("designIsValid"));else{this._errorMessage=e.errorMessage;var t=domainUtil.getUsedResourcesList(e.errorMessage,domain._messages.ITEM_BEING_USED_BY_RESOURCE),i=t.length||domainUtil.indexOfNoAccessMessage(e.errorMessage,domain._messages.resourcesWithNoAccess)>-1?domainUtil.getUsedResourcesFormattedMessage(t,e.errorMessage,{"resource.label":domain._messages["resource.label"],"field.label":domain._messages["field.label"],ITEM_BEING_USED_BY_RESOURCE:domain._messages.ITEM_BEING_USED_BY_RESOURCE,resourcesWithNoAccess:domain._messages.resourcesWithNoAccess}):this._errorMessage;this._showConfirmation&&(t.length||domainUtil.indexOfNoAccessMessage(e.errorMessage,domain._messages.resourcesWithNoAccess)>-1)?domain.confirmDialog.show(this._INVALID_DESIGN_TEMPLATE_DOM_ID,this._onOk.bind(this),this._onCancel.bind(this),_.bind(function(e){this._showAffectedResources(e,i)},this),domain.confirmDialog.MODE_YES_NO):domain.detailsDialog.show(i)}},_onOk:function(){this._callback&&this._callback()},_onCancel:function(){},_showAffectedResources:function(e,t){return domain.elementClicked(e,this._INVALID_DESIGN_LINK_ID)?(domain.detailsDialog.show(t),!0):void 0}},dd.emptySetsValidator={_EMPTY_SETS_TEMPLATE_DOM_ID:"emptySetsConfirmMessage",_EMPTY_SETS_LINK_ID:"#emptySetsDetails",_callback:null,_emptySets:null,validate:function(e){dd.emptySetsValidator._validate.bind(dd.emptySetsValidator,e)()},_validate:function(e){this._callback=e,dd.checkForEmptySets.bind(dd,this._checkCallback.bind(this))()},_checkCallback:function(e){e&&e.first()?(this._emptySets=e,domain.confirmDialog.show(this._EMPTY_SETS_TEMPLATE_DOM_ID,this._onOk.bind(this),this._onCancel.bind(this),this._showAffectedResources.bind(this))):this._callback&&this._callback()},_onOk:function(){dd.deleteEmptySets.bind(dd,this._emptySets,this._callback)()},_onCancel:function(){this._callback&&this._callback()},_showAffectedResources:function(e){return domain.elementClicked(e,this._EMPTY_SETS_LINK_ID)?(domain.detailsDialog.show(this._emptySets),!0):void 0}},dd.exportSchemaValidator={_EXPORT_SCHEMA_PREFIXES_TEMPLATE_DOM_ID:"exportSchemaPrefixesConfirmMessage",_callback:null,validate:function(e){dd.exportSchemaValidator._validate.bind(dd.exportSchemaValidator,e)()},_validate:function(e){this._callback=e,dd.getCheckDesignValidator().validate(!0,this._checkDesignValidatorCallback.bind(this))},_checkDesignValidatorCallback:function(){dd.hasSchemas?domain.confirmDialog.show(this._EXPORT_SCHEMA_PREFIXES_TEMPLATE_DOM_ID,this._onOk.bind(this),this._onCancel.bind(this),null,domain.confirmDialog.MODE_YES_NO):this._callback&&this._callback()},_onOk:function(){this._callback&&this._callback(!0)},_onCancel:function(){this._callback&&this._callback(!1)}},dd.exportBundlesValidator={_EXPORT_BUNDLES_TEMPLATE_DOM_ID:"exportBundlesConfirmMessage",_GENERATE_LABEL_KEYS_PATTERN:"#autoGenerateLabelKeys",_GENERATE_LABEL_KEYS_ID:"generateLabelKeys",_GENERATE_DESCR_KEYS_PATTENR:"#autoGenerateDescriptionKeys",_GENERATE_DESCR_KEYS_ID:"generateDescriptionKeys",_callback:null,_generateLabelKeys:!1,_generateDescrKeys:!1,validate:function(e){dd.exportBundlesValidator._validate.bind(dd.exportBundlesValidator,e)()},_validate:function(e){this._callback=e,dd.getCheckDesignValidator().validate(!0,this._checkDesignValidatorCallback.bind(this))},_checkDesignValidatorCallback:function(){domain.confirmDialog.show(this._EXPORT_BUNDLES_TEMPLATE_DOM_ID,this._onOk.bind(this),this._onCancel.bind(this),this._handleCheckBoxes.bind(this))},_onOk:function(){this._callback&&this._callback(this._generateDescrKeys,this._generateLabelKeys)},_onCancel:function(){},_handleCheckBoxes:function(e){return matchMeOrUp($(e),this._GENERATE_LABEL_KEYS_PATTERN)?(this._generateLabelKeys=$F(this._GENERATE_LABEL_KEYS_ID),domain.PROPAGATE_EVENT):matchMeOrUp($(e),this._GENERATE_DESCR_KEYS_PATTENR)?(this._generateDescrKeys=$F(this._GENERATE_DESCR_KEYS_ID),domain.PROPAGATE_EVENT):void 0}},dd.deleteCalcFieldsValidator={_DELETE_CALCFIELDS_TEMPLATE_ID:"calcFieldsConfirmMessage",_CALC_FIELDS_DETAILS_LINK_ID:"#calcFieldsDetails",_involvedFieldsIds:null,_involvedFieldsExpressionIds:null,_nodes:null,_callback:null,_validateForCalcFields:null,init:function(e){dd.deleteCalcFieldsValidator._init.bind(dd.deleteCalcFieldsValidator,e)()},validate:function(e,t,i){dd.deleteCalcFieldsValidator._validate.bind(dd.deleteCalcFieldsValidator,e,t,i)()},_init:function(e){this._validateForCalcFields=e},_validate:function(e,t,i){this._nodes=e,this._callback=i;var a=Object.toJSON(e.collect(function(e){return e.param.extra.datasourceId+"."+e.param.extra.itemId}));this._validateForCalcFields(a,t,this._validationCallback.bind(this))},_validationCallback:function(e){this._involvedFieldsIds=[],this._involvedFieldsExpressionIds=[],"success"===e?this._onOk():(this._involvedFieldsIds=e.involvedFieldsIds,this._involvedFieldsExpressionIds=e.involvedFieldsExpressionIds,domain.confirmDialog.show(this._DELETE_CALCFIELDS_TEMPLATE_ID,this._onOk.bind(this),this._onCancel.bind(this),this._showAffectedResources.bind(this)))},_onOk:function(){this._callback&&this._callback(this._involvedFieldsIds,this._involvedFieldsExpressionIds)},_onCancel:function(){},_showAffectedResources:function(e){return domain.elementClicked(e,this._CALC_FIELDS_DETAILS_LINK_ID)?(domain.detailsDialog.show(this._involvedFieldsExpressionIds),!0):void 0}},dd.deleteFiltersValidator={_DELETE_FILTERS_TEMPLATE_ID:"deleteFiltersConfirmMessage",_FILTER_DETAILS_LINK_ID:"#filtersDetails",_tablesAffectedInFilters:null,_nodes:null,_callback:null,_getTablesUsedForFilters:null,init:function(e){dd.deleteFiltersValidator._init.bind(dd.deleteFiltersValidator,e)()},validate:function(e,t){dd.deleteFiltersValidator._validate.bind(dd.deleteFiltersValidator,e,t)()},_init:function(e){this._getTablesUsedForFilters=e},_validate:function(e,t){this._callback=t,this._tablesAffectedInFilters=this._getTablesUsedForFilters(e),this._tablesAffectedInFilters.first()?domain.confirmDialog.show(this._DELETE_FILTERS_TEMPLATE_ID,this._onOk.bind(this),this._onCancel.bind(this),this._showAffectedResources.bind(this)):this._onOk()},_onOk:function(){this._callback&&this._callback()},_onCancel:function(){},_showAffectedResources:function(e){return domain.elementClicked(e,this._FILTER_DETAILS_LINK_ID)?(domain.detailsDialog.show(this._tablesAffectedInFilters),!0):void 0}},dd.calcFieldsAndFiltersValidator={init:function(e,t){dd.deleteCalcFieldsValidator.init(e),dd.deleteFiltersValidator.init(t)},validate:function(e,t,i){dd.deleteCalcFieldsValidator.validate(e,t,dd.calcFieldsAndFiltersValidator._deleteCalcFieldsCallback.bind(dd.calcFieldsAndFiltersValidator,i,e))},_deleteCalcFieldsCallback:function(e,t,i,a){dd.deleteFiltersValidator.validate(t,this._deleteFiltersCallback.bind(this,e,i,a))},_deleteFiltersCallback:function(e,t,i){e&&e(t,i)}},define("domain.designer.validators",["domain.designer"],function(e){return function(){var t;return t||e.dd}}(this)),dd.display={PAGE:"design",LEFT_TREE_TEMPLATE_DOM_ID:"list_responsive_collapsible_type_tables",RIGHT_TREE_TEMPLATE_DOM_ID:"list_responsive_collapsible_type_sets",TREE_DRAG_PATTERN:".draggable",JOINS_TREE_ID:"joinsTree",TABLES_TREE_ID:"tablesTree",VIEW_TREE_ID:"viewTree",JOINS_TREE_DATA_PROVIDER:"joinTreeDataProvider",TABLES_TREE_DATA_PROVIDER:"selectedTreeDataProvider",VIEW_TREE_DATA_PROVIDER:"selectedViewTreeDataProvider",RESOURCE_VIEW_MODES:{JOIN_TREE:"joinTree",TABLES_TREE:"tablesTree"},TAB_JOIN_TREE_VIEW_ID:"joinTreeView",TAB_TABLES_LIST_VIEW_ID:"tableListView",ADD_ITEM_ID:"add",ADD_ITEM_TO_SET_ID:"addToSet",DELETE_ITEM_ID:"deleteItem",DELETE_TABLE_ID:"deleteTable",NEW_SET_ID:"newSet",MOVE_TO_TOP_ID:"toTop",MOVE_UPWARD_ID:"upward",MOVE_TO_BOTTOM_ID:"toBottom",MOVE_DOWNWARD_ID:"downward",DONE_BUTTON_ID:"done",DEFAULT_SET_ID:"newSet",CREATE_NEW_SET_ID:"#newSet",RESOURCES_CONTAILNER_ID:"resourcesBody",SETS_CONTAILNER_ID:"setsAndItemsBody",DOM_ID_TO_SAVE_SELECTED_NODES:["#add","#addToSet","#deleteTable","#newSet","#deleteItem","#toTop","#upward","#downward","#toBottom","#joinTreeView","#tableListView","#properties","#joinsTree","#tablesTree","#viewTree"],joinsTree:null,tablesTree:null,viewTree:null,copyMoveController:new domain.NodeCopyMoveController,resourceViewMode:null,dontWarnOfDeleteItems:!0,islands:null,joinTreeModel:null,usedTablesByItemId:null,dataSourceId:null,designerMode:null,changeOrderController:new domain.DisplayNodeChangeOrderController,getCheckDesignValidator:function(){return this.checkDesignValidator},getValidationPostData:function(){return{page:this.PAGE,selectedModel:this.getTreeModel(this.tablesTree),islands:Object.toJSON(this.islands),selectedView:this.getTreeModel(this.viewTree)}},getTreeModel:function(e){for(var t=e.getRootNode().childs,i=[],a=0;a<t.length;a++)t[a]._markAsDeleted!==!0&&(domain.unescapeTree(t[a]),i.push(t[a]));return Object.toJSON(i)},fillForm:function(){$("islands").writeAttribute("value",Object.toJSON(this.islands)),$("selectedView").writeAttribute("value",this.getTreeModel(this.viewTree)),$("dontWarnOfDeleteItems").writeAttribute("value",this.dontWarnOfDeleteItems),$("selectedModel").writeAttribute("value",this.getTreeModel(this.tablesTree)),$("unsavedChangesPresent").writeAttribute("value",dd.isUnsavedChangesPresent().toString())},exportEnabled:function(){return this.viewTree&&this.viewTree.getRootNode()&&!!this.viewTree.getRootNode().childs.first()},exportBundleStub:function(){var e=jQuery.Deferred(),t=function(){e.resolve(),this.viewTreeLoadCallback()}.bind(this),i=function(){this.viewTree.showTree(100,t,domain.treeErrorHandler)}.bind(this),a=function(t,a){dd.generateAndDownloadBundles.bind(dd)(t,a,i,e)};dd.exportBundlesValidator.validate(a)},initFromOptions:function(e){this.joinTreeModel=e.joinTreeModel,this.designerMode=e.designerMode,this.usedTablesByItemId=e.usedTablesByItemId,this.dataSourceId=e.dataSourceId},init:function(e){this.initFromOptions(e),dd.calcFieldsAndFiltersValidator.init(dd.validateForCalcFields.bind(dd),dd.getTablesUsedForFilters.bind(dd,this.usedTablesByItemId[this.dataSourceId])),domain.resetTreeSelectionHandler.init(this.DOM_ID_TO_SAVE_SELECTED_NODES,function(){return[this.tablesTree,this.viewTree,this.joinsTree]}.bind(this),this.updateButtonsState.bind(this),this.deselectNodesValidator.bind(this)),domain.registerClickHandlers([this.changeResourceViewModeClickHandler.bind(this),this.moveButtonsClickEventHandler.bind(this),this.createNewSetClickEventHandler.bind(this),this.addDeleteItemsClickEventHandler.bind(this)]),dd_display.deleteViewItemValidator.init(this.designerMode,this.isDontWarnOfDeleteItems.bind(this),this.setDontWarnOfDeleteItems.bind(this),this.buildCompositeIdentifier),dd_display.addViewItemsValidator.init(domain.getDataIslandId),dd_display.checkDesignValidator.init(this.refreshViewTreeStyle.bind(this)),dd_display.emptySetsValidator.init(this.getViewTree.bind(this),this.copyMoveController),this.propertiesEditor.init(e.defaultMasks,e.typesMap),this.initTrees(),propsEditor.hide()},initTrees:function(){this.tablesTree=domain.createItemsTree({treeId:this.TABLES_TREE_ID,providerId:this.TABLES_TREE_DATA_PROVIDER,templateDomId:this.LEFT_TREE_TEMPLATE_DOM_ID,nodeClass:domain.TablesNode}),this.joinsTree=domain.createItemsTree({treeId:this.JOINS_TREE_ID,providerId:this.JOINS_TREE_DATA_PROVIDER,templateDomId:this.LEFT_TREE_TEMPLATE_DOM_ID,dragPattern:dd.TREE_DRAG_PATTERN,nodeClass:domain.TablesNode,selectOnMousedown:!0}),this.viewTree=domain.createItemsTree({treeId:this.VIEW_TREE_ID,providerId:this.VIEW_TREE_DATA_PROVIDER,templateDomId:this.RIGHT_TREE_TEMPLATE_DOM_ID,dragPattern:dd.TREE_DRAG_PATTERN,nodeClass:domain.DisplayNode,selectOnMousedown:!0}),this.viewTree.createDraggableIfNeeded=function(e,t){this._overNode=t,dynamicTree.Tree.prototype.createDraggableIfNeeded.call(this,e,t)},this.viewTree.sorters=[this.sortByType,this.viewTree.sortByOrder,this.viewTree.sortByName],$H(this.treeEventFactory).each(function(e){[this.tablesTree,this.joinsTree,this.viewTree].invoke("observe",e.key,e.value.bindAsEventListener(this))}.bind(this)),this.initDragAndDrop(),this.tablesTree.showTree(1,this.tablesTreeLoadCallback.bind(this),domain.treeErrorHandler),this.joinsTree.showTree(2,this.joinsTreeLoadCallback.bind(this),domain.treeErrorHandler),this.viewTree.showTree(100,this.viewTreeLoadCallback.bind(this),domain.treeErrorHandler)},sortByType:function(e,t){var i=e.param.type,a=t.param.type;return a>i?1:i>a?-1:0},initDragAndDrop:function(){var e=[this.JOINS_TREE_ID,this.TABLES_TREE_ID,this.RESOURCES_CONTAILNER_ID,this.VIEW_TREE_ID,this.SETS_CONTAILNER_ID],t=function(e,t,i){var a,n=e.node;if(n){var r=dynamicTree.trees[n.getTreeId()],d=matchAny(t,["#"+this.RESOURCES_CONTAILNER_ID],!0)?this.joinsTree:this.viewTree;if(r!==d)if(r===this.viewTree)a=this.viewTree.selectedNodes,this.canDeleteTreeItems(a)&&this.deleteItemsFromViewTree(a,this.successDeleteTreeItemsCallback.bind(this));else{var o=this.viewTree._overNode;if(o){if(!o.isParent())for(;!o.isParent();)o=o.parent}else o=this.viewTree.getRootNode();a=this.joinsTree.selectedNodes,this.canDeleteTreeItems(a)&&this.addItemsToViewTree(a,o),this.viewTree._overNode=null}}}.bind(this);e.each(function(e){Droppables.remove(e),Droppables.add(e,{accept:["draggable","wrap"],onDrop:t})})},tablesTreeLoadCallback:function(){this.resourceViewMode=this.RESOURCE_VIEW_MODES.JOIN_TREE,$(this.TABLES_TREE_ID).addClassName(layoutModule.HIDDEN_CLASS),dd.createTreeNodesMap(this.tablesTree),this.updateButtonsState()},joinsTreeLoadCallback:function(){this.islands=this.createIslands(this.joinsTree.getRootNode()),dd.createTreeNodesMap(this.joinsTree),this.updateButtonsState()},viewTreeLoadCallback:function(){dd.createTreeNodesMap(this.viewTree),this.buildJoinTreeModelMap(),this.updateButtonsState(),this.setOriginalItemId(this.viewTree.getRootNode())},getFullNodePath:function(e){for(var t=e,i=[t.param.extra.originalItemId];t=t.parent;)t.param.extra&&i.push(t.param.extra.originalItemId);return i.reverse(),i.join(".")},setOriginalItemId:function(e){e.param.extra&&(e.param.extra.originalItemId=e.param.extra.itemId),e.childs&&_.each(e.childs,function(e){dd_display.setOriginalItemId(e)})},getItemTypeNodesRecursively:function(e){var t=[];return"ItemType"===e.param.type&&t.push(e),e.childs&&e.childs.length&&_.each(e.childs,function(e){t=t.concat(dd_display.getItemTypeNodesRecursively(e))}),t},isDontWarnOfDeleteItems:function(){return this.dontWarnOfDeleteItems},setDontWarnOfDeleteItems:function(e){this.dontWarnOfDeleteItems=!1},getJoinTreeModelNodeId:function(e){return e.extra.itemId},getJoinsTreeNodeId:function(e){return e.param.extra.itemId},getViewTree:function(){return this.viewTree},buildJoinTreeModelMap:function(){if(this.joinTreeModel){this.joinTreeModel.treeMap={},this.joinTreeModel.viewTreeMap={};var e={},t=function(e,i){this.joinTreeModel.treeMap[i.id]=i,i.parent=e,i.children&&i.children.first()&&(i.isParent=!0,i.children.each(t.bind(this,i)))};this.joinTreeModel.children&&this.joinTreeModel.children.each(t.bind(this,this.joinTreeModel)),$H(this.joinTreeModel.treeMap).values().each(function(t){if(!t.isParent){var i=this.buildCompositeIdentifier(t,".",this.getJoinTreeModelNodeId,this.joinTreeModel);e[i]=t}}.bind(this)),this.viewTree.resourceIdMap={},$H(this.viewTree.treeMap).values().each(function(t){if(!t.isParent()){var i=t.param.extra.resourceId;e[i]&&(this.viewTree.resourceIdMap[i]=t,this.joinTreeModel.viewTreeMap[i]=e[i].id)}}.bind(this))}},deselectNodesValidator:function(){var e=propsEditor.submitEdit();return e&&propsEditor.hide(),e},changeResourceViewMode:function(e){if(this.resourceViewMode!==e.mode){if(!propsEditor.submitEdit())return buttonManager.unSelect(e.destTabId),void buttonManager.select(e.sourceTabId);var t=e.getSourceTree().selectedNodes.first();if(1===e.getSourceTree().selectedNodes.length&&propsEditor.view(t),$(e.sourceTreeId).addClassName(layoutModule.HIDDEN_CLASS),$(e.destTreeId).removeClassName(layoutModule.HIDDEN_CLASS),t){var i=$H(e.getDestTree().treeMap).values().find(function(e){return e.param.id===t.param.id});i&&(e.getDestTree()._deselectAllNodes(),e.getDestTree().openAndSelectNode(i.param.uri))}e.getDestTree()===this.joinsTree?propsEditor.hide():propsEditor.view(e.getDestTree().selectedNodes.first()),this.resourceViewMode=e.mode}},createIslands:function(e){var t=e.childs,i=[];return t.each(function(e){var t=e.childs.findAll(function(e){return e.isParent()}).collect(function(e){return e.param.id});t.length>0&&i.push({islandId:e.param.extra.itemId,tablesIds:t})}),i},buildCompositeIdentifier:function(e,t,i,a){for(var n=i(e),r=e.parent;r&&r!==a;)n=i(r)+t+n,r=r.parent;return n},updateViewTreeResorceIds:function(e,t){var i=this.joinTreeModel.treeMap[e],a=function(e,t,i){return i===e&&t?t:i.extra.itemId}.curry(i,t.param.extra.itemId);i.children.each(function(e){var i=this.buildCompositeIdentifier(e,".",this.getJoinTreeModelNodeId,this.joinTreeModel);delete this.joinTreeModel.treeMap[e.id],e.id=t.param.id+"."+e.extra.itemId,this.joinTreeModel.treeMap[e.id]=e;var n=this.buildCompositeIdentifier(e,".",a,this.joinTreeModel),r=this.viewTree.resourceIdMap[i];r&&(r.param.extra.resourceId=n,delete this.viewTree.resourceIdMap[i],this.viewTree.resourceIdMap[n]=r,delete this.joinTreeModel.viewTreeMap[i],this.joinTreeModel.viewTreeMap[n]=e.id)}.bind(this)),delete this.joinTreeModel.treeMap[i.id],i.id=t.param.id,this.joinTreeModel.treeMap[i.id]=i,i.extra.itemId=t.param.extra.itemId},changeNodeId:function(e,t,i){if(e){var a=e.param.id,n=dynamicTree.trees[e.getTreeId()];e.isParent()?(e.param.extra.originalId||(e.param.extra.originalId=e.param.extra.itemId),e.param.extra.itemId=t,e.name=t,e._getElement()&&(e._getTitle().data=t),e.param.id=e.param.extra.datasourceId+"."+e.param.extra.itemId,i&&this.updateViewTreeResorceIds(a,e)):(e.param.extra.originalId||(e.param.extra.originalId=e.parent.param.extra.originalId+"."+e.param.extra.itemId),e.param.id=e.parent.param.id+"."+e.param.extra.itemId);var r="/"===e.parent.param.uri;e.param.uri=r?"/"+e.param.id:e.parent.param.uri+"/"+e.param.id,delete n.treeMap[a],n.treeMap[e.param.id]=e}},updateExpressions:function(e){e&&e.first()&&e.each(function(e){for(var t in e)[this.tablesTree,this.joinsTree,this.viewTree].each(function(i){var a=i.treeMap[t];a&&(a.param.extra.expression=e[t])})}.bind(this))},changeNodeAlias:function(e,t,i){var a=e.param.id;e=this.tablesTree.treeMap[a];var n=e.param.extra.itemId,r=this.joinsTree.treeMap[a],d=function(a){return"error"===a?void(i&&i(!0)):(dd.setUnsavedChangesPresent(!0),this.updateExpressions(a.changesExpressions),[e,r].each(function(e,i){e&&(this.changeNodeId(e,t,0===i),e.childs.each(function(e){this.changeNodeId(e,t,0===i)}.bind(this)))}.bind(this)),void(i&&i(!0)))};return dd.changeTableAlias(n,t,d.bind(this)),!0},idExistsInTree:function(e,t){var i=e.treeMap;return!!$H(i).values().find(function(e){return e.param.extra.itemId===t||e.param.id===t})},createNode:function(e,t,i){var a=e.processNode(i);return t.addChild(a),a.isloaded=!0,e.treeMap[a.param.id]=a,a},getUniqueItemId:function(e,t){for(var i=1;this.idExistsInTree(e,t+i);)i++;return t+i},updateChildOrders:function(e){e.childs.first()&&(this.viewTree.resortSubtree(e),e.childs.each(function(e,t){e.orderNumber=t+1}),e.refreshNode())},addNewSet:function(){dd.setUnsavedChangesPresent(!0);var e=this.viewTree.selectedNodes.first();e?e.param.type!==e.Types.Folder.name&&(e=e.parent):e=this.viewTree.getRootNode();var t=this.getUniqueItemId(this.viewTree,this.DEFAULT_SET_ID),i=this.changeOrderController.findMaxSiblingNode(e.childs,!1,!1,e.Types.Folder.name),a=i?i.orderNumber:0,n=e===this.viewTree.getRootNode()?"/"+t:e.param.uri+"/"+t,r={id:t,label:t,type:e.Types.Folder.name,uri:n,order:a+1,extra:{itemId:t,originalItemId:t,label:t,descr:t,labelId:"",descrId:"",resourceId:""}},d=this.createNode(this.viewTree,e,r);return this.updateChildOrders(d.parent),d},canDeleteTreeItems:function(e){return sessionManager.resetSession(dd.flowExecutionKey),e&&e.first()&&propsEditor.submitEdit()},successDeleteTreeItemsCallback:function(){propsEditor.hide(),this.updateButtonsState()},getOrCreateJoinsTreeNode:function(e){var t=this.joinsTree.treeMap[e];if(t&&this.joinsTree.findNodeById(t.param.id))return t;var i,a=this.joinTreeModel.treeMap[e],n={id:a.id,label:a.extra.itemId,type:a.type,uri:a.uri,extra:deepClone(a.extra)};return i=a.parent===this.joinTreeModel?this.joinsTree.getRootNode():this.getOrCreateJoinsTreeNode(a.parent.id),this.createNode(this.joinsTree,i,n)},restoreItemToJoinsTree:function(e){delete this.viewTree.resourceIdMap[e];var t=this.joinTreeModel.viewTreeMap[e];t&&this.getOrCreateJoinsTreeNode(t)},updateNodeResourceId:function(e){if(e.isParent()&&e.parent){var t=e.childs.findAll(function(e){return!e.isParent()||""!==e.param.extra.resourceId}).length;t>0||(e.param.extra.resourceId="",e.parent!=this.viewTree.getRootNode()&&this.updateNodeResourceId(e.parent))}},deleteItemsFromViewTree:function(e,t){_.each(e,function(e){e._markAsDeleted=!0});var i=function(){dd.setUnsavedChangesPresent(!0);var i=function(e){e.parent.removeChild(e),this.updateChildOrders(e.parent),delete this.viewTree.treeMap[e.param.id],e.isParent()||this.restoreItemToJoinsTree(e.param.extra.resourceId)}.bind(this),a=function(e){e.isParent()&&e.childs.clone().each(function(e){a(e)}),i(e),this.updateNodeResourceId(e.parent)}.bind(this),n=function(e){e.clone().each(function(e){a(e)}),this.joinsTree.resortSubtree(this.joinsTree.getRootNode()),this.resourceViewMode==dd_display.RESOURCE_VIEW_MODES.JOIN_TREE&&this.joinsTree.renderTree(),t&&t()};dd_display.deleteViewItemValidator.validate(e,n.bind(this))},a=this;domain.designer.checkDesign(_.bind(function(t){if(_.each(e,function(e){e._markAsDeleted=!1}),"success"!==t&&t.errorMessage){var n=domainUtil.getUsedResourcesList(t.errorMessage,domain._messages.ITEM_BEING_USED_BY_RESOURCE),r=[];_.each(e,function(e){r=r.concat(dd_display.getItemTypeNodesRecursively(e))}),r=_.uniq(_.map(r,dd_display.getFullNodePath)),n=_.filter(n,function(e){return-1!==_.indexOf(r,e.field)}),n.length||domainUtil.indexOfNoAccessMessage(t.errorMessage,domain._messages.resourcesWithNoAccess)>-1?(jQuery("#dependentResourcesConfirmMessage").html(domainUtil.getUsedResourcesFormattedMessage(n,t.errorMessage,{"resource.label":domain._messages["resource.label"],"field.label":domain._messages["field.label"],ITEM_BEING_USED_BY_RESOURCE:domain._messages.ITEM_BEING_USED_BY_RESOURCE,resourcesWithNoAccess:domain._messages.resourcesWithNoAccess})),dd_display.makeConfirmDialogSizeable(),domain.confirmDialog.show("dependentResourcesConfirmMessage",function(){i.call(a),dd_display.makeConfirmDialogNotSizeable()},function(){dd_display.makeConfirmDialogNotSizeable()})):i.call(this)}else i.call(this)},this))},makeConfirmDialogSizeable:function(){jQuery(domain.confirmDialog._dialog).addClass("detail").addClass("noMaxWidth").addClass("sizeable").find(".sizer").show()},makeConfirmDialogNotSizeable:function(){jQuery(domain.confirmDialog._dialog).removeClass("detail").removeClass("noMaxWidth").removeClass("sizeable").css({height:"auto",width:"auto"}).find(".sizer").hide()},deleteInvalidViewItems:function(e){if("success"!==e){var t=$H(e.presentationObjectIds).keys();dd.deleteNodesFromTreeById(t,this.viewTree,this.copyMoveController)}},removeTables:function(e,t){var i=e.collect(function(e){return e.param.id}),a=function(){this.joinsTreeLoadCallback(),$(this.JOINS_TREE_ID).addClassName(layoutModule.HIDDEN_CLASS)},n=function(){dd.checkDesign(r.bind(this))},r=function(e){this.deleteInvalidViewItems(e),this.joinsTree.showTree(2,a.bind(this),domain.treeErrorHandler),t&&t()},d=function(e,t){dd.setUnsavedChangesPresent(!0),dd.deleteNodesFromTreeById(e,this.tablesTree,this.copyMoveController),dd.deleteNodesFromTreeById(i,this.tablesTree,this.copyMoveController),this.updateJoinView(n.bind(this))};dd.calcFieldsAndFiltersValidator.validate(e,!1,d.bind(this))},addItemToViewTree:function(e,t){if(e.param.extra.isIsland)return e.childs.collect(function(e){return this.addItemToViewTree(e,t).first()}.bind(this));var i=e.param.id,a=e.param.extra.itemId;this.idExistsInTree(this.viewTree,a)&&(a=this.getUniqueItemId(this.viewTree,a)),this.idExistsInTree(this.viewTree,i)&&(i=this.getUniqueItemId(this.viewTree,i));var n,r=e.isParent()?t.Types.Folder.name:t.Types.Leaf.name,d=this.viewTree.getRootNode(),o=this.changeOrderController.findMaxSiblingNode(t.childs,!1,!1,r),s=o?o.orderNumber:0,l=t===d?"/"+i:t.param.uri+"/"+i,c=domain.getDataIslandId(e,"itemId");n=e.isParent()?c?c:e.param.extra.itemId:this.buildCompositeIdentifier(e,".",this.getJoinsTreeNodeId,this.joinsTree.getRootNode());var u={id:i,label:e.name,type:r,uri:l,order:s+1,extra:{itemId:a,originalItemId:a,label:e.name,descr:a,labelId:"",descrId:"",resourceId:n}};if(e.isParent()||(u.extra.dataType=e.param.extra.JavaType,
u.extra.defaultMask="none"),t.param.extra&&(!t.param.extra.resourceId||t.param.extra.resourceId===e.CONSTANT_TABLE_ID))for(var h=t;h!=this.viewTree.getRootNode();)h.param.extra.resourceId=c,h=h.parent;var m=this.createNode(this.viewTree,t,u);return this.updateChildOrders(m.parent),e.isParent()||(this.viewTree.resourceIdMap[n]=m,this.joinTreeModel.viewTreeMap[n]=e.param.id),e.isParent()&&e.childs.each(function(e){this.addItemToViewTree(e,m)}.bind(this)),[m]},addItemsToViewTree:function(e,t){if(e&&e.first()){t.isloaded=!0;var i=function(){dd.setUnsavedChangesPresent(!0);var i=[];e.clone().each(function(e){var a=this.addItemToViewTree(e,t);i=i.concat(a),dd.deleteNodesFromTreeById([e.param.id],this.joinsTree,this.copyMoveController)}.bind(this)),i.compact().each(function(e){this.viewTree.openAndSelectNode(e.param.uri)}.bind(this)),this.viewTree._deselectAllNodes(),i.each(function(e){e.select()}),1===this.viewTree.selectedNodes.length&&propsEditor.view(this.viewTree.selectedNodes.first()),this.updateButtonsState()};dd_display.addViewItemsValidator.validate(t,e,i.bind(this))}},refreshViewTreeStyle:function(e){$H(this.viewTree.treeMap).values().each(function(e){e.param.extra&&e.param.extra.isInvalid&&(delete e.param.extra.isInvalid,delete e.tooltip,e.refreshNode())}),e&&$H(e).each(function(e){var t=this.viewTree.treeMap[e.key];t&&(t.param.extra.isInvalid="true",t.tooltip=e.value,t.refreshNode())}.bind(this))},updateJoinView:function(e){var t={flowExecutionKey:dd.flowExecutionKey,eventId:"updateJoinView"},i=this.getValidationPostData();i.autoGenerateJoins="false",domain.sendAjaxRequest(t,i,e)},treeMouseDown:function(e){},treeDblclick:function(e){var t=dynamicTree.trees[e.getTreeId()];t===this.joinsTree?$(this.ADD_ITEM_ID).click():t===this.viewTree&&$(this.DELETE_ITEM_ID).click()},treeMouseUp:function(e){var t=dynamicTree.trees[e.getTreeId()];if(t===this.joinsTree)return void this.updateButtonsState();if(!propsEditor.submitEdit()){var i=propsEditor.getNode(),a=dynamicTree.trees[i.getTreeId()];return t===a&&(t._deselectAllNodes(),i.select()),void this.updateButtonsState()}1==t.selectedNodes.length?propsEditor.view(t.selectedNodes.first()):propsEditor.hide(),this.updateButtonsState()},changeResourceViewModeClickHandler:function(e){var t=!1;return this.changeResourceViewModeHandlerMap.each(function(i){if(domain.elementClicked(e,i.key))throw this.changeResourceViewMode(i.value),this.updateButtonsState(),t=!0,$break}.bind(this)),t},moveButtonsClickEventHandler:function(e){var t=!1;return this.moveButtonsClickEventMap.each(function(i){if(domain.elementClicked(e,i.key)){var a=this.viewTree.selectedNodes;throw a.sort(i.value.upward?this.changeOrderController.nodeAscSorter:this.changeOrderController.nodeDescSorter).each(function(e){this.changeOrderController.moveNode(e,i.value.upward,i.value.maxmove)}.bind(this)),this.viewTree.resortSubtree(a.first().parent),this.viewTree.renderTree(),this.updateChangeOrderButtonsState(),sessionManager.resetSession(dd.flowExecutionKey),t=!0,$break}}.bind(this)),t},createNewSetClickEventHandler:function(e){if(domain.elementClicked(e,this.CREATE_NEW_SET_ID)){if(sessionManager.resetSession(dd.flowExecutionKey),!propsEditor.submitEdit())throw!0;var t=this.addNewSet();return this.viewTree.openAndSelectNode(t.param.uri),propsEditor.view(t),this.updateButtonsState(),!0}},addDeleteItemsClickEventHandler:function(e){var t=!1;return this.addDeleteItemsClickEventMap.each(function(i){if(domain.elementClicked(e,i.key))throw t=!0,i.value.bind(this)(),$break}.bind(this)),t},updateButtonsState:function(){this.updateSetsButtonsState(),this.updateChangeOrderButtonsState(),this.updateDeleteItemButtonState(),this.updateDeleteTableButtonState(),this.updateDoneButtonState(),dd.updateToolBarButtons()},updateSetsButtonsState:function(){if(this.resourceViewMode!==this.RESOURCE_VIEW_MODES.JOIN_TREE)return domain.enableButton(this.ADD_ITEM_ID,!1),void domain.enableButton(this.ADD_ITEM_TO_SET_ID,!1);domain.enableButton(this.ADD_ITEM_ID,!!this.joinsTree.selectedNodes.first());var e=this.joinsTree.selectedNodes.first()&&1==this.viewTree.selectedNodes.length&&this.viewTree.selectedNodes.first().isParent();domain.enableButton(this.ADD_ITEM_TO_SET_ID,e)},disableMoveButtons:function(){[this.MOVE_TO_TOP_ID,this.MOVE_UPWARD_ID,this.MOVE_DOWNWARD_ID,this.MOVE_TO_BOTTOM_ID].each(function(e){domain.enableButton(e,!1)})},updateChangeOrderButtonsState:function(){if(this.viewTree&&this.viewTree.selectedNodes.first()){var e=this.viewTree.selectedNodes.first().parent,t=this.viewTree.selectedNodes.find(function(t){return t.parent!==e});if(t)return void this.disableMoveButtons();var i=this.viewTree.selectedNodes.first().param.type,a=this.viewTree.selectedNodes.find(function(e,t){return t.param.type!==e}.curry(i));if(a)return void this.disableMoveButtons();var n=this.changeOrderController.findMaxSiblingNode(e.childs,!1,!0,i),r=this.changeOrderController.findMaxSiblingNode(e.childs,!0,!1,i),d=n&&n.orderNumber<r.orderNumber;[this.MOVE_TO_TOP_ID,this.MOVE_UPWARD_ID].each(function(e){domain.enableButton(e,d)});var o=this.changeOrderController.findMaxSiblingNode(e.childs,!1,!1,i),s=this.changeOrderController.findMaxSiblingNode(e.childs,!0,!0,i),l=o&&o.orderNumber>s.orderNumber;[this.MOVE_DOWNWARD_ID,this.MOVE_TO_BOTTOM_ID].each(function(e){domain.enableButton(e,l)})}else this.disableMoveButtons()},updateDeleteItemButtonState:function(){domain.enableButton(this.DELETE_ITEM_ID,this.viewTree.selectedNodes.first())},updateDeleteTableButtonState:function(){if(this.resourceViewMode!==this.RESOURCE_VIEW_MODES.TABLES_TREE)return void $(this.DELETE_TABLE_ID).addClassName(layoutModule.HIDDEN_CLASS);$(this.DELETE_TABLE_ID).removeClassName(layoutModule.HIDDEN_CLASS);var e=this.tablesTree.selectedNodes.first()&&!this.tablesTree.selectedNodes.find(function(e){return!e.isParent()});domain.enableButton(this.DELETE_TABLE_ID,e)},updateDoneButtonState:function(){var e=!!(this.viewTree&&this.viewTree.getRootNode()&&this.viewTree.getRootNode().childs.first());domain.enableButton(this.DONE_BUTTON_ID,e)}};var dd_display=dd.display;dd_display.propertiesEditor={_PROPERTIES_PANEL_ID:"properties",_MODES:{EMPTY:"empty",VIEW:"view",EDIT:"edit"},_ALL_FIELDSETS:["#identification","#bundleInfo","#itemSpecific","#resourceInfo"],_EDIT_ID:"edit",_CANCEL_ID:"cancel",_SAVE_ID:"save",_mode:null,_node:null,_params:null,_defaultAgg:{},_defaultMasks:null,_dimensionOrMeasureLabels:{},_typesMap:null,init:function(e,t){dd_display.propertiesEditor._init.bind(dd_display.propertiesEditor)(e,t)},view:function(e,t){dd_display.propertiesEditor._view.bind(dd_display.propertiesEditor)(e,t)},submitEdit:function(){return dd_display.propertiesEditor._submitEdit.bind(dd_display.propertiesEditor)()},getNode:function(){return dd_display.propertiesEditor._node},hide:function(){dd_display.propertiesEditor._hide.bind(dd_display.propertiesEditor)()},_init:function(e,t){this._defaultMasks=e,this._typesMap=t,this._initAggregations(),this._initDimensionOrMeasureLabels(),domain.registerClickHandlers([this._propertiesEditorClickHandler.bind(this)])},_propertiesEditorClickHandler:function(e){var t=!1;return this.buttonsMap.each(function(i){if(domain.elementClicked(e,i.key))throw i.value&&i.value(),sessionManager.resetSession(dd.flowExecutionKey),t=!0,$break}.bind(this)),t},_getGetValueLabelPairForObject:function(e){return{value:e,label:e}},_initAggregations:function(){var e=function(e){return"None"===e.value?"AAA":e.value};this._defaultAgg["int"]=this._defaultAgg.dec=_.sortBy(this.numberAggFunctionArray.collect(this._getGetValueLabelPairForObject),e),this._defaultAgg.NaN=_.sortBy(this.nanAggFunctionArray.collect(this._getGetValueLabelPairForObject),e),this._defaultAgg.date=this._defaultAgg.timestamp=this._defaultAgg.time=_.sortBy(this.dateAggFunctionArray.collect(this._getGetValueLabelPairForObject),e)},_initDimensionOrMeasureLabels:function(){this._dimensionOrMeasureLabels=this.dimensionOrMeasureArray.collect(this._getGetValueLabelPairForObject)},_view:function(e){if(this._submitEdit()&&(this._mode!==this._MODES.VIEW||this._node!==e)){if(!e)return void this._hide();this._node=e,this._mode=this._MODES.VIEW,$$(this._ALL_FIELDSETS).each(function(e){e.addClassName(layoutModule.HIDDEN_CLASS)}),$(this._EDIT_ID).removeClassName(layoutModule.HIDDEN_CLASS);var t=this.nodeTypeFactory[e.param.type];t.view.bind(this)(e),domain.enableButton(this._EDIT_ID,t.canEdit(e)),this._enableEditMode(!1)}},_edit:function(){this._mode==this._MODES.VIEW&&(this._mode=this._MODES.EDIT,this.nodeTypeFactory[this._node.param.type].edit.bind(this)(this._node),this._enableEditMode(!0),this._initialParamState=_.clone(this._node.param.extra))},_submitEdit:function(){if(this._mode!==this._MODES.EDIT)return!0;var e=function(e){e&&(dd.setUnsavedChangesPresent(!0),this._mode=this._MODES.EMPTY,this._view(this._node))}.bind(this);if(!this._validate())return!1;var t=this.nodeTypeFactory[this._node.param.type],i=t.getValues.bind(this)(this._node),a=t.submitChanges(this._node,i,e),n=this;if(a){var r;if(domain.designer.checkDesign(function(e){r=e},{synchronous:!0}),"success"!==r&&r.errorMessage){var d=domainUtil.getUsedResourcesList(r.errorMessage,domain._messages.ITEM_BEING_USED_BY_RESOURCE),o=_.uniq(_.map(dd_display.getItemTypeNodesRecursively(this._node),dd_display.getFullNodePath));return d=_.filter(d,function(e){return-1!==_.indexOf(o,e.field)}),d.length||domainUtil.indexOfNoAccessMessage(r.errorMessage,domain._messages.resourcesWithNoAccess)>-1?(jQuery("#dependentResourcesConfirmMessage").html(domainUtil.getUsedResourcesFormattedMessage(d,r.errorMessage,{"resource.label":domain._messages["resource.label"],"field.label":domain._messages["field.label"],ITEM_BEING_USED_BY_RESOURCE:domain._messages.ITEM_BEING_USED_BY_RESOURCE,resourcesWithNoAccess:domain._messages.resourcesWithNoAccess})),dd_display.makeConfirmDialogSizeable(),domain.confirmDialog.show("dependentResourcesConfirmMessage",function(){dd_display.makeConfirmDialogNotSizeable(),e(a)},function(){dd_display.makeConfirmDialogNotSizeable(),t.submitChanges(n._node,n._initialParamState,e),t.view.bind(n)(n._node),t.edit.bind(n)(n._node)}),!1):(e(a),!0)}return e(a),!0}},_cancelEdit:function(){this._mode===this._MODES.EDIT&&(this._mode=this._MODES.EMPTY,this._view(this._node),this._validate(!0))},_hide:function(){this._submitEdit()&&(this._node=null,this._validator=null,this._mode=this._MODES.EMPTY,$$(this._ALL_FIELDSETS.concat(["#"+this._EDIT_ID])).each(function(e){e.addClassName(layoutModule.HIDDEN_CLASS)}),this._enableEditMode(!1))},_validate:function(e){return this.nodeTypeFactory[this._node.param.type].validate.bind(this)(e)},_enableEditMode:function(e){e?$(this._PROPERTIES_PANEL_ID).addClassName("editMode"):$(this._PROPERTIES_PANEL_ID).removeClassName("editMode")},_getDataType:function(e){var t=this._typesMap[e.param.extra.dataType];return t||(t="NaN"),t},_itemExistsValidator:function(e){var t=dynamicTree.trees[this._node.getTreeId()],i=t.treeMap,a=!$H(i).values().find(function(e,t){return t!=this._node&&t.param.extra.itemId===e}.bind(this,e));return{isValid:a,errorMessage:domain.getMessage("item.exists")}}};var propsEditor=dd_display.propertiesEditor;dd_display.changeResourceViewModeHandlerMap=$H({"#joinTreeView":{mode:dd_display.RESOURCE_VIEW_MODES.JOIN_TREE,getSourceTree:function(){return dd_display.tablesTree},getDestTree:function(){return dd_display.joinsTree},sourceTreeId:dd_display.TABLES_TREE_ID,destTreeId:dd_display.JOINS_TREE_ID,sourceTabId:dd_display.TAB_TABLES_LIST_VIEW_ID,destTabId:dd_display.TAB_JOIN_TREE_VIEW_ID},"#tableListView":{mode:dd_display.RESOURCE_VIEW_MODES.TABLES_TREE,getSourceTree:function(){return dd_display.joinsTree},getDestTree:function(){return dd_display.tablesTree},sourceTreeId:dd_display.JOINS_TREE_ID,destTreeId:dd_display.TABLES_TREE_ID,sourceTabId:dd_display.TAB_JOIN_TREE_VIEW_ID,destTabId:dd_display.TAB_TABLES_LIST_VIEW_ID}}),dd_display.treeEventFactory={"leaf:mousedown":function(e){var t=e.memo.node;this.treeMouseDown(t),Event.stop(e)},"node:mousedown":function(e){var t=e.memo.node;this.treeMouseDown(t),Event.stop(e)},"leaf:mouseup":function(e){var t=e.memo.node;this.treeMouseUp(t),Event.stop(e)},"node:mouseup":function(e){var t=e.memo.node;this.treeMouseUp(t),Event.stop(e)},"leaf:dblclick":function(e){var t=e.memo.node;this.treeDblclick(t),Event.stop(e)},"node:dblclick":function(e){var t=e.memo.node;this.treeDblclick(t),Event.stop(e)},"tree:mouseout":function(e){var t=e.memo.tree;t===this.viewTree&&(t._overNode=null),Event.stop(e)},"tree:blur":function(e){var t=e.memo.tree;t===this.viewTree&&(t._overNode=null),Event.stop(e)}},dd_display.moveButtonsClickEventMap=$H({"#toTop":{upward:!0,maxmove:!0},"#upward":{upward:!0,maxmove:!1},"#downward":{upward:!1,maxmove:!1},"#toBottom":{upward:!1,maxmove:!0}}),dd_display.addDeleteItemsClickEventMap=$H({"#add":function(){var e=this.joinsTree.selectedNodes;this.canDeleteTreeItems(e)&&this.addItemsToViewTree(e,this.viewTree.getRootNode())},"#addToSet":function(){var e=this.joinsTree.selectedNodes;this.canDeleteTreeItems(e)&&this.addItemsToViewTree(e,this.viewTree.selectedNodes.first())},"#deleteItem":function(){var e=this.viewTree.selectedNodes;this.canDeleteTreeItems(e)&&this.deleteItemsFromViewTree(e,this.successDeleteTreeItemsCallback.bind(this))},"#deleteTable":function(){var e=this.tablesTree.selectedNodes;this.canDeleteTreeItems(e)&&this.removeTables(e,this.successDeleteTreeItemsCallback.bind(this))}}),propsEditor.numberAggFunctionArray=["None","Sum","Average","Max","Min","StdDevP","StdDevS","Mode","Median","Range","CountAll","CountDistinct"],propsEditor.dateAggFunctionArray=["None","Max","Min","Mode","Median","RangeMinutes","RangeHours","RangeDays","RangeWeeks","RangeMonths","RangeQuarters","RangeSemis","RangeYears","CountAll","CountDistinct"],propsEditor.nanAggFunctionArray=["None","CountDistinct","CountAll","Mode"],propsEditor.dimensionOrMeasureArray=["Dimension","Measure"],propsEditor.buttonsMap=$H({"#edit":propsEditor._edit.bind(propsEditor),"#save":propsEditor._submitEdit.bind(propsEditor),"#cancel":propsEditor._cancelEdit.bind(propsEditor)}),propsEditor.nodeTypeFactory={ItemGroupType:{view:function(e){$$(["#identification","#bundleInfo"]).each(function(e){e.removeClassName(layoutModule.HIDDEN_CLASS)});var t=e.param.extra,i=domain.getMessage("none");$("itemName").writeAttribute("readonly","readonly").value=t.label?t.label:i,$("itemID").writeAttribute("readonly","readonly").value=t.itemId,$("itemDescription").writeAttribute("readonly","readonly").value=t.descr?t.descr:i,$("itemNameKey").writeAttribute("readonly","readonly").value=t.labelId?t.labelId:i,$("itemDescriptionKey").writeAttribute("readonly","readonly").value=t.descrId?t.descrId:i},canEdit:function(e){return!0},edit:function(e){$("itemName").writeAttribute("readonly",null),$("itemID").writeAttribute("readonly",null),$("itemDescription").writeAttribute("readonly",null),$("itemNameKey").writeAttribute("readonly",null),$("itemDescriptionKey").writeAttribute("readonly",null),$H({label:"itemName",descr:"itemDescription",labelId:"itemNameKey",descrId:"itemDescriptionKey"}).each(function(t){e.param.extra[t.key]||($(t.value).value="")})},getValues:function(){return{label:$F("itemName"),itemId:$F("itemID"),descr:$F("itemDescription"),labelId:$F("itemNameKey"),descrId:$F("itemDescriptionKey")}},validate:function(e){return e?([$("itemName"),$("itemDescription"),$("itemNameKey"),$("itemDescriptionKey"),$("itemID")].each(function(e){ValidationModule.hideError(e)}),!0):ValidationModule.validateLegacy([{validator:dd.escapeJsonValidator.bind(this),element:$("itemName")},{validator:dd.escapeJsonValidator.bind(this),element:$("itemDescription")},{validator:dd.escapeJsonValidator.bind(this),element:$("itemNameKey")},{validator:dd.itemKeyValidator.bind(this,"itemNameKey.invalid"),element:$("itemNameKey")},{validator:dd.escapeJsonValidator.bind(this),element:$("itemDescriptionKey")},{validator:dd.itemKeyValidator.bind(this,"itemDescriptionKey.invalid"),element:$("itemDescriptionKey")},{validator:dd.emptyValidator.bind(this),element:$("itemID")},{validator:dd.itemIdValidator.bind(this,"id.invalid"),element:$("itemID")},{validator:dd.itemIdNotStartFromNumberValidator.bind(this),element:$("itemID")},{validator:this._itemExistsValidator.bind(this),element:$("itemID")}])},submitChanges:function(e,t){return e.changeName(t.label&&t.label.strip()?t.label:t.itemId),$H(t).each(function(t){e.param.extra[t.key]=t.value}),!0}},ItemType:{view:function(e){$$(["#identification","#bundleInfo","#itemSpecific"]).each(function(e){e.removeClassName(layoutModule.HIDDEN_CLASS)});var t=e.param.extra,i=domain.getMessage("none");$("itemName").writeAttribute("readonly","readonly").value=t.label?xssUtil.unescape(t.label):i,$("itemID").writeAttribute("readonly","readonly").value=xssUtil.unescape(t.itemId),$("itemDescription").writeAttribute("readonly","readonly").value=t.descr?xssUtil.unescape(t.descr):i,$("itemNameKey").writeAttribute("readonly","readonly").value=t.labelId?xssUtil.unescape(t.labelId):i,$("itemDescriptionKey").writeAttribute("readonly","readonly").value=t.descrId?xssUtil.unescape(t.descrId):i,$("resourceID").value=t.resourceId;var a=this._getDataType(e),n=function(e,i,n){var r={value:i.value,label:i.label},d="int"==a||"dec"==a;return t[e]?r.selected=t[e]===i.value:"dimensionOrMeasure"==e?r.selected=d&&"Measure"==r.value:"defaultAgg"==e?r.selected=r.value==(d?"Sum":"CountAll"):r.selected=0===n,r},r=this._defaultAgg[a].collect(n.curry("defaultAgg"));domain.setOptionsToSelect($("summaryType").writeAttribute("disabled","diabled"),r),r=this._dimensionOrMeasureLabels.collect(n.curry("dimensionOrMeasure")),domain.setOptionsToSelect($("dimensionOrMeasure").writeAttribute("disabled","diabled"),r),"NaN"!==a?($$("label[for=dataFormat]").first().removeClassName(layoutModule.HIDDEN_CLASS),r=this._defaultMasks[a].collect(n.curry("defaultMask")),domain.setOptionsToSelect($("dataFormat").writeAttribute("disabled","disabled"),r)):$$("label[for=dataFormat]").first().addClassName(layoutModule.HIDDEN_CLASS)},canEdit:function(e){return!0},edit:function(e){$("itemName").writeAttribute("readonly",null),$("itemID").writeAttribute("readonly",null),$("itemDescription").writeAttribute("readonly",null),$("itemNameKey").writeAttribute("readonly",null),$("itemDescriptionKey").writeAttribute("readonly",null),$("summaryType").writeAttribute("disabled",null),"NaN"!==this._getDataType(e)&&$("dataFormat").writeAttribute("disabled",null),$("dimensionOrMeasure").writeAttribute("disabled",null),$H({label:"itemName",descr:"itemDescription",labelId:"itemNameKey",descrId:"itemDescriptionKey"}).each(function(t){e.param.extra[t.key]||($(t.value).value="")})},getValues:function(e){var t={label:$F("itemName"),itemId:$F("itemID"),descr:$F("itemDescription"),labelId:$F("itemNameKey"),descrId:$F("itemDescriptionKey"),defaultAgg:$F("summaryType"),dimensionOrMeasure:$F("dimensionOrMeasure")};return"NaN"!==this._getDataType(e)&&(t.defaultMask=$F("dataFormat")),t},validate:function(e){return e?([$("itemName"),$("itemDescription"),$("itemNameKey"),$("itemDescriptionKey"),$("itemID")].each(function(e){ValidationModule.hideError(e)}),!0):ValidationModule.validateLegacy([{validator:dd.escapeJsonValidator.bind(this),element:$("itemName")},{validator:dd.escapeJsonValidator.bind(this),element:$("itemDescription")},{validator:dd.escapeJsonValidator.bind(this),element:$("itemNameKey")},{validator:dd.itemKeyValidator.bind(this,"itemNameKey.invalid"),element:$("itemNameKey")},{validator:dd.escapeJsonValidator.bind(this),element:$("itemDescriptionKey")},{validator:dd.itemKeyValidator.bind(this,"itemDescriptionKey.invalid"),element:$("itemDescriptionKey")},{validator:dd.emptyValidator.bind(this),element:$("itemID")},{validator:dd.itemIdValidator.bind(this,"id.invalid"),element:$("itemID")},{validator:dd.itemIdNotStartFromNumberValidator.bind(this),element:$("itemID")},{validator:this._itemExistsValidator.bind(this),element:$("itemID")}])},submitChanges:function(e,t){return e.changeName(t.label?t.label:t.itemId),$H(t).each(function(t){e.param.extra[t.key]=t.value}),!0}},level:{view:function(e){$("resourceInfo").removeClassName(layoutModule.HIDDEN_CLASS),$$(["label[for=resourceItemType]"]).first().addClassName(layoutModule.HIDDEN_CLASS);var t=e.param.extra;$("resourceItemId").writeAttribute("readonly","readonly").value=t.itemId,$("resourceItemDataSource").value=t.dataSource,$("resourceItemSourceTable").value=t.table},canEdit:function(e){return!e.param.extra.isIsland&&![e.CONSTANT_TABLE_ID,e.CROSSTABLES_FIELDS_TABLE_ID].include(e.param.id)},edit:function(e){$("resourceItemId").writeAttribute("readonly",null)},getValues:function(){return{itemId:$F("resourceItemId")}},validate:function(){return ValidationModule.validateLegacy([{validator:this._itemExistsValidator.bind(this),element:$("resourceItemId")},{validator:dd.emptyValidator.bind(this),element:$("resourceItemId")},{validator:dd.itemIdValidator.bind(this,"id.invalid"),element:$("resourceItemId")},{validator:dd.itemIdNotStartFromNumberValidator.bind(this),element:$("resourceItemId")}])},submitChanges:function(e,t,i){return e.param.extra.itemId===t.itemId?!0:(dd_display.changeNodeAlias(e,t.itemId,i),!0)}},item:{view:function(e){$("resourceInfo").removeClassName(layoutModule.HIDDEN_CLASS),$$(["label[for=resourceItemType]"]).first().removeClassName(layoutModule.HIDDEN_CLASS);var t=e.param.extra;$("resourceItemId").writeAttribute("readonly","readonly").value=t.itemId,$("resourceItemDataSource").value=t.dataSource,$("resourceItemSourceTable").value=t.table,$("resourceItemType").value=t.JavaType},canEdit:function(e){return!1},edit:function(e){},getValues:function(){},validate:function(){},submitChanges:function(e,t){}}},"undefined"==typeof require&&document.observe("dom:loaded",dd.initialize.bind(dd)),define("domain.designer.display",["domain.designer.validators"],function(e){return function(){var t;return t||e.dd_display}}(this)),dd_display.deleteViewItemValidator={_DELETE_VIEW_ITEMS_TEMPLATE_ID:"deleteViewItemsConfirmMessage",_VIEW_ITEMS_DETAILS_LINK_ID:"#viewItemsDetails",_DONT_WARN_ID:"dontWarnInCurrentSession",_CREATE_MODE:"createMode",_EDIT_MODE:"editMode",_mode:null,_isDontWarnOfDeleteItems:null,_setDontWarnOfDeleteItems:null,_buildCompositeIdentifier:null,_fieldsInfo:null,init:function(e,t,i,a){dd_display.deleteViewItemValidator._init.bind(dd_display.deleteViewItemValidator)(e,t,i,a)},validate:function(e,t){dd_display.deleteViewItemValidator._validate.bind(dd_display.deleteViewItemValidator)(e,t)},_init:function(e,t,i,a){this._mode=e,this._isDontWarnOfDeleteItems=t,this._setDontWarnOfDeleteItems=i,this._buildCompositeIdentifier=a},_validate:function(e,t){this._onOk.bind(this)(e,t)},_getFieldInfo:function(e){var t=function(e){return e.param.extra.itemId},i=dynamicTree.trees[e.getTreeId()].getRootNode(),a="/"+this._buildCompositeIdentifier(e,"/",t,i),n=e.param.extra.label?e.param.extra.label:e.param.extra.itemId;return n+" "+a+" "+e.param.extra.dataType},_getFieldsInfo:function(e){var t=[];return e.each(function(e){e.param.type===e.Types.Folder.name?t=t.concat(this._getFieldsInfo(e.childs)):t.push(this._getFieldInfo(e))}.bind(this)),t},_onOk:function(e,t){t&&t(e)},_onCancel:function(){},_showAffectedResources:function(e){return domain.elementClicked(e,this._VIEW_ITEMS_DETAILS_LINK_ID)?(domain.detailsDialog.show(this._fieldsInfo),!0):void 0}},dd_display.addViewItemsValidator={init:function(e){dd_display.addViewItemsValidator._init.bind(dd_display.addViewItemsValidator)(e)},validate:function(e,t,i){dd_display.addViewItemsValidator._validate.bind(dd_display.addViewItemsValidator)(e,t,i)},_init:function(e){this._getDataIslandId=e},_validate:function(e,t,i){for(var a="",n=e;""===a&&n.parent;)a=n.param.extra.resourceId,n=n.parent;var r=t.find(function(e){var t=this._getDataIslandId(e,"itemId");return a&&a!==e.CONSTANT_TABLE_ID&&t!==e.CONSTANT_TABLE_ID&&t!==a}.bind(this));r?domain.detailsDialog.show(domain.getMessage("items.fromDifferentDataIslands")):i&&i()}},dd_display.emptySetsValidator={_EMPTY_SETS_TEMPLATE_DOM_ID:"emptySetsConfirmMessage",_EMPTY_SETS_LINK_ID:"#emptySetsDetails",_callback:null,_emptySetUris:null,_emptySetIds:null,_copyMoveController:null,_getTree:null,init:function(e,t){dd_display.emptySetsValidator._init.bind(dd_display.emptySetsValidator)(e,t)},validate:function(e){dd_display.emptySetsValidator._validate.bind(dd_display.emptySetsValidator)(e)},_init:function(e,t){this._getTree=e,this._copyMoveController=t},_validate:function(e){this._callback=e;var t=$H(this._getTree().treeMap).values().findAll(function(e){return e.param.type===e.Types.Folder.name&&e!==this._getTree().getRootNode()&&!e.childs.first()}.bind(this));t&&t.first()?(this._emptySetUris=t.collect(function(e){return e.param.uri}),this._emptySetIds=t.collect(function(e){return e.param.id}),domain.confirmDialog.show(this._EMPTY_SETS_TEMPLATE_DOM_ID,this._onOk.bind(this),this._onCancel.bind(this),this._showAffectedResources.bind(this))):this._callback&&this._callback()},_onOk:function(){dd.deleteNodesFromTreeById(this._emptySetIds,this._getTree(),this._copyMoveController),this._callback&&this._callback()},_onCancel:function(){this._callback&&this._callback()},_showAffectedResources:function(e){return domain.elementClicked(e,this._EMPTY_SETS_LINK_ID)?(domain.detailsDialog.show(this._emptySetUris),!0):void 0}},dd_display.checkDesignValidator={_INVALID_DESIGN_TEMPLATE_DOM_ID:"invalidDesignConfirmMessage",_INVALID_DESIGN_LINK_ID:"#designDetails",_callback:null,_errorMessage:null,_showConfirmation:null,_refreshViewTreeStyle:null,init:function(e){dd_display.checkDesignValidator._init.bind(dd_display.checkDesignValidator)(e)},validate:function(e,t){dd_display.checkDesignValidator._validate.bind(dd_display.checkDesignValidator,e,t)()},_init:function(e){this._refreshViewTreeStyle=e},_validate:function(e,t){this._callback=t,this._showConfirmation=e,dd_display.emptySetsValidator.validate(this._emptySetsCallback.bind(this))},_emptySetsCallback:function(){dd.checkDesign.bind(dd,this._checkDesignCallback.bind(this))()},_checkDesignCallback:function(e){if("success"===e)this._refreshViewTreeStyle(),this._callback?this._callback():dialogs.systemConfirm.show(domain.getMessage("designIsValid"));else{this._errorMessage=e.errorMessage,this._refreshViewTreeStyle(e.presentationObjectIds);var t=domainUtil.getUsedResourcesList(e.errorMessage,domain._messages.ITEM_BEING_USED_BY_RESOURCE),i=t.length||domainUtil.indexOfNoAccessMessage(e.errorMessage,domain._messages.resourcesWithNoAccess)>-1?domainUtil.getUsedResourcesFormattedMessage(t,e.errorMessage,{"resource.label":domain._messages["resource.label"],"field.label":domain._messages["field.label"],ITEM_BEING_USED_BY_RESOURCE:domain._messages.ITEM_BEING_USED_BY_RESOURCE,resourcesWithNoAccess:domain._messages.resourcesWithNoAccess}):this._errorMessage;this._showConfirmation&&(t.length||domainUtil.indexOfNoAccessMessage(e.errorMessage,domain._messages.resourcesWithNoAccess)>-1)?domain.confirmDialog.show(this._INVALID_DESIGN_TEMPLATE_DOM_ID,this._onOk.bind(this),this._onCancel.bind(this),_.bind(function(e){this._showAffectedResources(e,i)},this),domain.confirmDialog.MODE_YES_NO):domain.detailsDialog.show(i)}},_onOk:function(){this._callback&&this._callback()},_onCancel:function(){},_showAffectedResources:function(e,t){return domain.elementClicked(e,this._INVALID_DESIGN_LINK_ID)?(domain.detailsDialog.show(t),!0):void 0}},define("domain.designer.display.validators",["domain.designer.display"],function(e){return function(){var t;return t||e.dd_display}}(this)),DragListener.DRAGGING_STARTED="draggingStarted",DragListener.DRAGGING_FINISHED="draggingFinished",DragListener.DRAGGING="dragging",DragListener.prototype.registerAgent=function(e){this.agents[e]=[]},DragListener.prototype.publishEvent=function(e,t,i){this.agents[e][t]=i},DragListener.prototype.notify=function(e,t){var i=this.agents[this.currentAgentName];if(i){var a=i[e];if(a){var n=this.dragger?this.dragger.draggingObjs:null;a(t,n)}}},DragListener.prototype.isDragging=function(){return null!=this.currentAgentName},DragListener.prototype.setCurrentAgentName=function(e){this.currentAgentName=e},DragListener.prototype.getCurrentAgentName=function(){return this.currentAgentName};var invokeDragging=function(e){return function(t){e.dragging(t)}},invokeDraggingFinished=function(e){return function(t){e.draggingFinished(t)}};Dragger.prototype.addAnotherDraggingObject=function(e,t){e=e?e:event,this.draggingObjs[this.draggingObjs.length]=t,this.originalX[this.originalX.length]=parseInt(t.style.left),this.originalY[this.originalY.length]=parseInt(t.style.top),this.initDragger(e)},Dragger.prototype.initDragger=function(e){this.isDragging=!1,this.mouseX=e.clientX,this.mouseY=e.clientY,document.onmousemove=invokeDragging(this),document.onmouseup=invokeDraggingFinished(this)},Dragger.prototype.dragging=function(e){var t=e?e:event,i=!1,a=0,n=0;if(this.dragsX&&(a=t.clientX-this.mouseX,i=Math.abs(a)>this.sigMove),this.dragsY&&(n=t.clientY-this.mouseY,i=i||Math.abs(n)>this.sigMove),!this.isDragging&&i){this.isDragging=!0,this.dragListener&&this.dragListener.notify(DragListener.DRAGGING_STARTED,e);for(var r=0;r<this.draggingObjs.length;r++)this.draggingObjs[r].style.display="block"}if(this.isDragging){if(a){for(var r=0;r<this.draggingObjs.length;r++){parseInt(this.originalX[r]+a)}if(a)for(var r=0;r<this.draggingObjs.length;r++)this.draggingObjs[r].style.left=parseInt(this.originalX[r]+a)+"px"}if(n){for(var r=0;r<this.draggingObjs.length;r++){parseInt(this.originalY[r]+n)}if(n)for(var r=0;r<this.draggingObjs.length;r++)this.draggingObjs[r].style.top=parseInt(this.originalY[r]+n)+"px"}(a||n)&&this.dragListener.notify(DragListener.DRAGGING,e)}},Dragger.prototype.draggingFinished=function(e){document.onmousemove="default",document.onmouseup="default",this.isDragging?(this.isDragging=!1,this.cleanUpUtil&&this.cleanUpUtil(),this.dragListener&&(this.dragListener.notify(DragListener.DRAGGING_FINISHED,e),this.dragListener.setCurrentAgentName(null))):this.dragListener&&this.dragListener.setCurrentAgentName(null)},Dragger.prototype.clearDraggingObjects=function(){for(var e=0;e<this.draggingObjs.length;e++){var t=this.draggingObjs[e];t&&(t.parentNode&&t.parentNode.removeChild(t),t=null)}},define("tools.drag",["jquery","prototype"],function(e){return function(){var t;return t||e.Dragger}}(this)),define("domain/domainDesignerDisplayMain",["require","!domReady","underscore","domain.components","domain.designer.validators","jrs.configs","domain.designer.display.validators","tools.drag"],function(e){"use strict";var t=e("!domReady"),i=e("underscore"),a=e("domain.components"),n=e("domain.designer.validators"),r=e("jrs.configs");e("domain.designer.display.validators"),e("tools.drag"),t(function(){"undefined"==typeof window.localContext&&(window.localContext={}),i.extend(window.localContext,r.domainDesigner.localContext),i.extend(a._messages,r.domainDesigner.domain._messages),n.initialize()})});