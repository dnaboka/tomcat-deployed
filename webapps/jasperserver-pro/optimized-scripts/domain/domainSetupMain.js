var domain={PROPAGATE_EVENT:"propagateEvent",_messages:{},disabledFolderTooltip:"disabledFolderTooltip",attributesPattern:new RegExp("\\s*attribute\\s*\\(\\s*'[^\\/'\\s][^\\/']*'(?:\\s*,\\s*'[^\\/'\\s][^\\/']*')*\\s*\\)\\s*"),getMessage:function(e,t){var i=this._messages[e];return i?new Template(i).evaluate(t?t:{}):""},setMessage:function(e,t){this._messages[e]=t},treeErrorHandler:function(){throw"exception while loading tree"},submitForm:function(e,t,i){if(t){var a=buildActionUrl(t);i&&i(),$(e).writeAttribute("method","post").writeAttribute("action",a),$(e).submit()}},sendAjaxRequest:function(e,t,i,a){var o=buildActionUrl(e),d={postData:Object.toQueryString(t),callback:i,errorHandler:this._serverErrorHandler,mode:AjaxRequester.prototype.EVAL_JSON};a&&Object.extend(d,a),ajaxTargettedUpdate(o,d)},_serverErrorHandler:function(e,t){return baseErrorHandler(e)},elementClicked:function(e,t){return e&&t?matchAny(e,[t],!0):!1},basicClickHandler:function(e,t,i){var a=null;return t.any(function(t){return a=domain.elementClicked(e,t.key),a?(Object.isFunction(t.value)?t.value(a):Object.isFunction(i)&&i(t.value),!0):void 0})},registerClickHandlers:function(e,t,i){if(domain._bodyClickEventHandlers)return void(i?Array.prototype.unshift:Array.prototype.push).apply(domain._bodyClickEventHandlers,e);domain._bodyClickEventHandlers=e;var a=t?t:"body";$$(a)[0].observe(isSupportsTouch()?"touchstart":"click",function(e){var t=e.element();domain._bodyClickEventHandlers&&domain._bodyClickEventHandlers.each(function(i){var a=i(t);if(a)throw a!==domain.PROPAGATE_EVENT&&Event.stop(e),$break})})},enableButton:function(e,t){"string"==typeof e&&(e=$(e)),e.disabled=t,t?buttonManager.enable(e):buttonManager.disable(e)},setOptionsToSelect:function(e,t){return e&&(e.update(""),t)?(t.each(function(t){var i={value:t.value,title:t.label};t.selected&&(i.selected="selected");var a=new Element("option",i);a.appendChild(document.createTextNode(t.label)),e.appendChild(a)}),e):void 0},getDataIslandId:function(e,t){var i=dynamicTree.trees[e.getTreeId()].getRootNode(),a=function o(e,t){return null===e.parent||e.parent===i?e.param.extra[t]:o(e.parent,t)};return a(e,t)},areNodesFromSameIsland:function(e,t){var i=e.any(function(e){return e.param.extra.isConstant});if(i)return!0;var a=1===e.pluck("parent").uniq().length;return a?!0:1===e.map(function(e){return domain.getDataIslandId(e,t||"itemId")}).uniq().length},NumberFormat:function(e,t){var i="."===e,a=new RegExp("["+e.gsub(/\s/,"\\s")+"]+"),o=new RegExp("["+t.gsub(/\s/,"\\s")+"]+"),d=new RegExp("^-|\\"+t+"?\\d+|\\"+t+"$|\\"+e+"+","g");return{toNumber:function(e){return!e||!i&&/[.]/.test(e)?NaN:Number(e.gsub(o,"").gsub(a,"."))||domain.attributesPattern.test(e)},normalizeNumberEntry:function(i){var a=i.strip(),o=a.match(domain.attributesPattern)||a.match(d);if(!o)return"";for(var n=!1,s=0;s<o.length;s++)o[s].startsWith(e)?n?delete o[s]:(o[s]=e,n=!0):o[s].startsWith(t)&&n&&(o[s]=o[s].substring(1));var r=o.join("");return r},isInteger:function(e){return a.test(e)}}},baseValidator:function(e,t){var i=!0,a="";return e()&&(a=t,i=!1),{isValid:i,errorMessage:a}},maxLengthValidator:function(e,t,i){return domain.baseValidator(function(e,t){return e.length>t}.curry(e,t),i)},minLengthValidator:function(e,t,i){return domain.baseValidator(function(e,t){return e.length<t}.curry(e,t),i)},valueNotEmptyValidator:function(e,t){return domain.baseValidator(function(e){return Object.isArray(e)&&0===e.length||!e||!String(e).strip()}.curry(e),t)},stringIdValidator:function(e,t){return domain.baseValidator(function(e){return!/^[^0-9() .,'"=!+-\/><\/\/:][^() .,'"=!+-\/><\/\/:]*$/.test(e)}.curry(e),t)},numberValidator:function(e,t,i){return domain.baseValidator(isNaN.curry(t.toNumber(e)),i)},numberBoundsValidator:function(e,t,i){return domain.baseValidator(function(e,t){return e===1/0||e===-(1/0)?!0:!(e<=t.max&&e>=t.min)}.curry(e,t),i)},rangeValidator:function(e,t,i){return domain.baseValidator(function(e,t){return!(t>e)}.curry(e,t),i)},dateValidator:function(e,t,i){return domain.baseValidator(function(e,t){return 0===getDateFromFormat(t,e)&&!domain.attributesPattern.test(t)}.curry(t,e),i)},unescapeTree:function e(t){t.hasChilds()&&_.each(t.childs,function(t){e(t)}),t.name=xssUtil.unescape(t.name)}};domain.NodeCopyMoveController=function(){},domain.NodeCopyMoveController.addMethod("copy",function(e,t,i){if(e&&e.length>0&&t){var a=dynamicTree.trees[t.getTreeId()],o=e.collect(function(e){var o=e.param.id,d=this._copyParentStructure(e,a);return d?this._mergeToDestTree(d,t,o,i):null}.bind(this));return t.isloaded=!0,o.without(null)}}),domain.NodeCopyMoveController.addMethod("copySelected",function(e,t){return sourceTree&&t?this.copy(sourceTree.selectedNodes,t):void 0}),domain.NodeCopyMoveController.addMethod("move",function(e,t){if(e&&t){var i=this.copy(e,t);return this.hide(e),i}}),domain.NodeCopyMoveController.addMethod("moveSelected",function(e,t){return e&&t?this.move(e.selectedNodes,t):void 0}),domain.NodeCopyMoveController.addMethod("hide",function(e,t,i){if(e&&e.length>0){t||(t=this._getVisibleChildrenCount),i||(i=function(e,t){e.hide(t)});var a=dynamicTree.trees[e[0].getTreeId()];e.collect(function(e){return e.id}).each(function(e){var o=dynamicTree.nodes[e];i(o,!0);for(var d=o.parent;d&&d!=a.getRootNode()&&!(t(d)>0);)i(d,!1),d.refreshStyle(),d=d.parent}.bind(this))}}),domain.NodeCopyMoveController.addMethod("_handleDuplicatedNode",function(e,t){return e.param.id}),domain.NodeCopyMoveController.addMethod("_markAsLoaded",function(e){e.isloaded=!0,e.isParent()&&e.childs.each(function(e){this._markAsLoaded(e)}.bind(this))}),domain.NodeCopyMoveController.addMethod("_mergeToDestTree",function(e,t,i,a){if(t){var o=dynamicTree.trees[t.getTreeId()];if(a)return i=this._handleDuplicatedNode(e,t),o.findNodeById(i,e);var d=o.findNodeChildByMetaName(t,e.param.id);return null!=d?(d.isHidden()&&d.show(),e.hasChilds()&&(d.disabled&&d.enable(e.tooltip),e.childs.each(function(e){this._mergeToDestTree(e,d)}.bind(this))),o.findNodeById(i,d)):(t.addChild(e),this._markAsLoaded(e),o.findNodeById(i,e))}}),domain.NodeCopyMoveController.addMethod("_copyParentStructure",function(e,t){if(e&&t){var i=dynamicTree.trees[e.getTreeId()];if(e.disabled)return null;for(var a=this._copyNode(e,t,!0),o=e.parent,d=null;o&&o!=i.getRootNode();)d=this._copyNode(o,t,!1),d.addChild(a),a=d,o=o.parent;return a}}),domain.NodeCopyMoveController.addMethod("_buildMetanode",function(e){return deepClone(e.param)}),domain.NodeCopyMoveController.addMethod("_copyNode",function(e,t,i){if(e&&t){var a=t.processNode(this._buildMetanode(e));i&&(e.hasChilds()?e.childs.each(function(e){if(!e.disabled){var e=this._copyNode(e,t,i);e&&a.addChild(e)}}.bind(this)):a.setHasChilds(!1));var o=e.childs.findAll(function(e){return e.disabled});return e.childs.length>0&&o.length==e.childs.length?null:a}}),domain.NodeCopyMoveController.addMethod("_delete",function(e){e&&e.collect(function(e){return e.id}).each(function(e){var t=dynamicTree.nodes[e];t&&t.parent.removeChild(t)})}),domain.NodeCopyMoveController.addMethod("_getVisibleChildrenCount",function(e){var t=e.childs.findAll(function(e){return e.isHidden()});return e.childs.length-t.length}),domain.resetTreeSelectionHandler={_COMMON_ELEMENTS_TO_SAVE_SELECTION:["#pageDimmer","#detail","#standardConfirm"],_getTrees:null,_elementIds:null,_callback:null,_validator:null,init:function(e,t,i,a){domain.resetTreeSelectionHandler._init.bind(domain.resetTreeSelectionHandler,e,t,i,a)()},_init:function(e,t,i,a){this._getTrees=t,this._callback=i,this._validator=a,this._elementIds=this._COMMON_ELEMENTS_TO_SAVE_SELECTION.concat(e),domain.registerClickHandlers([this._removeTreeSelectionClickEventHandler.bind(this)],null,!0)},_removeTreeSelectionClickEventHandler:function(e){if(!matchAny(e,this._elementIds,!0)){var t=!1;return this._getTrees().each(function(e){if(e.selectedNodes&&e.selectedNodes.first())throw t=!0,$break}),t?this._validator&&!this._validator()?!0:(this._getTrees().each(function(e){e._deselectAllNodes()}),this._callback&&this._callback(),!1):!1}}},domain.NodeChangeOrderController=function(){},domain.NodeChangeOrderController.addMethod("findNodeWithSpecificOrder",function(e,t,i){for(var a=e.length-1;a>=0;a--)if(e[a].isSelected()==i&&e[a].orderNumber===t)return e[a];return null}),domain.NodeChangeOrderController.addMethod("findMaxSiblingNode",function(e,t,i){var a=null,o=null;return e.each(function(e){e.isSelected()==t&&(null===a||i==e.orderNumber<a)&&(a=e.orderNumber,o=e)}),o}),domain.NodeChangeOrderController.addMethod("moveNode",function(e,t,i,a){var o=e.orderNumber,d=e.parent.childs,n=null,s=null;i?(n=this.findMaxSiblingNode(d,!1,t,e.param.type),s=n?n.orderNumber:-1,d.each(function(i){i.param.id!==e.param.id&&(t==i.orderNumber>s&&t==i.orderNumber<o||i.orderNumber==s)&&(i.orderNumber=t?i.orderNumber+1:i.orderNumber-1,a&&a(i,i.orderNumber))}),a&&a(e,s),e.orderNumber=s):(s=t?e.orderNumber-1:e.orderNumber+1,n=this.findNodeWithSpecificOrder(d,s,!1),n&&(a&&a(e,s),a&&a(n,o),e.orderNumber=s,n.orderNumber=o))}),domain.NodeChangeOrderController.addMethod("nodeAscSorter",function(e,t){return e.orderNumber-t.orderNumber}),domain.NodeChangeOrderController.addMethod("nodeDescSorter",function(e,t){return t.orderNumber-e.orderNumber}),domain.DisplayNodeChangeOrderController=function(){domain.NodeChangeOrderController.call()},domain.DisplayNodeChangeOrderController.prototype=deepClone(domain.NodeChangeOrderController.prototype),domain.DisplayNodeChangeOrderController.addMethod("findMaxSiblingNode",function(e,t,i,a){var o=null,d=null;return e.each(function(e){e.isSelected()==t&&(null!==o&&i!=e.orderNumber<o||(a?e.param.type!==a:0)||(o=e.orderNumber,d=e))}),d}),define("domain.base",["jquery","underscore","backbone","utils.common"],function(e){return function(){var t;return t||e.domain}}(this)),domain.ItemNode=function(e){dynamicTree.TreeNode.call(this,e),this.Types={Folder:new dynamicTree.TreeNode.Type("ItemGroupType"),Leaf:new dynamicTree.TreeNode.Type("ItemType")},this.nodeHeaderTemplateDomId="list_responsive_collapsible_fields:fields",this._hidden=!1,this.disabled=!1},domain.ItemNode.prototype=deepClone(dynamicTree.TreeNode.prototype),domain.ItemNode.addMethod("hide",function(e){if(e&&this.hasChilds())for(var t=0;t<this.getChildCount();t++)this.childs[t].hide(!0);var i=(this.childs.findAll(function(e){return e.disabled}).length,this.childs.findAll(function(e){return e.isHidden()}).length),a=this.childs.length-i;this.disabled||0!==a?this.getType()===this.Types.Leaf&&(this.deselect(),this.disable(domain.getMessage(domain.disabledFolderTooltip))):(this._hidden=!0,this.deselect(),this.refreshStyle())}),domain.ItemNode.addMethod("show",function(){this._hidden=!1,this._getElement()&&this.refreshStyle(this._getElement())}),domain.ItemNode.addMethod("disable",function(e){e&&(this.tooltip=e),this.disabled=!0,this._getElement()&&this.refreshStyle(this._getElement())}),domain.ItemNode.addMethod("enable",function(e){e&&(this.tooltip=e),this.disabled=!1,this._getElement()&&this.refreshStyle(this._getElement())}),domain.ItemNode.addMethod("refreshStyle",function(e){if(e||(e=this._getElement())){dynamicTree.TreeNode.prototype.refreshStyle.call(this,e),this.isHidden()?e.addClassName(layoutModule.HIDDEN_CLASS):e.removeClassName(layoutModule.HIDDEN_CLASS);var t=e.select("p").first();t&&(this.tooltip?t.title=this.tooltip:t.title="",this.disabled?(buttonManager.disable(t),buttonManager.disable(e)):(buttonManager.enable(t),buttonManager.enable(e)))}}),domain.ItemNode.addMethod("isHidden",function(){return this._hidden}),domain.ItemNode.addMethod("toJSON",function(){var e=this.param.extra,t={id:this.param.id,label:this.name,type:this.param.type};return e&&(t.labelId=e.labelId||"",t.descr=e.descr,t.descrId=e.descrId||"",t.dataType=e.dataType||"",t.resourceId=e.resourceId),this.isParent()&&(t.children=_.chain(this.childs).filter(function(e){return!e.isHidden()}).invoke("toJSON").value()),t}),domain.ItemNode.addMethod("hasVisibleChilds",function(){return this.hasChilds()&&!!this.childs.find(function(e){return!e.isHidden()})}),domain.ItemNode.addMethod("hasEnabledChilds",function(){return this.hasChilds()&&!!this.childs.find(function(e){return!e.disabled})}),domain.ItemNode.addMethod("removeChilds",function(){this.hasChilds()&&this.childs.each(function(e){this.removeChild(e)}.bind(this))}),domain.FieldsCopyMoveController=function(){domain.NodeCopyMoveController(this)},domain.FieldsCopyMoveController.prototype=deepClone(domain.NodeCopyMoveController.prototype),domain.FieldsCopyMoveController.addMethod("_buildMetanode",function(e){var t=deepClone(e.param);return t.label=e.name,t.order=e.orderNumber,t.tooltip=e.tooltip,t}),domain.TwoColumnNode=function(e){dynamicTree.TreeNode.call(this,e),this.Types={Folder:new dynamicTree.TreeNode.Type("ItemGroupType",{}),Leaf:new dynamicTree.TreeNode.Type("ItemType",{})},this.nodeHeaderTemplateDomId="list_responsive:twoColumn"},domain.TwoColumnNode.prototype=deepClone(dynamicTree.TreeNode.prototype),domain.TwoColumnNode.addMethod("_createNode",function(){var e=this.id,t=(dynamicTree.trees[this.getTreeId()],this._getHeaderTemplateElement());t.id=this.NODE_ID_PREFIX+e,this.refreshStyle(t),t.treeNode=this;var i=t.childElements()[0];this.tooltip&&(i.title=this.tooltip);var a=i.childElements()[0];a.id=this.HANDLER_ID_PREFIX+e;var o=i.childElements()[1],d=this.param.extra&&this.param.extra.label?this.param.extra.label:this.name;o.insert(xssUtil.escape(d));var n=i.childElements()[2];n.insert(xssUtil.escape(this.name)),this._element=t}),domain.TwoColumnNode.addMethod("_getTitle",function(){var e=this._getElement().childElements()[0].childElements()[2];return e.cleanWhitespace(),0===e.childNodes.length&&e.appendChild(document.createTextNode("")),e.childNodes[0]}),domain.TwoColumnNode.addMethod("toJSON",function(){var e=this.param.extra,t={id:this.param.id,label:this.name,type:this.param.type,order:this.orderNumber.toString()};return e&&(t.labelId=e.labelId||"",t.dataType=e.dataType||"",t.resourceId=e.resourceId),this.isParent()&&(t.children=_.invoke(this.childs,"toJSON")),t}),domain.TwoColumnNode.addMethod("expandAllChilds",function(){var e=dynamicTree.trees[this.getTreeId()];this.isParent()&&!this.isOpen()&&(e.writeStates(this.id,dynamicTree.TreeNode.State.OPEN),this.refreshNode()),this.hasChilds()&&this.childs.each(function(e){e.expandAllChilds()})}),domain.TablesNode=function(e){dynamicTree.TreeNode.call(this,e),this.Types={Folder:new dynamicTree.TreeNode.Type("level"),Leaf:new dynamicTree.TreeNode.Type("item")},this.nodeHeaderTemplateDomId="list_responsive_collapsible_type_tables:tables"},domain.TablesNode.prototype=deepClone(domain.ItemNode.prototype),domain.TablesNode.addMethod("toJSON",function(){var e=this.param.extra,t={id:this.param.id,label:this.name,type:this.param.type};return e&&(t.originalId=e.originalId,t.datasourceId=e.datasourceId,t.repoId=e.repoId,t.itemId=e.itemId,t.dataSource=e.dataSource,t.table=e.table,this.isParent()?(t.query=e.query,t.dataSetType=e.dataSetType):(t.expression=e.expression,t.islandId=e.islandId,t.isConstant=e.isConstant,t.JavaType=e.JavaType,t.JdbcType=e.JdbcType),e.fieldDbName&&(t.fieldDbName=e.fieldDbName)),this.isParent()&&(t.children=_.chain(this.childs).filter(function(e){return!e.isHidden()}).invoke("toJSON").value()),t}),domain.TablesNode.addVar("CONSTANT_TABLE_ID","constant_fields_level"),domain.TablesNode.addVar("CROSSTABLES_FIELDS_TABLE_ID","crossTablesFieldsLevel"),domain.TablesNode.addVar("INVALID_NODE_CLASS","invalid"),domain.TablesNode.addVar("DATA_ISLAND_CLASS","dataIsland"),domain.TablesNode.addVar("DERIVED_TABLE_CLASS","table derived"),domain.TablesNode.addVar("CONSTANT_TABLE_CLASS","table constant"),domain.TablesNode.addVar("CALCULATED_FIELD_CLASS","field calculated"),domain.TablesNode.addMethod("refreshStyle",function(e){(e||(e=this._getElement()))&&(domain.ItemNode.prototype.refreshStyle.call(this,e),this.param.extra&&"true"===this.param.extra.isInvalid?e.addClassName(this.INVALID_NODE_CLASS):e.removeClassName(this.INVALID_NODE_CLASS),this.param.extra&&this.param.extra.expression&&e.addClassName(this.CALCULATED_FIELD_CLASS),this.param.extra&&this.param.extra.query&&e.addClassName(this.DERIVED_TABLE_CLASS),this.param.id===this.CONSTANT_TABLE_ID&&e.addClassName(this.CONSTANT_TABLE_CLASS),this.param.extra&&this.param.extra.isIsland&&e.addClassName(this.DATA_ISLAND_CLASS))}),domain.TablesNode.addMethod("edit",function(e){e&&"dblclick"!==e.type||domain.ItemNode.prototype.edit.call(this,e)}),domain.TablesCustomNode=function(e){domain.TablesNode.call(this,e),this.nodeHeaderTemplateDomId=e.param.type===this.Types.Folder.name?"list_responsive_collapsible_type_tables:tables":"list_responsive_collapsible_type_tables:fields"},domain.TablesCustomNode.prototype=deepClone(domain.TablesNode.prototype),domain.TablesCopyMoveController=function(){domain.NodeCopyMoveController(this)},domain.TablesCopyMoveController.prototype=deepClone(domain.NodeCopyMoveController.prototype),domain.TablesCopyMoveController.addMethod("_buildMetanode",function(e){var t={id:e.param.id,label:e.name,type:e.param.type,uri:e.param.uri};return e.param.extra&&(t.extra={originalId:e.param.extra.originalId,table:e.param.extra.table,itemId:e.param.extra.itemId,datasourceId:e.param.extra.datasourceId,repoId:e.param.extra.repoId,dataSource:e.param.extra.dataSource,dataSetType:e.param.extra.dataSetType,query:e.param.extra.query},e.param.extra.expression&&(t.extra.expression=e.param.extra.expression),e.param.extra.fieldDbName&&(t.extra.fieldDbName=e.param.extra.fieldDbName),e.isParent()||(t.extra.JavaType=e.param.extra.JavaType,t.extra.JdbcType=e.param.extra.JdbcType,t.extra.sourceItem=e.parent.param.extra.originalId)),t}),domain.TablesCopyMoveController.addMethod("_handleDuplicatedNode",function(e,t){if(e.isParent()){for(var i=1,a=e.param.extra.datasourceId+"."+e.param.extra.itemId+i,o=dynamicTree.trees[t.getTreeId()];o.findNodeChildByMetaName(t,a);)i++,a=e.param.extra.datasourceId+"."+e.param.extra.itemId+i;return e.param.id=a,e.param.extra.itemId+=i,e.name=e.param.extra.itemId,e.param.extra.originalId=e.param.extra.itemId,t.addChild(e),e.isloaded=!0,e.hasChilds()&&e.childs.each(function(t){this._handleDuplicatedNode(t,e)}.bind(this)),a}e.param.id=e.parent.param.id+"."+e.param.extra.itemId,e.param.extra.originalId=e.parent.param.extra.originalId+"."+e.param.extra.itemId}),domain.DerivedTablesNode=function(e){domain.TablesNode.call(this,e),e.param.type===this.Types.Folder.name&&e.param.extra&&e.param.extra.query&&(this.isSelectable=!0)},domain.DerivedTablesNode.prototype=deepClone(domain.TablesNode.prototype),domain.JoinsList=function(e,t){dynamicList.List.call(this,e,t)},domain.JoinsList.prototype=deepClone(dynamicList.List.prototype),domain.JoinsList.addMethod("_changeHandler",function(e){var t=this.getItemByEvent(e);t&&(t._respondOnItemEvents&&!e.isInvoked&&this.fire("item:change",{targetEvent:e,item:t}),e.isInvoked=!0)}),domain.JoinsList.addMethod("_initEvents",function(){dynamicList.List.prototype._initEvents.call(this);var e=this._getElement();jQuery(e).off("change").on("change","select",_.bind(this._changeHandler,this))}),domain.JoinsListItem=function(e){dynamicList.ListItem.call(this,e),this._hidden=!1},domain.JoinsListItem.prototype=deepClone(dynamicList.ListItem.prototype),domain.JoinsListItem.addMethod("hide",function(e){this._hidden=!!e,this.refreshStyle()}),domain.JoinsListItem.addMethod("refreshStyle",function(){dynamicList.ListItem.prototype.refreshStyle.call(this),this._getElement()&&(this._hidden?this._getElement().addClassName(layoutModule.HIDDEN_CLASS):this._getElement().removeClassName(layoutModule.HIDDEN_CLASS))}),domain.JoinsListItem.addMethod("processTemplate",function(e){var t=e.childElements()[0];t.cleanWhitespace();var i=t.childElements()[1],a=t.childElements()[2],o=t.childElements()[3],d=o.childElements()[0],n=d.childElements();return i.update(xssUtil.escape(this._value.left.table.label)+":"+xssUtil.escape(this._value.left.label)),a.update(xssUtil.escape(this._value.right.table.label)+":"+xssUtil.escape(this._value.right.label)),n.each(function(e){e.selected=e.value===this._value.type}.bind(this)),e}),domain.JoinsListItem.addMethod("setJoinType",function(e){this.getValue().type=e;var t=this._getElement();if(t){var i=t.childElements()[0].childElements()[3].childElements()[0];$(i).value=e}}),domain.JoinsListItem.addMethod("toJSON",function(){return{left:this._value.left.id,right:this._value.right.id,type:this._value.type}}),domain.DisplayNode=function(e){domain.ItemNode.call(this,e),this.Types={Folder:new dynamicTree.TreeNode.Type("ItemGroupType"),Leaf:new dynamicTree.TreeNode.Type("ItemType")},this.nodeHeaderTemplateDomId="list_responsive_collapsible_type_sets:sets"},domain.DisplayNode.prototype=deepClone(domain.ItemNode.prototype),domain.DisplayNode.addMethod("toJSON",function(){var e=this.param.extra,t={id:this.param.id,type:this.param.type};return e&&(t.itemId=e.itemId,t.descr=e.descr,t.labelId=e.labelId||"",t.descrId=e.descrId||"",t.resourceId=e.resourceId||""),e&&e.label&&(t.label=e.label),this.isParent()?t.children=_.chain(this.childs).filter(function(e){return!e.isHidden()&&!e._markAsDeleted}).invoke("toJSON").value():(t.dataType=e.dataType,t.dimensionOrMeasure=e.dimensionOrMeasure,t.defaultMask=e.defaultMask,t.defaultAgg=e.defaultAgg),t}),domain.DisplayNode.addVar("INVALID_NODE_CLASS","invalid"),domain.DisplayNode.addMethod("refreshStyle",function(e){(e||(e=this._getElement()))&&(domain.ItemNode.prototype.refreshStyle.call(this,e),this.param.extra&&"true"===this.param.extra.isInvalid?e.addClassName(this.INVALID_NODE_CLASS):e.removeClassName(this.INVALID_NODE_CLASS))}),domain.genericTreeParams={rootUri:"/",showRoot:!1,nodeClass:domain.ItemNode,treeClassName:"",multiSelectEnabled:!0},domain.createItemsTree=function(e){return e=Object.extend(deepClone(domain.genericTreeParams),e),new dynamicTree.TreeSupport(e.treeId,e)},domain.confirmDialog={MODE_OK_CANCEL:"okCancel",MODE_YES_NO:"yesNo",_CONFIRM_DIALOG_DOM_ID:"standardConfirm",_CONFIRM_DIALOG_BODY_DOM_PATTERN:"#standardConfirm > .content > .body",_CONFIRM_DIALOG_OK_BUTTON_ID:"#confirmYes",_CONFIRM_DIALOG_CANCEL_BUTTON_ID:"#confirmNo",_CONFIRM_DIALOG_OK_PATTERN:"#confirmYes > span",_CONFIRM_DIALOG_CANCEL_PATTERN:"#confirmNo > span",_yesMessageHolder:null,_noMessageHolder:null,_dialog:null,_onOk:null,_onCancel:null,_customEventHandler:null,_templateDomId:null,_visible:!1,init:function(){domain.confirmDialog._init.bind(domain.confirmDialog)()},show:function(e,t,i,a,o){domain.confirmDialog._show.bind(domain.confirmDialog,e,t,i,a,o)()},hideForDetails:function(){dialogs.popup.hide(domain.confirmDialog._dialog)},showFromDetails:function(){dialogs.popup.show(domain.confirmDialog._dialog,!0)},visible:function(){return domain.confirmDialog._visible},_init:function(){this._dialog=$(this._CONFIRM_DIALOG_DOM_ID),this._yesMessageHolder=$$(this._CONFIRM_DIALOG_OK_PATTERN).first(),this._noMessageHolder=$$(this._CONFIRM_DIALOG_CANCEL_PATTERN).first(),domain.registerClickHandlers([this._clickEventHandler.bind(this)])},_show:function(e,t,i,a,o){this._onOk=t,this._onCancel=i,this._customEventHandler=a,this._templateDomId=e,o&&o==this.MODE_YES_NO?(this._yesMessageHolder.update(domain.getMessage("yes")),this._noMessageHolder.update(domain.getMessage("no"))):(this._yesMessageHolder.update(domain.getMessage("ok")),this._noMessageHolder.update(domain.getMessage("cancel"))),$(this._templateDomId).removeClassName(layoutModule.HIDDEN_CLASS),dialogs.popup.show(this._dialog,!0),this._visible=!0},_hide:function(e){$(this._templateDomId).addClassName(layoutModule.HIDDEN_CLASS),dialogs.popup.hide(this._dialog),this._visible=!1,e&&e()},_clickEventHandler:function(e){return domain.elementClicked(e,this._CONFIRM_DIALOG_OK_BUTTON_ID)?(this._hide(this._onOk),!0):domain.elementClicked(e,this._CONFIRM_DIALOG_CANCEL_BUTTON_ID)?(this._hide(this._onCancel),!0):this._customEventHandler?this._customEventHandler(e):void 0}},domain.detailsDialog={_DETAIL_DIALOG_DOM_ID:"detail",_DETAIL_DIALOG_CLOSE_BUTTON_ID:"#close",_DETAIL_DIALOG_LIST_DOM_ID:"detailsList",_DETAIL_DIALOG_TEXT_DOM_ID:"detailsText",_LIST_TEMPLATE:"defaultListTemplate",_LIST_ITEM_TEMPLATE:"dynamicListItemTemplate",_dialog:null,_showConfirmAfterClose:!1,_list:null,_listItems:null,init:function(){domain.detailsDialog._init.bind(domain.detailsDialog)()},show:function(e){domain.detailsDialog._show.bind(domain.detailsDialog,e)()},_init:function(){this._dialog=$(this._DETAIL_DIALOG_DOM_ID),domain.registerClickHandlers([this._clickEventHandler.bind(this)])},_show:function(e){domain.confirmDialog.visible()?(domain.confirmDialog.hideForDetails(),this._showConfirmAfterClose=!0):this._showConfirmAfterClose=!1,this._createMessage(e),dialogs.popup.show(this._dialog,!0),$(this._DETAIL_DIALOG_LIST_DOM_ID).parentNode.scrollTop=0},_createMessage:function(e){"string"==typeof e?($(this._DETAIL_DIALOG_LIST_DOM_ID).addClassName(layoutModule.HIDDEN_CLASS),$(this._DETAIL_DIALOG_TEXT_DOM_ID).removeClassName(layoutModule.HIDDEN_CLASS).update(e)):($(this._DETAIL_DIALOG_TEXT_DOM_ID).addClassName(layoutModule.HIDDEN_CLASS),$(this._DETAIL_DIALOG_LIST_DOM_ID).removeClassName(layoutModule.HIDDEN_CLASS),this._items&&(this._list.removeItems(this._items),this._items=null,this._list=null),this._items=e.collect(function(e){return new dynamicList.ListItem({label:e})}),this._list=new dynamicList.List(this._DETAIL_DIALOG_LIST_DOM_ID,{listTemplateDomId:this._LIST_TEMPLATE,itemTemplateDomId:this._LIST_ITEM_TEMPLATE,items:this._items}),this._list.show())},_close:function(){dialogs.popup.hide(this._dialog),this._showConfirmAfterClose&&domain.confirmDialog.showFromDetails()},_clickEventHandler:function(e){return domain.elementClicked(e,this._DETAIL_DIALOG_CLOSE_BUTTON_ID)?(this._close(),!0):void 0}},define("domain.components",["domain.base","dynamicTree.utils","components.list"],function(e){return function(){var t;return t||e.domain}}(this)),define("text!domain/template/domainUsedResourcesTemplate.htm",[],function(){return"<table class='usedResources'>\n    <thead>\n        <tr>\n            <th>{{- fieldLabel }}</th>\n            <th>{{- resourceLabel }}</th>\n        </tr>\n    </thead>\n    <tbody>\n        {{ _.each(usedResources, function(usedResource, index) { }}\n        <tr>\n            <td>{{- usedResource.field }}</td>\n            <td><a target='_blank' href='{{- contextPath }}/flow.html?_flowId=adhocFlow&resource={{- encodeURIComponent(usedResource.resource) }}'>{{- usedResource.resource }}</a></td>\n        </tr>\n        {{ }); }}\n    </tbody>\n</table>"}),define("domain/domainUtil",["require","underscore","jrs.configs","text!./template/domainUsedResourcesTemplate.htm"],function(e){"use strict";function t(e){return new RegExp(e.replace(".","\\.").replace("]","\\]").replace("[","\\[").replace("{0}","(\\S+)").replace("{1}","(\\S+)"),"g")}var i=e("underscore"),a=e("jrs.configs"),o=i.template(e("text!./template/domainUsedResourcesTemplate.htm"));return window.domainUtil={getUsedResourcesList:function(e,i){for(var a,o=t(i),d=[];a=o.exec(e);)d.push({field:a[1],resource:a[2]});return d},indexOfNoAccessMessage:function(e,t){return e.indexOf(t)},getUsedResourcesFormattedMessage:function(e,t,i){if(!e.length)return t;var d=i.ITEM_BEING_USED_BY_RESOURCE.split("{0}")[0],n=t.split(d)[0],s=n+o({contextPath:a.contextPath,usedResources:e,resourceLabel:i["resource.label"],fieldLabel:i["field.label"]});return this.indexOfNoAccessMessage(t,i.resourcesWithNoAccess)>-1&&(s+="<br/>"+i.resourcesWithNoAccess),s}},window.domainUtil}),domain.wizard={securityFile:null,bundles:null,bundleList:null,bundleExtention:".properties",selectSecurityDialog:null,selectBundleDialog:null,isDataSourceValid:!0,organizationId:null,publicFolderUri:null,STEP_DISPLAY_FORM:"pageForm",INPUT_DS:"dataSourceInput",LAUNCH_DD:"launchDD",CREATE_RADIO:"schemaCreateRadio",UPLOAD_RADIO:"schemaUploadRadio",BROWSER_BUTTON:"browser_button",DATA_SOURCE_BROWSER_BUTTON:"ds_browser_button",SCHEMA_UPLOAD:"schemaUpload",LAUNCHER:"launcher",RESOURCE_ALREADY_EXISTS:"resource already exists",ADD_BUNDLE_LEAF:"addBundleLeaf",INPUT_SL_NAME:"slName",INPUT_SL_RESOURCE_ID:"slResourceID",SCHEMA_DESCRIPTION:"slDescription",SCHEMA_LOCATION:"schemaLocation",SCHEMA_LOCATION_HIDDEN:"slLocation",BUTTON_SAVE:"done",BUTTON_CANCEL:"cancel_button",_canGenerateId:!0,initialize:function(){function e(){null!=domain.wizard.securityFile&&domain.wizard.updateSecurityFileUI()}function t(){for(var e=[],t=0;t<domain.wizard.bundles.length;t++)e.push(new dynamicList.ListItem({label:domain.wizard.bundles[t],value:domain.wizard.bundles[t],respondOnItemEvents:!1}));e.each(function(e){e.processTemplate=function(e){return e.select("p.one > a")[0].update(xssUtil.escape(this._value)),e.select("p.two > a")[0].update(xssUtil.escape(domain.getMessage("CSLD_CHANGE_LINK"))),e.select("p.two > a")[1].update(xssUtil.escape(domain.getMessage("CSLD_REMOVE_LINK"))),e}}),domain.wizard.bundleList=new dynamicList.List("bundlesList",{listTemplateDomId:"list_domain_bundles",itemTemplateDomId:"list_domain_bundles:leaf",items:e}),domain.wizard.bundleList.show()}if(webHelpModule.setCurrentContext("domain"),domain.confirmDialog.init(),domain.detailsDialog.init(),this._label=$(this.INPUT_SL_NAME),this._resourceId=$(this.INPUT_SL_RESOURCE_ID),this._description=$(this.SCHEMA_DESCRIPTION),this._label.validator=resource.labelValidator.bind(this),this._resourceId.validator=resource.resourceIdValidator.bind(this),this._description.validator=resource.descriptionValidator.bind(this),this._isEditMode="edit"==domain.wizard.mode,$(this.STEP_DISPLAY_FORM).observe("keyup",function(e){var t=e.element(),i=[this._label,this._resourceId,this._description];i.include(t)&&(ValidationModule.validate(resource.getValidationEntries([t])),t==this._resourceId&&this._resourceId.getValue()!=resource.generateResourceId(this._label.getValue())&&(this._canGenerateId=!1),t==this._label&&!this._isEditMode&&this._canGenerateId&&(this._resourceId.setValue(resource.generateResourceId(this._label.getValue())),ValidationModule.validate(resource.getValidationEntries([this._resourceId]))))}.bindAsEventListener(this)),$(this.STEP_DISPLAY_FORM).observe("click",function(e){var t=e.element(),i=matchAny(t,[layoutModule.BUTTON_PATTERN],!0);if(i){if(i.match("#"+this.BUTTON_SAVE)&&!i.hasAttribute(layoutModule.DISABLED_ATTR_NAME))return this.saveSchema(),void e.stop();if(i.match("#"+this.BUTTON_CANCEL))return this.exit(),void e.stop()}if(t.match("#"+this.LAUNCH_DD)&&!t.hasAttribute(layoutModule.DISABLED_ATTR_NAME))return void this.launchDomainDesigner();if(t.match("#"+this.CREATE_RADIO))return this.disableUploadSchema(),void this.enableCreateLink();if(t.match("#"+this.UPLOAD_RADIO))return domain.wizard.enableUploadSchema(),void domain.wizard.disableCreateLink();if(t.match("a#addSecurityLink"))return void this.addSecurityFile();if(t.match("p.one > a")){if(matchMeOrUp(t,"#securityFileLeaf"))return void this.downloadSecurityFile();if(matchMeOrUp(t,"#bundlesList"))return void this.downloadBundle(t.up("li"))}return t.match("p.two > a")?void(matchMeOrUp(t,"#securityFileLeaf")?t.previous("a")?this.removeSecurityFile():this.changeSecurityFile():matchMeOrUp(t,"#bundlesList")&&(t.previous("a")?this.removeBundle(t.up("li")):this.changeBundle(t.up("li")))):void(t.match("a#addBundleLink")&&this.addBundle())}.bindAsEventListener(this)),jQuery("#"+this.STEP_DISPLAY_FORM).on("submit",function(e){e.preventDefault()}),$(this.INPUT_SL_NAME).observe("change",this.onNameChange.bind(this)),$(this.SCHEMA_LOCATION).observe("change",this.onLocationChange.bind(this)),$(this.INPUT_DS).observe("change",this.updateDataSourceUri.bind(this)),$(this.SCHEMA_UPLOAD).observe("change",this._uploadSchema.bind(this)),!this.firstLoad){var i=$(this.INPUT_DS);this.selectedDatasourcesUri.length>0&&(i.value=this.selectedDatasourcesUri[0])}this.dataSourceSelector=new picker.FileSelector({treeId:"addResourceTreeRepoLocation",providerId:"repositoryTreeDatasourceProvider",uriTextboxId:this.INPUT_DS,
browseButtonId:this.DATA_SOURCE_BROWSER_BUTTON,onOk:this.updateDataSourceUri.bind(this),title:domain.getMessage("CSLD_SELECT_DS_FROM_REPO"),selectLeavesOnly:!0,suffix:"_DataSourcePicker",treeOptions:{organizationId:this.organizationId,publicFolderUri:this.publicFolderUri}}),this.selectSecurityDialog=new SelectFileDialog({idSuffix:"_security"}),this.selectBundleDialog=new SelectFileDialog({idSuffix:"_bundle"}),this.folderSelector=new picker.FileSelector({treeId:"addResourceTreeRepoLocation",providerId:"repositoryTreeFoldersProvider",uriTextboxId:this.SCHEMA_LOCATION,browseButtonId:this.BROWSER_BUTTON,onOk:this.onLocationChange.bind(this),title:domain.getMessage("CSLD_SAVE_DS_DIALOG_TITLE"),disabled:"create"!==this.mode,suffix:"_LocationPicker",treeOptions:{organizationId:this.organizationId,publicFolderUri:this.publicFolderUri}}),$H({repositoryTreeSecurityProvider:this.selectSecurityDialog,repositoryTreeBundleProvider:this.selectBundleDialog}).each(function(e){e.value.tree=dynamicTree.createRepositoryTree(e.value.treeLocationId,{providerId:e.key,organizationId:this.organizationId,publicFolderUri:this.publicFolderUri}),e.value.tree.showTree(1)}.bind(this)),e(),t(),this.refreshSchemaArea(),this.refreshSaveButton()},onNameChange:function(){ValidationModule.hideError($(this.INPUT_SL_NAME)),this.refreshSaveButton()},onLocationChange:function(){ValidationModule.hideError($(this.SCHEMA_LOCATION)),$(this.SCHEMA_LOCATION_HIDDEN).setValue($F(this.SCHEMA_LOCATION)),this.refreshSaveButton()},refreshSaveButton:function(){var e=this.getDataSource();$(this.INPUT_SL_NAME).getValue().length>0&&$(this.SCHEMA_LOCATION).getValue().length>0&&e&&e.uri.length>0&&this.isSchemaSet&&this.isDataSourceValid?domain.enableButton(this.BUTTON_SAVE,!0):domain.enableButton(this.BUTTON_SAVE,!1)},getDataSource:function(){var e=$F(this.INPUT_DS);return 0===e.length?{uri:"",name:""}:e.startsWith("/")&&e.split("/").last()?{uri:e,name:e.split("/").last()}:!1},checkDataSource:function(e,t){var i=function(e){"success"===e?(this.isDataSourceValid=!0,t&&t()):(ValidationModule.showError($(this.INPUT_DS),domain.getMessage("CSLD_DATA_SOURCE_IS_INVALID")),this.isDataSourceValid=!1,this.refreshSchemaArea(),this.refreshSaveButton())}.bind(this),a={datasources:"['"+xssUtil.escape(e.uri)+"']"};this._sendInfo("checkDataSource",a,i)},updateDataSourceUri:function(){var e=function(e){this._sendInfo("convertTablesToVds",{prependSubDsId:e},function(){dialogs.systemConfirm.show(domain.getMessage("CSLD_SCHEMA_PREFIXES_UPDATED"))})}.bind(this),t=function(e){this._sendInfo("convertTablesFromVds",{removeSubDsId:e},function(){dialogs.systemConfirm.show(domain.getMessage("CSLD_SCHEMA_PREFIXES_UPDATED"))})}.bind(this),i=this.getDataSource();if(ValidationModule.hideError($(this.INPUT_DS)),this.refreshSchemaArea(),this.refreshSaveButton(),!i)return void ValidationModule.showError($(this.INPUT_DS),domain.getMessage("CSLD_DATA_SOURCE_IS_INVALID"));if(i.uri){var a=function(){var a={datasources:"['"+i.uri+"']",mappedDatasources:"[{'"+i.name+"':'"+i.uri+"'}]"},o=function(a){a.prependSubDsId?domain.confirmDialog.show("convertPrefixToVdsConfirmMessage",function(){e(a.prependSubDsId)},null,null,domain.confirmDialog.MODE_YES_NO):a.removeSubDsId&&domain.confirmDialog.show("convertPrefixFromVdsConfirmMessage",function(){t(a.removeSubDsId)},null,null,domain.confirmDialog.MODE_YES_NO),a.isSchemaSet&&(this.isSchemaSet=!0),this.selectedDatasourcesUri=[i.uri],dialogs.systemConfirm.show(domain.getMessage("CSLD_DATA_SOURCE_IS_SET")),this.refreshSchemaArea(),this.refreshSaveButton()}.bind(this);this._sendInfo("setDatasources",a,o)}.bind(this);this.checkDataSource(i,a)}},enableSchemaArea:function(){$(domain.wizard.CREATE_RADIO).removeAttribute(layoutModule.DISABLED_ATTR_NAME),$(domain.wizard.UPLOAD_RADIO).removeAttribute(layoutModule.DISABLED_ATTR_NAME),$(domain.wizard.LAUNCH_DD).removeAttribute(layoutModule.DISABLED_ATTR_NAME),$(domain.wizard.UPLOAD_RADIO).checked&&$(domain.wizard.SCHEMA_UPLOAD).removeAttribute(layoutModule.DISABLED_ATTR_NAME)},disableSchemaArea:function(){$(domain.wizard.CREATE_RADIO).setAttribute(layoutModule.DISABLED_ATTR_NAME,layoutModule.DISABLED_ATTR_NAME),$(domain.wizard.UPLOAD_RADIO).setAttribute(layoutModule.DISABLED_ATTR_NAME,layoutModule.DISABLED_ATTR_NAME),$(domain.wizard.LAUNCH_DD).setAttribute(layoutModule.DISABLED_ATTR_NAME,layoutModule.DISABLED_ATTR_NAME),$(domain.wizard.SCHEMA_UPLOAD).setAttribute(layoutModule.DISABLED_ATTR_NAME,layoutModule.DISABLED_ATTR_NAME)},refreshSchemaArea:function(){var e=this.getDataSource();e&&e.uri.length>0&&this.isDataSourceValid?this.enableSchemaArea():this.disableSchemaArea()},enableCreateLink:function(){$(domain.wizard.LAUNCH_DD).removeClassName(layoutModule.DISABLED_CLASS).addClassName(domain.wizard.LAUNCHER)},disableCreateLink:function(){$(domain.wizard.LAUNCH_DD).removeClassName(domain.wizard.LAUNCHER).addClassName(layoutModule.DISABLED_CLASS)},enableUploadSchema:function(){$(domain.wizard.SCHEMA_UPLOAD).removeAttribute(layoutModule.DISABLED_ATTR_NAME)},disableUploadSchema:function(){$(domain.wizard.SCHEMA_UPLOAD).setAttribute(layoutModule.DISABLED_ATTR_NAME,layoutModule.DISABLED_ATTR_NAME)},launchDomainDesigner:function(){var e=$(domain.wizard.STEP_DISPLAY_FORM);e.action="flow.html?_flowId=createSLDatasourceFlow",e.method="post",e.enctype="multipart/form-data",e._eventId.value=domain.wizard.isSchemaSet?"editSchema":"createSchema",e.submit()},addSecurityFile:function(){domain.wizard.showSelectResourceFromRepository({fileType:"security",mode:"add"})},downloadSecurityFile:function(){var e={securityFile:domain.wizard.securityFile,_flowExecutionKey:domain.wizard.flowExecutionKey,_eventId:"downloadFile"},t="flow.html?"+Object.toQueryString(e);ajaxIframeDownload(t)},changeSecurityFile:function(){domain.wizard.showSelectResourceFromRepository({fileType:"security",mode:"edit"})},removeSecurityFile:function(){var e={securityUri:domain.wizard.securityFile},t=function(e){e.result?(domain.wizard.securityFile=null,dialogs.systemConfirm.show(domain.getMessage("CSLD_SECURITY_FILE_IS_REMOVED")),$("securityFileLeaf").addClassName("hidden"),$("noSecurityFileLeaf").removeClassName("hidden")):dialogs.systemConfirm.show(domain.getMessage("error"))}.bind(this);domain.wizard._sendInfo("deleteSecurity",e,t)},updateSecurityFileUI:function(){var e=$("securityFileLeaf");e.removeClassName("hidden"),$("noSecurityFileLeaf").addClassName("hidden"),e.select("p.one > a")[0].update(domain.wizard.securityFile),e.select("p.two > a")[0].update(domain.getMessage("CSLD_CHANGE_LINK")),e.select("p.two > a")[1].update(domain.getMessage("CSLD_REMOVE_LINK"))},addBundle:function(){domain.wizard.showSelectResourceFromRepository({fileType:"bundle",mode:"add"})},changeBundle:function(e){domain.wizard.showSelectResourceFromRepository({fileType:"bundle",mode:"edit",oldUri:e.listItem.getValue(),oldId:e.listItem.getId()})},downloadBundle:function(e){var t={bundle:e.listItem.getValue(),_flowExecutionKey:domain.wizard.flowExecutionKey,_eventId:"downloadFile"},i="flow.html?"+Object.toQueryString(t);ajaxIframeDownload(i)},removeBundle:function(e){var t=e.listItem.getValue(),i=[];i.push(t);var a={deletedBundles:"['"+i.join("','")+"']"},o=function(t){if(t.result){for(var i=e.listItem.getValue(),a=0;a<domain.wizard.bundles.length;a++)if(i==domain.wizard.bundles[a]){domain.wizard.bundles.splice(a,1);break}e.listItem.remove(),dialogs.systemConfirm.show(domain.getMessage("CSLD_BUNDLE_REMOVED"))}else dialogs.systemConfirm.show(domain.getMessage("error"))}.bind(this);domain.wizard._sendInfo("deleteBundle",a,o)},showSelectResourceFromRepository:function(e){var t,i,a=null;"security"==e.fileType?(i="add"==e.mode?domain.getMessage("CSLD_ADD_SECURITY_FILE"):domain.getMessage("CSLD_CHANGE_SECURITY_FILE"),t=domain.wizard.selectSecurityDialog,a=domain.wizard._uploadSecurity):"bundle"==e.fileType&&(i="add"==e.mode?domain.getMessage("CSLD_ADD_BUNDLE_FILE"):domain.getMessage("CSLD_CHANGE_BUNDLE_FILE"),t=domain.wizard.selectBundleDialog,a=domain.wizard._uploadBundle),t.title.update(i),t.filePath.value="",t.tree._deselectAllNodes(),t.fromLocalRadio.checked=!0,ValidationModule.hideError(t.filePath),ValidationModule.hideError(t.fromRepoRadio),this.fromLocalHandler(t),t.show(),t.selectedFileClickSelect=function(){a(this,e)&&t.hide()}},fromLocalHandler:function(e){"local"!==e.mode&&(e.mode="local",e.filePath.removeAttribute(layoutModule.DISABLED_ATTR_NAME),e.lastSelectedNode=e.tree.selectedNodes.first(),e.tree._deselectAllNodes(),e.tree._getElement().setAttribute(layoutModule.DISABLED_ATTR_NAME,layoutModule.DISABLED_ATTR_NAME),e.fromLocalRadio.checked=!0)},fromRepoHandler:function(e){"repo"!==e.mode&&(e.mode="repo",e.tree._getElement().removeAttribute(layoutModule.DISABLED_ATTR_NAME),e.lastSelectedNode&&e.lastSelectedNode.select(),e.filePath.setAttribute(layoutModule.DISABLED_ATTR_NAME,layoutModule.DISABLED_ATTR_NAME),e.fromRepoRadio.checked=!0)},isCorrectBundle:function(e){var t;return e.endsWith(this.bundleExtention)?domain.wizard.bundles.length>0&&(t=domain.wizard.getFileName(domain.wizard.bundles[0]),!domain.wizard.isSameBaseName(t,e))?domain.getMessage("notSameBaseName"):null:domain.getMessage("notCorrectBundleFileType")},isSameBaseName:function(e,t){var i,a=this.getBundleSuffix(e),o=this.getBundleSuffix(t);i=e.length-a.length-this.bundleExtention.length;var d=e.substr(0,i);i=t.length-o.length-this.bundleExtention.length;var n=t.substr(0,i);return d==n},getBundleSuffix:function(e){var t=new RegExp(".*(?:(?:[_])([a-z][a-z]))(?:[_]){0,1}([A-Z][A-Z]){0,1}(?:(?:[_])([^_]*)){0,1}.properties"),i=t.exec(e);if(i){var a="_"+i[1],o=i[2]?"_"+i[2]:"",d=i[3]?"_"+i[3]:"";return a+o+d}return""},getFileName:function(e){for(var t,i=["\\","/"],a=0;a<i.length&&(t=e.lastIndexOf(i[a]),-1==t);a++);var o=e.substr(-1==t?0:t+1,e.length);return 0===o.length?e:o},saveSchema:function(){this.isValidateNameAndDescription($(this.INPUT_SL_NAME),$(this.SCHEMA_DESCRIPTION))&&this.validateAndSave()},isValidateNameAndDescription:function(e,t){return ValidationModule.hideError(e),ValidationModule.hideError(t),ValidationModule.validate([{validator:function(e){return domain.maxLengthValidator(e,100,domain.getMessage("tooLongName"))},element:e},{validator:function(e){return domain.maxLengthValidator(e,250,domain.getMessage("tooLongDescription"))},element:t}])},validateAndSave:function(e){var t=function(t){if(t.result)this.RESOURCE_ALREADY_EXISTS===t.message&&"create"==this.mode?ValidationModule.showError($(this.INPUT_SL_RESOURCE_ID),domain._messages.resourceIdDuplicate):e?dialogs.systemConfirm.show(domain.getMessage("CSLD_SCHEMA_UPLOADED")):this._doSave(!1);else{e&&(domain.wizard.isSchemaSet||(domain.enableButton(this.BUTTON_SAVE,!1),$(this.LAUNCH_DD).update(domain.getMessage("CSLD_CREATE_WITH_DD"))),dialogs.systemConfirm.show(domain.getMessage("CSLD_SCHEMA_UPLOAD_ERROR"),5e3));var i,a;t.message?(a=domainUtil.getUsedResourcesList(t.message,domain._messages.ITEM_BEING_USED_BY_RESOURCE),i=a.length||domainUtil.indexOfNoAccessMessage(t.message,domain._messages.resourcesWithNoAccess)>-1?domainUtil.getUsedResourcesFormattedMessage(a,t.message,{"resource.label":domain._messages["resource.label"],"field.label":domain._messages["field.label"],ITEM_BEING_USED_BY_RESOURCE:domain._messages.ITEM_BEING_USED_BY_RESOURCE,resourcesWithNoAccess:domain._messages.resourcesWithNoAccess}):t.message):i=domain.getMessage("CSLD_DOMAIN_VALIDATION_ERROR"),domain.wizard.allowDesignerCloseWithValidationErrors&&(a.length||domainUtil.indexOfNoAccessMessage(t.message,domain._messages.resourcesWithNoAccess)>-1)?domain.confirmDialog.show("invalidDesignConfirmMessage",_.bind(function(){this._doSave(!1)},this),function(){},_.bind(function(e){this._showAffectedResources(e,i)},this),domain.confirmDialog.MODE_YES_NO):domain.detailsDialog.show(i)}}.bind(this),i={slName:$F(this.INPUT_SL_NAME),slResourceID:$F(this.INPUT_SL_RESOURCE_ID),slLocation:$F(this.SCHEMA_LOCATION)};ValidationModule.hideError($(this.INPUT_DS)),ValidationModule.hideError($(this.INPUT_SL_NAME)),ValidationModule.hideError($(this.SCHEMA_LOCATION)),this._sendInfo("validateAndCheckIfExists",i,t)},_showAffectedResources:function(e,t){return domain.elementClicked(e,"#designDetails")?(domain.detailsDialog.show(t),!0):void 0},_doSave:function(e){var t=function(e){e.result?(dialogs.systemConfirm.show(domain.getMessage("CSLD_DOMAIN_SAVED")),setTimeout(this.exit,500)):"folder does not exists"===e.message?ValidationModule.showError($(this.SCHEMA_LOCATION),domain.getMessage("CSLD_FOLDER_DOESNT_EXIST")):"Access is denied"===e.message?ValidationModule.showError($(this.SCHEMA_LOCATION),domain.getMessage("CSLD_ACCESS_DENIED")):e.message?dialogs.systemConfirm.show(e.message):dialogs.systemConfirm.show(domain.getMessage("error"))}.bind(this),i={slName:$F(this.INPUT_SL_NAME),slResourceID:$F(this.INPUT_SL_RESOURCE_ID),slDescription:$F(this.SCHEMA_DESCRIPTION),slLocation:$F(this.SCHEMA_LOCATION),mode:this.mode,overwrite:e};ValidationModule.hideError($(this.SCHEMA_LOCATION)),domain.wizard._sendInfo("save",i,t)},exit:function(){var e=$(domain.wizard.STEP_DISPLAY_FORM);e.action="flow.html?_flowId=createSLDatasourceFlow",e._eventId.value="cancel",e.submit()},_uploadSchema:function(e){if(ValidationModule.hideError($(this.UPLOAD_RADIO)),e.target.getValue().endsWith(".xml")){var t=function(e){"string"==typeof e&&(e=e.evalJSON()),e.result?(this.isSchemaSet=!0,this.wasDesignResetted=!0,$(this.LAUNCH_DD).update(domain.getMessage("CSLD_EDIT_WITH_DD")),this.refreshSaveButton()):(ValidationModule.showError($(this.UPLOAD_RADIO),domain.getMessage("CSLD_SCHEMA_UPLOAD_ERROR")),e.message&&domain.detailsDialog.show(e.message)),this.validateAndSave(!0)}.bind(this),i=function(){this._fileUpload($("schemaUpload"),{fileType:"schema"},t)}.bind(this),a=function(){e.target.setValue(""),$(this.CREATE_RADIO).click()}.bind(this);"edit"===this.mode?domain.confirmDialog.show("uploadSchemaConfirmMessage",i,a,null,domain.confirmDialog.MODE_OK_CANCEL):i()}else ValidationModule.showError($(this.UPLOAD_RADIO),domain.getMessage("notCorrectSecurityFileType"))},_uploadSecurity:function(e,t){function i(t){e.filePath=e._dom.select("#filePath"+e.idSuffix)[0],"string"==typeof t&&(t=t.evalJSON()),t.result?(domain.wizard.securityFile=t.fileName,domain.wizard.updateSecurityFileUI(),ValidationModule.hideError($("securityFileError").select("div > p")[0]),dialogs.systemConfirm.show(domain.getMessage("CSLD_SECURITY_FILE_IS_SET"))):(ValidationModule.showError($("securityFileError").select("div > p")[0],domain.getMessage("securityUploadError")),t.message&&domain.detailsDialog.show(t.message))}var a=e.filePath.hasAttribute(layoutModule.DISABLED_ATTR_NAME),o=a?e.selectedURI:e.filePath.getValue();return a||o.endsWith(".xml")?(a?(t.securityUri=o,domain.wizard._sendInfo("addSecurityFromRepo",t,i)):domain.wizard._fileUpload(e.filePath,t,i),!0):(ValidationModule.showError(e.filePath,domain.getMessage("notCorrectSecurityFileType")),!1)},_uploadBundle:function(e,t){function i(i){if(e.filePath=e._dom.select("#filePath"+e.idSuffix)[0],"string"==typeof i&&(i=i.evalJSON()),i.result){if(t.oldUri)for(var a=domain.wizard.bundleList.getItems(),o=0;o<a.length;o++){var d=a[o];d.getId()==t.oldId&&(d.setValue(i.fileName),d.setLabel(i.fileName)),domain.wizard.bundles[o]==t.oldUri&&(domain.wizard.bundles[o]=i.fileName)}else{var n=new dynamicList.ListItem({label:i.fileName,value:i.fileName,respondOnItemEvents:!1});n.processTemplate=function(e){return e.select("p.one > a")[0].update(xssUtil.escape(this._value)),e.select("p.two > a")[0].update(xssUtil.escape(domain.getMessage("DOMAIN_WIZARD_CHANGE_DATASOURCE"))),e.select("p.two > a")[1].update(xssUtil.escape(domain.getMessage("DOMAIN_WIZARD_REMOVE_DATASOURCE"))),e},domain.wizard.bundleList.addItems([n]),domain.wizard.bundles.push(n.getValue())}domain.wizard.bundleList.refresh(),ValidationModule.hideError($("bundleError").select("div > p")[0]),dialogs.systemConfirm.show(domain.getMessage("CSLD_BUNDLE_IS_SET"))}else{var s=i.message?i.message:domain.getMessage("bundleUploadError");ValidationModule.showError($("bundleError").select("div > p")[0],s)}}function a(){d?(t.bundleUri=n,domain.wizard._sendInfo("addBundleFromRepo",t,i)):domain.wizard._fileUpload(e.filePath,t,i)}var o,d=e.filePath.hasAttribute(layoutModule.DISABLED_ATTR_NAME),n=d?e.selectedURI:e.filePath.getValue(),s=domain.wizard.getFileName(n),r=domain.wizard.isCorrectBundle(s);if(r)return o=d?e.fromRepoRadio:e.filePath,ValidationModule.showError(o,r),!1;for(var l=!1,u=0;u<domain.wizard.bundles.length;u++)if(existBundle=domain.wizard.getFileName(domain.wizard.bundles[u]),existBundle==s){l=!0;break}return l?(o=d?e.fromRepoRadio:e.filePath,ValidationModule.showError(o,""),setTimeout(function(){domain.confirmDialog.show("resourceExistsConfirmMessage",function(){domain.wizard.selectBundleDialog.hide(),a()},function(){pageDimmer.show()},null,domain.confirmDialog.MODE_OK_CANCEL)},300),!1):(a(),!0)},_sendInfo:function(e,t,i){var a={flowId:"createSLDatasourceFlow",flowExecutionKey:domain.wizard.flowExecutionKey,eventId:e};domain.sendAjaxRequest(a,t,i)},_fileUpload:function(e,t,i){t._eventId="upload",t._flowExecutionKey=domain.wizard.flowExecutionKey,fileSender.upload(e,"createSLDatasourceFlow",t,i)}},"undefined"==typeof require&&document.observe("dom:loaded",domain.wizard.initialize.bind(domain.wizard)),define("domain.setup",["domain.components","resource.base","components.pickers","domain/domainUtil"],function(e){return function(){var t;return t||e.domain.wizard}}(this));var SelectFileDialog=function(e){this._dom=$("selectFile").cloneNode(!0),this.selectedURI=null,this.selectedFileClickSelect=null,this.idSuffix=e.idSuffix,this.title=this._dom.select("div.title")[0],this.filePath=this._dom.select("#filePath")[0],this.selectBtn=this._dom.select("#selectFileBtnSelect")[0],this.cancelBtn=this._dom.select("#selectFileBtnCancel")[0],this.fromLocalRadio=this._dom.select("#fromLocalRadio")[0],this.fromRepoRadio=this._dom.select("#fromRepoRadio")[0],this.fromLocalRadioLabel=this._dom.select("label[for='fromLocalRadio']")[0],this.fromRepoRadioLabel=this._dom.select("label[for='fromRepoRadio']")[0],this.treeLocationId="addFileResourceTreeRepoLocation",this.treeDom=this._dom.select("#"+this.treeLocationId)[0],this.treeDom.writeAttribute("id",this.treeLocationId+this.idSuffix),this.treeLocationId+=this.idSuffix,[this._dom,this.filePath,this.selectBtn,this.cancelBtn,this.fromLocalRadio,this.fromRepoRadio].each(function(e){this._fixAttribute(e)},this),[this.fromLocalRadioLabel,this.fromRepoRadioLabel].each(function(e){this._fixAttribute(e,"for")},this),this.renderDialog()};SelectFileDialog.addMethod("_fixAttribute",function(e,t){var i=e.readAttribute(t?t:"id");e.writeAttribute(t?t:"id",i+this.idSuffix)}),SelectFileDialog.addMethod("_dialogClickHandler",function(e){var t=e.element();return matchAny(t,["button#selectFileBtnSelect"+this.idSuffix],!0)?(e.stop(),void this.selectedFileClickSelect()):matchAny(t,["button#selectFileBtnCancel"+this.idSuffix],!0)?(e.stop(),void this.hide()):(matchAny(t,["#fromLocalRadio"+this.idSuffix,"label[for='fromLocalRadio"+this.idSuffix+"'] > span"],!0)?domain.wizard.fromLocalHandler(this):matchAny(t,["#fromRepoRadio"+this.idSuffix,"label[for='fromRepoRadio"+this.idSuffix+"'] > span"],!0)&&domain.wizard.fromRepoHandler(this),void this.refreshSelectBtn())}),SelectFileDialog.addMethod("_dialogTreeClickHandler",function(e){domain.wizard.fromRepoHandler(this)}),SelectFileDialog.addMethod("refreshSelectBtn",function(){function e(e){e.selectBtn.disabled&&domain.enableButton(e.selectBtn,!0)}function t(e){e.selectBtn.disabled||domain.enableButton(e.selectBtn,!1)}"local"===this.mode?this.filePath.getValue().length>0?e(this):t(this):this.tree.getSelectedNode()&&this.tree.getSelectedNode().param.type!=this.tree.getSelectedNode().FOLDER_TYPE_NAME?(this.selectedURI=this.tree.getSelectedNode().param.uri,e(this)):t(this)}),SelectFileDialog.addMethod("renderDialog",function(){document.body.insert(this._dom),this._dom.observe("click",this._dialogClickHandler.bindAsEventListener(this)),this.filePath.observe("change",this.refreshSelectBtn.bindAsEventListener(this))}),SelectFileDialog.addMethod("show",function(){this.refreshSelectBtn(),dialogs.popup.show(this._dom,!0)}),SelectFileDialog.addMethod("hide",function(){dialogs.popup.hide(this._dom)}),define("domain.setup.dialogs",["domain.setup"],function(e){return function(){var t;return t||e.SelectFileDialog}}(this)),define("domain/domainSetupMain",["require","!domReady","resource.base","domain.components","domain.setup","underscore","jrs.configs","domain.setup.dialogs"],function(e){"use strict";var t=e("!domReady"),i=e("resource.base"),a=e("domain.components"),o=e("domain.setup"),d=e("underscore"),n=e("jrs.configs");e("domain.setup.dialogs"),t(function(){d.extend(window,n.domainDesigner.localContext),d.extend(a._messages,n.domainDesigner.domain._messages),d.extend(o,n.domainDesigner.domain.wizard),d.extend(i,n.domainDesigner.resource),isIPad()&&i.initSwipeScroll(),o.initialize()})});