var domain={PROPAGATE_EVENT:"propagateEvent",_messages:{},disabledFolderTooltip:"disabledFolderTooltip",attributesPattern:new RegExp("\\s*attribute\\s*\\(\\s*'[^\\/'\\s][^\\/']*'(?:\\s*,\\s*'[^\\/'\\s][^\\/']*')*\\s*\\)\\s*"),getMessage:function(e,t){var i=this._messages[e];return i?new Template(i).evaluate(t?t:{}):""},setMessage:function(e,t){this._messages[e]=t},treeErrorHandler:function(){throw"exception while loading tree"},submitForm:function(e,t,i){if(t){var n=buildActionUrl(t);i&&i(),$(e).writeAttribute("method","post").writeAttribute("action",n),$(e).submit()}},sendAjaxRequest:function(e,t,i,n){var a=buildActionUrl(e),d={postData:Object.toQueryString(t),callback:i,errorHandler:this._serverErrorHandler,mode:AjaxRequester.prototype.EVAL_JSON};n&&Object.extend(d,n),ajaxTargettedUpdate(a,d)},_serverErrorHandler:function(e,t){return baseErrorHandler(e)},elementClicked:function(e,t){return e&&t?matchAny(e,[t],!0):!1},basicClickHandler:function(e,t,i){var n=null;return t.any(function(t){return n=domain.elementClicked(e,t.key),n?(Object.isFunction(t.value)?t.value(n):Object.isFunction(i)&&i(t.value),!0):void 0})},registerClickHandlers:function(e,t,i){if(domain._bodyClickEventHandlers)return void(i?Array.prototype.unshift:Array.prototype.push).apply(domain._bodyClickEventHandlers,e);domain._bodyClickEventHandlers=e;var n=t?t:"body";$$(n)[0].observe(isSupportsTouch()?"touchstart":"click",function(e){var t=e.element();domain._bodyClickEventHandlers&&domain._bodyClickEventHandlers.each(function(i){var n=i(t);if(n)throw n!==domain.PROPAGATE_EVENT&&Event.stop(e),$break})})},enableButton:function(e,t){"string"==typeof e&&(e=$(e)),e.disabled=t,t?buttonManager.enable(e):buttonManager.disable(e)},setOptionsToSelect:function(e,t){return e&&(e.update(""),t)?(t.each(function(t){var i={value:t.value,title:t.label};t.selected&&(i.selected="selected");var n=new Element("option",i);n.appendChild(document.createTextNode(t.label)),e.appendChild(n)}),e):void 0},getDataIslandId:function(e,t){var i=dynamicTree.trees[e.getTreeId()].getRootNode(),n=function a(e,t){return null===e.parent||e.parent===i?e.param.extra[t]:a(e.parent,t)};return n(e,t)},areNodesFromSameIsland:function(e,t){var i=e.any(function(e){return e.param.extra.isConstant});if(i)return!0;var n=1===e.pluck("parent").uniq().length;return n?!0:1===e.map(function(e){return domain.getDataIslandId(e,t||"itemId")}).uniq().length},NumberFormat:function(e,t){var i="."===e,n=new RegExp("["+e.gsub(/\s/,"\\s")+"]+"),a=new RegExp("["+t.gsub(/\s/,"\\s")+"]+"),d=new RegExp("^-|\\"+t+"?\\d+|\\"+t+"$|\\"+e+"+","g");return{toNumber:function(e){return!e||!i&&/[.]/.test(e)?NaN:Number(e.gsub(a,"").gsub(n,"."))||domain.attributesPattern.test(e)},normalizeNumberEntry:function(i){var n=i.strip(),a=n.match(domain.attributesPattern)||n.match(d);if(!a)return"";for(var o=!1,s=0;s<a.length;s++)a[s].startsWith(e)?o?delete a[s]:(a[s]=e,o=!0):a[s].startsWith(t)&&o&&(a[s]=a[s].substring(1));var l=a.join("");return l},isInteger:function(e){return n.test(e)}}},baseValidator:function(e,t){var i=!0,n="";return e()&&(n=t,i=!1),{isValid:i,errorMessage:n}},maxLengthValidator:function(e,t,i){return domain.baseValidator(function(e,t){return e.length>t}.curry(e,t),i)},minLengthValidator:function(e,t,i){return domain.baseValidator(function(e,t){return e.length<t}.curry(e,t),i)},valueNotEmptyValidator:function(e,t){return domain.baseValidator(function(e){return Object.isArray(e)&&0===e.length||!e||!String(e).strip()}.curry(e),t)},stringIdValidator:function(e,t){return domain.baseValidator(function(e){return!/^[^0-9() .,'"=!+-\/><\/\/:][^() .,'"=!+-\/><\/\/:]*$/.test(e)}.curry(e),t)},numberValidator:function(e,t,i){return domain.baseValidator(isNaN.curry(t.toNumber(e)),i)},numberBoundsValidator:function(e,t,i){return domain.baseValidator(function(e,t){return e===1/0||e===-(1/0)?!0:!(e<=t.max&&e>=t.min)}.curry(e,t),i)},rangeValidator:function(e,t,i){return domain.baseValidator(function(e,t){return!(t>e)}.curry(e,t),i)},dateValidator:function(e,t,i){return domain.baseValidator(function(e,t){return 0===getDateFromFormat(t,e)&&!domain.attributesPattern.test(t)}.curry(t,e),i)},unescapeTree:function e(t){t.hasChilds()&&_.each(t.childs,function(t){e(t)}),t.name=xssUtil.unescape(t.name)}};domain.NodeCopyMoveController=function(){},domain.NodeCopyMoveController.addMethod("copy",function(e,t,i){if(e&&e.length>0&&t){var n=dynamicTree.trees[t.getTreeId()],a=e.collect(function(e){var a=e.param.id,d=this._copyParentStructure(e,n);return d?this._mergeToDestTree(d,t,a,i):null}.bind(this));return t.isloaded=!0,a.without(null)}}),domain.NodeCopyMoveController.addMethod("copySelected",function(e,t){return sourceTree&&t?this.copy(sourceTree.selectedNodes,t):void 0}),domain.NodeCopyMoveController.addMethod("move",function(e,t){if(e&&t){var i=this.copy(e,t);return this.hide(e),i}}),domain.NodeCopyMoveController.addMethod("moveSelected",function(e,t){return e&&t?this.move(e.selectedNodes,t):void 0}),domain.NodeCopyMoveController.addMethod("hide",function(e,t,i){if(e&&e.length>0){t||(t=this._getVisibleChildrenCount),i||(i=function(e,t){e.hide(t)});var n=dynamicTree.trees[e[0].getTreeId()];e.collect(function(e){return e.id}).each(function(e){var a=dynamicTree.nodes[e];i(a,!0);for(var d=a.parent;d&&d!=n.getRootNode()&&!(t(d)>0);)i(d,!1),d.refreshStyle(),d=d.parent}.bind(this))}}),domain.NodeCopyMoveController.addMethod("_handleDuplicatedNode",function(e,t){return e.param.id}),domain.NodeCopyMoveController.addMethod("_markAsLoaded",function(e){e.isloaded=!0,e.isParent()&&e.childs.each(function(e){this._markAsLoaded(e)}.bind(this))}),domain.NodeCopyMoveController.addMethod("_mergeToDestTree",function(e,t,i,n){if(t){var a=dynamicTree.trees[t.getTreeId()];if(n)return i=this._handleDuplicatedNode(e,t),a.findNodeById(i,e);var d=a.findNodeChildByMetaName(t,e.param.id);return null!=d?(d.isHidden()&&d.show(),e.hasChilds()&&(d.disabled&&d.enable(e.tooltip),e.childs.each(function(e){this._mergeToDestTree(e,d)}.bind(this))),a.findNodeById(i,d)):(t.addChild(e),this._markAsLoaded(e),a.findNodeById(i,e))}}),domain.NodeCopyMoveController.addMethod("_copyParentStructure",function(e,t){if(e&&t){var i=dynamicTree.trees[e.getTreeId()];if(e.disabled)return null;for(var n=this._copyNode(e,t,!0),a=e.parent,d=null;a&&a!=i.getRootNode();)d=this._copyNode(a,t,!1),d.addChild(n),n=d,a=a.parent;return n}}),domain.NodeCopyMoveController.addMethod("_buildMetanode",function(e){return deepClone(e.param)}),domain.NodeCopyMoveController.addMethod("_copyNode",function(e,t,i){if(e&&t){var n=t.processNode(this._buildMetanode(e));i&&(e.hasChilds()?e.childs.each(function(e){if(!e.disabled){var e=this._copyNode(e,t,i);e&&n.addChild(e)}}.bind(this)):n.setHasChilds(!1));var a=e.childs.findAll(function(e){return e.disabled});return e.childs.length>0&&a.length==e.childs.length?null:n}}),domain.NodeCopyMoveController.addMethod("_delete",function(e){e&&e.collect(function(e){return e.id}).each(function(e){var t=dynamicTree.nodes[e];t&&t.parent.removeChild(t)})}),domain.NodeCopyMoveController.addMethod("_getVisibleChildrenCount",function(e){var t=e.childs.findAll(function(e){return e.isHidden()});return e.childs.length-t.length}),domain.resetTreeSelectionHandler={_COMMON_ELEMENTS_TO_SAVE_SELECTION:["#pageDimmer","#detail","#standardConfirm"],_getTrees:null,_elementIds:null,_callback:null,_validator:null,init:function(e,t,i,n){domain.resetTreeSelectionHandler._init.bind(domain.resetTreeSelectionHandler,e,t,i,n)()},_init:function(e,t,i,n){this._getTrees=t,this._callback=i,this._validator=n,this._elementIds=this._COMMON_ELEMENTS_TO_SAVE_SELECTION.concat(e),domain.registerClickHandlers([this._removeTreeSelectionClickEventHandler.bind(this)],null,!0)},_removeTreeSelectionClickEventHandler:function(e){if(!matchAny(e,this._elementIds,!0)){var t=!1;return this._getTrees().each(function(e){if(e.selectedNodes&&e.selectedNodes.first())throw t=!0,$break}),t?this._validator&&!this._validator()?!0:(this._getTrees().each(function(e){e._deselectAllNodes()}),this._callback&&this._callback(),!1):!1}}},domain.NodeChangeOrderController=function(){},domain.NodeChangeOrderController.addMethod("findNodeWithSpecificOrder",function(e,t,i){for(var n=e.length-1;n>=0;n--)if(e[n].isSelected()==i&&e[n].orderNumber===t)return e[n];return null}),domain.NodeChangeOrderController.addMethod("findMaxSiblingNode",function(e,t,i){var n=null,a=null;return e.each(function(e){e.isSelected()==t&&(null===n||i==e.orderNumber<n)&&(n=e.orderNumber,a=e)}),a}),domain.NodeChangeOrderController.addMethod("moveNode",function(e,t,i,n){var a=e.orderNumber,d=e.parent.childs,o=null,s=null;i?(o=this.findMaxSiblingNode(d,!1,t,e.param.type),s=o?o.orderNumber:-1,d.each(function(i){i.param.id!==e.param.id&&(t==i.orderNumber>s&&t==i.orderNumber<a||i.orderNumber==s)&&(i.orderNumber=t?i.orderNumber+1:i.orderNumber-1,n&&n(i,i.orderNumber))}),n&&n(e,s),e.orderNumber=s):(s=t?e.orderNumber-1:e.orderNumber+1,o=this.findNodeWithSpecificOrder(d,s,!1),o&&(n&&n(e,s),n&&n(o,a),e.orderNumber=s,o.orderNumber=a))}),domain.NodeChangeOrderController.addMethod("nodeAscSorter",function(e,t){return e.orderNumber-t.orderNumber}),domain.NodeChangeOrderController.addMethod("nodeDescSorter",function(e,t){return t.orderNumber-e.orderNumber}),domain.DisplayNodeChangeOrderController=function(){domain.NodeChangeOrderController.call()},domain.DisplayNodeChangeOrderController.prototype=deepClone(domain.NodeChangeOrderController.prototype),domain.DisplayNodeChangeOrderController.addMethod("findMaxSiblingNode",function(e,t,i,n){var a=null,d=null;return e.each(function(e){e.isSelected()==t&&(null!==a&&i!=e.orderNumber<a||(n?e.param.type!==n:0)||(a=e.orderNumber,d=e))}),d}),define("domain.base",["jquery","underscore","backbone","utils.common"],function(e){return function(){var t;return t||e.domain}}(this)),domain.ItemNode=function(e){dynamicTree.TreeNode.call(this,e),this.Types={Folder:new dynamicTree.TreeNode.Type("ItemGroupType"),Leaf:new dynamicTree.TreeNode.Type("ItemType")},this.nodeHeaderTemplateDomId="list_responsive_collapsible_fields:fields",this._hidden=!1,this.disabled=!1},domain.ItemNode.prototype=deepClone(dynamicTree.TreeNode.prototype),domain.ItemNode.addMethod("hide",function(e){if(e&&this.hasChilds())for(var t=0;t<this.getChildCount();t++)this.childs[t].hide(!0);var i=(this.childs.findAll(function(e){return e.disabled}).length,this.childs.findAll(function(e){return e.isHidden()}).length),n=this.childs.length-i;this.disabled||0!==n?this.getType()===this.Types.Leaf&&(this.deselect(),this.disable(domain.getMessage(domain.disabledFolderTooltip))):(this._hidden=!0,this.deselect(),this.refreshStyle())}),domain.ItemNode.addMethod("show",function(){this._hidden=!1,this._getElement()&&this.refreshStyle(this._getElement())}),domain.ItemNode.addMethod("disable",function(e){e&&(this.tooltip=e),this.disabled=!0,this._getElement()&&this.refreshStyle(this._getElement())}),domain.ItemNode.addMethod("enable",function(e){e&&(this.tooltip=e),this.disabled=!1,this._getElement()&&this.refreshStyle(this._getElement())}),domain.ItemNode.addMethod("refreshStyle",function(e){if(e||(e=this._getElement())){dynamicTree.TreeNode.prototype.refreshStyle.call(this,e),this.isHidden()?e.addClassName(layoutModule.HIDDEN_CLASS):e.removeClassName(layoutModule.HIDDEN_CLASS);var t=e.select("p").first();t&&(this.tooltip?t.title=this.tooltip:t.title="",this.disabled?(buttonManager.disable(t),buttonManager.disable(e)):(buttonManager.enable(t),buttonManager.enable(e)))}}),domain.ItemNode.addMethod("isHidden",function(){return this._hidden}),domain.ItemNode.addMethod("toJSON",function(){var e=this.param.extra,t={id:this.param.id,label:this.name,type:this.param.type};return e&&(t.labelId=e.labelId||"",t.descr=e.descr,t.descrId=e.descrId||"",t.dataType=e.dataType||"",t.resourceId=e.resourceId),this.isParent()&&(t.children=_.chain(this.childs).filter(function(e){return!e.isHidden()}).invoke("toJSON").value()),t}),domain.ItemNode.addMethod("hasVisibleChilds",function(){return this.hasChilds()&&!!this.childs.find(function(e){return!e.isHidden()})}),domain.ItemNode.addMethod("hasEnabledChilds",function(){return this.hasChilds()&&!!this.childs.find(function(e){return!e.disabled})}),domain.ItemNode.addMethod("removeChilds",function(){this.hasChilds()&&this.childs.each(function(e){this.removeChild(e)}.bind(this))}),domain.FieldsCopyMoveController=function(){domain.NodeCopyMoveController(this)},domain.FieldsCopyMoveController.prototype=deepClone(domain.NodeCopyMoveController.prototype),domain.FieldsCopyMoveController.addMethod("_buildMetanode",function(e){var t=deepClone(e.param);return t.label=e.name,t.order=e.orderNumber,t.tooltip=e.tooltip,t}),domain.TwoColumnNode=function(e){dynamicTree.TreeNode.call(this,e),this.Types={Folder:new dynamicTree.TreeNode.Type("ItemGroupType",{}),Leaf:new dynamicTree.TreeNode.Type("ItemType",{})},this.nodeHeaderTemplateDomId="list_responsive:twoColumn"},domain.TwoColumnNode.prototype=deepClone(dynamicTree.TreeNode.prototype),domain.TwoColumnNode.addMethod("_createNode",function(){var e=this.id,t=(dynamicTree.trees[this.getTreeId()],this._getHeaderTemplateElement());t.id=this.NODE_ID_PREFIX+e,this.refreshStyle(t),t.treeNode=this;var i=t.childElements()[0];this.tooltip&&(i.title=this.tooltip);var n=i.childElements()[0];n.id=this.HANDLER_ID_PREFIX+e;var a=i.childElements()[1],d=this.param.extra&&this.param.extra.label?this.param.extra.label:this.name;a.insert(xssUtil.escape(d));var o=i.childElements()[2];o.insert(xssUtil.escape(this.name)),this._element=t}),domain.TwoColumnNode.addMethod("_getTitle",function(){var e=this._getElement().childElements()[0].childElements()[2];return e.cleanWhitespace(),0===e.childNodes.length&&e.appendChild(document.createTextNode("")),e.childNodes[0]}),domain.TwoColumnNode.addMethod("toJSON",function(){var e=this.param.extra,t={id:this.param.id,label:this.name,type:this.param.type,order:this.orderNumber.toString()};return e&&(t.labelId=e.labelId||"",t.dataType=e.dataType||"",t.resourceId=e.resourceId),this.isParent()&&(t.children=_.invoke(this.childs,"toJSON")),t}),domain.TwoColumnNode.addMethod("expandAllChilds",function(){var e=dynamicTree.trees[this.getTreeId()];this.isParent()&&!this.isOpen()&&(e.writeStates(this.id,dynamicTree.TreeNode.State.OPEN),this.refreshNode()),this.hasChilds()&&this.childs.each(function(e){e.expandAllChilds()})}),domain.TablesNode=function(e){dynamicTree.TreeNode.call(this,e),this.Types={Folder:new dynamicTree.TreeNode.Type("level"),Leaf:new dynamicTree.TreeNode.Type("item")},this.nodeHeaderTemplateDomId="list_responsive_collapsible_type_tables:tables"},domain.TablesNode.prototype=deepClone(domain.ItemNode.prototype),domain.TablesNode.addMethod("toJSON",function(){var e=this.param.extra,t={id:this.param.id,label:this.name,type:this.param.type};return e&&(t.originalId=e.originalId,t.datasourceId=e.datasourceId,t.repoId=e.repoId,t.itemId=e.itemId,t.dataSource=e.dataSource,t.table=e.table,this.isParent()?(t.query=e.query,t.dataSetType=e.dataSetType):(t.expression=e.expression,t.islandId=e.islandId,t.isConstant=e.isConstant,t.JavaType=e.JavaType,t.JdbcType=e.JdbcType),e.fieldDbName&&(t.fieldDbName=e.fieldDbName)),this.isParent()&&(t.children=_.chain(this.childs).filter(function(e){return!e.isHidden()}).invoke("toJSON").value()),t}),domain.TablesNode.addVar("CONSTANT_TABLE_ID","constant_fields_level"),domain.TablesNode.addVar("CROSSTABLES_FIELDS_TABLE_ID","crossTablesFieldsLevel"),domain.TablesNode.addVar("INVALID_NODE_CLASS","invalid"),domain.TablesNode.addVar("DATA_ISLAND_CLASS","dataIsland"),domain.TablesNode.addVar("DERIVED_TABLE_CLASS","table derived"),domain.TablesNode.addVar("CONSTANT_TABLE_CLASS","table constant"),domain.TablesNode.addVar("CALCULATED_FIELD_CLASS","field calculated"),domain.TablesNode.addMethod("refreshStyle",function(e){(e||(e=this._getElement()))&&(domain.ItemNode.prototype.refreshStyle.call(this,e),this.param.extra&&"true"===this.param.extra.isInvalid?e.addClassName(this.INVALID_NODE_CLASS):e.removeClassName(this.INVALID_NODE_CLASS),this.param.extra&&this.param.extra.expression&&e.addClassName(this.CALCULATED_FIELD_CLASS),this.param.extra&&this.param.extra.query&&e.addClassName(this.DERIVED_TABLE_CLASS),this.param.id===this.CONSTANT_TABLE_ID&&e.addClassName(this.CONSTANT_TABLE_CLASS),this.param.extra&&this.param.extra.isIsland&&e.addClassName(this.DATA_ISLAND_CLASS))}),domain.TablesNode.addMethod("edit",function(e){e&&"dblclick"!==e.type||domain.ItemNode.prototype.edit.call(this,e)}),domain.TablesCustomNode=function(e){domain.TablesNode.call(this,e),this.nodeHeaderTemplateDomId=e.param.type===this.Types.Folder.name?"list_responsive_collapsible_type_tables:tables":"list_responsive_collapsible_type_tables:fields"},domain.TablesCustomNode.prototype=deepClone(domain.TablesNode.prototype),domain.TablesCopyMoveController=function(){domain.NodeCopyMoveController(this)},domain.TablesCopyMoveController.prototype=deepClone(domain.NodeCopyMoveController.prototype),domain.TablesCopyMoveController.addMethod("_buildMetanode",function(e){var t={id:e.param.id,label:e.name,type:e.param.type,uri:e.param.uri};return e.param.extra&&(t.extra={originalId:e.param.extra.originalId,table:e.param.extra.table,itemId:e.param.extra.itemId,datasourceId:e.param.extra.datasourceId,repoId:e.param.extra.repoId,dataSource:e.param.extra.dataSource,dataSetType:e.param.extra.dataSetType,query:e.param.extra.query},e.param.extra.expression&&(t.extra.expression=e.param.extra.expression),e.param.extra.fieldDbName&&(t.extra.fieldDbName=e.param.extra.fieldDbName),e.isParent()||(t.extra.JavaType=e.param.extra.JavaType,t.extra.JdbcType=e.param.extra.JdbcType,t.extra.sourceItem=e.parent.param.extra.originalId)),t}),domain.TablesCopyMoveController.addMethod("_handleDuplicatedNode",function(e,t){if(e.isParent()){for(var i=1,n=e.param.extra.datasourceId+"."+e.param.extra.itemId+i,a=dynamicTree.trees[t.getTreeId()];a.findNodeChildByMetaName(t,n);)i++,n=e.param.extra.datasourceId+"."+e.param.extra.itemId+i;return e.param.id=n,e.param.extra.itemId+=i,e.name=e.param.extra.itemId,e.param.extra.originalId=e.param.extra.itemId,t.addChild(e),e.isloaded=!0,e.hasChilds()&&e.childs.each(function(t){this._handleDuplicatedNode(t,e)}.bind(this)),n}e.param.id=e.parent.param.id+"."+e.param.extra.itemId,e.param.extra.originalId=e.parent.param.extra.originalId+"."+e.param.extra.itemId}),domain.DerivedTablesNode=function(e){domain.TablesNode.call(this,e),e.param.type===this.Types.Folder.name&&e.param.extra&&e.param.extra.query&&(this.isSelectable=!0)},domain.DerivedTablesNode.prototype=deepClone(domain.TablesNode.prototype),domain.JoinsList=function(e,t){dynamicList.List.call(this,e,t)},domain.JoinsList.prototype=deepClone(dynamicList.List.prototype),domain.JoinsList.addMethod("_changeHandler",function(e){var t=this.getItemByEvent(e);t&&(t._respondOnItemEvents&&!e.isInvoked&&this.fire("item:change",{targetEvent:e,item:t}),e.isInvoked=!0)}),domain.JoinsList.addMethod("_initEvents",function(){dynamicList.List.prototype._initEvents.call(this);var e=this._getElement();jQuery(e).off("change").on("change","select",_.bind(this._changeHandler,this))}),domain.JoinsListItem=function(e){dynamicList.ListItem.call(this,e),this._hidden=!1},domain.JoinsListItem.prototype=deepClone(dynamicList.ListItem.prototype),domain.JoinsListItem.addMethod("hide",function(e){this._hidden=!!e,this.refreshStyle()}),domain.JoinsListItem.addMethod("refreshStyle",function(){dynamicList.ListItem.prototype.refreshStyle.call(this),this._getElement()&&(this._hidden?this._getElement().addClassName(layoutModule.HIDDEN_CLASS):this._getElement().removeClassName(layoutModule.HIDDEN_CLASS))}),domain.JoinsListItem.addMethod("processTemplate",function(e){var t=e.childElements()[0];t.cleanWhitespace();var i=t.childElements()[1],n=t.childElements()[2],a=t.childElements()[3],d=a.childElements()[0],o=d.childElements();return i.update(xssUtil.escape(this._value.left.table.label)+":"+xssUtil.escape(this._value.left.label)),n.update(xssUtil.escape(this._value.right.table.label)+":"+xssUtil.escape(this._value.right.label)),o.each(function(e){e.selected=e.value===this._value.type}.bind(this)),e}),domain.JoinsListItem.addMethod("setJoinType",function(e){this.getValue().type=e;var t=this._getElement();if(t){var i=t.childElements()[0].childElements()[3].childElements()[0];$(i).value=e}}),domain.JoinsListItem.addMethod("toJSON",function(){return{left:this._value.left.id,right:this._value.right.id,type:this._value.type}}),domain.DisplayNode=function(e){domain.ItemNode.call(this,e),this.Types={Folder:new dynamicTree.TreeNode.Type("ItemGroupType"),Leaf:new dynamicTree.TreeNode.Type("ItemType")},this.nodeHeaderTemplateDomId="list_responsive_collapsible_type_sets:sets"},domain.DisplayNode.prototype=deepClone(domain.ItemNode.prototype),domain.DisplayNode.addMethod("toJSON",function(){var e=this.param.extra,t={id:this.param.id,type:this.param.type};return e&&(t.itemId=e.itemId,t.descr=e.descr,t.labelId=e.labelId||"",t.descrId=e.descrId||"",t.resourceId=e.resourceId||""),e&&e.label&&(t.label=e.label),this.isParent()?t.children=_.chain(this.childs).filter(function(e){return!e.isHidden()&&!e._markAsDeleted}).invoke("toJSON").value():(t.dataType=e.dataType,t.dimensionOrMeasure=e.dimensionOrMeasure,t.defaultMask=e.defaultMask,t.defaultAgg=e.defaultAgg),t}),domain.DisplayNode.addVar("INVALID_NODE_CLASS","invalid"),domain.DisplayNode.addMethod("refreshStyle",function(e){(e||(e=this._getElement()))&&(domain.ItemNode.prototype.refreshStyle.call(this,e),this.param.extra&&"true"===this.param.extra.isInvalid?e.addClassName(this.INVALID_NODE_CLASS):e.removeClassName(this.INVALID_NODE_CLASS))}),domain.genericTreeParams={rootUri:"/",showRoot:!1,nodeClass:domain.ItemNode,treeClassName:"",multiSelectEnabled:!0},domain.createItemsTree=function(e){return e=Object.extend(deepClone(domain.genericTreeParams),e),new dynamicTree.TreeSupport(e.treeId,e)},domain.confirmDialog={MODE_OK_CANCEL:"okCancel",MODE_YES_NO:"yesNo",_CONFIRM_DIALOG_DOM_ID:"standardConfirm",_CONFIRM_DIALOG_BODY_DOM_PATTERN:"#standardConfirm > .content > .body",_CONFIRM_DIALOG_OK_BUTTON_ID:"#confirmYes",_CONFIRM_DIALOG_CANCEL_BUTTON_ID:"#confirmNo",_CONFIRM_DIALOG_OK_PATTERN:"#confirmYes > span",_CONFIRM_DIALOG_CANCEL_PATTERN:"#confirmNo > span",_yesMessageHolder:null,_noMessageHolder:null,_dialog:null,_onOk:null,_onCancel:null,_customEventHandler:null,_templateDomId:null,_visible:!1,init:function(){domain.confirmDialog._init.bind(domain.confirmDialog)()},show:function(e,t,i,n,a){domain.confirmDialog._show.bind(domain.confirmDialog,e,t,i,n,a)()},hideForDetails:function(){dialogs.popup.hide(domain.confirmDialog._dialog)},showFromDetails:function(){dialogs.popup.show(domain.confirmDialog._dialog,!0)},visible:function(){return domain.confirmDialog._visible},_init:function(){this._dialog=$(this._CONFIRM_DIALOG_DOM_ID),this._yesMessageHolder=$$(this._CONFIRM_DIALOG_OK_PATTERN).first(),this._noMessageHolder=$$(this._CONFIRM_DIALOG_CANCEL_PATTERN).first(),domain.registerClickHandlers([this._clickEventHandler.bind(this)])},_show:function(e,t,i,n,a){this._onOk=t,this._onCancel=i,this._customEventHandler=n,this._templateDomId=e,a&&a==this.MODE_YES_NO?(this._yesMessageHolder.update(domain.getMessage("yes")),this._noMessageHolder.update(domain.getMessage("no"))):(this._yesMessageHolder.update(domain.getMessage("ok")),this._noMessageHolder.update(domain.getMessage("cancel"))),$(this._templateDomId).removeClassName(layoutModule.HIDDEN_CLASS),dialogs.popup.show(this._dialog,!0),this._visible=!0},_hide:function(e){$(this._templateDomId).addClassName(layoutModule.HIDDEN_CLASS),dialogs.popup.hide(this._dialog),this._visible=!1,e&&e()},_clickEventHandler:function(e){return domain.elementClicked(e,this._CONFIRM_DIALOG_OK_BUTTON_ID)?(this._hide(this._onOk),!0):domain.elementClicked(e,this._CONFIRM_DIALOG_CANCEL_BUTTON_ID)?(this._hide(this._onCancel),!0):this._customEventHandler?this._customEventHandler(e):void 0}},domain.detailsDialog={_DETAIL_DIALOG_DOM_ID:"detail",_DETAIL_DIALOG_CLOSE_BUTTON_ID:"#close",_DETAIL_DIALOG_LIST_DOM_ID:"detailsList",_DETAIL_DIALOG_TEXT_DOM_ID:"detailsText",_LIST_TEMPLATE:"defaultListTemplate",_LIST_ITEM_TEMPLATE:"dynamicListItemTemplate",_dialog:null,_showConfirmAfterClose:!1,_list:null,_listItems:null,init:function(){domain.detailsDialog._init.bind(domain.detailsDialog)()},show:function(e){domain.detailsDialog._show.bind(domain.detailsDialog,e)()},_init:function(){this._dialog=$(this._DETAIL_DIALOG_DOM_ID),domain.registerClickHandlers([this._clickEventHandler.bind(this)])},_show:function(e){domain.confirmDialog.visible()?(domain.confirmDialog.hideForDetails(),this._showConfirmAfterClose=!0):this._showConfirmAfterClose=!1,this._createMessage(e),dialogs.popup.show(this._dialog,!0),$(this._DETAIL_DIALOG_LIST_DOM_ID).parentNode.scrollTop=0},_createMessage:function(e){"string"==typeof e?($(this._DETAIL_DIALOG_LIST_DOM_ID).addClassName(layoutModule.HIDDEN_CLASS),$(this._DETAIL_DIALOG_TEXT_DOM_ID).removeClassName(layoutModule.HIDDEN_CLASS).update(e)):($(this._DETAIL_DIALOG_TEXT_DOM_ID).addClassName(layoutModule.HIDDEN_CLASS),$(this._DETAIL_DIALOG_LIST_DOM_ID).removeClassName(layoutModule.HIDDEN_CLASS),this._items&&(this._list.removeItems(this._items),this._items=null,this._list=null),this._items=e.collect(function(e){return new dynamicList.ListItem({label:e})}),this._list=new dynamicList.List(this._DETAIL_DIALOG_LIST_DOM_ID,{listTemplateDomId:this._LIST_TEMPLATE,itemTemplateDomId:this._LIST_ITEM_TEMPLATE,items:this._items}),this._list.show())},_close:function(){dialogs.popup.hide(this._dialog),this._showConfirmAfterClose&&domain.confirmDialog.showFromDetails()},_clickEventHandler:function(e){return domain.elementClicked(e,this._DETAIL_DIALOG_CLOSE_BUTTON_ID)?(this._close(),!0):void 0}},define("domain.components",["domain.base","dynamicTree.utils","components.list"],function(e){return function(){var t;return t||e.domain}}(this));var toolbarButtonModule={UP:"up",DOWN:"down",OVER:"over",DISABLED:"disabled",PRESSED:"pressed",CONTENT_PREFIX:"toolbar_",MenuClass:"menu vertical dropDown",TOOLBAR_MENU_CLASS:"menu vertical dropDown fitable",ACTION_MODEL_TAG:"adhocActionModel",CAPSULE_PATTERN:"capsule",showButtonMenu:function(e,t){t=jQuery(t);var i=this.CONTENT_PREFIX+t.attr("id"),n="adhocActionModel"==this.ACTION_MODEL_TAG?this.actionModel:this.ACTION_MODEL_TAG;actionModel.showDropDownMenu(e,t,i,this.TOOLBAR_MENU_CLASS,n)},setActionModel:function(e){this.actionModel=e},isToolBarButton:function(e){return e?jQuery(e).hasClass("capsule"):!1},enable:function(e,t){buttonManager.enable(e)},disable:function(e){buttonManager.disable(e)},setButtonState:function(e,t){t?this.enable(e):this.disable(e)}};define("components.toolbarButtons",["jquery","prototype"],function(e){return function(){var t;return t||e.toolbarButtonModule}}(this)),toolbarButtonModule.initialize=function(e){toolbarButtonModule.actionMap=e,jQuery(".toolbar").on("mouseup mouseover mouseout","button",function(e){jQuery(this).prop("disabled")||toolbarButtonModule["mouse"+e.type.substring(5,6).toUpperCase()+e.type.substring(6)+"Handler"](e,this)}),isFirefox()&&jQuery(".toolbar li").each(function(e,t){jQuery(t).css("padding","0 2px")})},toolbarButtonModule.mouseUpHandler=function(e,t){var i=t.className.indexOf("capsule")>=0?toolbarButtonModule.actionMap[t.id]:null;if(i){var n=getAsFunction(i);n(e),e.stopPropagation()}},toolbarButtonModule.mouseOverHandler=function(e,t){t.className.indexOf("capsule")>=0&&t.className.indexOf("mutton")>=0&&!buttonManager.isDisabled(t)&&toolbarButtonModule.showButtonMenu(e.originalEvent,t)},toolbarButtonModule.mouseOutHandler=function(e,t){},define("components.toolbar",["jquery","prototype","utils.common","components.toolbarButtons"],function(e){return function(){var t;return t||e.toolbarButtonModule}}(this)),define("text!domain/template/domainUsedResourcesTemplate.htm",[],function(){return"<table class='usedResources'>\n    <thead>\n        <tr>\n            <th>{{- fieldLabel }}</th>\n            <th>{{- resourceLabel }}</th>\n        </tr>\n    </thead>\n    <tbody>\n        {{ _.each(usedResources, function(usedResource, index) { }}\n        <tr>\n            <td>{{- usedResource.field }}</td>\n            <td><a target='_blank' href='{{- contextPath }}/flow.html?_flowId=adhocFlow&resource={{- encodeURIComponent(usedResource.resource) }}'>{{- usedResource.resource }}</a></td>\n        </tr>\n        {{ }); }}\n    </tbody>\n</table>"}),define("domain/domainUtil",["require","underscore","jrs.configs","text!./template/domainUsedResourcesTemplate.htm"],function(e){"use strict";function t(e){return new RegExp(e.replace(".","\\.").replace("]","\\]").replace("[","\\[").replace("{0}","(\\S+)").replace("{1}","(\\S+)"),"g")}var i=e("underscore"),n=e("jrs.configs"),a=i.template(e("text!./template/domainUsedResourcesTemplate.htm"));return window.domainUtil={getUsedResourcesList:function(e,i){for(var n,a=t(i),d=[];n=a.exec(e);)d.push({field:n[1],resource:n[2]});return d},indexOfNoAccessMessage:function(e,t){return e.indexOf(t)},getUsedResourcesFormattedMessage:function(e,t,i){if(!e.length)return t;var d=i.ITEM_BEING_USED_BY_RESOURCE.split("{0}")[0],o=t.split(d)[0],s=o+a({contextPath:n.contextPath,usedResources:e,resourceLabel:i["resource.label"],fieldLabel:i["field.label"]});return this.indexOfNoAccessMessage(t,i.resourcesWithNoAccess)>-1&&(s+="<br/>"+i.resourcesWithNoAccess),s}},window.domainUtil}),domain.designer={FLOW_ID:"domainDesignerFlow",CREATE_DS_FLOW:"createSLDatasourceFlow",TABLES_VIEW:"domainDesigner_tables",DERIVED_TABLES_VIEW:"domainDesigner_derivedTables",JOINS_VIEW:"domainDesigner_joins",CALC_FIELDS_VIEW:"domainDesigner_calculatedFields",FILTERS_VIEW:"domainDesigner_filters",DISPLAY_VIEW:"domainDesigner_display",ACTION_MODEL_TAG:"domainDesignerActionModel",TREE_DRAG_PATTERN:".draggable",ITEM_KEY_BLACKLIST_REGEX_PATTERN:/[-+='"!#$%^&,<> %:;?{}@()|\*\[\]\/\\]/,ITEM_ID_BLACKLIST_REGEX_PATTERN:/[-+='"!%^&<> %.:;?{}()|\*\[\]\/\\]/,formDomId:"stepDisplayForm",currentPage:null,flowExecutionKey:null,hasSchemas:!1,presentationSelected:!1,unsavedChangesPresent:!1,derivedTableQueryRegex:/^\s*select\s+([^\s]+(\s+|$)){3,}|^\s*\{\s*attribute\s*\('.+'\)\s*\}\s*$/gi,initialize:function(){webHelpModule.setCurrentContext("domain");var e=localContext.domainInitOptions;this.flowExecutionKey=e.flowExecutionKey,this.unsavedChangesPresent=e.unsavedChangesPresent,this.allowDesignerCloseWithValidationErrors=e.allowDesignerCloseWithValidationErrors;var t=e.dataSourceId;if(!t&&e.dataSourcesList&&e.dataSourcesList.first()&&(t=e.dataSourcesList.first().id),!t)return void this.redirectToCreateDomain();this.presentationSelected=e.presentationSelected;var i=e.datasourcesProperties[t]?e.datasourcesProperties[t].schemas:null;this.hasSchemas=i&&i.first(),domain.registerClickHandlers([this.flowControlsClickEventHandler.bind(this),this.stopEventForToolbarButtonsClickEventHandler.bind(this)]),domain.confirmDialog.init(),domain.detailsDialog.init(),this.currentPage=document.body.identify();var n=this.pageInitFactory[this.currentPage]();this.initModule(n,e)},initModule:function(e,t){e&&(e.fillForm&&(dd.fillForm=e.fillForm.bind(e)),e.getValidationPostData&&(dd.getValidationPostData=e.getValidationPostData.bind(e)),e.getCheckDesignValidator&&(dd.getCheckDesignValidator=e.getCheckDesignValidator.bind(e)),e.exportEnabled&&(dd.exportEnabled=e.exportEnabled.bind(e)),e.exportBundleStub&&(dd.exportBundleStub=e.exportBundleStub.bind(e)),dd.initToolbar(e.toolbarActionMap),e.init.bind(e)(t))},initToolbar:function(e){this.toolbarActionMap=Object.extend(this.toolbarActionMap,e),toolbarButtonModule.ACTION_MODEL_TAG=this.ACTION_MODEL_TAG,toolbarButtonModule.initialize(this.toolbarActionMap)},redirectToCreateDomain:function(){document.location=buildActionUrl({flowId:this.CREATE_DS_FLOW})},fillForm:function(){},getValidationPostData:function(){return{}},getCheckDesignValidator:function(){return dd.checkDesignValidator},flowControlsClickEventHandler:function(e){
var t=!1;return this.flowControlsEventMap.each(function(i){if(domain.elementClicked(e,i.key)){var n=i.value;if(t=!0,this.currentPage===n.returnOnPage)throw $break;n.flowExecutionKey=this.flowExecutionKey;var a=function(){delete n.returnOnPage,delete n.performValidation,n.flowId=this.FLOW_ID,domain.submitForm(this.formDomId,n,this.fillForm)},d="#done"===i.key&&this.allowDesignerCloseWithValidationErrors;throw n.performValidation?this.getCheckDesignValidator().validate(d,a.bind(this)):a.bind(this)(),$break}}.bind(this)),t},stopEventForToolbarButtonsClickEventHandler:function(e){var t=!1;return $H(this.toolbarActionMap).each(function(i){if(domain.elementClicked(e,"#"+i.key))throw t=!0,$break}.bind(this)),t},checkDesign:function(e,t){var i={flowExecutionKey:this.flowExecutionKey,eventId:"validateSchema"};domain.sendAjaxRequest(i,this.getValidationPostData(),e,t)},checkForEmptySets:function(e){var t={flowExecutionKey:this.flowExecutionKey,eventId:"checkForEmptySets"};domain.sendAjaxRequest(t,{},e)},deleteEmptySets:function(e,t){var i={flowExecutionKey:this.flowExecutionKey,eventId:"deleteEmptySets"},n={emptySets:Object.toJSON(e)};domain.sendAjaxRequest(i,n,t)},exportToXml:function(e){var t={flowExecutionKey:this.flowExecutionKey,eventId:"exportToXML"};this.hasSchemas&&(t.exportSchemaPrefix=!!e),domain.submitForm(this.formDomId,t,null)},generateAndDownloadBundles:function(e,t,i,n){var a={flowExecutionKey:this.flowExecutionKey,eventId:"bundle"},d={generateDescrKey:!!e,generateLabelKey:!!t},o=function(e){"success"===e&&(i&&n?n.done(this.downloadBundleStubs.bind(this)):this.downloadBundleStubs(),i&&i())};domain.sendAjaxRequest(a,d,o.bind(this))},downloadBundleStubs:function(){var e={flowExecutionKey:this.flowExecutionKey,eventId:"downloadBundleStubs"};domain.submitForm(this.formDomId,e,null)},validateForCalcFields:function(e,t,i){var n={flowExecutionKey:this.flowExecutionKey,eventId:"validateDeletedTablesForCalcFields"},a={deletedTablesIds:e,isRealTables:t};domain.sendAjaxRequest(n,a,i)},changeTableAlias:function(e,t,i){var n={};n[e]=t;var a={flowExecutionKey:dd.flowExecutionKey,eventId:"changeTableAlias"},d={aliasChangesMap:Object.toJSON(n)};domain.sendAjaxRequest(a,d,i)},createTreeNodesMap:function(e){var t=function(e,i){e&&(i[e.param.id]=e,e.isParent()&&e.childs.each(function(e){t(e,i)}))};e.treeMap={},e.getRootNode().childs.each(function(i){t(i,e.treeMap)})},deleteNodesFromTreeById:function(e,t,i){if(e&&e.first()){var n=function(e){return e.childs.length},a=function(e){return e.parent.removeChild(e)},d=function(e){delete t.treeMap[e.param.id],e.isParent()&&e.childs.each(d)};e.each(function(e){var o=t.treeMap[e];o&&(i.hide([o],n,a),d(o))}.bind(this))}},getTablesUsedForFilters:function(e,t){if(!t.first())return[];var i=t.findAll(function(t){if(!e)return!1;var i=t.param.extra.itemId;return e&&e[i]&&e[i].itemId===i});return i.collect(function(e){return e.param.extra.itemId})},insertAtCaret:function(e,t,i){if(document.selection){if(i||(i=document.selection.createRange()),i.parentElement()!=e)return e.value+=t,!1;e.focus(),i.text=t,i.collapse(!1),i.select()}else if(Object.isNumber(e.selectionStart)&&e.selectionStart>=0){var n=e.getValue(),a=e.selectionStart,d=e.selectionEnd;e.setValue(n.substr(0,a)+t+n.substr(d)),e.focus(),e.setSelectionRange(a,a+t.length)}else e.value+=t},emptyValidator:function(e){return{isValid:e&&e.strip(),errorMessage:domain.getMessage("field.empty")}},itemKeyValidator:function(e,t){return{isValid:!t||null==t.match(dd.ITEM_KEY_BLACKLIST_REGEX_PATTERN),errorMessage:domain.getMessage(e)}},itemIdValidator:function(e,t){return{isValid:!t||null==t.match(dd.ITEM_ID_BLACKLIST_REGEX_PATTERN),errorMessage:domain.getMessage(e?e:"id.invalid")}},itemIdNotStartFromNumberValidator:function(e){return{isValid:!e||null==e.match(/^[0-9]/),errorMessage:domain.getMessage("id.startFromNumber")}},escapeJsonValidator:function(e){return{isValid:!e||!e.match(/[\?]+/g),errorMessage:domain.getMessage("field.invalid")}}};var dd=domain.designer;dd.confirmAndLeave=function(){return dd.isUnsavedChangesPresent()?confirm(domain.getMessage("exitMessage")):!0},dd.setUnsavedChangesPresent=function(e){dd.unsavedChangesPresent=!!e},dd.isUnsavedChangesPresent=function(){return dd.unsavedChangesPresent},dd.toolbarActionMap={checkDesign:"dd.validateDesign",exportSchema:"dd.exportSchema",exportBundleStub:"dd.exportBundleStub"},dd.toolbarEnableMap={exportSchema:function(){return dd.exportEnabled()},exportBundleStub:function(){return dd.exportEnabled()}},dd.updateToolBarButtons=function(){$H(dd.toolbarEnableMap).each(function(e){toolbarButtonModule.setButtonState(e.key,e.value())})},dd.exportSchema=function(){dd.exportSchemaValidator.validate(dd.exportToXml.bind(dd))},dd.isPresentationSelected=function(){return dd.presentationSelected},dd.exportBundleStub=function(){dd.exportBundlesValidator.validate(dd.generateAndDownloadBundles.bind(dd))},dd.exportEnabled=function(){return dd.presentationSelected},dd.validateDesign=function(){dd.getCheckDesignValidator().validate(!1)},dd.pageInitFactory={domainDesigner_tables:function(){return dd_tables},domainDesigner_derivedTables:function(){return dd_derivedTables},domainDesigner_joins:function(){return dd_joins},domainDesigner_calculatedFields:function(){return dd_calcFields},domainDesigner_filters:function(){return dd_filters},domainDesigner_display:function(){return dd_display}},dd.flowControlsEventMap=$H({"#tablesTab":{returnOnPage:dd.TABLES_VIEW,eventId:"tables"},"#derivedTablesTab":{returnOnPage:dd.DERIVED_TABLES_VIEW,eventId:"query"},"#joinsTab":{returnOnPage:dd.JOINS_VIEW,eventId:"joins"},"#calcFieldsTab":{returnOnPage:dd.CALC_FIELDS_VIEW,eventId:"calcFields"},"#preFiltersTab":{returnOnPage:dd.FILTERS_VIEW,eventId:"filters"},"#displayTab":{returnOnPage:dd.DISPLAY_VIEW,eventId:"design"},"#done":{eventId:"done",performValidation:!0},"#cancelButton":{eventId:"cancel"}}),define("domain.designer",["domain.components","components.toolbar","domain/domainUtil"],function(e){return function(){var t;return t||e.dd}}(this)),dd.checkDesignValidator={_INVALID_DESIGN_TEMPLATE_DOM_ID:"invalidDesignConfirmMessage",_INVALID_DESIGN_LINK_ID:"#designDetails",_DONE_BUTTON_ID:"done",_callback:null,_errorMessage:null,_showConfirmation:null,validate:function(e,t){dd.checkDesignValidator._validate.bind(dd.checkDesignValidator,e,t)()},_validate:function(e,t){this._callback=t,this._showConfirmation=e,dd.emptySetsValidator.validate(this._emptySetsCallback.bind(this))},_emptySetsCallback:function(e){"empty"===e&&domain.enableButton(this._DONE_BUTTON_ID,!1),dd.checkDesign.bind(dd,this._checkDesignCallback.bind(this))()},_checkDesignCallback:function(e){if("success"===e)this._callback?this._callback():dialogs.systemConfirm.show(domain.getMessage("designIsValid"));else{this._errorMessage=e.errorMessage;var t=domainUtil.getUsedResourcesList(e.errorMessage,domain._messages.ITEM_BEING_USED_BY_RESOURCE),i=t.length||domainUtil.indexOfNoAccessMessage(e.errorMessage,domain._messages.resourcesWithNoAccess)>-1?domainUtil.getUsedResourcesFormattedMessage(t,e.errorMessage,{"resource.label":domain._messages["resource.label"],"field.label":domain._messages["field.label"],ITEM_BEING_USED_BY_RESOURCE:domain._messages.ITEM_BEING_USED_BY_RESOURCE,resourcesWithNoAccess:domain._messages.resourcesWithNoAccess}):this._errorMessage;this._showConfirmation&&(t.length||domainUtil.indexOfNoAccessMessage(e.errorMessage,domain._messages.resourcesWithNoAccess)>-1)?domain.confirmDialog.show(this._INVALID_DESIGN_TEMPLATE_DOM_ID,this._onOk.bind(this),this._onCancel.bind(this),_.bind(function(e){this._showAffectedResources(e,i)},this),domain.confirmDialog.MODE_YES_NO):domain.detailsDialog.show(i)}},_onOk:function(){this._callback&&this._callback()},_onCancel:function(){},_showAffectedResources:function(e,t){return domain.elementClicked(e,this._INVALID_DESIGN_LINK_ID)?(domain.detailsDialog.show(t),!0):void 0}},dd.emptySetsValidator={_EMPTY_SETS_TEMPLATE_DOM_ID:"emptySetsConfirmMessage",_EMPTY_SETS_LINK_ID:"#emptySetsDetails",_callback:null,_emptySets:null,validate:function(e){dd.emptySetsValidator._validate.bind(dd.emptySetsValidator,e)()},_validate:function(e){this._callback=e,dd.checkForEmptySets.bind(dd,this._checkCallback.bind(this))()},_checkCallback:function(e){e&&e.first()?(this._emptySets=e,domain.confirmDialog.show(this._EMPTY_SETS_TEMPLATE_DOM_ID,this._onOk.bind(this),this._onCancel.bind(this),this._showAffectedResources.bind(this))):this._callback&&this._callback()},_onOk:function(){dd.deleteEmptySets.bind(dd,this._emptySets,this._callback)()},_onCancel:function(){this._callback&&this._callback()},_showAffectedResources:function(e){return domain.elementClicked(e,this._EMPTY_SETS_LINK_ID)?(domain.detailsDialog.show(this._emptySets),!0):void 0}},dd.exportSchemaValidator={_EXPORT_SCHEMA_PREFIXES_TEMPLATE_DOM_ID:"exportSchemaPrefixesConfirmMessage",_callback:null,validate:function(e){dd.exportSchemaValidator._validate.bind(dd.exportSchemaValidator,e)()},_validate:function(e){this._callback=e,dd.getCheckDesignValidator().validate(!0,this._checkDesignValidatorCallback.bind(this))},_checkDesignValidatorCallback:function(){dd.hasSchemas?domain.confirmDialog.show(this._EXPORT_SCHEMA_PREFIXES_TEMPLATE_DOM_ID,this._onOk.bind(this),this._onCancel.bind(this),null,domain.confirmDialog.MODE_YES_NO):this._callback&&this._callback()},_onOk:function(){this._callback&&this._callback(!0)},_onCancel:function(){this._callback&&this._callback(!1)}},dd.exportBundlesValidator={_EXPORT_BUNDLES_TEMPLATE_DOM_ID:"exportBundlesConfirmMessage",_GENERATE_LABEL_KEYS_PATTERN:"#autoGenerateLabelKeys",_GENERATE_LABEL_KEYS_ID:"generateLabelKeys",_GENERATE_DESCR_KEYS_PATTENR:"#autoGenerateDescriptionKeys",_GENERATE_DESCR_KEYS_ID:"generateDescriptionKeys",_callback:null,_generateLabelKeys:!1,_generateDescrKeys:!1,validate:function(e){dd.exportBundlesValidator._validate.bind(dd.exportBundlesValidator,e)()},_validate:function(e){this._callback=e,dd.getCheckDesignValidator().validate(!0,this._checkDesignValidatorCallback.bind(this))},_checkDesignValidatorCallback:function(){domain.confirmDialog.show(this._EXPORT_BUNDLES_TEMPLATE_DOM_ID,this._onOk.bind(this),this._onCancel.bind(this),this._handleCheckBoxes.bind(this))},_onOk:function(){this._callback&&this._callback(this._generateDescrKeys,this._generateLabelKeys)},_onCancel:function(){},_handleCheckBoxes:function(e){return matchMeOrUp($(e),this._GENERATE_LABEL_KEYS_PATTERN)?(this._generateLabelKeys=$F(this._GENERATE_LABEL_KEYS_ID),domain.PROPAGATE_EVENT):matchMeOrUp($(e),this._GENERATE_DESCR_KEYS_PATTENR)?(this._generateDescrKeys=$F(this._GENERATE_DESCR_KEYS_ID),domain.PROPAGATE_EVENT):void 0}},dd.deleteCalcFieldsValidator={_DELETE_CALCFIELDS_TEMPLATE_ID:"calcFieldsConfirmMessage",_CALC_FIELDS_DETAILS_LINK_ID:"#calcFieldsDetails",_involvedFieldsIds:null,_involvedFieldsExpressionIds:null,_nodes:null,_callback:null,_validateForCalcFields:null,init:function(e){dd.deleteCalcFieldsValidator._init.bind(dd.deleteCalcFieldsValidator,e)()},validate:function(e,t,i){dd.deleteCalcFieldsValidator._validate.bind(dd.deleteCalcFieldsValidator,e,t,i)()},_init:function(e){this._validateForCalcFields=e},_validate:function(e,t,i){this._nodes=e,this._callback=i;var n=Object.toJSON(e.collect(function(e){return e.param.extra.datasourceId+"."+e.param.extra.itemId}));this._validateForCalcFields(n,t,this._validationCallback.bind(this))},_validationCallback:function(e){this._involvedFieldsIds=[],this._involvedFieldsExpressionIds=[],"success"===e?this._onOk():(this._involvedFieldsIds=e.involvedFieldsIds,this._involvedFieldsExpressionIds=e.involvedFieldsExpressionIds,domain.confirmDialog.show(this._DELETE_CALCFIELDS_TEMPLATE_ID,this._onOk.bind(this),this._onCancel.bind(this),this._showAffectedResources.bind(this)))},_onOk:function(){this._callback&&this._callback(this._involvedFieldsIds,this._involvedFieldsExpressionIds)},_onCancel:function(){},_showAffectedResources:function(e){return domain.elementClicked(e,this._CALC_FIELDS_DETAILS_LINK_ID)?(domain.detailsDialog.show(this._involvedFieldsExpressionIds),!0):void 0}},dd.deleteFiltersValidator={_DELETE_FILTERS_TEMPLATE_ID:"deleteFiltersConfirmMessage",_FILTER_DETAILS_LINK_ID:"#filtersDetails",_tablesAffectedInFilters:null,_nodes:null,_callback:null,_getTablesUsedForFilters:null,init:function(e){dd.deleteFiltersValidator._init.bind(dd.deleteFiltersValidator,e)()},validate:function(e,t){dd.deleteFiltersValidator._validate.bind(dd.deleteFiltersValidator,e,t)()},_init:function(e){this._getTablesUsedForFilters=e},_validate:function(e,t){this._callback=t,this._tablesAffectedInFilters=this._getTablesUsedForFilters(e),this._tablesAffectedInFilters.first()?domain.confirmDialog.show(this._DELETE_FILTERS_TEMPLATE_ID,this._onOk.bind(this),this._onCancel.bind(this),this._showAffectedResources.bind(this)):this._onOk()},_onOk:function(){this._callback&&this._callback()},_onCancel:function(){},_showAffectedResources:function(e){return domain.elementClicked(e,this._FILTER_DETAILS_LINK_ID)?(domain.detailsDialog.show(this._tablesAffectedInFilters),!0):void 0}},dd.calcFieldsAndFiltersValidator={init:function(e,t){dd.deleteCalcFieldsValidator.init(e),dd.deleteFiltersValidator.init(t)},validate:function(e,t,i){dd.deleteCalcFieldsValidator.validate(e,t,dd.calcFieldsAndFiltersValidator._deleteCalcFieldsCallback.bind(dd.calcFieldsAndFiltersValidator,i,e))},_deleteCalcFieldsCallback:function(e,t,i,n){dd.deleteFiltersValidator.validate(t,this._deleteFiltersCallback.bind(this,e,i,n))},_deleteFiltersCallback:function(e,t,i){e&&e(t,i)}},define("domain.designer.validators",["domain.designer"],function(e){return function(){var t;return t||e.dd}}(this)),dd.calculatedFields={PAGE:"calsFields",getValidationPostData:function(){return{page:this.PAGE}},fillForm:function(){$("unsavedChangesPresent").writeAttribute("value",dd.isUnsavedChangesPresent().toString())},init:function(e){dd.formDomId="calculatedFieldsForm",dd_calcFields.fields.init(),dd_calcFields.editor.init(e)}};var dd_calcFields=dd.calculatedFields;dd_calcFields.fields={ITEMS_TREE_DOM_ID:"fieldsTreeRoot",TREE_DATA_PROVIDER:"joinTreeDataProviderForCalcFields",itemsTree:null,init:function(){this.itemsTree=domain.createItemsTree({treeId:this.ITEMS_TREE_DOM_ID,providerId:this.TREE_DATA_PROVIDER,templateDomId:"list_responsive_collapsible_type_tables",nodeClass:domain.TablesNode,selectOnMousedown:!0}),this.itemsTree.showTree(1,this.initTreeEvents.bind(this),domain.treeErrorHandler),domain.resetTreeSelectionHandler.init(["#"+this.ITEMS_TREE_DOM_ID],function(){return[this.itemsTree]}.bind(this))},treeEventFactory:{"leaf:dblclick":function(e){var t=e.memo.node;if(Event.stop(e),t){var i=dd_calcFields.editor,n=new dd_calcFields.CalculatedField(t);i.insertFieldReference(n),i.mode===i.EMPTY_MODE&&i.edit(n)}}},initTreeEvents:function(){for(var e in this.treeEventFactory)this.itemsTree.observe(e,this.treeEventFactory[e].bind(this))},refreshTree:function(e){this.itemsTree.showTree(2,function(){if(e){var t=this.itemsTree.findNodeById(e);this.itemsTree.openAndSelectNode(t.param.uri)}}.bind(this))}},dd_calcFields.editor={FIELD_NAME_ELEMENT_ID:"fieldName",DATA_TYPE_ELEMENT_ID:"dataType",EXPRESSION_ELEMENT_ID:"expression",SAVE_BUTTON_ID:"saveField",CANCEL_BUTTON_ID:"cancelField",DELETE_BUTTON_ID:"deleteField",CONFIRM_DIALOG_ID:"editFieldConfirmMessage",EMPTY_MODE:"empty",EDIT_MODE:"edit",EDIT_ALLOWED:!0,init:function(e){this.calculatedField=null,this.mode=this.EMPTY_MODE,this._setFieldsUsedByFilters(e.fieldsUsedByFilters[e.dataSourceId]),this._initControls(),this._updateViewState(),this._initHandlers()},edit:function(e){this.calculatedField=e,this.mode=this.EDIT_MODE,this.EDIT_ALLOWED=!0,this.calculatedField.isEdit()?this._validateDeletion(function(e){e&&e.length>0&&(domain.enableButton(this._saveButton,!1),domain.enableButton(this._deleteButton,!1),dialogs.systemConfirm.show(domain._messages.cannot_edit_field),this.EDIT_ALLOWED=!1)}.bind(this)):this.calculatedField.resetName(),this._updateViewState(),this._nameInput.activate()},insertFieldReference:function(e){dd.insertAtCaret(this._expressionInput,e.getExpressionId(),this.selectionRange)},_initControls:function(){this._saveButton=$(this.SAVE_BUTTON_ID),this._cancelButton=$(this.CANCEL_BUTTON_ID),this._deleteButton=$(this.DELETE_BUTTON_ID),this._nameInput=$(this.FIELD_NAME_ELEMENT_ID),this._dataTypeInput=$(this.DATA_TYPE_ELEMENT_ID),this._expressionInput=$(this.EXPRESSION_ELEMENT_ID),this.selectionRange=null,this._elementTypesMap=$H({name:this._nameInput,expression:this._expressionInput})},_setFieldsUsedByFilters:function(e){this.fieldsUsedByFilters=$H(e||{})},_updateViewState:function(){this._modelToTemplate(),this._updateButtonsState()},_updateButtonsState:function(){switch(this.mode){case this.EMPTY_MODE:[this._saveButton,this._cancelButton,this._deleteButton].each(function(e){domain.enableButton(e,!1)});break;case this.EDIT_MODE:domain.enableButton(this._cancelButton,!0),this.EDIT_ALLOWED===!0&&(domain.enableButton(this._saveButton,!0),domain.enableButton(this._deleteButton,this.calculatedField&&this.calculatedField.isEdit()));break;default:throw"Unexpected Calculated Field editor's state: [#{mode}]".interpolate({mode:this.mode})}},_discardPreviousEditing:function(){this.mode=this.EMPTY_MODE,this.calculatedField=null,this._updateViewState(),this._clearAllErrors()},_modelToTemplate:function(){this._nameInput.setValue(this.calculatedField?this.calculatedField.name:""),this._dataTypeInput.setValue(this.calculatedField?this.calculatedField.type:"java.lang.String"),this._expressionInput.setValue(this.calculatedField?this.calculatedField.expression:"")},_templateToModel:function(){this.calculatedField?(this.calculatedField.setName(this._nameInput.getValue()),this.calculatedField.setType(this._dataTypeInput.getValue()),this.calculatedField.setExpression(this._expressionInput.getValue())):this.calculatedField=new dd_calcFields.CalculatedField(this._nameInput.getValue(),this._dataTypeInput.getValue(),this._expressionInput.getValue())},_save:function(){this._templateToModel(),this._clearAllErrors(),this._validate()&&(this._isFieldNotUsedByFilter()?this._sendValidationRequest():this._showWarningDialog(domain.getMessage("confirm_filter_delete"),this._sendValidationRequest.bind(this)))},_validate:function(){return ValidationModule.validate([{validator:function(e){return domain.stringIdValidator(e,domain.getMessage("wrong_name_format"))},element:this._nameInput}])},_isFieldNotUsedByFilter:function(){return!this.fieldsUsedByFilters.any(function(e){return this.calculatedField.oldName===e.value.itemId},this)},_sendValidationRequest:function(){var e={calculateField:Object.toJSON(this.calculatedField)};this.calculatedField.isEdit()&&(e.oldCalcFieldName=this.calculatedField.getExpressionId()),dd_calcFields.sendAjaxRequest({eventId:"validateCalcField",flowExecutionKey:dd.flowExecutionKey},e,function(e){var t=e.down("#validationSuccess"),i=e.down("#validationWarning"),n=e.down("#validationFailed");return i?this._showWarningDialog(i.innerHTML,t&&this._doSave.bind(this,t.innerHTML)):t?this._doSave(t.innerHTML.replace(/\&amp;/g,"&")):n?this._handleValidationFailure(n.innerHTML,n.readAttribute("for")):void 0}.bind(this))},_doSave:function(e){var t=e.evalJSON()[0];this.calculatedField.isEdit()?this._removeField(function(){var e=this.calculatedField.getExpressionId();t.oldCalcFieldName=e,this._addCalculatedField(t)}.bind(this)):this._addCalculatedField(t)},_handleValidationFailure:function(e,t){this._showError(this._elementTypesMap.get(t),e)},_showWarningDialog:function(e,t){$(this.CONFIRM_DIALOG_ID).down(".message").update(e);var i=function(){domain.confirmDialog.hideForDetails()};domain.confirmDialog.show(this.CONFIRM_DIALOG_ID,t||i,i,null,domain.confirmDialog.MODE_YES_NO)},_addCalculatedField:function(e){dd.setUnsavedChangesPresent(!0),e.calculateField=Object.toJSON(this.calculatedField),dd_calcFields.sendAjaxRequest({eventId:"createCalcField",flowExecutionKey:dd.flowExecutionKey},e,this._saveFieldHandler.bind(this))},_saveFieldHandler:function(e){var t=e.innerHTML.replace(/\&amp;/g,"&").evalJSON()[0];dd_calcFields.fields.refreshTree(t.id);var i=this.calculatedField.isEdit()?"calculated_field_edited":"calculated_field_added";dialogs.systemConfirm.show(domain.getMessage(i,{field:t.id})),this._discardPreviousEditing()},_cancel:function(){this._discardPreviousEditing()},_remove:function(){var e=function(){this._validateDeletion(function(){this._removeField(function(){dd_calcFields.fields.refreshTree(),dialogs.systemConfirm.show(domain.getMessage("calculated_field_removed",{field:this.calculatedField.getExpressionId()})),this._discardPreviousEditing()}.bind(this))}.bind(this))}.bind(this);this._isFieldNotUsedByFilter()?e():this._showWarningDialog(domain.getMessage("confirm_filter_delete"),e)},_validateDeletion:function(e){dd_calcFields.sendAjaxRequest({eventId:"validateCalculateFieldDeletion",flowExecutionKey:dd.flowExecutionKey},{calculateField:this.calculatedField.getExpressionId()},function(){var t=["involvedFieldsIds","involvedFieldsExpressionIds"].collect(function(e){var t=$$("#ajaxbuffer #"+e)[0];return t?t.innerHTML.evalJSON():null});e.apply(this,t)}.bind(this))},_removeField:function(e){dd.setUnsavedChangesPresent(!0),dd_calcFields.sendAjaxRequest({eventId:"deleteCalculatedField",flowExecutionKey:dd.flowExecutionKey},{fieldsToDelete:Object.toJSON([this.calculatedField.getExpressionId()])},e)},_initHandlers:function(){this.buttonHandlersMap=this._buttonHandlersFactory(),domain.registerClickHandlers([this._clickHandler.bind(this)]),[this._nameInput,this._dataTypeInput,this._expressionInput].each(function(e){e.observe("change",function(){""===this._nameInput.getValue()&&""===this._expressionInput.getValue()?this.mode=this.EMPTY_MODE:this.mode=this.EDIT_MODE,this._updateButtonsState()}.bind(this))},this),this._expressionInput.observe("mouseup",this._saveSelection.bind(this))},_clickHandler:function(e){domain.basicClickHandler(e,this.buttonHandlersMap)},_buttonHandlersFactory:function(){return $H({"#saveField":this._save.bind(this),"#cancelField":this._cancel.bind(this),"#deleteField":this._remove.bind(this)})},_saveSelection:function(){document.selection&&(this.selectionRange=document.selection.createRange())},_showError:function(e,t){e&&ValidationModule.showError(e,t)},_clearAllErrors:function(){this._elementTypesMap.each(function(e){ValidationModule.hideError(e.value)})}},dd_calcFields.CalculatedField=function(){if(0===arguments.length)return this;if(1===arguments.length){var e=arguments[0];this.expression=e.param.extra.expression,this.expression&&(this.expression=this.expression.unescapeHTML(),this.setIsEdit(!0)),this.oldName=this.name=e.param.extra.itemId,this.type=e.param.extra.JavaType,this.parentName=e.parent.param.extra.itemId}else 3===arguments.length&&(this.setName(arguments[0]),this.setType(arguments[1]),this.setExpression(arguments[2]))},dd_calcFields.CalculatedField.addMethod("setName",function(e){this.name=e}),dd_calcFields.CalculatedField.addMethod("resetName",function(){this.oldName=this.name=""}),dd_calcFields.CalculatedField.addMethod("setType",function(e){this.type=e}),dd_calcFields.CalculatedField.addMethod("setExpression",function(e){this.expression=e.unescapeHTML()}),dd_calcFields.CalculatedField.addMethod("toJSON",function(){return{name:this.name,type:this.type,expression:dd_calcFields.normalizeLt(this.expression)}}),dd_calcFields.CalculatedField.addMethod("setIsEdit",function(e){this.isEditMode=e}),dd_calcFields.CalculatedField.addMethod("isEdit",function(){return!!this.isEditMode}),dd_calcFields.CalculatedField.addMethod("getExpressionId",function(){return[this.parentName,this.oldName||this.name].join(".").replace(/'/g,"''")}),dd_calcFields.sendAjaxRequest=function(e,t,i){domain.sendAjaxRequest(e,t,i,{mode:AjaxRequester.prototype.TARGETTED_REPLACE_UPDATE,fillLocation:"ajaxbuffer"})},dd_calcFields.normalizeLt=function(e){return e.replace(/\s*([<])\s*([^=])/g," $1 $2")},"undefined"==typeof require&&document.observe("dom:loaded",dd.initialize.bind(dd)),define("domain.designer.calculatedFields",["domain.designer.validators"],function(e){return function(){var t;return t||e.dd_calcFields}}(this)),define("domain/domainDesignerCalculatedFieldsMain",["require","!domReady","underscore","domain.components","domain.designer.validators","jrs.configs","domain.designer.calculatedFields"],function(e){"use strict";var t=e("!domReady"),i=e("underscore"),n=e("domain.components"),a=e("domain.designer.validators"),d=e("jrs.configs");e("domain.designer.calculatedFields"),t(function(){"undefined"==typeof window.localContext&&(window.localContext={}),i.extend(window.localContext,d.domainDesigner.localContext),i.extend(n._messages,d.domainDesigner.domain._messages),a.initialize()})});