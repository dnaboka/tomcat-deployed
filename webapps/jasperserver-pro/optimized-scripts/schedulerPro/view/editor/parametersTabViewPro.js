define(["require","controls.options","controls.controller","jquery","underscore","backbone","schedulerPro/enum/scheduledResourceTypeEnum","scheduler/view/editor/parametersTabView","dashboard/model/DashboardModel","dashboard/dashboardSettings","dashboard/factory/dashboardComponentViewFactory","schedulerPro/model/dashboardControlsControllerAdapter","text!scheduler/template/editor/parametersTabTemplate.htm"],function(e){"use strict";e("controls.options"),e("controls.controller");var o=e("jquery"),t=e("underscore"),r=e("backbone"),i=e("schedulerPro/enum/scheduledResourceTypeEnum"),n=e("scheduler/view/editor/parametersTabView"),s=e("dashboard/model/DashboardModel"),a=e("dashboard/dashboardSettings"),d=e("dashboard/factory/dashboardComponentViewFactory"),l=e("schedulerPro/model/dashboardControlsControllerAdapter");e("text!scheduler/template/editor/parametersTabTemplate.htm");return n.extend({events:{"click [name=saveCurrentValuesButton]":"saveCurrentValuesClick"},initialize:function(e){var o=n.prototype.initialize.apply(this,arguments);return this.listenTo(this.model,"change:source",this.sourceChangeReportOptions),o},remove:function(){return this.reportOptionsDialog&&this.reportOptionsDialog.remove(),r.View.prototype.remove.apply(this,arguments)},render:function(){var e=n.prototype.render.apply(this,arguments);return this.model.resourceType!==i.DASHBOARD&&(this.reportOptions=new JRS.Controls.ReportOptions,o(document).on("viewmodel:selection:changed",t.bind(this.viewModelSelectionChange,this)),this.reportOptionsDialog=new OptionsDialog({"button#saveAsBtnSave":t.bind(this.saveAsDialogButtonSaveClick,this),"button#saveAsBtnCancel":t.bind(this.saveAsDialogButtonCancelClick,this)})),e},saveCurrentValuesClick:function(){this.reportOptionsDialog.show()},saveAsDialogButtonSaveClick:function(){var e=this,t=this.reportOptionsDialog.input.getValue(),r=this.model.controlsController.getViewModel().get("selection"),i=t===this.reportOptionsDialog.optionNameToOverwrite;o.when(this.reportOptions.add(this.reportOptions.optionsUrl||this.reportOptions.url,t,r,i)).done(function(){e.reportOptionsDialog.hideWarning();var o=e.reportOptions.getElem().parent();0===o.length&&(o=e.$el.find(".saveCurrentValuesContainer"),o.prepend(e.reportOptions.getElem())),e.reportOptionsDialog.hide(),delete e.reportOptionsDialog.optionNameToOverwrite}).fail(function(r){try{var n=o.parseJSON(r.responseText);"report.options.dialog.confirm.message"===n.errorCode&&!i&&(e.reportOptionsDialog.optionNameToOverwrite=t),e.reportOptionsDialog.showWarning(n.message)}catch(s){}})},saveAsDialogButtonCancelClick:function(){this.reportOptionsDialog.hide()},sourceChange:function(e,o){if(this.model.resourceType==i.DASHBOARD){this.$(".saveCurrentValuesContainer").hide();var t=!this.dashboardModel||this.dashboardModel.get("uri")!==o.reportUnitURI,r=this.model;if(!this.dashboardModel){a.CONTEXT_PATH="..";var p=this.$("#inputControlsContainer"),h=this;this.dashboardModel=new s({uri:o.reportUnitURI},{contextPath:a.CONTEXT_PATH}),this.dashboardModel.on("propertiesAvailable",function(e){if(e.get("useFixedSize"))h.model.fixedSize=!0,h.model.update("source",{referenceWidth:e.get("fixedWidth"),referenceHeight:e.get("fixedHeight")});else{var o=h.model.get("source");h.model.update("source",{referenceWidth:o.referenceWidth||a.DEFAULT_REFERENCE_WIDTH,referenceHeight:o.referenceHeight||a.DEFAULT_REFERENCE_HEIGHT})}}),this.dashboardModel.foundations.on("addComponent",function(e,t){if(t===h.dashboardModel.currentFoundation&&"inputControl"==e.get("type")){h.dashboardModel.hasControls=!0,function(o,t){e.on(o,function(e){var o=r.get("source");o.parameters.parameterValues[t]=e,r.set("source",o)}),h.model.get("source").parameters.parameterValues[o]&&e.set("value",h.model.get("source").parameters.parameterValues[o])}(e.getOwnerParameterName(),e.id);var i=d({model:e,dashboardProperties:h.dashboardModel.currentFoundation.components.getDashboardPropertiesComponent(),dashboardId:o.reportUnitURI});h.model.controlsController.controls.push(i),p.append(i.render().$el)}}),this.model.controlsController=new l(this.model)}t&&this.dashboardModel.fetch().done(function(){h.trigger(h.dashboardModel.hasControls?"IC_Displayed":"failedToGet_IC")}).fail(function(){h.trigger("failedToGet_IC")})}else n.prototype.sourceChange.apply(this,arguments)},sourceChangeReportOptions:function(e,t){var r=this,i=t&&t.reportUnitURI;if(this.reportOptions&&i!==this.reportOptions.url){this.reportOptions.optionsUrl=void 0,this.model.resource("reportOptions",this.model.get("source").reportUnitURI,function(e,t){e||(r.reportOptions.optionsUrl=t.reportUri,o.when(r.reportOptions.fetch(t.reportUri||i,"")).done(function(){r.$el.find(".saveCurrentValuesContainer").prepend(r.reportOptions.getElem()),o(document).trigger("viewmodel:selection:changed")}))});var n=this.model.get("repositoryDestination").folderURI;this.model.checkPermissionOnFolder(n,function(e,o){var t=!1;e||(t=1===o||30===o),r.$el.find("[name=saveCurrentValuesButton]").attr("disabled",t?null:"disabled")}),this.reportOptions.url=i}},viewModelSelectionChange:function(){var e=this.reportOptions.find({uri:this.reportOptions.url});this.reportOptions.set({selection:e},!0)}})});