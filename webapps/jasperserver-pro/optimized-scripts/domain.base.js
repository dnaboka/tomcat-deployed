var domain={PROPAGATE_EVENT:"propagateEvent",_messages:{},disabledFolderTooltip:"disabledFolderTooltip",attributesPattern:new RegExp("\\s*attribute\\s*\\(\\s*'[^\\/'\\s][^\\/']*'(?:\\s*,\\s*'[^\\/'\\s][^\\/']*')*\\s*\\)\\s*"),getMessage:function(e,r){var t=this._messages[e];return t?new Template(t).evaluate(r?r:{}):""},setMessage:function(e,r){this._messages[e]=r},treeErrorHandler:function(){throw"exception while loading tree"},submitForm:function(e,r,t){if(r){var n=buildActionUrl(r);t&&t(),$(e).writeAttribute("method","post").writeAttribute("action",n),$(e).submit()}},sendAjaxRequest:function(e,r,t,n){var o=buildActionUrl(e),d={postData:Object.toQueryString(r),callback:t,errorHandler:this._serverErrorHandler,mode:AjaxRequester.prototype.EVAL_JSON};n&&Object.extend(d,n),ajaxTargettedUpdate(o,d)},_serverErrorHandler:function(e,r){return baseErrorHandler(e)},elementClicked:function(e,r){return e&&r?matchAny(e,[r],!0):!1},basicClickHandler:function(e,r,t){var n=null;return r.any(function(r){return n=domain.elementClicked(e,r.key),n?(Object.isFunction(r.value)?r.value(n):Object.isFunction(t)&&t(r.value),!0):void 0})},registerClickHandlers:function(e,r,t){if(domain._bodyClickEventHandlers)return void(t?Array.prototype.unshift:Array.prototype.push).apply(domain._bodyClickEventHandlers,e);domain._bodyClickEventHandlers=e;var n=r?r:"body";$$(n)[0].observe(isSupportsTouch()?"touchstart":"click",function(e){var r=e.element();domain._bodyClickEventHandlers&&domain._bodyClickEventHandlers.each(function(t){var n=t(r);if(n)throw n!==domain.PROPAGATE_EVENT&&Event.stop(e),$break})})},enableButton:function(e,r){"string"==typeof e&&(e=$(e)),e.disabled=r,r?buttonManager.enable(e):buttonManager.disable(e)},setOptionsToSelect:function(e,r){return e&&(e.update(""),r)?(r.each(function(r){var t={value:r.value,title:r.label};r.selected&&(t.selected="selected");var n=new Element("option",t);n.appendChild(document.createTextNode(r.label)),e.appendChild(n)}),e):void 0},getDataIslandId:function(e,r){var t=dynamicTree.trees[e.getTreeId()].getRootNode(),n=function o(e,r){return null===e.parent||e.parent===t?e.param.extra[r]:o(e.parent,r)};return n(e,r)},areNodesFromSameIsland:function(e,r){var t=e.any(function(e){return e.param.extra.isConstant});if(t)return!0;var n=1===e.pluck("parent").uniq().length;return n?!0:1===e.map(function(e){return domain.getDataIslandId(e,r||"itemId")}).uniq().length},NumberFormat:function(e,r){var t="."===e,n=new RegExp("["+e.gsub(/\s/,"\\s")+"]+"),o=new RegExp("["+r.gsub(/\s/,"\\s")+"]+"),d=new RegExp("^-|\\"+r+"?\\d+|\\"+r+"$|\\"+e+"+","g");return{toNumber:function(e){return!e||!t&&/[.]/.test(e)?NaN:Number(e.gsub(o,"").gsub(n,"."))||domain.attributesPattern.test(e)},normalizeNumberEntry:function(t){var n=t.strip(),o=n.match(domain.attributesPattern)||n.match(d);if(!o)return"";for(var i=!1,a=0;a<o.length;a++)o[a].startsWith(e)?i?delete o[a]:(o[a]=e,i=!0):o[a].startsWith(r)&&i&&(o[a]=o[a].substring(1));var l=o.join("");return l},isInteger:function(e){return n.test(e)}}},baseValidator:function(e,r){var t=!0,n="";return e()&&(n=r,t=!1),{isValid:t,errorMessage:n}},maxLengthValidator:function(e,r,t){return domain.baseValidator(function(e,r){return e.length>r}.curry(e,r),t)},minLengthValidator:function(e,r,t){return domain.baseValidator(function(e,r){return e.length<r}.curry(e,r),t)},valueNotEmptyValidator:function(e,r){return domain.baseValidator(function(e){return Object.isArray(e)&&0===e.length||!e||!String(e).strip()}.curry(e),r)},stringIdValidator:function(e,r){return domain.baseValidator(function(e){return!/^[^0-9() .,'"=!+-\/><\/\/:][^() .,'"=!+-\/><\/\/:]*$/.test(e)}.curry(e),r)},numberValidator:function(e,r,t){return domain.baseValidator(isNaN.curry(r.toNumber(e)),t)},numberBoundsValidator:function(e,r,t){return domain.baseValidator(function(e,r){return e===1/0||e===-(1/0)?!0:!(e<=r.max&&e>=r.min)}.curry(e,r),t)},rangeValidator:function(e,r,t){return domain.baseValidator(function(e,r){return!(r>e)}.curry(e,r),t)},dateValidator:function(e,r,t){return domain.baseValidator(function(e,r){return 0===getDateFromFormat(r,e)&&!domain.attributesPattern.test(r)}.curry(r,e),t)},unescapeTree:function e(r){r.hasChilds()&&_.each(r.childs,function(r){e(r)}),r.name=xssUtil.unescape(r.name)}};domain.NodeCopyMoveController=function(){},domain.NodeCopyMoveController.addMethod("copy",function(e,r,t){if(e&&e.length>0&&r){var n=dynamicTree.trees[r.getTreeId()],o=e.collect(function(e){var o=e.param.id,d=this._copyParentStructure(e,n);return d?this._mergeToDestTree(d,r,o,t):null}.bind(this));return r.isloaded=!0,o.without(null)}}),domain.NodeCopyMoveController.addMethod("copySelected",function(e,r){return sourceTree&&r?this.copy(sourceTree.selectedNodes,r):void 0}),domain.NodeCopyMoveController.addMethod("move",function(e,r){if(e&&r){var t=this.copy(e,r);return this.hide(e),t}}),domain.NodeCopyMoveController.addMethod("moveSelected",function(e,r){return e&&r?this.move(e.selectedNodes,r):void 0}),domain.NodeCopyMoveController.addMethod("hide",function(e,r,t){if(e&&e.length>0){r||(r=this._getVisibleChildrenCount),t||(t=function(e,r){e.hide(r)});var n=dynamicTree.trees[e[0].getTreeId()];e.collect(function(e){return e.id}).each(function(e){var o=dynamicTree.nodes[e];t(o,!0);for(var d=o.parent;d&&d!=n.getRootNode()&&!(r(d)>0);)t(d,!1),d.refreshStyle(),d=d.parent}.bind(this))}}),domain.NodeCopyMoveController.addMethod("_handleDuplicatedNode",function(e,r){return e.param.id}),domain.NodeCopyMoveController.addMethod("_markAsLoaded",function(e){e.isloaded=!0,e.isParent()&&e.childs.each(function(e){this._markAsLoaded(e)}.bind(this))}),domain.NodeCopyMoveController.addMethod("_mergeToDestTree",function(e,r,t,n){if(r){var o=dynamicTree.trees[r.getTreeId()];if(n)return t=this._handleDuplicatedNode(e,r),o.findNodeById(t,e);var d=o.findNodeChildByMetaName(r,e.param.id);return null!=d?(d.isHidden()&&d.show(),e.hasChilds()&&(d.disabled&&d.enable(e.tooltip),e.childs.each(function(e){this._mergeToDestTree(e,d)}.bind(this))),o.findNodeById(t,d)):(r.addChild(e),this._markAsLoaded(e),o.findNodeById(t,e))}}),domain.NodeCopyMoveController.addMethod("_copyParentStructure",function(e,r){if(e&&r){var t=dynamicTree.trees[e.getTreeId()];if(e.disabled)return null;for(var n=this._copyNode(e,r,!0),o=e.parent,d=null;o&&o!=t.getRootNode();)d=this._copyNode(o,r,!1),d.addChild(n),n=d,o=o.parent;return n}}),domain.NodeCopyMoveController.addMethod("_buildMetanode",function(e){return deepClone(e.param)}),domain.NodeCopyMoveController.addMethod("_copyNode",function(e,r,t){if(e&&r){var n=r.processNode(this._buildMetanode(e));t&&(e.hasChilds()?e.childs.each(function(e){if(!e.disabled){var e=this._copyNode(e,r,t);e&&n.addChild(e)}}.bind(this)):n.setHasChilds(!1));var o=e.childs.findAll(function(e){return e.disabled});return e.childs.length>0&&o.length==e.childs.length?null:n}}),domain.NodeCopyMoveController.addMethod("_delete",function(e){e&&e.collect(function(e){return e.id}).each(function(e){var r=dynamicTree.nodes[e];r&&r.parent.removeChild(r)})}),domain.NodeCopyMoveController.addMethod("_getVisibleChildrenCount",function(e){var r=e.childs.findAll(function(e){return e.isHidden()});return e.childs.length-r.length}),domain.resetTreeSelectionHandler={_COMMON_ELEMENTS_TO_SAVE_SELECTION:["#pageDimmer","#detail","#standardConfirm"],_getTrees:null,_elementIds:null,_callback:null,_validator:null,init:function(e,r,t,n){domain.resetTreeSelectionHandler._init.bind(domain.resetTreeSelectionHandler,e,r,t,n)()},_init:function(e,r,t,n){this._getTrees=r,this._callback=t,this._validator=n,this._elementIds=this._COMMON_ELEMENTS_TO_SAVE_SELECTION.concat(e),domain.registerClickHandlers([this._removeTreeSelectionClickEventHandler.bind(this)],null,!0)},_removeTreeSelectionClickEventHandler:function(e){if(!matchAny(e,this._elementIds,!0)){var r=!1;return this._getTrees().each(function(e){if(e.selectedNodes&&e.selectedNodes.first())throw r=!0,$break}),r?this._validator&&!this._validator()?!0:(this._getTrees().each(function(e){e._deselectAllNodes()}),this._callback&&this._callback(),!1):!1}}},domain.NodeChangeOrderController=function(){},domain.NodeChangeOrderController.addMethod("findNodeWithSpecificOrder",function(e,r,t){for(var n=e.length-1;n>=0;n--)if(e[n].isSelected()==t&&e[n].orderNumber===r)return e[n];return null}),domain.NodeChangeOrderController.addMethod("findMaxSiblingNode",function(e,r,t){var n=null,o=null;return e.each(function(e){e.isSelected()==r&&(null===n||t==e.orderNumber<n)&&(n=e.orderNumber,o=e)}),o}),domain.NodeChangeOrderController.addMethod("moveNode",function(e,r,t,n){var o=e.orderNumber,d=e.parent.childs,i=null,a=null;t?(i=this.findMaxSiblingNode(d,!1,r,e.param.type),a=i?i.orderNumber:-1,d.each(function(t){t.param.id!==e.param.id&&(r==t.orderNumber>a&&r==t.orderNumber<o||t.orderNumber==a)&&(t.orderNumber=r?t.orderNumber+1:t.orderNumber-1,n&&n(t,t.orderNumber))}),n&&n(e,a),e.orderNumber=a):(a=r?e.orderNumber-1:e.orderNumber+1,i=this.findNodeWithSpecificOrder(d,a,!1),i&&(n&&n(e,a),n&&n(i,o),e.orderNumber=a,i.orderNumber=o))}),domain.NodeChangeOrderController.addMethod("nodeAscSorter",function(e,r){return e.orderNumber-r.orderNumber}),domain.NodeChangeOrderController.addMethod("nodeDescSorter",function(e,r){return r.orderNumber-e.orderNumber}),domain.DisplayNodeChangeOrderController=function(){domain.NodeChangeOrderController.call()},domain.DisplayNodeChangeOrderController.prototype=deepClone(domain.NodeChangeOrderController.prototype),domain.DisplayNodeChangeOrderController.addMethod("findMaxSiblingNode",function(e,r,t,n){var o=null,d=null;return e.each(function(e){e.isSelected()==r&&(null!==o&&t!=e.orderNumber<o||(n?e.param.type!==n:0)||(o=e.orderNumber,d=e))}),d});