define(["require","exports","module","underscore","jquery","logger","domReady","backbone","bundle!CommonBundle","common/util/domUtil"],function(e,t,n){"use strict";var o=e("underscore"),i=e("jquery"),r=e("logger").register(n),a=(e("domReady"),e("backbone")),l=e("bundle!CommonBundle"),s=e("common/util/domUtil");return a.View.extend({overlayDOMObject:[],$overlayHolder:!1,scaleFactor:1,savedExternalContainersOverflow:!1,initialize:function(e){this.propertiesModel=e.propertiesModel,this.setExternalContainer(e.externalContainer),this.setBiComponentContainer(e.biComponentContainer),this.setBiComponent(e.biComponent),this.setScaleFactor(e.scaleFactor)},setExternalContainer:function(e){this.$externalContainer=i(e)},setBiComponentContainer:function(e){this.$biComponentContainer=i(e)},setBiComponent:function(e){this.$biComponent=i(e)},setScaleFactor:function(e){o.isUndefined(e)||(this.scaleFactor=e)},applyScale:function(e){o.isUndefined(e)||(this.scaleFactor=e,this._applyScaleTransform())},show:function(){return this.$biComponentContainer.length<1?void r.debug("loading overlay: external container is absent"):0===this.$biComponentContainer.height()||0===this.$biComponentContainer.width()?void r.debug("loading overlay: component container has zero size"):this.propertiesModel.get("isolateDom")&&!this.$biComponent.height()?void r.debug("iframe mode: bi component hasn't any size"):(this._buildOverlay(),this._attachToContainer(),this.hideScrollBarOnContainer(),this._adjustOverlaySizeAndPosition(),this._applyScaleTransform(),void this.$overlayHolder.show())},hide:function(){this.$overlayHolder&&this.$overlayHolder.hide(),this.showScrollBarOnContainer()},showScrollBarOnContainer:function(){this.savedExternalContainersOverflow===!0&&(this.$externalContainer.css("overflow-x",this.savedExternalContainerOverflowValueX),this.$externalContainer.css("overflow-y",this.savedExternalContainerOverflowValueY),this.savedExternalContainersOverflow=!1)},hideScrollBarOnContainer:function(){if(this.savedExternalContainersOverflow===!1){var e=s.hasScrollBar(this.$externalContainer[0],"vertical")||s.hasScrollBar(this.$externalContainer[0],"horizontal");e&&(this.savedExternalContainerOverflowValueX=this.$externalContainer.css("overflow-x"),this.savedExternalContainerOverflowValueY=this.$externalContainer.css("overflow-y"),this.savedExternalContainersOverflow=!0,this.$externalContainer.css("overflow-x","hidden"),this.$externalContainer.css("overflow-y","hidden"))}},remove:function(){return this.hide(),a.View.prototype.remove.call(this)},_buildOverlay:function(){0===this.overlayDOMObject.length&&0===this.overlayDOMObject.length&&(this.overlayDOMObject=i("<div>"+l["dialog.overlay.loading"]+"</div>").css({position:"absolute",top:20,left:0,width:"100%",color:"#fff","text-align":"center"}))},_attachToContainer:function(){this.$overlayHolder&&this.$overlayHolder.remove(),this.$overlayHolder=i("<div></div>").append(i("<div></div>").css({width:"100%",height:"100%",filter:"alpha(opacity=40)",opacity:".4","background-color":"black"})),this.$overlayHolder.append(this.overlayDOMObject),this.$overlayHolder.prependTo(this.$biComponentContainer)},_adjustOverlaySizeAndPosition:function(){var e,t,n=0,i=0,a={padding:{left:0,top:0,right:0,bottom:0},innerHeight:this.$externalContainer.innerHeight(),innerWidth:this.$externalContainer.innerWidth(),outerHeight:this.$externalContainer.outerHeight(),outerWidth:this.$externalContainer.outerWidth(),scrollHeight:this.$externalContainer[0].scrollHeight,scrollWidth:this.$externalContainer[0].scrollWidth,scrollTop:this.$externalContainer.scrollTop(),scrollLeft:this.$externalContainer.scrollLeft()};a.padding.top=parseInt(this.$externalContainer.css("paddingTop"),10),o.isNaN(a.padding.top)&&(a.padding.top=0),a.padding.right=parseInt(this.$externalContainer.css("paddingRight"),10),o.isNaN(a.padding.right)&&(a.padding.right=0),a.padding.bottom=parseInt(this.$externalContainer.css("paddingBottom"),10),o.isNaN(a.padding.bottom)&&(a.padding.bottom=0),a.padding.left=parseInt(this.$externalContainer.css("paddingLeft"),10),o.isNaN(a.padding.left)&&(a.padding.left=0),a.scrollWidth<=a.outerWidth?(r.debug("width: biComponent is smaller than container or equal OR container doesn't have horizontal scroll bars"),e=a.innerWidth-(a.padding.left+a.padding.right),i=a.scrollLeft):(r.debug("width: biComponent is larger than container"),i=a.scrollLeft-(a.scrollLeft<a.padding.left?0:a.padding.left),e=a.innerWidth+a.padding.right,a.scrollLeft+a.outerWidth>=a.scrollWidth-a.padding.right&&(r.debug("width: scrolled to the end"),e=a.innerWidth)),a.scrollHeight<=a.outerHeight?(r.debug("height: biComponent is smaller than container or equal OR container doesn't have vertical scroll bars"),t=a.innerHeight-(a.padding.top+a.padding.bottom),n=a.scrollTop):(r.debug("height: biComponent is larger than container"),n=a.scrollTop-(a.scrollTop<a.padding.top?0:a.padding.top),t=a.innerHeight+a.padding.bottom,a.scrollTop+a.outerHeight>=a.scrollHeight-a.padding.bottom&&(r.debug("height: scrolled to the end"),t=a.innerHeight)),this.$overlayHolder.css({position:"absolute",top:n,left:i,"z-index":495,width:e/this.scaleFactor,height:t/this.scaleFactor,display:"none"})},_applyScaleTransform:function(){var e="scale("+this.scaleFactor+")",t="top left",n={"-webkit-transform":e,"-moz-transform":e,"-ms-transform":e,"-o-transform":e,filter:"progid:DXImageTransform.Microsoft.Matrix(M11="+this.scaleFactor+", M12=0, M21=0, M22="+this.scaleFactor+", SizingMethod='auto expand')",transform:e,"-webkit-transform-origin":t,"-moz-transform-origin":t,"-ms-transform-origin":t,"-o-transform-origin":t,"transform-origin":t};this.$overlayHolder&&this.$overlayHolder.css(n)}})});