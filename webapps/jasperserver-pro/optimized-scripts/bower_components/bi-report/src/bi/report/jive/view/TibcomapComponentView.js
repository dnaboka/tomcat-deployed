define(["require","./BaseJiveComponentView","../jr/tibcoGeoanalitics","csslink!bi/report/jive/jr/theme/tibco-geoanalitics.css"],function(e){"use strict";var t=e("./BaseJiveComponentView"),n=e("../jr/tibcoGeoanalitics");return e("csslink!bi/report/jive/jr/theme/tibco-geoanalitics.css"),t.extend({render:function(e){this.$reportEl=e,this.infowindow={},this._init()},_init:function(){var e=this,t=e.model.get("instanceData");e._showMap(e.model.get("id"),t)},_showMap:function(e,t){var o,r,i=this,a=t.mapData,l=t.markerList,s=t.pathsList,c={},u={};i._getCoords(a,a.customerName,a.customerKey).then(function(t){if(c.center=new n.LatLng(t.latitude,t.longitude),c.zoom=a.zoom?a.zoom:5,c.urlLocation=!1,a.minZoom&&(c.minZoom=a.minZoom),a.maxZoom&&(c.maxZoom=a.maxZoom),a.repeatX&&(c.repeatX=i._isTrue(a.repeatX,!0)),r=new n.Map(i.$reportEl.find("#"+e)[0],c),a.layerName&&(u.name=a.layerName),a.opacity&&(u.opacity=a.opacity),o=new n.TibcoLayer(u),r.addLayer(o),s&&s.length>0){var m,d,f,g,y,h,p,w,k,v,_,L,b,C={};for(C.useCanvas=i._isTrue(a.useCanvas,!1),a.pathsLayerName&&(C.name=a.pathsLayerName),a.clipOffset&&(C.clipOffset=a.clipOffset),m=new n.VectorLayer(C),r.addLayer(m),d=0;d<s.length;d++){f=s[d],y={},h=[],p=!1;for(g in f)if("locations"===g&&f[g])for(w=f[g],k=0;k<w.length;k++)v=w[k],i._getCoords(v,a.customerName,a.customerKey).then(function(e){h.push([e.latitude,e.longitude])},function(e){});else"dashArray"===g||"lineCap"===g||"lineJoin"===g?m.options.defaultStyle[g]=f[g]:"isPolygon"===g?p=i._isTrue(f[g],!1):"clickable"===g?L=i._isTrue(f[g],!0):"reverseCoordinates"===g?b=i._isTrue(f[g],!1):"stroke"===g||"fill"===g?y[g]=i._isTrue(f[g],!0):y[g]=f[g];if(p){var T=[h];_=new n.Polygon(T)}else _=new n.Polyline(h);_.options.clickable=L,_.options.reverseCoordinates=b,_.setStyle(y),m.addGeometry(_)}}if(l&&l.length>0){var N,j,M,x,Z,z,P,G,J,K,O,U={};for(a.markersLayerName&&(U.name=a.markersLayerName),N=new n.MarkersLayer(U),r.addLayer(N),j=0;j<l.length;j++)M=l[j],function(e){i._getCoords(e,a.customerName,a.customerKey).then(function(t){x=new n.LatLng(t.latitude,t.longitude),Z=i._isTrue(e.draggable,!1),G=e.xoffset?e.xoffset:0,J=e.yoffset?e.yoffset:0,z={draggable:Z,offset:new n.Point(G,J)},e.anchor&&(z.anchor=e.anchor),e["icon.url"]&&e["icon.url"].length>0?e.title&&e.title.length>0?(K="<img src='"+e["icon.url"]+"' title='"+e.title+"'",e.hyperlink&&e.hyperlink.length>0&&(O=e.target&&e.target.length>0?e.target:"_blank",K+=" onclick=\"javascript:window.open('"+e.hyperlink+"', '"+O+"')\""),K+="/>",P=new n.HtmlMarker(x,K,z)):(P=new n.ImageMarker(x,e["icon.url"],z),e.hyperlink&&e.hyperlink.length>0&&(P.myUrl=e.hyperlink,P.target=e.target&&e.target.length>0?e.target:"_blank")):e.html&&e.html.length>0&&(P=new n.HtmlMarker(x,e.html,z)),P&&N.addMarker(P)},function(e){})}(M);N.events.on("marker-click",function(e){e&&e.myUrl&&window.open(e.myUrl,e.target)})}i._isTrue(a["layers.control"],!1)&&r.addControl(new n.LayersControl({}))},function(e){})},_getCoords:function(e,t,o){var r,i=new n.Promise;if(e.latitude||e.longitude)r={},r.latitude=e.latitude,r.longitude=e.longitude,i.resolve(r);else if(e.country){var a=new n.Geocoder(t,o),l={country:e.country,city:e.city,zip:e.zip,state:e.state,street:e.street};a.geocode(l).then(function(e){e[0]&&(r={},r.latitude=e[0].location.lat,r.longitude=e[0].location.lng,i.resolve(r))},function(e){i.reject(e)})}return i},_isTrue:function(e,t){return e?e===!0||"true"===e:t===!0||"true"===t}})});