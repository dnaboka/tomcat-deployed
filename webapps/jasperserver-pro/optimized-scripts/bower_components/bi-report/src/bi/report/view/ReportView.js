define(["require","underscore","backbone","../jive/enum/jiveTypes","../enum/reportCreators","../jive/view/JiveComponentCollectionView","../enum/reportOutputFormats","jquery","common/util/browserDetection","../enum/reportEvents","../enum/scaleStrategies","common/util/domUtil","domReady","./LoadingOverlay","logger","./LocalFrameView","jquery-ui/jquery.ui.core"],function(e){"use strict";function t(e,t,i,o,r){var n;if(e===p.WIDTH)n=o/t;else if(e===p.HEIGHT)n=r/i;else{var a=o/t,s=r/i;n=r>a*i?a:s}return n}function i(e,t){var i=e.model.components.getLinks(),n=e.linkOptions();n.beforeRender&&i.length&&n.beforeRender(r.map(i,function(e){return{element:t.find("[data-id='"+e.id+"']")[0],data:e}})),n.events&&i.length&&(e.events=r.reduce(r.keys(n.events),function(t,r){return t[r+" ._jrHyperLink"]=o(i,e.stateModel.get("linkOptions").events[r]),t},{}),e.delegateEvents())}function o(e,t){return function(i){t.call(this,i,r.findWhere(e,{id:i.currentTarget.getAttribute("data-id")}))}}var r=e("underscore"),n=e("backbone"),a=e("../jive/enum/jiveTypes"),s=e("../enum/reportCreators"),l=e("../jive/view/JiveComponentCollectionView"),h=e("../enum/reportOutputFormats"),c=e("jquery"),d=e("common/util/browserDetection"),u=e("../enum/reportEvents"),p=e("../enum/scaleStrategies"),g=e("common/util/domUtil"),m=e("domReady"),f=e("./LoadingOverlay"),v=e("logger").register("ReportView"),w=e("./LocalFrameView");e("jquery-ui/jquery.ui.core");var y="adhoc_chart_report_title";return n.View.extend({el:"<div style='height: 100%;'></div>",$reportContainer:!1,$jrTables:!1,savedContainersOverflow:!1,reportIsEmpty:!1,initialize:function(e){this.stateModel=e.stateModel,this.chartTypeDialogStates={},this.jiveComponentCollectionView=new l({collection:this.collection,stateModel:e.stateModel,chartTypeDialogStates:this.chartTypeDialogStates}),this.$el.css("position","relative"),this._afterResizeFunc=r.throttle(r.bind(function(e){e&&!e.target.tagName&&this.stateModel.get("autoresize")!==!1&&this.applyScale()},this),500),c(window).on("resize",this._afterResizeFunc)},linkOptions:function(){return this.stateModel.get("linkOptions")},remove:function(){return c(window).off("resize",this._afterResizeFunc),this._setLocalFrameSize&&(c(window).off("resize",this._setLocalFrameSize),this._setLocalFrameSize=!1),this.jiveComponentCollectionView.remove(),this.localFrameView&&this.localFrameView.remove(),n.View.prototype.remove.call(this)},setContainer:function(e){var t=c(e),i=this;return t.length?t[0]===this.$reportContainer[0]&&c.contains(t[0],this.el)?!0:(t.empty(),this.$jrTables=!1,this.$reportContainer=t,this.containerAttachedToDOM=new c.Deferred,m(function(){i.stateModel.get("isolateDom")?(i.localFrameView=new w(i.$el),i.$reportContainer.html(i.localFrameView.$el)):(i.$reportContainer.html(i.$el),i.showOverlay()),i.containerAttachedToDOM.resolve()}),!0):!1},render:function(){var e=this,t=new c.Deferred;return this.containerAttachedToDOM.done(function(){if(e.stateModel.get("isolateDom"))e.renderIsolatedDom(t);else{if(e.renderReport(),this.reportIsEmpty)return void t.resolve();e.renderJive().then(t.resolve,t.reject)}}),t},renderIsolatedDom:function(e){var t=this;return this.isElasticChart()&&(this._setLocalFrameSize=r.throttle(function(){var e=t.$reportContainer.height();t.localFrameView.$el.height(e||400)},100),this._setLocalFrameSize(),c(window).resize(this._setLocalFrameSize)),this.renderReport(),this.reportIsEmpty?void e.resolve():void this.renderJive().done(function(){e.resolve()})},renderReport:function(){var e=this.model.getExport(h.HTML).getHTMLOutput(),t=this.isElasticChart(),o="undefined"==typeof this.stateModel.get("scrollToTop")?!0:this.stateModel.get("scrollToTop"),n="undefined"==typeof this.stateModel.get("showAdhocChartTitle")?!0:this.stateModel.get("showAdhocChartTitle"),a=c(e),s="",l=this.stateModel.get("defaultJiveUi");if(e){this.reportIsEmpty=!1,this.stateModel.get("linkOptions")&&i(this,a),t&&(n&&(s=c("<div></div>").addClass(y).append(a.find("tbody tr td span").clone()).css({height:"0px",textAlign:"center",backgroundColor:"white"})),a=a.find(".highcharts_parent_container").clone().css({margin:"0 auto",height:"100%"}),a=c("<div></div>").append(s).append(a).append("<table cellpadding='0' cellspacing='0' class='jrPage'></table>").html()),this.$el.html(a),l&&!l.enabled&&this.$el.addClass("jiveDisabled"),this.trigger(u.BEFORE_RENDER,this.$el[0]);var d=this.$reportContainer;if(this.loadingOverlay&&this.loadingOverlay.showScrollBarOnContainer(),this.stateModel.get("isolateDom")&&(d=this.localFrameView.$frameBody),this.$jrTables=d.find(t?"._jr_report_container_":"._jr_report_container_ > table"),this.applyScale(),this.stateModel.has("pages")&&r.isObject(this.stateModel.get("pages"))){var p=this.stateModel.get("pages").anchor;if(!r.isUndefined(p)&&""!==p){var m=this.$el.find("[name='"+p+"']"),f=this.calculateScaleFactor();m.length||(m=this.$el.find("#"+p)),m.length&&!r.isUndefined(f)?this.$el.scrollParent().scrollTop((g.getElementOffset(m[0]).top-g.getElementOffset(this.$el.scrollParent()[0]).top)*f):o&&this.$el.scrollParent().scrollTop(0)}}else o&&this.$el.scrollParent().scrollTop(0)}else this.reportIsEmpty=!0,this.$el.empty();return this},renderJive:function(){var e=this;v.debug("Start JIVE Rendering"),e.showOverlay();var t=this.jiveComponentCollectionView.render(this.$el);return t.always(function(){e.hideOverlay(),v.debug("Finish JIVE Rendering")}),t},showOverlay:function(){var e=this,t=function(){if(e.stateModel.get("loadingOverlay")!==!1&&e.$reportContainer){var t=e.$el;e.stateModel.get("isolateDom")&&(t=e.localFrameView.$frameBody),e.loadingOverlay?(e.loadingOverlay.setExternalContainer(e.$reportContainer),e.loadingOverlay.setBiComponentContainer(t),e.loadingOverlay.setBiComponent(e.$jrTables),e.loadingOverlay.setScaleFactor(e.scaleFactor)):e.loadingOverlay=new f({propertiesModel:e.stateModel,scaleFactor:e.scaleFactor,externalContainer:e.$reportContainer,biComponentContainer:t,biComponent:e.$jrTables}),e.loadingOverlay.show()}};this.stateModel.get("isolateDom")?this.localFrameView.frameLoaded.done(t):t()},hideOverlay:function(){this.loadingOverlay&&this.loadingOverlay.hide()},applyScale:function(){var e=this;if(this.$jrTables){var t=this.calculateScaleFactor();if(!r.isUndefined(t)&&(this._applyScaleTransform(t),this.isElasticChart())){this._autoScaleFontsEnabled()&&this._setAutoScaleFonts();var i=c(this.$jrTables.parents()[0]),o=this.$reportContainer.find("."+y);i.css("overflow","hidden"),this.jiveComponentCollectionView.getSizableSubviews().then(function(t){o.height(0),r.invoke(t,"setSize",i.width(),i.height(),e.stateModel.get("chart").animation),setTimeout(function(){o.height("auto")},0)}),i.css("overflow","visible")}}},calculateScaleFactor:function(){var e,i=this.stateModel.get("scale");if(r.isUndefined(i))e=1;else if(r.contains(r.values(p),i)){var o=this.$jrTables.width(),n=this.$jrTables.height(),a=this.$reportContainer.width(),s=this.$reportContainer.height()||400;if(e=t(i,o,n,a,s),g.isScrollable(this.$reportContainer[0])){var l=g.getScrollbarWidth();(i===p.CONTAINER||i===p.WIDTH)&&e*n>s&&(a-=l+1,e=t(i,o,n,a,s)),(i===p.CONTAINER||i===p.HEIGHT)&&e*o>a&&(s-=l+1,e=t(i,o,n,a,s))}}else{var h=/^\d+%$/.test(i);e=parseFloat(i.toString().replace(",",".")),r.isNaN(e)&&(e=void 0),h&&(e/=100)}return e},_applyScaleTransform:function(e){this.scaleFactor=e,this.loadingOverlay&&this.loadingOverlay.applyScale(e);var t=this._getCssRulesForScalingFactor(e);this.$jrTables.length>1?this.$jrTables.parent().css(t):this.$jrTables.css(t),this.isGoogleMap()&&this._setScaleForGooglemap(e),this.jiveComponentCollectionView.getScalableSubviews().then(function(t){r.invoke(t,"scale",e)}),this.stateModel.get("isolateDom")&&(this.localFrameView.$el.width()<this.$jrTables.width()*e&&this.localFrameView.$el.width(this.$jrTables.width()*e),this.localFrameView.$el.height(this.$jrTables.height()*this.$jrTables.length*e))},_getCssRulesForScalingFactor:function(e){var t="scale("+e+")",i="top left",o={"-webkit-transform":t,"-moz-transform":t,"-ms-transform":t,"-o-transform":t,transform:t,"-webkit-transform-origin":i,"-moz-transform-origin":i,"-ms-transform-origin":i,"-o-transform-origin":i,"transform-origin":i};return d.isIE8()&&(o.filter="progid:DXImageTransform.Microsoft.Matrix(M11="+e+", M12=0, M21=0, M22="+e+", SizingMethod='auto expand')"),o},isElasticChart:function(){return this.collection.some(function(e){return s.AD_HOC_DESIGNER===e.get("creator")&&a.CHART===e.get("type")})},isGoogleMap:function(){return this.collection.some(function(e){return a.GOOGLEMAP===e.get("type")})},_setScaleForGooglemap:function(e){this.collection.each(function(t){if(a.GOOGLEMAP===t.get("type")){var i=this.$el.find("#"+t.get("id")),o=i.parent();i.width(o.width()*e),i.height(o.height()*e),i.css(this._getCssRulesForScalingFactor(1/e))}},this)},_autoScaleFontsEnabled:function(){return this.collection.some(function(e){return e.get("hcinstancedata").services[0].data.chartState.autoScaleFonts})},_setAutoScaleFonts:function(){var e=parseInt(this.$jrTables.css("font-size")),t=this.$jrTables.width(),i=t>600?1:(Math.floor(t/100)+4)/10,o=Math.round(e*i);this.$jrTables.find(".highcharts_parent_container").css("font-size",o)}})});