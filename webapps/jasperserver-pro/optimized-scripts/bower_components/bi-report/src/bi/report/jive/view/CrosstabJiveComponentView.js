define(["require","./BaseJiveComponentView","underscore","bi/report/jive/factory/headerToolbarViewFactory","./overlay/JiveOverlayView","jquery","common/util/browserDetection","jquery-ui/jquery.ui.position"],function(t){"use strict";var e=t("./BaseJiveComponentView"),o=t("underscore"),r=t("bi/report/jive/factory/headerToolbarViewFactory"),i=t("./overlay/JiveOverlayView"),a=t("jquery");t("common/util/browserDetection");return t("jquery-ui/jquery.ui.position"),e.extend({init:function(){this.reportContainer=this.getReportContainer(this.getReportId()),this.initJiveComponents(this.reportContainer),this.resetSelected(),this.initJiveEvents(this.model)},initJiveEvents:function(t){this.headerToolbar&&this.listenTo(this.headerToolbar,"select",this._onHeaderToolbarSelect),this.overlay&&this.listenTo(this.overlay,"overlayClicked",this._overlayClicked),this.crosstabElement=this.getReportContainer(this.getReportId());var e=t.getFragmentId();this.crosstabElement.on("click touchend","td.jrxtcolheader[data-jrxtid='"+e+"']",o.bind(this._onClick,this,t)),this.crosstabElement.on("click touchend","td.jrxtdatacell[data-jrxtid='"+e+"']",o.bind(this._onClick,this,t)),this.crosstabElement.on("click touchend","td.jrxtrowheader[data-jrxtid='"+e+"']",o.bind(this._onClick,this,t)),this.model.get("hasFloatingHeaders")&&this.stateModel.isFloatingCrosstabHeaderEnabled()&&(this._initFloatingHeaders(),this.listenTo(this.model,"change:scaleFactor",function(){this.floatingColumnHeader=null,this.floatingRowHeader=null,this.floatingCrossHeader=null,this.firstCol=null,this.lastCell=null}))},initJiveComponents:function(t){this.overlay=new i({parentElement:t}),this.headerToolbar=r(this.model.get("type"),{parentElement:t}),this.headerToolbar.$el.addClass("jr_xtab")},_onClick:function(t,e){if(!a(e.target).parent().is("._jrHyperLink")){var o=a(e.currentTarget).hasClass("jrxtrowheader")?"RowGroup":"DataColumn";return this["select"+o](t,a(e.currentTarget)),!1}},_onHeaderToolbarSelect:function(t,e,o){var r=e.get("order");t.$el.hasClass("disabled")?this.hide():this.sort(r)},selectDataColumn:function(t,e){var o=e.data("jrxtcolidx"),r=e.data("jrxtid"),i=e.parents("table:first"),l=a("td.jrxtcolheader[data-jrxtid='"+r+"'][data-jrxtcolidx='"+o+"']:first",i),s=a("td.jrxtdatacell[data-jrxtid='"+r+"'][data-jrxtcolidx='"+o+"']:last",i),d={crosstab:t,header:l,cell:e,isColumn:!0};this.resetSelected(d);var n=this.getOverlaySize(s,l,this.model.get("scaleFactor"));this.overlay.css({width:n.width,height:n.height}).show().setPosition({of:l,my:"left top",at:"left top",collision:"none"});var h=l.data("jrxtcolidx"),c=t.isDataColumnSortable(h);this.headerToolbar.show(c),this._setToolbarAndOverlayPosition(),this.isSelectionActive=!0},selectRowGroup:function(t,e){var o=e.data("jrxtcolidx"),r=e.data("jrxtid"),i=a("td.jrxtrowheader[data-jrxtid='"+r+"'][data-jrxtcolidx='"+o+"']",e.parents("table:first")),l=a(i[0]),s=a(i[i.length-1]),d={crosstab:t,header:l,cell:e,isColumn:!1};this.resetSelected(d);var n=this.getOverlaySize(s,l,this.model.get("scaleFactor"));this.overlay.css({width:n.width,height:n.height}).show(),this.headerToolbar.show(!0),this._setToolbarAndOverlayPosition(),this.isSelectionActive=!0},getOverlaySize:function(t,e,o){var r=t.offset(),i=e.offset(),o=o||1;return{width:(r.left+t.outerWidth()-i.left)*o,height:r.top+t.outerHeight()*o-i.top}},sort:function(t){this.hide();var e=this.selected,o=e.crosstab;if(this.selected.header.hasClass("jrxtcolheader")){var r=e.header.data("jrxtcolidx"),i=t;i==o.getColumnOrder(r)&&(i="NONE"),o.sortByDataColumn(r,i)}else if(e.header.hasClass("jrxtrowheader")){var a=e.header.data("jrxtcolidx"),i=t;i==o.config.rowGroups[a].order&&(i="NONE"),o.sortRowGroup(a,i)}},hide:function(){this.overlay&&this.overlay.hide(),this.headerToolbar&&this.headerToolbar.hide(),this.$el.hide()},show:function(){this.overlay&&this.overlay.show(),this.headerToolbar&&this.headerToolbar.$el.show(),this.$el.show()},render:function(t){var e=new a.Deferred;return this.setDataReportId(t,this.report.id),this.stateModel.isDefaultJiveUiEnabled()?(this.init(),this.overlay&&this.overlay.render(),this.headerToolbar&&this.headerToolbar.render(),e.resolve(),this.canFloat=!0,e):(e.resolve(),e)},resetSelected:function(t){this.selected=t?t:null},_getModulesToLoad:function(){var t=e.prototype._getModulesToLoad.call(this);return t.push("csslink!jr.jive.crosstab.templates.styles.css"),t},detachEvents:function(){this.crosstabElement&&this.crosstabElement.off()},remove:function(){this.overlay&&this.overlay.remove(),this.headerToolbar&&this.headerToolbar.remove(),this.$scrollContainer&&(this.floatingColumnHeader&&this.floatingColumnHeader.remove(),this.floatingRowHeader&&this.floatingRowHeader.remove(),this.floatingCrossHeader&&this.floatingCrossHeader.remove(),this.floatingColumnHeader=null,this.floatingRowHeader=null,this.floatingCrossHeader=null,this.firstCol=null,this.lastCell=null,this.$scrollContainer.off("scroll")),e.prototype.remove.call(this,arguments)},_overlayClicked:function(){this.hide(),this.resetSelected(),this.isSelectionActive=!1},_initFloatingHeaders:function(){this.$scrollContainer=a(this.stateModel.get("container")),"static"===this.$scrollContainer.css("position")&&this.$scrollContainer.css("position","relative"),this.canFloat=!1,this.$scrollContainer.on("scroll",o.throttle(o.bind(this._scrollHeaders,this),100,{leading:!0,trailing:!0})),this.scrollData={bColMoved:!1,bRowMoved:!1},this.on("columnHeader:scroll",this._onColumnHeaderScroll),this.on("columnHeader:scrollStop",this._onColumnHeaderScrollStop),this.on("rowHeader:scroll",this._onRowHeaderScroll),this.on("rowHeader:scrollStop",this._onRowHeaderScrollStop)},_scrollHeaders:function(t,e){if(this.canFloat&&this._isCrosstabVisible()){var o=this.$scrollContainer,r=!1,i=!1,a=this.scrollData;null!=a.scrollTop?o.scrollTop()!=a.scrollTop&&(a.scrollTop=o.scrollTop(),r=!0):0!==o.scrollTop()&&(a.scrollTop=o.scrollTop(),r=!0),null!=a.scrollLeft?o.scrollLeft()!=a.scrollLeft&&(a.scrollLeft=o.scrollLeft(),i=!0):0!==o.scrollLeft()&&(a.scrollLeft=o.scrollLeft(),i=!0),(i||r||e)&&(this._scrollColumnHeader(),this._scrollRowHeader(),this._scrollCrossSection())}},_isCrosstabVisible:function(){var t,e,o,r=this.$scrollContainer,i=r.offset().top,a=this.model.getFragmentId();return this.firstCol||(this.firstCol=r.find("td.jrxtcolfloating[data-jrxtid='"+a+"']").first()),t=this.firstCol,this.lastCell||(this.lastCell=t.closest("table").find("td.jrxtdatacell[data-jrxtid='"+a+"']").last()),e=this.lastCell,o=e.offset().top<i||t.offset().top>i+r.outerHeight(),!o},_scrollColumnHeader:function(){var t=this.$scrollContainer,e=this.scrollData,o=this.model.getFragmentId(),r=t.find("td.jrxtcolfloating[data-jrxtid='"+o+"']").first();if(r.length){this.floatingColumnHeader||(this.floatingColumnHeader=this._getColumnHeaderFloatingTable(r,o));var i=this.floatingColumnHeader,a=t.offset().top,l=r.closest("tr").offset().top,s=t.find("td.jrxtcolfloating[data-jrxtid='"+o+"']").first(),d=t.find("td.jrxtrowheader[data-jrxtid='"+o+"']").first(),n=s.closest("table").find("td.jrxtdatacell[data-jrxtid='"+o+"']").last(),h=n.length?n.offset().top-i.outerHeight()-a:-1,c=this.model.get("scaleFactor"),f=0>l-a&&h>0;!e.bColMoved&&f||e.bColMoved&&f?(i.show(),c&&!e.appliedColHeaderScale&&(this._applyScaleTransform(i,c),e.appliedColHeaderScale=!0),i.offset({top:a,left:d.offset().left}),e.bColMoved=!0,this.trigger("columnHeader:scroll")):e.bColMoved&&(i.hide(),e.bColMoved=!1,this.trigger("columnHeader:scrollStop"))}},_scrollRowHeader:function(){var t=this.$scrollContainer,e=this.scrollData,o=this.model.getFragmentId(),r=t.find("td.jrxtrowfloating[data-jrxtid='"+o+"']").first();if(r.length){this.floatingRowHeader||(this.floatingRowHeader=this._getFloatingTable(r,o,"jr_floating_row_header","jrxtrowfloating"));var i=this.floatingRowHeader,a=t.offset().left,l=r.offset().left,s=t.find("table.jrPage td.jrxtdatacell[data-jrxtid='"+o+"']").last(),d=s.length?s.offset().left-i.width()-a:-1,n=this.model.get("scaleFactor"),h=0>l-a&&d>0;(!e.bRowMoved&&h||e.bRowMoved&&h)&&.8*t.outerWidth()>i.outerWidth()*n?(i.show(),n&&!e.appliedRowHeaderScale&&(this._applyScaleTransform(i,n),e.appliedRowHeaderScale=!0),i.offset({top:r.offset().top,left:a}),e.bRowMoved=!0,this.trigger("rowHeader:scroll")):e.bRowMoved&&(i.hide(),e.bRowMoved=!1,this.trigger("rowHeader:scrollStop"))}},_scrollCrossSection:function(){var t=this.$scrollContainer,e=this.scrollData,o=this.model.getFragmentId();t.find("table.jr_floating_cross_header[data-jrxtid='"+o+"']").length||this._markCrossHeaderElements(o);var r=t.find("td.jrxtcrossheader[data-jrxtid='"+o+"']").first();if(r.length){this.floatingCrossHeader||(this.floatingCrossHeader=this._getFloatingTable(r,o,"jr_floating_cross_header","jrxtcrossheader"));var i=this.floatingCrossHeader,a=this.floatingColumnHeader||this._getFloatingTable(r,o,"jr_floating_column_header"),l=this.floatingRowHeader||this._getFloatingTable(r,o,"jr_floating_row_header"),s=this.model.get("scaleFactor");(e.bColMoved||e.bRowMoved)&&.8*t.outerWidth()>l.outerWidth()*s?(i.show(),s&&!e.appliedCrossHeaderScale&&(this._applyScaleTransform(i,s),e.appliedCrossHeaderScale=!0),i.offset({top:e.bColMoved?a.offset().top:r.offset().top,left:e.bRowMoved?l.offset().left:r.offset().left}),e.bCrossMoved=!0):e.bCrossMoved&&(i.hide(),e.bCrossMoved=!1)}},_getFloatingTable:function(t,e,o,r,i){var l=this.$scrollContainer.find("table."+o+"[data-jrxtid='"+e+"']");if(t&&0===l.length){l=a("<table class='"+o+"' data-jrxtid='"+e+"' style='display:none'/>").appendTo(this.$scrollContainer),"jrxtrowfloating"==r?l.on("click",".jrxtrowfloating",function(t){if(!a(t.target).parent().is("._jrHyperLink")){var e=a(this),o=e.attr("data-jrxtid"),r=e.attr("data-jrxtcolidx"),i=l.parent().find("table.jrPage td.jrxtrowfloating[data-jrxtid='"+o+"']").filter("td[data-jrxtcolidx='"+r+"']").eq(0);return i.length&&i.trigger("click"),!1}}):"jrxtcrossheader"==r&&l.on("click",".jrxtcrossheader",function(t){if(!a(t.target).parent().is("._jrHyperLink")){var e,o=a(this),r=o.attr("data-jrxtid"),i=o.attr("data-jrxtcolidx");return e=l.parent().find("table.jrPage td.jrxtrowfloating[data-jrxtid='"+r+"']").filter("td[data-jrxtcolidx='"+i+"']").eq(0),e.length&&e.trigger("click"),!1}});var s,d,n,h,c,f,g,p,u,x,b,j,v=t.closest("table"),C=v.find("td."+r+"[data-jrxtid='"+e+"']").last(),m=[],w=[],_=0,H=0,y=!1;if(t.length>0){if(d=t.closest("tr"),h=C.closest("tr"),b=t.closest("table"),j=v.find("tr"),d.get(0)===h.get(0))m.push(d);else for(p=j.index(d),u=j.index(h),x=p;u>=x;x++)m.push(j.get(x));if("jrxtcrossheader"===r){h=a(m[m.length-1]);var T=j.index(h),M=a.map(h.find("td.jrxtcrossheader"),function(t){return a(t).prop("rowspan")}),S=Math.max.apply(Math,M);if(x=1,S>1)for(x;S>x;x++)m.push(j.get(T+x))}a.each(m,function(t,o){for(n=a(o),g=n.find("td"),s=a("<tr></tr>"),w[t]=0,s.attr("style",n.attr("style")),s.css("height",n.css("height")),s.attr("valign",n.attr("valign")),p=0;p<g.length;p++)f=a(g.get(p)),!y&&(_+=f.prop("colspan")),f.data("jrxtid")===e&&(f.is("."+r)||i&&f.is("."+i))&&("jrxtrowfloating"!==r&&(0!==t||y||(_-=f.prop("colspan"),y=!0),H+=f.prop("colspan")),"jrxtrowfloating"==r&&f.is(".jrxtinteractive")?(c=a("<td class='jrxtrowfloating jrxtinteractive'></td>"),c.attr("data-jrxtid",f.attr("data-jrxtid")),c.attr("data-jrxtcolidx",f.attr("data-jrxtcolidx"))):(c=f.clone(),c.css("width",f.css("width")),c.css("height",f.css("height")),w[t]=w[t]+f.outerWidth()),s.append(c));if(0===t&&void 0!==_&&"jrxtrowfloating"!==r){var d=b.find("tr").first(),h=d.find("td"),u=a("<tr></tr>"),x=_;for(x;_+H>x;x++)u.append(a(h.get(x)).clone());l.append(u)}l.append(s)}),l.css({position:"absolute",width:Math.max.apply(Math,w),"empty-cells":b.css("empty-cells"),"border-collapse":b.css("border-collapse"),"background-color":b.css("background-color")}),l.attr("cellpadding",b.attr("cellpadding")),l.attr("cellspacing",b.attr("cellspacing")),l.attr("border",b.attr("border"))}}return l},_getColumnHeaderFloatingTable:function(t,e){var o="jr_floating_column_header",r="jrxtcolfloating",i=this.$scrollContainer.find("table."+o+"[data-jrxtid='"+e+"']");if(t&&0===i.length){i=a("<table class='"+o+"' data-jrxtid='"+e+"' style='display:none'/>").appendTo(this.$scrollContainer),i.on("click",".jrxtcolfloating",function(t){if(!a(t.target).parent().is("._jrHyperLink")){var e=a(this),o=e.attr("data-jrxtid"),r=e.attr("data-jrxtcolidx"),l=i.parent().find("table.jrPage td.jrxtcolheader[data-jrxtid='"+o+"']").filter("td[data-jrxtcolidx='"+r+"']").eq(0);return l.length&&l.trigger("click"),!1}});var l,s,d,n,h,c,f,g,p,u,x,b,j,v=t.closest("table"),C=v.find("td."+r+"[data-jrxtid='"+e+"']").last(),m=v.find("td.jrxtrowheader.jrxtinteractive[data-jrxtid='"+e+"']").last(),w=[],_=[],H=0,y=0,T=!1;if(t.length>0){if(s=t.closest("tr"),n=C.closest("tr"),h=m.closest("tr"),b=v,j=v.find("tr"),h.length&&j.index(h)>j.index(n)&&(n=h),s.get(0)===n.get(0))w.push(s);else for(p=j.index(s),u=j.index(n),x=p;u>=x;x++)w.push(j.get(x));a.each(w,function(t,o){for(d=a(o),g=d.find("td"),l=a("<tr></tr>"),_[t]=0,l.attr("style",d.attr("style")),l.css("height",d.css("height")),l.attr("valign",d.attr("valign")),p=0;p<g.length;p++)f=a(g.get(p)),!T&&(H+=f.prop("colspan")),f.data("jrxtid")===e&&(0!==t||T||(H-=f.prop("colspan"),T=!0),y+=f.prop("colspan"),c=f.clone(),c.css("width",f.css("width")),c.css("height",f.css("height")),_[t]=_[t]+f.outerWidth(),l.append(c));if(0===t&&void 0!==H){var r=b.find("tr").first(),s=r.find("td"),n=a("<tr></tr>"),h=H;for(h;H+y>h;h++)n.append(a(s.get(h)).clone());i.append(n)}i.append(l)}),i.css({position:"absolute",width:Math.max.apply(Math,_),"empty-cells":b.css("empty-cells"),"border-collapse":b.css("border-collapse"),"background-color":b.css("background-color")}),i.attr("cellpadding",b.attr("cellpadding")),i.attr("cellspacing",b.attr("cellspacing")),i.attr("border",b.attr("border"))}}return i},_markCrossHeaderElements:function(t){var e=this.$scrollContainer;if(!e.find("td.jrxtcrossheader[data-jrxtid='"+t+"']").length){var o,r,i,l,s,d,n,h,c,f,g,p,u,x=e.find("td.jrxtcolfloating[data-jrxtid='"+t+"']").first(),b=[],j=1;if(x.length){for(i=x.closest("table"),o=x.closest("tr"),l=i.find("tr"),r=i.find("td.jrxtrowheader.jrxtinteractive[data-jrxtid='"+t+"']").last().closest("tr"),r.length||(r=i.find("td.jrxtcolfloating[data-jrxtid='"+t+"']").last().closest("tr")),d=l.index(o),n=l.index(r),s=d;n>=s;s++)b.push(l.get(s)),h=a(l.get(s)),f=a.map(h.find("td"),function(t){return a(t).prop("rowspan")}),c=Math.max.apply(Math,f),c>j&&(j=c),j--;if(s=1,j>1)for(s;j>s;s++)b.push(l.get(n+s));a.each(b,function(e,o){g=0,a(o).find("td").each(function(o,r){var i=a(r);g+=i.prop("colspan"),i.data("jrxtid")===t&&(0===e&&!u&&i.is(".jrxtcolfloating")&&(u=!0,p=g-i.prop("colspan")),(!u||p>=g&&!i.is(".jrxtcolfloating"))&&i.addClass("jrxtcrossheader"))})})}}},_onColumnHeaderScroll:function(){if(this.headerToolbar.$el.is(":visible")){var t,e,o;if(this.selected.isColumn?(t=this.floatingColumnHeader,e=t.find("td.jrxtcolheader[data-jrxtcolidx='"+this.selected.header.data("jrxtcolidx")+"']").first()):(t=this.floatingCrossHeader,this.scrollData.bRowMoved&&!t.length&&(t=this.floatingRowHeader),e=t.find("td.jrxtrowheader[data-jrxtcolidx='"+this.selected.header.data("jrxtcolidx")+"']").first()),e&&e.length){if(e.offset().top>t.offset().top){var r=e.offset().top-t.offset().top-this.headerToolbar.$el.outerHeight();o="left bottom",0>r&&(o+="+"+Math.abs(r))}else o="left top";this.headerToolbar.setPosition({my:o,at:"left top",of:e,collision:"none"})}else{var i,a=this.$scrollContainer.offset().top,r=this.selected.header.offset().top-this.headerToolbar.$el.outerHeight()-a;i=0>=r?a:this.selected.header.offset().top-this.headerToolbar.$el.outerHeight()+1,this.headerToolbar.$el.offset({top:i,left:this.headerToolbar.$el.offset().left})}}},_onColumnHeaderScrollStop:function(){this.headerToolbar.$el.is(":visible")&&this._setToolbarAndOverlayPosition()},_onRowHeaderScroll:function(){if(this.isSelectionActive){var t=this.floatingRowHeader,e=this.model.get("scaleFactor"),o=t.offset().left+t.width()*e;this.headerToolbar.$el.is(":visible")&&this.selected.header.offset().left<o?this.hide():!this.headerToolbar.$el.is(":visible")&&this.selected.header.offset().left>=o&&this.show()}},_onRowHeaderScrollStop:function(){this.isSelectionActive&&(this.headerToolbar.$el.is(":visible")||(this.show(),this._setToolbarAndOverlayPosition()))},_setToolbarAndOverlayPosition:function(){var t,e,o,r,i,a=this.scrollData||{},l=this.model.getFragmentId(),s=!1;if((!a.bColMoved&&!a.bRowMoved||a.bRowMoved&&!a.bColMoved)&&(t=this.selected.header),this.overlay.setPosition({my:"left top",at:"left top",of:this.selected.header,collision:"none"}),a.bColMoved)if(this.selected.isColumn?(e=this.floatingColumnHeader||this._getFloatingTable(null,l,"jr_floating_column_header"),t=e.find("td.jrxtcolheader[data-jrxtcolidx='"+this.selected.header.data("jrxtcolidx")+"']").first()):(e=this.floatingCrossHeader||this._getFloatingTable(null,l,"jr_floating_cross_header"),!this.scrollData.bRowMoved||e.length&&e.find("td.jrxtrowheader").length||(e=this.floatingRowHeader||this._getFloatingTable(null,l,"jr_floating_row_header")),t=e.find("td.jrxtrowheader[data-jrxtcolidx='"+this.selected.header.data("jrxtcolidx")+"']").first()),t&&t.length)t.offset().top>e.offset().top?(r=t.offset().top-e.offset().top-this.headerToolbar.$el.outerHeight(),o="left bottom",0>r&&(o+="+"+Math.abs(r))):o="left top",e.is(".jr_floating_row_header")&&(t.offset().top<this.$scrollContainer.offset().top?o="left top+"+(this.$scrollContainer.offset().top-t.offset().top):(o="left bottom",r=t.offset().top-this.$scrollContainer.offset().top-this.headerToolbar.$el.outerHeight(),0>r&&(o+="+"+Math.abs(r)))),this.headerToolbar.setPosition({my:o,at:"left top",of:t,collision:"none"}),s=!0;else{var d,n=this.$scrollContainer.offset().top,r=this.selected.header.offset().top-this.headerToolbar.$el.outerHeight()-n;d=0>=r?n:this.selected.header.offset().top-this.headerToolbar.$el.outerHeight()+1,this.headerToolbar.$el.offset({top:d,left:this.selected.header.offset().left}),s=!0}a.bRowMoved&&(this.selected.isColumn||(e=this.floatingCrossHeader||this._getFloatingTable(null,l,"jr_floating_cross_header"),e.length&&e.find("td.jrxtrowheader").length||(e=this.floatingRowHeader||this._getFloatingTable(null,l,"jr_floating_row_header")),t=e.find("td.jrxtrowheader[data-jrxtcolidx='"+this.selected.header.data("jrxtcolidx")+"']").first(),i=this.overlay.$el.offset(),this.overlay.$el.offset({left:t.offset().left,top:i.top}))),!s&&this.headerToolbar.setPosition({my:o?o:"left bottom+1",at:"left top",of:t,collision:"none"})}})});