define(["require","backbone","underscore","jquery","../enum/jiveTypes","logger"],function(t){function e(t,e){var o=n.clone(e);if(e.events){var r={};n.each(n.keys(e.events),function(o){r[o]=function(t,e){return function(o,r){t.call(this,r,n.isObject(o)?o:n.findWhere(e.getLinks(),{id:o}))}}(e.events[o],t)}),o.events=r}return o}var o=t("backbone"),n=t("underscore"),r=t("jquery"),i=t("../enum/jiveTypes"),s=t("logger").register("ReportComponentCollection");return o.Collection.extend({initialize:function(t,o){var r=this;this._parts=[],this._root=null,this.stateModel=o.stateModel,this.report=o.report,this.componentsMeta=o.componentsMeta,this.stateModel.get("linkOptions")&&(this.linkOptions=e(this,this.stateModel.get("linkOptions"))),this.listenTo(this.stateModel,"change:linkOptions",function(t,o){r.linkOptions=e(r,o)}),this.on("change add reset remove",function(){n.each(i,function(t){r[t]=[]}),r.forEach(function(t){r[t.get("type")]&&n.isArray(r[t.get("type")])&&r[t.get("type")].push(t)})}),this.on("reset",function(t){n.each(t.models,function(t){t&&t.get("type")&&("bookmarks"===t.get("type")&&r.trigger("bookmarksReady",t.get("bookmarks")),"reportparts"===t.get("type")&&r.trigger("reportPartsReady",t.get("reportParts")))})})},registerPart:function(t){var e=this;t&&(t.get("parentId")?e._root?e._root.registerPart(t):e._parts.push(t):(e._root=t,n.each(this._parts,function(t){e._root.registerPart(t)})))},fetch:function(){var e=this,o=[],i=[],s=[],p=new r.Deferred;return this.componentsMeta.forEach(function(t){t.get("type")&&"table"===t.get("type")&&o.push("../model/TableComponentModel"),t.get("type")&&"column"===t.get("type")&&o.push("../model/ColumnComponentModel"),t.get("type")&&"chart"===t.get("type")&&o.push("bi/chart/jr/jive/highcharts/model/ChartComponentModel"),t.get("type")&&("fusionChart"===t.get("type")||"fusionMap"===t.get("type")||"fusionWidget"===t.get("type"))&&o.push("../model/FusionComponentModel"),t.get("type")&&"googlemap"===t.get("type")&&o.push("../model/GooglemapComponentModel"),t.get("type")&&"tibco-maps"===t.get("type")&&o.push("../model/TibcomapComponentModel"),t.get("type")&&"crosstab"===t.get("type")&&o.push("../model/CrosstabComponentModel"),t.get("type")&&"webfonts"===t.get("type")&&o.push("../model/WebfontsComponentModel"),t.get("type")&&"hyperlinks"===t.get("type")&&o.push("../model/HyperlinksComponentModel"),t.get("type")&&"bookmarks"===t.get("type")&&o.push("../model/BookmarksComponentModel"),t.get("type")&&"reportparts"===t.get("type")&&o.push("../model/ReportPartsComponentModel"),t.get("type")&&"CVComponent"===t.get("type")&&o.push("../model/CustomComponentModel"),t.get("type")&&i.push(t.attributes)}),t(o,function(){var t=n.toArray(arguments),o={parent:e.report,linkOptions:e.linkOptions,collection:e,parse:!0};n.each(t,function(t,n){var r=new t(i[n],o);s.push(r),e.registerPart(r)}),e.reset(s),p.resolve()},p.reject),p},add:function(t,e){var r=[];return this.stateModel.get("isolateDom")&&(n.each(t,function(t,e,o){!t.get("type")||-1===t.get("type").indexOf("fusion")&&-1===t.get("type").indexOf("tibco-maps")?r.push(o[e]):(-1!==t.get("type").indexOf("fusion")&&s.info("Fusion components usage deprecated when isolateDom option enabled for report"),-1!==t.get("type").indexOf("tibco-maps")&&s.info("Tibco maps components usage deprecated when isolateDom option enabled for report"))}),t=r),o.Collection.prototype.add.call(this,t,e)},getComponents:function(){var t=this.reduce(function(t,e){if(e.toReportComponentObject){var o=e.toReportComponentObject();if(!o)return t;n.isArray(o)?t=t.concat(o):t.push(o)}return t},[]);return n.forEach(t,function(t){void 0===t.name&&delete t.name}),t},getLinks:function(){return this.reduce(function(t,e){return t.concat(e.get("hyperlinks")||[])},[])},getBookmarks:function(){return this.reduce(function(t,e){return t.concat(e.get("bookmarks")||[])},[])},getReportParts:function(){return this.reduce(function(t,e){return t.concat(e.get("reportParts")||[])},[])},updateComponents:function(t){var e=this,r=[],i=new o.Collection(this.map(function(t){var e=new o.Model(t.attributes);return n.extend(e,{updateFromReportComponentObject:t.updateFromReportComponentObject,actions:t.actions,parent:t.parent,headingFormat:t.headingFormat,detailsRowFormat:t.detailsRowFormat,conditions:t.conditions}),t.attachEvents&&t.attachEvents.call(e),e}));return i.forEach(function(t){n.each(t.actions,function(o,n){e.listenToOnce(t,n,function(t,e,o){r.push(t.actions[n].call(t,o))})})}),n.each(t,function(t){var e=i.get(t.id.split("/")[0]);e&&e.updateFromReportComponentObject(t)}),r}})});