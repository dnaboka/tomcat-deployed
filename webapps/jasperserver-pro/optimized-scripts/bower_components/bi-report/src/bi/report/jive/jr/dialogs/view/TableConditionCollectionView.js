define(["require","backbone","backbone.epoxy","underscore","../../../util/jiveDataConverter","common/component/dialog/AlertDialog","../util/FormatModelCache","bundle!jasperreports_messages","text!../template/tableConditionCollectionTemplate.htm","./TableConditionView","../model/TableConditionModel"],function(e){"use strict";function t(e,t,o){var i,a,l,s=this.cache,r=t,d=e.previous("applyTo"),c=this.columnComponentModel;if(null!=r&&!o.isReset){if(!this.validate())return void e.set({applyTo:d},{isReset:!0});d&&(i="detailrows"===d?s.createKey(d,c):s.createKey(d,c.parent.columnGroups.findWhere({id:d}),!0),s.set(i,this.collection.toJSON())),"detailrows"===r?(i=s.createKey(r,c),null===s.get(i)&&s.set(i,n.call(this,c.conditions.toJSON(),c.get("dataType")))):(l=c.parent.columnGroups.findWhere({id:r}),i=s.createKey(r,l,!0),null===s.get(i)&&s.set(i,n.call(this,l.conditions.toJSON(),l.get("dataType")))),a=s.keyInfo[i].model,this.collection.conditionPattern=a.get("conditionalFormattingData").conditionPattern,this.collection.dataType=a.get("dataType"),this.addAll(s.get(i))}}function o(){var e=this,t=this.columnComponentModel,o=t.get("columnIndex"),i=t.parent.columnGroups,n=[],a=[],l=[],s=[];i.each(function(t){-1!=r.indexOf(t.get("forColumns"),o)&&null!==t.get("conditionalFormattingData")&&("groupheading"===t.get("groupType")?a.push({value:t.get("id"),label:t.get("groupName")+" "+e.i18n["net.sf.jasperreports.components.headertoolbar.groupheading.prefix"]}):"groupsubtotal"===t.get("groupType")?l.push({value:t.get("id"),label:t.get("groupName")+" "+e.i18n["net.sf.jasperreports.components.headertoolbar.groupsubtotal.prefix"]}):"tabletotal"===t.get("groupType")&&s.push({value:t.get("id"),label:e.i18n["net.sf.jasperreports.components.headertoolbar.applyto.option.tabletotal"]}))}),n.push.apply(n,a),t.get("canFormatConditionally")&&n.push({value:"detailrows",label:this.i18n["net.sf.jasperreports.components.headertoolbar.applyto.option.detailrows"]}),n.push.apply(n,l),n.push.apply(n,s),this.viewModel.set("applyToOptions",n);var d=this.viewModel.previous("applyTo");d?(this.viewModel.set("applyTo",null,{silent:!0}),r.findWhere(n,{value:d})?this.viewModel.set("applyTo",d):this.viewModel.set("applyTo","detailrows")):this.viewModel.set("applyTo","detailrows"),n.length?this.viewModel.set("canAddCondition",!0):this.viewModel.set("canAddCondition",!1)}function i(){var e,t=this.viewModel.get("applyTo");"detailrows"===t?e=this.cache.createKey(t,this.columnComponentModel):t&&(e=this.cache.createKey(t,this.columnComponentModel.parent.columnGroups.findWhere({id:t}),!0)),e&&this.cache.set(e,this.collection.toJSON())}function n(e,t){var o,i=this,n=d.dataTypeToSchemaFormat[t];return r.map(e,function(e){var t={};return e.operator&&(t.operator=d.schemaFormatOperatorToFilterOperator(e.operator,e.value,n),o=i.columnComponentModel.parent.config.genericProperties,"datetime"===n?r.isArray(e.value)?(t.value=[],t.value[0]=d.isoTimestampTojQueryUiTimestamp(e.value[0],o),t.value[1]=d.isoTimestampTojQueryUiTimestamp(e.value[1],o)):t.value=d.isoTimestampTojQueryUiTimestamp(e.value,o):"time"===n?r.isArray(e.value)?(t.value=[],t.value[0]=d.isoTimeTojQueryUiTime(e.value[0],o),t.value[1]=d.isoTimeTojQueryUiTime(e.value[1],o)):t.value=d.isoTimeTojQueryUiTime(e.value,o):t.value=e.value),r.extend(e,t)})}function a(e,t,o){var i,n=this;return e.map(function(e){if(e.operator){var a=r.isArray(e.value)?e.value[0]:e.value,l=r.isArray(e.value)?e.value[1]:void 0;i=d.operatorAndValueToSchemaFormat.call(n.columnComponentModel,e.operator,d.dataTypeToSchemaFormat[t],a,l,o)}return r.extend(e,i)})}var l=e("backbone"),s=e("backbone.epoxy"),r=e("underscore"),d=e("../../../util/jiveDataConverter"),c=e("common/component/dialog/AlertDialog"),p=e("../util/FormatModelCache"),u=e("bundle!jasperreports_messages"),h=e("text!../template/tableConditionCollectionTemplate.htm"),m=e("./TableConditionView"),v=e("../model/TableConditionModel"),g=l.Collection.extend({model:v}),f=s.Model.extend({defaults:function(){return{applyToOptions:[],applyTo:null,canAddCondition:!0}},reset:function(){return this.clear({silent:!0}).set(this.defaults()),this},remove:function(){}});return s.View.extend({events:{"click .jive_inputbutton[name='conditionAdd']":"addNewCondition"},el:function(){return r.template(h,{i18n:u})},constructor:function(e){this.i18n=e.i18n,s.View.apply(this,arguments)},initialize:function(){this.viewModel=new f,this.collection=new g,this.cache=new p,this._subviews=[],this._$subviewsContainer=this.$("table.conditionList > tbody"),this.listenTo(this.viewModel,"change:applyTo",r.bind(t,this)),this.listenTo(this.collection,"remove",this.removeSubview),this.on("tabSwitched",function(){i.call(this)}),this.errorDialog=new c({additionalCssClasses:"jive_dialog"}),s.View.prototype.initialize.apply(this,arguments)},addSubview:function(e){var t=new m(r.extend({},{i18n:this.i18n,model:e,genericProperties:this.columnComponentModel.parent.config.genericProperties}));return this._$subviewsContainer.append(t.render().$el),this._subviews.push(t),t},addModel:function(e,t){var o,i,n=new m({i18n:this.i18n,genericProperties:this.columnComponentModel.parent.config.genericProperties}),a=this.viewModel.get("applyTo");return n.parent=this,o="detailrows"===a?this.columnComponentModel.get("dataType").toLowerCase():this.columnComponentModel.parent.columnGroups.findWhere({id:a}).get("dataType").toLowerCase(),n.viewModel.set({conditionOptions:this.columnComponentModel.parent.config.genericProperties.operators[o],dataType:o,calendarPatterns:this.columnComponentModel.parent.config.genericProperties.calendarPatterns}),n.model.set(e),this._$subviewsContainer.append(n.render().$el),this._subviews.push(n),t||(i=this.collection.add(n.model),n.viewModel.set("conditionIndex",this.collection.indexOf(i)+1)),n.model},addAll:function(e){var t=this;this.collection.set(r.map(e,function(e,o){var i=t.addModel(e,!0),n=t.getSubviewByModel(i);return n.viewModel.set("conditionIndex",o+1),i}))},removeSubview:function(e){var t=this.getSubviewByModel(e);if(t){var o=r.indexOf(this._subviews,t);this._subviews.splice(o,1),t.remove()}},getSubviewByModel:function(e){return r.find(this._subviews,function(t){return t.model===e})},render:function(){r.invoke(this._subviews,"remove"),this._subviews=[],this._$subviewsContainer.empty();var e=this.collection.toJSON();return this.collection.reset(),this.addAll(e),this},addNewCondition:function(e){if(!this.$(e.target).is(".disabled")){var t=new v,o=this.addModel(t.defaults()),i=this.getSubviewByModel(o);o.set("operator",i.getBinding("convertedOptions")[0].value),t.remove()}},setColumnComponentModel:function(e,t){t?i.call(this):(this.cache.clear(),this.viewModel.set({applyTo:null},{silent:!0}),this.collection.genericProperties=e.parent.config.genericProperties),this.columnComponentModel=e,o.call(this)},getActions:function(){var e=this,t=this.cache,o=[];return i.call(this),r.each(t.map,function(i,n){var l=t.keyInfo[n];l.model.updateFromReportComponentObject({conditions:a.call(e,i.current,l.model.get("dataType"),l.model.get("conditionalFormattingData").conditionPattern)}),o.push(l.model.actions["change:conditions"].call(l.model))}),o},isValid:function(){var e=[];return this.collection.reduce(function(e,t){return t.isValid()||e.push(t),e},e),!e.length},validate:function(){return this.isValid()?!0:(this.errorDialog.setMessage(u["net.sf.jasperreports.components.headertoolbar.conditions.invalid"]),this.errorDialog.open(),!1)},clear:function(){r.invoke(this._subviews,"remove"),this.collection.reset(),this.cache.clear()},remove:function(){s.View.prototype.remove.apply(this,arguments),this.viewModel&&this.viewModel.remove(),this.collection&&this.collection.remove(),this.cache&&this.cache.remove(),this.errorDialog&&this.errorDialog.remove(),r.invoke(this._subviews,"remove"),this._subviews=[]}})});