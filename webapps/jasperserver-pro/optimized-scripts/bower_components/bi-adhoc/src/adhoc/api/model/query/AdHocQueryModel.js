define(["require","underscore","backbone","jrs.configs","../enum/QueryExecutorHttpHeaders","../../visualChooser/visualizationTypesManager","../enum/DefaultFormatMap","./AdHocQueryParametersModel","./AdHocQueryExpressionModel","./AdHocQueryExpansionsCollection","./AdHocQueryLevelCollection","./AdHocQueryOrderByCollection"],function(e){"use strict";function t(e,t){var r=t.get("member")||t.get("level");r.expanded=!1,i.call(this,e,t)}function i(e,t){var i=r.call(this,e,t);this._triggerChanged(),e.expansions.trigger("expansions:change",i,e)}function r(e,t){var i=[t.attributes];return i=t.has("level")?i.concat(a.apply(this,arguments)):i.concat(n.apply(this,arguments))}function a(e,t){for(var i,r,a=this.groupByJSON()[e.id].items,n=t.get("level"),o=!0,s=-1,l=0;l<a.length;l++)n.aggregation&&a[l].aggregations||n.fieldRef&&a[l].level&&n.fieldRef===a[l].level.id?(o=!1,s=l):(r=e.expansions.getByGroupByItem(a[l]),r.attributes.level.expanded=o);return i=A.reduce(e.expansions.getMemberExpansions(),function(e,t){return t.get("member").path.length-1>s?t.get("member").expanded?e.toApply.push(t):e.toRemove.push(t):t.get("member").path.length-1===s?e.toRemove.push(t):t.get("member").expanded?e.toRemove.push(t):e.toApply.push(t),e},{toRemove:[],toApply:[]}),e.expansions.remove(i.toRemove,{silent:!0}),A.map(i.toApply,function(e){return e.toJSON()})}function n(e,t){var i=e.expansions.filter(function(e){return e.has("member")&&o(t.get("member").path,e.get("member").path)}),r=A.map(i,function(e){return{member:{expanded:!1,path:e.attributes.member.path}}});return e.expansions.remove(i,{silent:!0}),s(e,t),r}function o(e,t){if(e.length<t.length){for(var i=0;i<e.length;i++)if(t[i]!==e[i])return!1;return!0}return!1}function s(e,t){var i,r=t.get("member");if(r&&e.axis.hasMeasures()&&!e.axis.models[e.axis.length-1].isMeasure()){i=e.axis.toQueryMultiaxisAxisItems();var a=A.reduce(i,function(e,t,i){return t.aggregations?i:e});if(r.expanded&&r.path.length>=a){for(var n=r.path.slice(0,a),o=0;o<n.length;o++){var s=e.expansions.getByPath(n.slice(0,o));s&&e.expansions.remove(s,{silent:!0})}e.expansions.add({member:{expanded:!0,path:r.path.slice(0,a)}},{silent:!0})}if(!r.expanded&&r.path.length<a){for(var l=[].concat(r.path),c=e.axis.reduce(function(e,t){return t.isMeasure()&&e.push(t.has("id")?t.get("id"):t.get("hierarchicalName")),e},[]),o=l.length;a>o;o++)l.push("All");for(var o=0;o<c.length;o++){var s=e.expansions.getByPath(l.concat([c[o]]));s?s.get("member").expanded=!1:e.expansions.add({member:{expanded:!1,path:l.concat([c[o]])}},{silent:!0})}}}}function l(e,t){return e.components.reduce(function(e,i){return"Measures"===i.get("reference")?e=c(e,t):e[i.get("reference")]={format:i.get("format"),formatId:i.get("formatId"),aggregationFormat:i.get("aggregationFormat"),aggregationFormatId:i.get("aggregationFormatId")},e},{})}function c(e,t){return t.components.reduce(function(e,t){return e[t.get("reference")]={aggregationFormat:t.get("format"),aggregationFormatId:t.get("formatId")},e},e)}function g(e,t,i,r,a){var n=i.schema,o=l(r,a);return A.reduce(e,function(e,i){if(i.level){var r=n.getByReference(i.level.field);e.push(A.defaults(i.level,{id:r.hierarchicalName,kind:r.kind,field:r.name,dimension:r.hierarchicalName,hierarchicalName:r.hierarchicalName,functionName:r.aggregation,type:r.type,label:r.label,labelId:r.labelId,includeAll:!1,format:o[i.level.id||i.level.field].format,formatId:o[i.level.id||i.level.field].formatId,aggregationFormat:o[i.level.id||i.level.field].aggregationFormat,aggregationFormatId:o[i.level.id||i.level.field].aggregationFormatId}))}else{if(!i.aggregations)throw new Error('Unknown element in "GroupBy"');e=e.concat(u(t,n,o))}return e},[])}function d(e,t){var i=t.schema,r=A.reduce(t.component.getTableComponent().getGroups(),function(e,t){return e[t.get("reference")]={aggregationFormat:t.get("aggregationFormat"),format:t.get("format")},e},{});return A.map(A.compact(A.pluck(e,"group")),function(e){var t=i.getByReference(e.field);return A.defaults(e,{id:t.hierarchicalName,kind:t.kind,field:t.name,dimension:t.hierarchicalName,hierarchicalName:t.hierarchicalName,functionName:t.aggregation,type:t.type,label:t.label,labelId:t.labelId,aggregationFormat:r[e.id||e.field].aggregationFormat,aggregationFormatId:r[e.id||e.field].aggregationFormatId,format:r[e.id||e.field].format,formatId:r[e.id||e.field].formatId,includeAll:!0})})}function h(e,t){for(var i=t.schema,r=[],a=[].concat(e.aggregations||[]),n=e.fields||[],o=A.reduce(t.component.getTableComponent().getColumns(),function(e,t){return e[t.get("reference")]={aggregationFormat:t.get("aggregationFormat"),aggregationFormatId:t.get("aggregationFormatId"),format:t.get("format"),formatId:t.get("formatId")},e},{}),s=0;s<n.length;s++){for(var l=!1,c=0;c<a.length&&!l;c++)!a[c]||a[c].fieldRef!==n[s].id&&a[c].fieldRef!==n[s].field||(l=m(a[c],n[s].id||n[s].field,i.getByReference(n[s].field),o),a[c]=!1);l?r.push(l):r.push(p(n[s],i,o))}return r.concat(u(A.compact(a),i,o,n))}function u(e,t,i,r){return A.map(e,function(e){var a,n;return r?(a=A.find(r,function(t){return e.fieldRef===t.id||e.fieldRef===t.field}),a?(a=a.field,n=a.id||a.field):a=e.fieldRef):a=e.fieldRef,m(e,n,t.getByReference(a),i)})}function m(e,t,i,r){return A.defaults({field:e.fieldRef,functionName:e.functionName,aggregationType:e.type,aggregationFormat:r[e.id||e.fieldRef].aggregationFormat,aggregationFormatId:r[e.id||e.fieldRef].aggregationFormatId,format:r[e.id||e.fieldRef].format,formatId:r[e.id||e.fieldRef].formatId,id:t||e.id,firstLevelExpression:e.firstLevelExpression,timeBalanceFunctionName:e.timeBalanceFunctionName},{id:i.hierarchicalName,kind:i.kind,field:i.name,dimension:i.hierarchicalName,hierarchicalName:i.hierarchicalName,functionName:i.aggregation,type:i.type,label:i.label,labelId:i.labelId,includeAll:!0})}function p(e,t,i){var r=t.getByReference(e.field);return{id:e.id||e.field,kind:r.kind,field:r.name,dimension:r.hierarchicalName,hierarchicalName:r.hierarchicalName,functionName:r.aggregation,aggregationFormat:i[e.id||e.field].aggregationFormat,aggregationFormatId:i[e.id||e.field].aggregationFormatId,format:i[e.id||e.field].format,formatId:i[e.id||e.field].formatId,type:r.type,label:r.label,labelId:r.labelId,includeAll:!0}}function f(e,t){var i,r,a=t.get("showTotals");return e.type()===O.type.MULTIAXES?i={aggregations:A.reduce(e.cols.axis.models.concat(e.rows.axis.models),function(e,t){return t.isMeasure()&&e.push({id:t.get("id"),type:t.get("aggregationType"),functionName:t.get("functionName"),fieldRef:t.get("hierarchicalName"),firstLevelExpression:t.get("firstLevelExpression"),timeBalanceFunctionName:t.get("timeBalanceFunctionName")}),e},[])}:(i={},r=A.reduce(t.getColumns(),function(e,t){if(a||t.hasSummary()){var i=t.level();i&&e.push({id:i.get("id")||i.get("type"),type:i.get("aggregationType"),functionName:i.get("functionName"),fieldRef:i.get("hierarchicalName"),firstLevelExpression:i.get("firstLevelExpression"),timeBalanceFunctionName:i.get("timeBalanceFunctionName")})}return e},[]),r.length&&(i.aggregations=r),t.get("showDetails")&&(i.fields=e.cols.axis.map(function(e){return{id:e.get("id"),field:e.get("hierarchicalName")}}))),i}function y(e){var t;return t=e.type()===O.type.MULTIAXES?{rows:x(e.rows,e.get("_chartMode")),columns:x(e.cols,e.get("_chartMode"))}:[{allGroup:{}}].concat(e.rows.axis.map(function(e){return{group:{id:e.get("id"),field:e.get("hierarchicalName")}}}))}function x(e,t){var i={items:e.axis.toQueryMultiaxisAxisItems()};return e.expansions.length&&(i.expansions=e.expansions.toJSON({isChartMode:t})),i}function v(e){var t=e.aggregations||[],i=e.fields||[];A.each(t,function(e){e.id===e.fieldRef&&delete e.id}),A.each(e.fields||[],function(e){e.id===e.field&&delete e.id});for(var r=0;r<t.length;r++)for(var a=0;a<i.length;a++)t[r].id&&t[r].id==i[a].id&&(t[r].fieldRef=i[a].id,delete t[r].id);return e}function I(e){return A.each(e.rows&&e.columns?e.rows.items.concat(e.columns.items):e,function(e){var t=e.level||e.group;t&&t.id&&t.id===t.field&&delete t.id}),e}function T(e,t){var i=t.axis.multiAxisMap(function(e){var t;if(e.isMeasure())t={componentType:"level",components:[],properties:{reference:"Measures",dimension:"Measures",label:"Measures"}};else{if(!e.isLevel())throw new Error("Unknown kind: "+e.get("kind"));t={componentType:"level",components:[],properties:{reference:e.has("id")?e.get("id"):e.get("hierarchicalName"),dimension:e.get("dimension"),includeAll:e.get("includeAll"),format:e.get("format"),formatId:e.get("formatId"),aggregationFormat:e.get("aggregationFormat")}}}return t});return{componentType:"axis",components:i,properties:{name:t.id}}}function M(e){var t=function(e){return e.isMeasure()},i=e.rows.axis.filter(t).concat(e.cols.axis.filter(t));return{componentType:"measures",components:A.map(i,function(e){return{componentType:"measure",components:[],properties:{format:e.get("aggregationFormat"),formatId:e.get("aggregationFormatId"),reference:e.get("id")||e.get("hierarchicalName")}}}),properties:{}}}function w(e){return e.cols.axis.map(function(e){return{componentType:"column",components:[],properties:{id:e.has("id")?e.get("id"):e.get("hierarchicalName"),reference:e.has("id")?e.get("id"):e.get("field"),detailFieldReference:e.get("hierarchicalName"),aggregatedFieldReferences:[e.get("hierarchicalName")],aggregationFormat:e.get("aggregationFormat"),aggregationFormatId:e.get("aggregationFormatId"),format:e.get("format"),formatId:e.get("formatId")}}})}function E(e){return e.rows.axis.map(function(e){return{componentType:"group",components:[],properties:{reference:e.get("hierarchicalName"),format:e.get("format"),formatId:e.get("formatId")}}})}function N(e){return e.isLevel()?{id:e.get("id")||e.get("hierarchicalName"),type:e.get("type")}:void 0}var A=e("underscore"),L=e("backbone"),b=e("jrs.configs"),C=e("../enum/QueryExecutorHttpHeaders"),F=e("../../visualChooser/visualizationTypesManager"),_=(e("../enum/DefaultFormatMap"),e("./AdHocQueryParametersModel")),B=e("./AdHocQueryExpressionModel"),R=e("./AdHocQueryExpansionsCollection"),S=e("./AdHocQueryLevelCollection"),U=e("./AdHocQueryOrderByCollection"),O=L.Model.extend({initialize:function(e,t){this.contextPath=t&&t.server,this.adHocModel=t.adHocModel,this.where=new B({},t),this.rows={id:"rows"},this.cols={id:"columns"},this._initializeAxes(t),this._initializeParameters(t),this._initializeExpansions(t),this._initializeOrderBy(t),this.listenTo(this.adHocModel,"change:visualizationType",function(e,t){var i="Table"===t?O.type.MULTILEVEL:O.type.MULTIAXES;this.set({_type:i,_chartMode:i===O.type.MULTIAXES&&"Crosstab"!==t})}),this.on("change:_type",this._triggerChanged,this),this.on("change:_chartMode",this._triggerChanged,this)},toJSON:function(e){var t,i,r={},a=this.type();return a!==O.type.PROVIDED&&(i=this.selectJSON(),i&&(r.select=v(i)),i=this.whereJSON(),i&&(r.where=i),i=this.groupByJSON(),i&&(r.groupBy=I(i)),i=this.orderByJSON(),i&&(r.orderBy=i),e?t=r:(t={},t[a]=r)),t},selectJSON:function(){return f(this,this.adHocModel.component.getTableComponent())},whereJSON:function(){return A.cloneDeep(this.get("where"))},groupByJSON:function(){return y(this)},orderByJSON:function(){return this.orderBy.toJSON(this.type()===O.type.MULTILEVEL)},acquire:function(e){var t;if(e[O.type.MULTILEVEL]?(t=e[O.type.MULTILEVEL],t._type=O.type.MULTILEVEL):e[O.type.MULTIAXES]?(t=e[O.type.MULTIAXES],t._type=O.type.MULTIAXES):this.clear(),t){if(this.set(t),t.where&&(this.where.acquire(t.where.filterExpression),this.parameters.acquire(t.where.parameters,this.where.readFilterInformation())),t.groupBy)if(t.groupBy.rows&&t.groupBy.columns){var i=this.adHocModel.component.getMultiAxisComponent(),r=i.getMeasuresComponent();this.rows.axis.reset(g(t.groupBy.rows.items,t.select.aggregations,this.adHocModel,i.getRowsComponent(),r),{silent:!0}),this.cols.axis.reset(g(t.groupBy.columns.items,t.select.aggregations,this.adHocModel,i.getColumnsComponent(),r),{silent:!0}),this.rows.expansions.reset(t.groupBy.rows.expansions||[],{silent:!0}),this.cols.expansions.reset(t.groupBy.columns.expansions||[],{silent:!0}),this.rows.expansions.forEach(A.bind(s,this,this.rows)),this.cols.expansions.forEach(A.bind(s,this,this.cols))}else this.rows.axis.reset(d(t.groupBy,this.adHocModel),{silent:!0}),this.cols.axis.reset(h(t.select,this.adHocModel),{silent:!0}),this.rows.expansions.reset([],{silent:!0}),this.cols.expansions.reset([],{silent:!0});else this.cols.axis.reset(h(t.select,this.adHocModel.schema),{silent:!0}),this.rows.expansions.reset([],{silent:!0}),this.cols.expansions.reset([],{silent:!0});t.orderBy&&this.orderBy.reset(t.orderBy,{silent:!0}),this.trigger("query:componentsDataChange",this)}},type:function(e){if(!arguments.length){var t=this.get("_type");return t||(t=this.has("select")?O.type.MULTILEVEL:O.type.PROVIDED,this.has("groupBy")&&this.get("groupBy").rows&&this.get("groupBy").columns&&(t=O.type.MULTIAXES)),t}this.set({_type:e})},headers:function(){var e;return e=this.type()===O.type.MULTILEVEL?{Accept:C.ACCEPT_MULTI_LEVEL_DATA,"Content-Type":C.CONTENT_TYPE_MULTI_LEVEL_QUERY}:this.type()===O.type.MULTIAXES?{Accept:C.ACCEPT_MULTI_AXES_DATA,"Content-Type":C.CONTENT_TYPE_MULTI_AXES_QUERY}:{Accept:C.ACCEPT_NO_FLAT,"Content-Type":C.CONTENT_TYPE_PROVIDED_QUERY},e["Accept-Timezone"]=b.userTimezone,e},_initializeAxes:function(e){this.cols.axis=new S([],e),this.rows.axis=new S([],A.extend({master:this.cols.axis},e));var t=A.bind(function(){this.trigger("query:componentsDataChange",this),this._triggerChanged()},this);this.listenTo(this.cols.axis,"add change remove reset",t),this.listenTo(this.rows.axis,"add change remove reset",t)},_initializeParameters:function(e){this.parameters=new _({},e),this.listenTo(this.parameters,"change",function(){if(this.has("where")){var e=A.omit(this.get("where"),"parameters");e.parameters=A.defaults(this.parameters.toJSON(),this.get("where").parameters),this.set("where",e)}this._triggerChanged()},this)},_initializeExpansions:function(e){this.rows.expansions=new R([],A.extend({query:this,axis:this.rows},e)),this.cols.expansions=new R([],A.extend({query:this,axis:this.cols},e)),this.listenTo(this.rows.expansions,"add change",A.bind(i,this,this.rows)),this.listenTo(this.cols.expansions,"add change",A.bind(i,this,this.cols)),this.listenTo(this.rows.expansions,"remove",A.bind(t,this,this.rows)),this.listenTo(this.cols.expansions,"remove",A.bind(t,this,this.cols))},_initializeOrderBy:function(){this.orderBy=new U,this.on("query:componentsDataChange",function(){this.orderBy.measures=A.reduce(this.rows.axis.models.concat(this.cols.axis.models),function(e,t){return t.isMeasure()&&(e[t.get("hierarchicalName")]=!0),e},{}),this.orderBy.multiAxisItems=A.reduce(this.rows.axis.toQueryMultiaxisAxisItems().concat(this.cols.axis.toQueryMultiaxisAxisItems()),function(e,t){return t.level&&(e[t.level.id||t.level.field]=!0),e},{})},this),this.listenTo(this.orderBy,"add change remove",this._triggerChanged,this)},_triggerChanged:function(){this.trigger("query:changed",this)},_outputParameters:function(){var e=this.rows.axis.hasMeasures()||this.cols.axis.hasMeasures()?[{id:"Measures"}]:[];return e=this.type()===O.type.MULTIAXES?e.concat(this.rows.axis.multiAxisMap(N).concat(this.cols.axis.multiAxisMap(N))):e.concat(this.rows.axis.map(N).concat(this.cols.axis.map(N))),A.compact(e)},toDataComponent:function(){return{metadata:{availableVisualizationTypes:this.getAllowedTypesList(),inputParameters:this.parameters.toDataComponent(),outputParameters:this._outputParameters()}}},getTableComponents:function(){return w(this).concat(E(this))},getCrosstabComponents:function(){return[T(this,this.cols),T(this,this.rows),M(this)]},getChartComponents:function(){return this.getCrosstabComponents()},getDisabledTypesList:function(){return F.getDisabledTypesList(this.cols.axis,this.rows.axis)},getAllowedTypesList:function(){return F.getAllowedTypesList(this.cols.axis,this.rows.axis)}},{type:{PROVIDED:"provided",FLAT:"flat",MULTILEVEL:"multiLevel",MULTIAXES:"multiAxes"}});return O.prototype.defaults={_type:O.type.PROVIDED},O});