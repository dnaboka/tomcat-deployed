define(["require","underscore","jquery","common/bi/error/biComponentErrorFactory","./query/AdHocQueryModel","backbone","logger"],function(t){"use strict";function e(t,e,a){this.dataUrl=a.getResponseHeader("Content-Location")||this.dataUrl,this.adHocModel.trigger("data:available","query",this.query);var r=s(a,this.query);this._data[r]&&this._data[r].resolve(this.attributes).promise()}function a(t,e){var a=l.requestError(t),r=s(t,this.query);this._data[r]&&(this._data[r].reject(a),this.trigger("error:dataset",a))}function s(t,e){var a;return a=t.getResponseHeader&&t.getResponseHeader("Content-Type")?t.getResponseHeader("Content-Type").replace("application/","").replace("Data+json",""):e.type()}function r(t){var e=function(t,e){return e.isMeasure()?t+1:t},a=t.rows.axis.reduce(e,0),s=t.cols.axis.reduce(e,0);return[s?s:1,a?a:1]}function i(t){var e=t[1]?o.map(new Array(t[1]),function(){return""}):"";return o.map(new Array(t[0]),function(){return e})}function n(t){for(var e=t.axis.toQueryMultiaxisAxisItems(),a=o.map(e,function(e){var a={};return e.level?a.level={members:[]}:a.aggregation={fields:t.axis.reduce(function(t,e){return e.isMeasure()&&t.push({reference:e.get("id")}),t},[])},a}),s=o.map(e,function(t){return[{all:!!t.level}]}),r=0;r<a.length;r++)if(a[r].aggregation)for(var i=0;i<a[r].aggregation.fields.length;i++)s[r][i]||s[r].push(o.cloneDeep(s[r][0])),s[r][i].memberIdx=i;var n=function(t,e){return a[e]&&(t.children=o.map(s[e],function(t){return n(t,e+1)})),t};return{levels:a,axisNode:n({all:!0},0)}}var o=t("underscore"),u=t("jquery"),l=t("common/bi/error/biComponentErrorFactory"),d=t("./query/AdHocQueryModel"),h=t("backbone"),p=t("logger").register("AdHocDataSetModel"),c=h.Model.extend({defaults:{dataSourceUri:"",params:{offset:[0,0],pageSize:[50,50]}},url:function(){var t;return t=this.isNew()?this.contextPath+"/rest_v2/queryExecutions":this.dataUrl+"?"+o.map(this.get("params").offset,function(t){return"offset="+t}).concat(o.map(this.get("params").pageSize,function(t){return"pageSize="+t})).join("&")},initialize:function(t,e){this.adHocModel=e.adHocModel,this.contextPath=e.server,this._lastData=o.cloneDeep(this.defaults),this._data={},this.query=new d({},e),this.on("change:params",this.clearDataset,this),this.on("change:dataSourceUri",this.resetDataset,this),this.listenTo(this.query,"query:changed",this.resetDataset,this),this._scheduleDataUpdate()},sync:function(t,e,a){return"read"==t&&(this.isNew()&&(a.data=JSON.stringify(this.toJSON()),a.type="POST",a.processData=!1),a.headers=this.query.headers()),"delete"!=t||this.isNew()||(a.url=this.dataUrl.split("/data")[0]),h.Model.prototype.sync.call(this,t,e,a)},parse:function(t){if(this.get("params")){for(var e=t.params.offset,a=this.get("params").offset,s=0;s<e.length;s++)for(var o=0;o<e[s].length;o++)e[s][o]!==a[s][o]&&p.info("offsets does not match!");delete t.params}return t&&t.dataset&&!t.dataset.data&&!t.dataset.levels&&(t.dataset.counts=r(this.query),t.dataset.data=i(t.dataset.counts),t.dataset.axes=[n(this.query.cols),n(this.query.rows)],t.dataset.empty=!0),t},isNew:function(){return!this.dataUrl},data:function(){return this._data[this.query.type()]||(this._data[this.query.type()]=new u.Deferred,this.fetch().done(o.bind(e,this)).fail(o.bind(a,this))),this._data[this.query.type()].promise()},toJSON:function(){var t=h.Model.prototype.toJSON.apply(this,arguments);return this.query.type()!==d.type.PROVIDED&&(t.query=this.query.toJSON(!0)),this.query.type()===d.type.MULTILEVEL&&(t.params={offset:[t.params.offset[0]],pageSize:[t.params.pageSize[0]]}),t},toDataComponent:function(){var t={_dataset_internal_:o.cloneDeep(this.get("dataset"))};return this.query.type()===d.type.MULTILEVEL?t._dataset_internal_.params={offset:[this.get("params").offset[0]],pageSize:[this.get("params").pageSize[0]]}:t._dataset_internal_.params=o.cloneDeep(this.get("params")),t._dataset_internal_.totalCounts=o.isArray(this.get("totalCounts"))?o.cloneDeep(this.get("totalCounts")):[this.get("totalCounts")],this.get("truncated")&&(t._dataset_internal_.truncated=!0),this._cleanupDatasetFromTemporaryProperties(t._dataset_internal_),t},_cleanupDatasetFromTemporaryProperties:function(t){delete t.empty},updateFromDataComponent:function(t){var e,a;if(t.params){if(t.params.offset)for(a=0;a<t.params.offset.length;a++)(t.params.offset[a]<0||this._lastData._dataset_internal_&&this._lastData._dataset_internal_.totalCounts&&this._lastData._dataset_internal_.totalCounts[a]&&t.params.offset[a]>=this._lastData._dataset_internal_.totalCounts[a])&&(e=(new u.Deferred).reject({message:"Invalid offset specified. Offset should be bounded by [0, 0] and ["+this._lastData._dataset_internal_.totalCounts.join()+"]",errorCode:"paging.offset.out.of.range",parameters:[[0,0],this._lastData._dataset_internal_.totalCounts.slice()]}));if(t.params.pageSize)for(a=0;a<t.params.pageSize.length;a++)t.params.pageSize[a]<=0&&(e=(new u.Deferred).reject({errorCode:"page.size.out.of.boundaries",message:"The pageSize parameter value must be greater than 0",parameters:[a,0]}));this._lastData.params=o.defaults(t.params,this._lastData.params),this.set("params",this._lastData.params)}return e||(this._scheduleDataUpdate(),e=this.data()),e},resetDataset:function(){this.clearDataset(),this.destroy(),this.dataUrl=void 0,this.unset("totalCounts",{silent:!0}),this.adHocModel.trigger("dataset:reset")},clearDataset:function(){this.unset("dataset",{silent:!0}),this._data={},this.adHocModel.trigger("dataset:clear")},_scheduleDataUpdate:function(){this.once("change:dataset",function(){this._lastData._dataset_internal_={totalCounts:o.isArray(this.get("totalCounts"))?o.cloneDeep(this.get("totalCounts")):[this.get("totalCounts")]},this.adHocModel.trigger("data:available","_dataset_internal_",this)},this)}});return c});