define(["require","underscore","bundle!AdHocBundle"],function(e){function t(e,t){var a=n.cloneDeep(e.columnsOutputParams);if(a=a.concat(t.rowsOutputParams),"Measures"!==a[0].name.name){var r=t.options?t.options.x:t.x;n.isUndefined(r)||(a[0].value=e.heatmapXCategories[r])}return a}var n=e("underscore"),a=e("bundle!AdHocBundle"),r=function(){this._timestampToMemberMapping={}};return n.extend(r.prototype,{perform:function(e,t){var a=e.options.linkOptions,r=this;a&&a.events&&("timeseries_heatmap"===t.series[0].chartType&&(t.chart.events||(t.chart.events={}),a.events.click&&(t.chart.events.click=function(t){var n=this.hoverPoint,o=n.series.options;a.events.click.call(this,t,r.getHyperlink(o,n,e))})),n.forEach(t.series,function(t){t.cursor="pointer",t.point||(t.point={}),t.point.events={},"timeseries_heatmap"!==t.chartType&&r.attachEvent.call(r,"click",a,t,e),r.attachEvent.call(r,"mouseOver",a,t,e),r.attachEvent.call(r,"mouseOut",a,t,e)}))},getOutputParamsForTreemap:function(e,t,a){var r=a.adHocModel.component.getChartComponent(),o=r.components.findComponentDeep("measure"),i=n.pluck(a.adHocModel.dataSet.attributes.dataset.axes[1].levels,"level"),s=i.length>1?t.id.split("/@#/").slice(1):[t.name];return n.map(s,function(e,t){return{value:e,name:{name:i[t].referenceObject.name}}}).concat({value:n.map(o,function(e){return e.label(!0)}),name:{name:"Measures"}})},getOutputParams:function(e,a,r){var o=[];return e.columnsOutputParams&&(o=o.concat(e.columnsOutputParams)),a&&a.rowsOutputParams&&(o=o.concat(a.rowsOutputParams)),"treemap"===e.chartType&&a&&(o=o.concat(this.getOutputParamsForTreemap(e,a,r))),"heatmap"===e.chartType&&a&&(o=t(e,a)),o=n.filter(o,function(e){return!n.isUndefined(e.value)})},getMeasureReferenceByLabel:function(e,t){return n.find(e,function(e){return e.label(!0)===t}).get("reference")},getMeasures:function(e,t){var a=t.adHocModel.component.getChartComponent(),r=a.components.findComponentDeep("measure");return n.isArray(e)?n.map(e,function(e){return this.getMeasureReferenceByLabel(r,e)},this):[this.getMeasureReferenceByLabel(r,e)]},getHyperlink:function(e,t,a){return n.reduce(this.getOutputParams(e,t,a),function(e,t){return"Measures"===t.name.name||"MeasuresLevel"===t.name.name?e.Measures=this.getMeasures(t.value,a):e[t.name.name]=this.loadInitialValue(this.encodeFieldValue(t.value)),e},{},this)},getHyperlinks:function(e,t){var a=this;return n.map(n.flatten(n.map(e.series,function(e){return n.map(e.data,function(n){return a.getHyperlink(e,n,t)})})),function(e){return{element:null,data:e}})},encodeFieldValue:function(e){switch(e){case a["adhoc.node.other.node"]:e="other_node";break;case a["adhoc.node.total.node"]:e="total_node"}return e},attachEvent:function(e,t,n,a){var r=this;t.events[e.toLowerCase()]&&(n.point.events[e]=function(o){var i=this;t.events[e.toLowerCase()].call(r,o,r.getHyperlink(n,i,a),null,null)})},saveInitialValue:function(e,t){this._timestampToMemberMapping[e]=t},loadInitialValue:function(e){return n.isUndefined(this._timestampToMemberMapping[e])?e:this._timestampToMemberMapping[e]}}),r});