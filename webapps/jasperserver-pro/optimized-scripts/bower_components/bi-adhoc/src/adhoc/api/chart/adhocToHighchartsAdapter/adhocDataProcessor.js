!function(e,a){"use strict";"function"==typeof define&&define.amd?define(["underscore","xssUtil"],e):a.AdhocDataProcessor=e(_,xssUtil)}(function(e,a){"use strict";var n={debug:!1,fn:{getMessage:function(e){return this.messages?this.messages[e]:e},load:function(e){var a=n;a.data=e.data,a.metadata=e.metadata,a.treeNodeAxes=e.treeNodes,a.fn.load_common(),n.debug&&(console.info("Data Processor State:"),console.info(a))},load_common:function(){var e=n;if(e.measureAxis=e.metadata.measureAxis,e.nonMeasureAxis=0===e.measureAxis?1:0,e.metadata.axes.length&&(e.measureLevelNumber=e.fn.getMeasureLevelNumber.call(e),e.metadata.isOLAP&&(e.measureDimensionNumber=0,e.dimensionMappings=[],e.dimensionAllMappings=new Array(2),e.dimensionLevels=new Array(2),e.rowDimensionMapping=e.fn.dimensionMapping(0),e.dimensionMappings.push(e.rowDimensionMapping),e.colDimensionMapping=e.fn.dimensionMapping(1),e.dimensionMappings.push(e.colDimensionMapping)),e.lastRowNonMeasureLevel=0,e.lastColumnNonMeasureLevel=0,e.rowSliderLevelCount=e.metadata.axes[0].length+1-(0===e.metadata.measureAxis?1:0),e.colSliderLevelCount=e.metadata.axes[1].length+1-(1===e.metadata.measureAxis?1:0),e.rowGroupMapping=e.fn.groupMapping.call(e,0),e.colGroupMapping=e.fn.groupMapping.call(e,1)),e.treeNodeAxes.length&&(e.fn.createTreeNodeStructure.call(e,e.treeNodeAxes[0]),e.fn.createTreeNodeStructure.call(e,e.treeNodeAxes[1])),e.data.length){if("undefined"==typeof e.measureAxis)throw"AdhocDataProcessor.load_common  missing measureAxis metadata !";if(e.measureAxis>1)throw"AdhocDataProcessor.load_common  measureAxis > 1 !";if(e.measureAxis<0)throw"AdhocDataProcessor.load_common  measureAxis < 0 !";if("undefined"==typeof e.measureLevelNumber)throw"AdhocDataProcessor.load_common  measureLevelNumber undetermined !";if(e.measureLevelNumber<=0)throw"AdhocDataProcessor.load_common  measureLevelNumber <= 0 !"}},getOLAPDimensionInfo:function(){for(var e=n,a=new Array(2),r=0;2>r;r++){var t=[],o=e.dimensionMappings[r],s=e.measureAxis===r;if(o.length<=0);else for(var l=e.dimensionAllMappings[r],i=0;i<o.length;i++){var u=o[i];if(!(s&&u.length>0&&"Measures"===u[0].dimension)){var d=!1;l[i]===!0&&(d=!0);var m={};m.levels=[];var v=0;d&&m.levels.push({label:"(All)",levelName:"(All)",levelNumber:v}),v=1;for(var f=0;f<u.length;f++){var g=u[f];m.dimension=g.dimension,g.name&&"(All)"===g.name||(m.levels.push({label:g.label,levelName:g.name,levelNumber:v}),v++)}t.push(m)}}a[r]=t}return n.debug&&(console.log("AdhocDataProcessor.getOLAPDimensionInfo: 4098h  olapAxes"),console.log(a)),a},getMeasureLevelNumber:function(e){e||(e=this.metadata);for(var a=e.axes[e.measureAxis],n=0;n<a.length;n++)if("Measures"==a[n].dimension)return n+1},groupMapping:function(e){var a,r=n,t=[0],o=1,s=r.metadata.axes[e];for(a=0;a<s.length;a++)"Measures"!=s[a].dimension&&(t[o++]=a+1);return t},dimensionMapping:function(e){var a=n;if(!a.metadata.isOLAP)return null;var r=a.metadata.axes[e],t=1,o=[],s=[];if(a.metadata.axes[e].length<=0)return o;var l=0,i=!1,u=r[0].dimension,d=u;u||alert("dataprocessor.js  ERROR ! 0983jhrn   null dimension in axis "+e);for(var m=[],v=[],f=[],g=t,c=0;c<r.length;c++)if(d=r[c].dimension,"Measures"===d&&(a.measureDimensionNumber=l,a.measureLevelNumber=t),d!==u&&(i?s.push(!0):s.push(!1),f.push({dimension:u,startLevel:g,endLevel:t-1}),o.push(m),l++,m=[],i=!1,u=d,g=t),"(All)"!==r[c].label&&"(ALL)"!==r[c].label||(i=!0,!(c<r.length-1&&d===r[c+1].dimension))){var L={dimension:r[c].dimension,label:r[c].label,name:r[c].name,levelNumber:t};m.push(L),v.push(L),t++}return i?s.push(!0):s.push(!1),o.push(m),f.push({dimension:d,startLevel:g,endLevel:t-1}),a.metadata.axes[e]=v,a.dimensionAllMappings[e]=s,a.dimensionLevels[e]=f,n.debug&&(console.log("AdhocDataProcessor.dimensionMapping:49e8h  dimensions for axis "+e),console.log(o)),o},createTreeNodeStructure:function(e){var a=e;a.parent=null,a.children?this.fn.connectParentNode.call(this,a,a.children):a.children=[]},connectParentNode:function(e,a){var n,r;for(n=0;n<a.length;n++)if(r=a[n],r.parent=e,r.children){var t=r.children;t.length&&this.fn.connectParentNode.call(this,r,t)}else r.children=[]},getDataStyle:function(){var e=n;return 0===e.metadata.axes[e.nonMeasureAxis].length?0:e.metadata.axes[e.nonMeasureAxis].length>0&&e.metadata.axes[e.measureAxis].length>1?2:1},getNodeListForSliderLevel:function(e,a){var r=n,t=r.metadata.axes[e].length,o=[];o.push({startLevel:0,endLevel:a,leafLevel:t});var s=r.fn.getNodeListForDimLevels(e,o);return n.debug&&(console.log("AdhocDataProcessor.getNodeListForSliderLevel: 4088h  nodeList for axisIndex="+e+" sliderLevel="+a),console.log(s)),s},getNodeListForDimLevelRadio:function(e,a){var r=n;if(!r.metadata.isOLAP)throw"dataprocessor.getNodeListForDimLevelRadio called RadioButton method for non-OLAP query !";if(null===a)throw"dataprocessor.getNodeListForDimLevelRadio.js  y5g59i8y  NULL radioLevel input !";var t=r.dimensionMappings[e];if(!t)throw"dataprocessor.getNodeListForDimLevelRadio.js 0oi098  no dimensionMappings for axis "+e;if(t.length<=0)return r.fn.getEmptyAxisResult();if(a.length>t.length)throw"dataprocessor.getNodeListForDimLevelRadio.js  98hu for axis: "+e+", number of input dimensionss from radio buttons: "+a.length+", exceeds the number of dimensions in the chart data: "+t.length;if(a.length+(e==r.metadata.measureAxis?1:0)<t.length){n.debug&&console.log("AdhocDataProcessor.getNodeListForDimLevelRadio.js need to add  Radio Dimensions padding");for(var o=a.length,s=o;s<t.length;s++){var l=t[s];"Measures"!==l.dimension&&a.push({level:l.length})}}var i=[],u=(r.metadata.axes[e],t.length,0),d=0,m=!1,v=t[0],f="Measures"===v[0].dimension,g=0;if(f&&(g=1),f&&0===a.length)i.push({startLevel:0,endLevel:1,leafLevel:1});else for(var c=0;c<a.length;c++){var l=t[c+g];if(null===l)throw"dataprocessor.getNodeListForDimLevelRadio.js 98hn8 metadata  no dimension for number "+c;if(u++,r.metadata.measureAxis===e&&0>=g){if(c+2>t.length)throw"dataprocessor.getNodeListForDimLevelRadio.js  43098h  we were expecting dimensions to be at least "+(c+2)+" in length, instead it is "+t.length;var L=t[c+1];"Measures"===L[0].dimension&&(m=!0,g=1)}var h=l.length,p=d,A=d+a[c].level,N=d+h;(f||m)&&((A===N||f)&&A++,N++,f=!1,m=!1),i.push({startLevel:p,endLevel:A,leafLevel:N}),d=N}var x=r.fn.getNodeListForDimLevels(e,i);return n.debug&&(console.log("AdhocDataProcessor.getNodeListForDimLevelRadio: 39uh  nodeList for axis="+e+" radioDims, dimLevels "),console.log(a),console.log(i),console.log(x)),x},getNodeListForDimLevels:function(e,a){var r=n;if(0===r.metadata.axes[0].length&&0===r.metadata.axes[1].length)return null;var t=r.metadata.axes[e].length;if(t>0){var o=r.fn.getNodeListForDimensionLevelsMeasure(e,a);return o}return r.fn.getEmptyAxisResult()},getNodeListForSliderLevelGroupMeasure:function(e,a){var r=n,t=r.metadata.axes[e].length;if(t>0){var o=[];return o.push({startLevel:0,endLevel:a,leafLevel:t}),r.fn.getNodeListForDimensionLevelsMeasure(e,o)}return r.fn.getEmptyAxisResult()},getEmptyAxisResult:function(){var e=n;if(!e.emptyAxisResult){var a={isAll:!1,label:"(empty axis)",level:0,axisCoordinate:0};e.emptyAxisResult=[],e.emptyAxisResult.push(a)}return e.emptyAxisResult},getNodeListForDimensionLevelsMeasure:function(e,a){var r=n,t=!1;e===r.metadata.measureAxis&&(t=!0);var o=0===e?r.rowGroupMapping:r.colGroupMapping,s=r.treeNodeAxes[e],l=[];l.push(s);for(var i=0;i<a.length;i++){var u=a[i].startLevel,d=a[i].endLevel,m=a[i].leafLevel;n.debug&&console.log("AdhocDataProcessor.getNodeListForDimensionLevelsMeasure: 93287h  begin qualifying nodes for dim="+i+" startlevel="+u+", endLevel="+d+"localLeafLevel="+m);var v=!1;r.metadata.isOLAP?d===m&&(v=!0):i>=a.length-1&&(0===e?d>=r.rowSliderLevelCount-1&&(v=!0):d>=r.colSliderLevelCount-1&&(v=!0));var f=[];if(v){var g=m;r.metadata.isOLAP||i===a.length-1&&(g=r.metadata.axes[e].length),r.fn.getNodeListForActualLevel(e,l,g,f),n.debug&&(console.log("AdhocDataProcessor.getNodeListForDimensionLevelsMeasure: we9iuhf  LeafLevel nodeList for targetLevel="+g),console.log(f));var c=[],L=0;r.metadata.isOLAP&&(L=u);for(var h=0;h<f.length;h++){var p=f[h];if(p.isAll!==!0)for(var A=p.parent;null!=A;){if(A.level<=L){c.push(p);break}if(A.isAll===!0)break;A=A.parent}}l=c,n.debug&&(console.log("AdhocDataProcessor.getNodeListForDimensionLevelsMeasure:  er83   qualifiedChildren"),console.log(l))}else{var g=o[d+1];r.metadata.isOLAP&&(g=d+1),1===a.length&&0===g?f.push(s):l&&r.fn.getNodeListForActualLevel(e,l,g,f);for(var N=[],h=0;h<f.length;h++){var p=f[h],x=!1;if(p.level<=0)throw"dataprocessor.getNodeListForDimensionLevelsMeasure  leaf  node.level is unexpectedly less or equal to zero !";if(0!==p.level&&p.isAll===!0&&(x=!0),x){if(!p.parent)throw"AdhocDataProcessor.getNodeListForDimensionLevelsMeasure Unexpected missing node.parent in axis "+e;var b=p.parent;if(t&&p.parent.level==r.measureLevelNumber&&r.measureLevelNumber>1){if(!p.parent.parent)throw"AdhocDataProcessor.getNodeListForDimensionLevelsMeasure Unexpected missing node.parent.parent in axis "+e;b=p.parent.parent}b.level>u&&b.isAll===!0&&(x=!1)}x&&(p.level===m?N.push(p):r.fn.chaseAllNodesToLeafToList(p.parent,p,m,N))}l=N,n.debug&&(console.log("AdhocDataProcessor.getNodeListForDimensionLevelsMeasure: 3w948h  non-LeafLevel qualified children    X"),console.log(l))}}return l},getNodeListForActualLevel:function(e,a,r,t){for(var o=n,s=0;s<a.length;s++){var l=a[s];l.level==r?t.push(l):l.children&&o.fn.getNodeListForActualLevel(e,l.children,r,t)}},chaseAllNodesToLeafToList:function(e,a,r,t){var o=n;if(a.level<r&&"children"in a&&a.children.length>0)for(var s=0;s<a.children.length;s++){var l=a.children[s],i=!1;if(l.isAll===!1?l.level==o.measureLevelNumber&&(i=!0):i=!0,i){var u=o.fn.chaseAllNodesToLeafToList(e,l,r,t);u.level===r&&t.push(u)}}return a},recurseLeafArrayFromSimpleNode:function(e,a){var r=n;if(e.children.length>0)for(var t=e.children,o=0;o<t.length;o++)r.fn.recurseLeafArrayFromSimpleNode(t[o],a);else a.push(e)},getDataFromRowColumn:function(e,a){if(!e)throw"dataprocessor.getDataFromRowColumn   NULL row object !";if(e.axisCoordinate<0)throw"dataprocessor.getDataFromRowColumn   row Coordinate < 0 !";if(!a)throw"dataprocessor.getDataFromRowColumn   NULL column object !";if(a.axisCoordinate<0)throw"dataprocessor.getDataFromRowColumn   column Coordinate < 0 !";var r=n.data[e.axisCoordinate][a.axisCoordinate];return"string"==typeof r&&(r=""===r?null:parseFloat(r)),r},getLabelNameArray:function(e,a){var r=n,t=[];if(null===a)return t;var o=a;if(r.metadata.isOLAP){var s=(a.level,r.dimensionLevels[e]),l=0;if(s)for(var i=0;i<s.length;i++)if(l=i,o.level>=s[i].startLevel&&o.level<=s[i].endLevel){for(;o.parent;){if(!o.isAll){t.push(o.label);break}if(!o.parent)break;if(o=o.parent,o.level<s[i].startLevel)break}break}for(var i=l-1;i>=0;i--){var u=s[i].startLevel,d=s[i].endLevel;for(o=a;o.parent;)if(o=o.parent,o.level<=d&&o.level>=u&&o.level>0&&!o.isAll){t.push(o.label);break}}}else{for(;null!=o.parent;)o.isAll!==!0&&t.push(o.label),o=o.parent;o.level>0&&t.push(o.label)}return t.length<=0&&t.push(this.getMessage("totalsLabelForChart")),t},isOLAP:function(){var e=n;return e.metadata.isOLAP},isMeasuresLastOnAxis:function(e){var a=n;if(e!==a.measureAxis)return!1;if(a.fn.isOLAP()){var r=a.dimensionMappings[e];if(r.length<=0)return!1;var t=r[r.length-1],o=t[0];return"Measures"===o.dimension?!0:!1}var s=a.metadata.axes[e];return"Measures"===s[s.length-1].label?!0:!1},doPathsMatch:function(e,a){for(;e.parent;){if(0===e.parent.level)return 0===a.parent.level?!0:!1;if(!a.parent)return!1;if(e=e.parent,a=a.parent,e.level!==a.level)return!1;if(e.label!==a.label)return!1}return a.parent?!1:!0},getLevelsWithoutMeasures:function(n){return e.chain(n).filter(function(e){return"Measures"!=e.dimension}).map(function(e){return e.name=a.unescape(e.name),e.label=a.unescape(e.label),e}).value()},getLevelIndex:function(e,a){for(var n=0;n<e.length;n++)if(e[n].name===a.name)return n;throw"Specified level was not found."},levelsToLevelNumbers:function(e,a){var r=n.fn,t=[];if(r.isOLAP()){var o=r.getOLAPDimensionInfo();t=r._getOlapLevelNumbers(e,o[a])}else t=r._getNonOlapDataProcessorLevelNumber(e,n.metadata.axes[a]);return t},_getOlapLevelNumbers:function(a,r){var t=n.fn;return e.map(a,function(a){var n=e.find(r,function(e){return e.dimension===a.dimension});return{level:t._getOlapDataProcessorLevelNumber(a,n)}})},_getOlapDataProcessorLevelNumber:function(e,a){for(var n=0;n<a.levels.length;n++)if(a.levels[n].levelName===e.name)return a.levels[n].levelNumber;throw"No olap info found for specified level = "+e.name},_getNonOlapDataProcessorLevelNumber:function(e,a){var r=n.fn;if(0===e.length)return 0;var t=r.getLevelsWithoutMeasures(a);return r.getLevelIndex(t,e[0])+1}}};return{messages:{},getMessage:n.fn.getMessage,load:n.fn.load,levelsToLevelNumbers:n.fn.levelsToLevelNumbers,getLevelIndex:n.fn.getLevelIndex,getLevelsWithoutMeasures:n.fn.getLevelsWithoutMeasures,getOLAPDimensionInfo:n.fn.getOLAPDimensionInfo,getDataFromRowColumn:n.fn.getDataFromRowColumn,getLabelNameArray:n.fn.getLabelNameArray,isMeasuresLastOnAxis:n.fn.isMeasuresLastOnAxis,getDataStyle:n.fn.getDataStyle,getNodeListForDimLevelRadio:n.fn.getNodeListForDimLevelRadio,getNodeListForSliderLevel:n.fn.getNodeListForSliderLevel,getColumnSliderLevelCount:function(){return n.colSliderLevelCount},getRowSliderLevelCount:function(){return n.rowSliderLevelCount},getMeasureLevelNumber:n.fn.getMeasureLevelNumber}},this);