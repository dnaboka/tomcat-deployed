define(["require","exports","module","jquery","underscore","logger","bundle!AdHocBundle","backbone","common/bi/error/enum/biComponentErrorCodes","adhoc/api/model/AdHocModel","adhoc/api/model/query/AdHocQueryModel","adhoc/api/model/validators/Validation","adhoc/api/chart/ChartView","adhoc/api/table/TableView","adhoc/api/crosstab/CrosstabView","components/overlay/Overlay","components/message/Message","components/message/enums/messageTypes","adhoc/api/visualChooser/VisualChooserDialog","text!./template/generalLayout.htm"],function(e,t,i){function o(e,t){return t&&n.each(t,function(t,i){e=e.replace("{"+i+"}",t)}),e}function s(e){var t,i;return e||(e=this.options.canvas&&this.options.canvas.type),t=e?f[e.toLowerCase()]||c:this.model.component.components.reduce(function(e,t){return e||t.componentType&&f[t.componentType]},!1),i=new t({dataModel:this.model,options:this.options})}var a=e("jquery"),n=e("underscore"),r=(e("logger").register(i),e("bundle!AdHocBundle")),h=e("backbone"),l=(e("common/bi/error/enum/biComponentErrorCodes"),e("adhoc/api/model/AdHocModel")),d=(e("adhoc/api/model/query/AdHocQueryModel"),e("adhoc/api/model/validators/Validation")),c=e("adhoc/api/chart/ChartView"),u=e("adhoc/api/table/TableView"),p=e("adhoc/api/crosstab/CrosstabView"),m=e("components/overlay/Overlay"),v=e("components/message/Message"),g=e("components/message/enums/messageTypes"),y=e("adhoc/api/visualChooser/VisualChooserDialog"),C=e("text!./template/generalLayout.htm"),T=400,f={table:u,chart:c,crosstab:p},_=h.View.extend({el:function(){return a(C)[0]},events:{"click .jr-jAdhocLauncher":"_onVisualizationSwitcherClick","mouseenter .jr-jAdhocLauncherButton":"_onMouseEnterVisualizationButton","mouseleave .jr-jAdhocLauncherButton":"_onMouseLeaveVisualizationButton"},initialize:function(e,t){n.bindAll(this,"resize"),this.instanceData=e,this.options=e.properties,this.stateModel=t.stateModel,this.container=this.options.container,this.$container=a(this.container),this.dataComponents={},this.$container.empty(),this.$el.height(this.$container.height()?"100%":T),this.$el.children(".jr-jAdhocVizualization").height(this.$container.height()?"100%":T),this.$container[0]&&this.$container.append(this.el),this.model=new l({uri:this.options.resource},{server:this.options.server}),this._initalizeMainOverlay(),this._initializeMessage(),this.optionsValidators=d(this.model),this.$canvas=this.$(".jr-jAdhocVisualizationContainer"),this.$title=this.$(".jr-jAdhocVisualizationTitle"),this.$titleText=this.$(".jr-jAdhocVisualizationTitleText"),this.$visualizationLauncher=this.$(".jr-jAdhocLauncher"),this.$visualizationLauncherIcon=this.$(".jr-jAdhocLauncherIcon"),this.$el.css({position:"relative"}),this.listenTo(this.model.dataSet,"change:dataset",this._updateDisabledVisualizationTypes,this),this.listenTo(this.model.dataSet,"error:dataset",this._showError,this),this.listenTo(this.model,"data:available",function(e,t){this.dataComponents[e]=t,this.instanceData.data=n.extend(this.instanceData.data,t.toDataComponent())},this),this.listenTo(this.model,"component:error",this._showError,this)},visualChooserDialog:function(){return this._visualChooserDialog||(this._visualChooserDialog=new y,this._visualChooserDialog.visualChooserView.on("change:visualizationType",this._onVisalizationTypeChange,this)),this._visualChooserDialog},_initalizeMainOverlay:function(){this.loadingOverlay=new m({el:this.$(".jr-jOverlay")}),this.listenTo(this.stateModel,"change:loadingOverlay",function(){this.stateModel.get("loadingOverlay")?this.loadingOverlay.show():this.loadingOverlay.hide()},this),this.listenTo(this.model,"component:busy",function(e){e?this.loadingOverlay.show(200):this.loadingOverlay.hide()}),this.stateModel.trigger("change:loadingOverlay")},_initializeMessage:function(){this.message=new v({title:null,text:null,type:g.Type.Error,visible:!1}),this.$(".jr-jAdhocMessage").append(this.message.el)},_onMouseEnterVisualizationButton:function(e){this.$(e.currentTarget).addClass("jr-isHovered")},_onMouseLeaveVisualizationButton:function(e){this.$(e.currentTarget).removeClass("jr-isHovered")},_initComponentListeners:function(){var e=this.model.component;this.listenTo(e,"change:showTitle",this._updateTitleVisibility,this),this.listenTo(e,"change:title",this._updateTitleText,this),this.listenTo(e,"change:visualizationType",this._onVisualizationTypeChanged,this)},_onVisualizationSwitcherClick:function(){this.visualChooserDialog().open()},_onVisalizationTypeChange:function(e){this.stateModel.set({loadingOverlay:!0}),this._hideError(),this._manageComponentType(e),this.component.render(this.$canvas).always(n.bind(this.stateModel.set,this.stateModel,{loadingOverlay:!1}))},_updateTitleVisibility:function(){this.model.component.get("showTitle")?(this.$title.removeClass("jr-isHidden"),this.$visualizationLauncher.removeClass("jr-isMinimized"),this.$visualizationLauncherIcon.removeClass("jr-meatball"),this.$visualizationLauncherIcon.addClass("jr-chartColumn")):(this.$title.addClass("jr-isHidden"),this.$visualizationLauncher.addClass("jr-isMinimized"),this.$visualizationLauncherIcon.addClass("jr-meatball"),this.$visualizationLauncherIcon.removeClass("jr-chartColumn")),this._updateCanvasHeight()},_updateTitleText:function(){this.$titleText.text(this.model.component.has("title")?this.model.component.get("title"):""),this._updateCanvasHeight()},_updateCanvasHeight:function(){var e=(this.$container.height()||T)-parseFloat(this.$canvas.css("marginBottom"));this.model.component&&this.model.component.get("showTitle")&&(e-=this.$title.height()+parseFloat(this.$title.css("marginTop"))+parseFloat(this.$title.css("marginBottom"))),this.$canvas.height(e)},_applyProperties:function(){this.visualChooserDialog().visualChooserView.setSelectedType(this.model.component.get("visualizationType")),this._updateDisabledVisualizationTypes(),this.options.hasOwnProperty("showTitle")&&this.model.component.set("showTitle",this.options.showTitle)},_onVisualizationTypeChanged:function(){this.visualChooserDialog().visualChooserView.setSelectedType(this.model.component.get("visualizationType"))},_updateDisabledVisualizationTypes:function(){this.visualChooserDialog().visualChooserView.setDisabledTypes(this.model.dataSet.query.getDisabledTypesList())},_showError:function(e){var t=e&&e.errorCode&&r["adhoc.error."+e.errorCode]?o(r["adhoc.error."+e.errorCode],e.parameters):r["adhoc.error.unexpected.error"];this.$(".jr-jAdhocVizualization").addClass("jr-isHidden"),this.$visualizationLauncher.addClass("jr-isHidden"),this.message.model.set({text:t,visible:!0}),this.stateModel.set({loadingOverlay:!1})},_hideError:function(){this.$(".jr-jAdhocVizualization").removeClass("jr-isHidden"),this.$visualizationLauncher.removeClass("jr-isHidden"),this.message.model.set({visible:!1})},_fetchModels:function(e,t){var i=this,o=a.Deferred(),s=n.bind(o.resolve,o),r=n.bind(o.reject,o);return t.metadata().fail(function(e){i._showError(e),r.apply(this,arguments)}).done(function(){var o=i.optionsValidators.validate(e);o?(i.component||i._showError(o),r(o)):(e.params&&t.dataSet.query.parameters.set(e.params),s())}),o.promise()},_manageComponentType:function(e){var t;this.component?this.component.isAcceptable(e)?this.model.component.set({visualizationType:e}):(t=s.call(this,e),this.component.remove(),this.component=t,this.model.component.set({visualizationType:e})):(this.component=s.call(this),this.model.component.set({visualizationType:e}))},_checkAutoresize:function(){var e=this.stateModel.get("autoresize")?"on":"off";a(window)[e]("resize",this.resize)},run:function(e){var t=this,i=e||new a.Deferred;return i.fail(function(){t.stateModel.set("loadingOverlay",!1)}),this.stateModel.set("loadingOverlay",!0),this._hideError(),this._checkAutoresize(),this._fetchModels(this.options,this.model).done(function(){t.render().done(function(){i.resolve({metadata:t.instanceData.data.metadata,_dataset_internal_:t.model.dataSet.toDataComponent()._dataset_internal_})}).fail(n.bind(i.reject,i))}).fail(n.bind(i.reject,i)),i.promise()},render:function(e){var t=this;return e||(e=new a.Deferred),this._initComponentListeners(),this._updateTitleText(),this._updateTitleVisibility(),this.model.metadata().done(function(){t.options.container?(t.model.bundles.bundle().fail(n.bind(e.reject,e)),t.options.canvas&&t.options.canvas.type&&t._manageComponentType(t.options.canvas.type),t.component||(t.component=s.call(t)),t.component.render(t.$canvas).done(n.bind(e.resolve,e)).fail(n.bind(e.reject,e)),t._applyProperties()):(t.component&&(t.component.remove(),delete t.component),t.model.dataSet.data().done(n.bind(e.resolve,e)).fail(n.bind(e.reject,e)))}),e.promise()},destroy:function(e){this.remove(),this.model.dataSet.isNew()?e.resolve():this.model.dataSet.destroy({success:n.bind(e.resolve,e),error:n.bind(e.reject,e)})},refresh:function(e){var t=e||new a.Deferred;return this.component?(this._hideError(),this.component.refresh(t)):this.run(t),t.promise()},resize:function(){this._updateCanvasHeight(),this.component&&this.component.resize()},remove:function(){return this.loadingOverlay.remove(),this.component||this.component.remove(),h.View.prototype.remove.apply(this,arguments)}});return _});