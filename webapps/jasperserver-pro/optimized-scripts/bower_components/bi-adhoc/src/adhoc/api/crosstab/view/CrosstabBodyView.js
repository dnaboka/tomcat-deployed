define(["require","backbone","underscore","jquery","adhoc/api/model/factory/formattersFactory","adhoc/api/model/factory/cellTypesFactory","text!../template/crosstabBodyTemplate.htm"],function(t){function e(t,e,a,o,l){var s=-1;if(t.resultPixels){var s=e,n=o,i=n+l,h=r.reduce(t.resultPixels,function(t,e){return t+e},0),c=t.top,u=c+h;if(l>h)return-1;for(;i>u;)c=u,u+=h,s+=a;for(;c>n;)c=Math.max(0,c-h),s=Math.max(0,s-a),u=c+h;if(i>u)for(var g=0;g<t.resultPixels.length&&i>u;g++)u+=t.resultPixels[g],c+=t.resultPixels[g],s++;n>=c&&u>=i?s===e&&(s=-1):s=-1}return s}var a=t("backbone"),r=t("underscore"),o=(t("jquery"),t("adhoc/api/model/factory/formattersFactory")),l=t("adhoc/api/model/factory/cellTypesFactory"),s=t("text!../template/crosstabBodyTemplate.htm"),n=r.template(s),i=a.View.extend({events:{scroll:"onScroll"},initialize:function(t){this._initElements(),this.options=t,this.$container=this.$("table"),this.hyperlinkEnabledFor=[],this.on("scroll",this.scrollTo,this)},render:function(){return this.data&&(this.hasData()?this.$emptyMessage.hide():this.$emptyMessage.show(),this.$container.html(n({data:this.data,cellTypesFactory:l,hyperlinks:this.hyperlinks}))),this},acquireData:function(t){this.data=[],this.columnTotalsInx={},this.rowTotalsInx={};var e=this.model.dataSet.query.groupByJSON();e.columns.items.length&&r.each(t.columns.range,function(t,e){r.each(t,function(t){t.isTotal&&(this.columnTotalsInx[e]=!0)},this)},this),e.rows.items.length&&r.each(t.rows.range,function(t,e){r.each(t,function(t){t.isTotal&&(this.rowTotalsInx[e]=!0)},this)},this);var a,l,s,n,i=this.model.component.getCrosstabComponent(),h=i.getRowsComponent().hasMeasures(),c=i.getMeasuresComponent().components,u=(c.last().get("reference"),this.model.dataSet.query[h?"rows":"cols"].axis),g=[],d=h?t.rows.range:t.columns.range,f=c.reduce(function(t,e){return t[e.get("reference")]=e.level()&&e.level().get("aggregationType"),t},{}),m=c.reduce(function(t,e){return t[e.get("reference")]={format:e.get("format"),categorizer:e.level()&&e.level().get("categorizer"),ignoreTimezone:!0},t},{}),p=u.reduce(function(t,e){return"measure"===e.get("kind")&&(t[e.get("id")]=o(e.get("aggregationType"))),t},{});if(d.length){for(var y=0;y<d[0].length&&!d[0][y].isMeasure;y++);for(var v=0;v<d.length;v++)g.push(d[v][y].value);for(var w=0;w<t.data.length;w++){a=[],a.totalRow=this.rowTotalsInx[w],t.data[w].rowMemberLast&&!a.totalRow&&(a.rowMemberLast=!0);for(var T=0;T<t.data[w].length;T++)n={label:"",totalCell:a.totalRow||this.columnTotalsInx[T]},s=t.data[w][T],s.label&&(l=h?w:T,n.aggregationType=f[g[l]],n.label=p[g[l]].format(s.label,m[g[l]].format,m[g[l]])),n.totalCell&&(n.isTotal=!0),a.push(n);t.rows.range[w].rowMemberLast&&void 0===a.totalRow&&(a.lastRowValue=!0),this.data.push(a),a.totalRow===!0&&this.data.length>1&&void 0===this.data[this.data.length-2].totalRow&&(this.data[this.data.length-2].lastRowValue=!0)}for(var b=0;b<t.columns.range.length;b++)for(var x=0;x<t.columns.range[b].length;x++)x-1>-1&&(t.columns.range[b][x-1].isTotal||t.columns.range[b][x-1].istotalCol)&&(t.columns.range[b][x].istotalCol=!0)}},onScroll:function(t){var e={left:this.$el.scrollLeft(),top:this.$el.scrollTop()};this.trigger("scroll:x",e.left),this.trigger("scroll:y",e.top),this.trigger("scroll",e)},scrollToLeft:function(t){this.$el.scrollLeft(t)},scrollToTop:function(t){this.$el.scrollTop(t)},enableHyperlinks:function(t){if(this.hyperlinks=!0,t.events){var e=this;for(var a in t.events)this.hyperlinkEnabledFor.push(a),this.$el.on(a,".jr-jHyperLink",function(t){e.trigger("hyperlink",{context:this,event:t,row:+t.currentTarget.getAttribute("data-row-index"),column:+t.currentTarget.getAttribute("data-column-index")})})}},disableHyperlinks:function(){this.hyperlinks=!0;for(var t=0;t<this.hyperlinkEnabledFor;t++)this.$el.off(this.hyperlinkEnabledFor[t],".jr-jHyperLink")},validateViewportHeight:function(t,a,r){return e(t,a,r,this.$el.scrollTop(),this.$el.height())},validateViewportWidth:function(t,a,r){return e(t,a,r,this.$el.scrollLeft(),this.$el.width())},_initElements:function(){this.$emptyMessage=this.$(".jr-jEmptyMessage"),this.$emptyMessage.hide()},hasData:function(){var t=!0,e=function(t){return"measure"===t.get("kind")},a=this.model.dataSet.query.rows.axis.filter(e).length,o=this.model.dataSet.query.cols.axis.filter(e).length;return(!this.data.length||this.data.length===a&&1===this.data[0].length||1===this.data.length&&this.data[0].length===o)&&(t=!1,r.each(this.data,function(e){r.each(e,function(e){r.isUndefined(e.label)||""===e.label||(t=!0)})})),t}});return i});