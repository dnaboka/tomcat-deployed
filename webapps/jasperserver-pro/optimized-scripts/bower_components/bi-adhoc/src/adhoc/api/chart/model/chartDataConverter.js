define(["require","exports","module","underscore","logger","jquery","jrs.configs","moment","../../model/factory/formattersFactory","../HyperlinkChartHelper","bundle!AdHocBundle"],function(e,t,a){"use strict";var r=e("underscore"),n=(e("logger").register(a),e("jquery")),o=e("jrs.configs"),l=e("moment"),s=e("../../model/factory/formattersFactory"),i=(e("../HyperlinkChartHelper"),e("bundle!AdHocBundle"));return function(e,t,a,c){function u(e){return!e||"-"!==e[e.length-5]&&"+"!==e[e.length-5]?e:e.slice(0,e.length-2).concat(":",e.slice(-2))}function d(e,t){var a=t.components.findComponentDeep("axis").reverse(),n=t.components.findComponentDeep("measures");r.each(a,function(t,a){var r=t.components.map(function(t){var r;return"Measures"===t.get("reference")?(e.queryData.metadata.measureAxis=a,r=i["adhoc.node.measures.node"]):r=t.label(!0),{label:r,dimension:t.get("dimension"),name:t.get("reference")}});e.queryData.metadata.axes.push(r)}),r.each(n,function(t){e.queryData.metadata.measures=t.components.map(function(e){return e.label(!0)})})}function m(e,t){for(var a=t.dataset.axes.reverse(),r=0;r<a.length;r++)e.queryData.treeNodes.push({label:i["adhoc.node.total.node"],level:0,axisCoordinate:g(a[r].axisNode),children:p(a,a[r].axisNode,1,r),isAll:a[r].axisNode.all})}function p(e,t,a,n){return r.map(t.children,function(t){var r=h(e,n,a-1,t),o=v(e,n,a-1,t);return r!==o&&c.saveInitialValue(r,o),{label:r,rawLabel:o,level:a,type:f(e,n,a-1),axisCoordinate:g(t),children:p(e,t,a+1,n),isAll:t.all}})}function f(e,t,a){var r=e[t].levels[a];return r&&r.hasOwnProperty("level")?r.level.type:void 0}function g(e){return e.hasOwnProperty("dataIdx")?e.dataIdx:-1}function h(e,t,r,n){if(!n.hasOwnProperty("memberIdx"))return i["adhoc.node.total.node"];var o=e[t].levels[r];return o.hasOwnProperty("level")?y(o.level.referenceObject.name,o.level.type,o.level.members[n.memberIdx]):o.hasOwnProperty("aggregation")?a.component.getMeasureLabelByReference(o.aggregation.fields[n.memberIdx].reference):""}function v(e,t,r,n){if(!n.hasOwnProperty("memberIdx"))return i["adhoc.node.total.node"];var o=e[t].levels[r];return o.hasOwnProperty("level")?o.level.members[n.memberIdx]:o.hasOwnProperty("aggregation")?a.component.getMeasureLabelByReference(o.aggregation.fields[n.memberIdx].reference):""}function y(e,t,a){var n=r.find(C,function(t){return t.get("reference")===e}),o=n.level(),l={format:n.get("format"),categorizer:o&&o.get("categorizer"),ignoreTimezone:!0};return"other_node"===a&&(a=i["adhoc.node.other.node"]),s(t).format(a,l.format,l)}function x(e,t,a){var n;t.groupBy.columns.hasOwnProperty("expansions")&&r.each(t.groupBy.columns.expansions,function(t){t.level&&t.level.expanded&&!t.level.aggregation&&(n=S(a,t.level.fieldRef),e.chartState.columnsSelectedLevels=[w(n)])}),"dual_measure_tree_map"===e.chartState.chartType?(n=a.dataSet.query.rows.axis.first(),e.chartState.rowsSelectedLevels=[w(n)]):"dual_level_pie"===e.chartState.chartType?(r.each(t.groupBy.rows.expansions,function(r,o){if(r.level&&r.level.expanded&&!r.level.aggregation){var l=t.groupBy.rows.expansions[o+1];l&&l.level&&!l.level.aggregation&&(n=S(a,l.level.fieldRef),e.chartState.rowsSelectedLevels=[w(n)])}}),e.chartState.rowsSelectedLevels.length||(n=a.dataSet.query.rows.axis.find(function(e){return e.isLevel()}),e.chartState.rowsSelectedLevels=[w(n)])):t.groupBy.rows.hasOwnProperty("expansions")&&r.each(t.groupBy.rows.expansions,function(t){t.level&&t.level.expanded&&!t.level.aggregation&&(n=S(a,t.level.fieldRef),e.chartState.rowsSelectedLevels=[w(n)])})}function w(e){return{label:e.label(!0),dimension:e.get("dimension"),name:e.get("id")||e.get("dimension")}}function S(e,t){var a=function(e){return t===e.get("id")};return e.dataSet.query.cols.axis.find(a)||e.dataSet.query.rows.axis.find(a)}function b(e){return r.map(e,function(e){return r.map(e,function(e){return n.isNumeric(e)?parseFloat(e):null})})}function L(){return r.map(["01","02","03","04","05","06","07","08","09","10","11","12"],function(e){return r.capitalize(l("1970-".concat(e,"-01")).locale(o.userLocale).format("MMMM")).slice(0,3)})}var D=a.component.getChartComponent(),N=D.components.findComponentDeep("level"),q=D.components.findComponentDeep("measure"),C=N.concat(q),z=r.extend(D.getProperties(),{chartType:D.getLegacyAdhocChartType(),columnsSelectedLevels:[],rowsSelectedLevels:[],decimalPoint:".",shortMonths:L(),showXAxisLabels:!0,showYAxisLabels:!0,thousandSeparator:"None"});t.dataset.data=b(t.dataset.data),delete z.type,delete z.title;var _={title:e.label,chartState:z,queryData:{metadata:{axes:[],measureAxis:0,measures:[],canRender:!0,isFullDataQuery:!1,isOLAP:!1},treeNodes:[],data:r.zip.apply(null,t.dataset.data)},viewType:"ichart"};if(d(_,D),m(_,t),x(_,e.query.multiAxes,a),D.isTimeSeries()){if(_.chartState.timeSeriesCategorizerName=e.query.multiAxes.groupBy.rows.items[0].level.categorizer,!_.chartState.rowsSelectedLevels.length){var A=S(a,e.query.multiAxes.groupBy.rows.expansions[0].level.fieldRef);_.chartState.rowsSelectedLevels.push({label:A.label(!0),dimension:A.get("dimension"),name:A.get("id")})}r.each(_.queryData.data,function(e,t,a){a[t]=r.map(e,function(e){var a,n,s,i=_.queryData.treeNodes[0].children[t],d=u(i.rawLabel);return i&&("day"===_.chartState.timeSeriesCategorizerName&&Date.parse(d)&&(n=new Date(d),a=0),r.contains(["hour_by_day","minute_by_day","second_by_day","millisecond_by_day"],_.chartState.timeSeriesCategorizerName)&&!isNaN(Date.parse(d))&&(n=new Date(d),a=parseInt(l(d).tz(o.userTimezone).format("Z"))),r.contains(["hour","minute","second","millisecond"],_.chartState.timeSeriesCategorizerName)&&!isNaN(Date.parse("1970-01-01T"+d))&&(n=new Date(Date.parse("1970-01-01T"+d)),a=parseInt(l("1970-01-01T"+d).tz(o.userTimezone).format("Z"))),s=n?n.getTime()+60*a*60*1e3:NaN,c.saveInitialValue(s,d)),{timestamp:s,value:parseFloat(e)}})})}return _}});