define(["require","exports","module","backbone","underscore","./CrosstabAuxModelNodeBuilder","./visitors/MultiAxisModelRangeVisitor","./visitors/MultiAxisModelIndexVisitor","logger"],function(t,e,o){var s=t("backbone"),i=t("underscore"),a=t("./CrosstabAuxModelNodeBuilder"),r=t("./visitors/MultiAxisModelRangeVisitor"),n=t("./visitors/MultiAxisModelIndexVisitor"),h=t("logger").register(o),d=s.Model.extend({initialize:function(t,e){i.bindAll(this,"_checkAvailability","_onExpansionsChange","_onError","_onSuccess"),this.EMPTY_CELL={label:""},this.adHocModel=e.dataModel,this._clear(),this.listenTo(this.adHocModel.dataSet.query.cols.expansions,"expansions:change",this._onExpansionsChange),this.listenTo(this.adHocModel.dataSet.query.rows.expansions,"expansions:change",this._onExpansionsChange),this.on("change",this._checkAvailability)},dispose:function(){this.stopListening()},reset:function(){this._clear(),this.set({colsOffset:0,colsPageSize:50,rowsOffset:0,rowsPageSize:50},{silent:!0}),this._checkAvailability()},keepAxis:function(t){"rows"===t?(this.colIndex=new n,this.colsAuxModel=null):(this.rowIndex=new n,this.rowsAuxModel=null),this.dataModel=[]},_clear:function(){this.watchDog=0,this.colsAuxModel=null,this.rowsAuxModel=null,this.rowIndex=new n,this.colIndex=new n,this.dataModel=[]},_checkAvailability:function(){var t=this._readHeader(1),e=this._readHeader(0),o=!1;if(t.range?this.trigger("data:rows",t.range):(o=this._toParameters(),o.offset[1]=t.missingIndex),e.range?this.trigger("data:columns",e.range):(o=o||this._toParameters(),o.offset[0]=e.missingIndex),o){if(t.loaded){for(;o.offset[1]>=t.loaded;)o.offset[1]-=o.pageSize[1];o.offset[1]=Math.max(o.offset[1],0)}if(e.loaded){for(;o.offset[0]>=e.loaded;)o.offset[0]-=o.pageSize[0];o.offset[0]=Math.max(o.offset[0],0)}}else{var s=this._readData(t,e);s.data?(this.watchDog=0,this.trigger("data:data",{data:s.data,columns:e,rows:t}),this.trigger("data:loading",!1)):o=this._toParameters(s)}o&&(this.watchDog++,this.adHocModel.dataSet.set("params",o),this.trigger("data:loading",!0),this.adHocModel.dataSet.data().fail(this._onError).done(this._onSuccess))},_toParameters:function(t){var e,o,s={offset:[this.get("colsOffset"),this.get("rowsOffset")],pageSize:[Math.max(this.get("colsPageSize"),100),Math.max(this.get("rowsPageSize"),100)]};return t&&(e=t.bottom-t.top+1,o=t.right-t.left+1,e!==this.get("rowsPageSize")&&o===this.get("colsPageSize")?0===t.top?s.offset[1]=Math.max(0,this.get("rowsOffset")-s.pageSize[1]+e):t.bottom+1===this.get("rowsPageSize")?s.offset[1]=this.get("rowsOffset")+this.get("rowsPageSize")-e:(s.offset[1]+=t.top,s.pageSize[1]=e):e===this.get("rowsPageSize")&&o!==this.get("colsPageSize")?0===t.left?s.offset[0]=Math.max(0,this.get("colsOffset")-s.pageSize[1]+o):t.right+1===this.get("colsPageSize")?s.offset[0]=this.get("colsOffset")+this.get("colsPageSize")-o:(s.offset[0]+=t.left,s.pageSize[0]=o):e!==this.get("rowsPageSize")&&o!==this.get("colsPageSize")&&(s.offset[0]+=t.left,s.pageSize[0]=o,s.offset[1]+=t.top,s.pageSize[1]=e)),s},_readHeader:function(t){var e=t?this.rowsAuxModel:this.colsAuxModel,o=t?this.get("rowsOffset"):this.get("colsOffset"),s=t?this.get("rowsPageSize"):this.get("colsPageSize"),i=new r(o,o+s);return e&&e.visit(i),i.getResult()},_readData:function(t,e){var o={top:-1,bottom:-1,left:-1,right:-1};if(t.range.length&&e.range.length){for(var s,i,a,r=[],n=t.range,h=t.range[0].length-1,d=e.range,l=e.range[0].length-1,g=0;g<t.range.length;g++)if(s=[],a=this.dataModel[n[g][h].index]){for(var f=0;f<e.range.length;f++)i=d[f][l].index,a[i]?s.push(a[i]):(o.left=o.left<0?f:Math.min(o.left,f),o.right=Math.max(o.right,f),o.top=o.top<0?g:Math.min(o.top,g),o.bottom=Math.max(o.bottom,g));r.push(s)}else o.left=0,o.right=d.length,o.top=o.top<0?g:Math.min(o.top,g),o.bottom=Math.max(o.bottom,g);-1==o.top&&-1==o.bottom&&-1==o.left&&-1==o.right&&(o.data=r)}else o.data=[];return o},_writeData:function(){var t,e,o,s,i,a,r=this.adHocModel.dataSet.get("dataset").data,n=this.adHocModel.dataSet.get("params");this.colsAuxModel.visit(this.colIndex.range(n.offset[0],n.offset[0]+n.pageSize[0])),this.rowsAuxModel.visit(this.rowIndex.range(n.offset[1],n.offset[1]+n.pageSize[1])),t=this.rowIndex.getResult(),e=this.colIndex.getResult();for(var h=0;h<t.length;h++){o=t[h];for(var d=0;d<e.length;d++)s=e[d],i=this.dataModel[o],i?i=i[s]:this.dataModel[o]=[],i||(a=r[d][h],""===a?this.dataModel[o][s]=this.EMPTY_CELL:this.dataModel[o][s]={label:a})}},_onExpansionsChange:function(t,e){var o="rows"===e.id?this.rowsAuxModel:this.colsAuxModel;o&&(o.applyExpansions(t,e),this._ignoreExpansionsChange||this._checkAvailability())},_onSuccess:function(){var t,e,o,s=this.adHocModel.dataSet.query.groupByJSON();try{if(t=a.buildFromDataSet(this.adHocModel.dataSet,this.adHocModel.dataSet.query.cols),this.colsAuxModel){if(!this.colsAuxModel.addTree(t.rootNode))throw new Error("Cannot merge cols")}else this.colsAuxModel=t.rootNode;o=t.requiredExpansions}catch(i){return h.error(i,this.colsAuxModel,t),void this._onError()}try{if(t=a.buildFromDataSet(this.adHocModel.dataSet,this.adHocModel.dataSet.query.rows),this.rowsAuxModel){if(!this.rowsAuxModel.addTree(t.rootNode))throw new Error("Cannot merge rows")}else this.rowsAuxModel=t.rootNode;e=t.requiredExpansions}catch(i){return h.error(i,this.rowsAuxModel,t),void this._onError()}if(this._writeData(),this.watchDog<7){if(o.length||e.length)try{this._ignoreExpansionsChange=!0,this.adHocModel.dataSet.query.cols.expansions.add(o),this.adHocModel.dataSet.query.rows.expansions.add(e),this._ignoreExpansionsChange=!1}catch(i){this._ignoreExpansionsChange=!1,h.error(i,this.rowsAuxModel,o,e),this._onError()}this._checkAvailability()}else h.error("Endless recursion",this.attributes,s),this._onError()},_onError:function(t){this.trigger("data:error",t),this.trigger("data:loading",!1)}});return d});