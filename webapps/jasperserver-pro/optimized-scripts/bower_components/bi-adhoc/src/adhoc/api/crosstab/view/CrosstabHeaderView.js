define(["require","backbone","underscore","jquery","bundle!AdHocBundle","../../model/factory/formattersFactory","text!../template/crosstabRowsTemplate.htm","text!../template/crosstabColumnsTemplate.htm"],function(t){function e(t,e,r,l,d,u){var m=l?o(e,r):a(e,r),f=t.components.findComponentDeep("measure");if(i(m,e,d),s(m,e,f),h(m,e,d),p(m,e,d,r,u),r){var c={isSpacer:!0,label:""},g=[];if(m=n(m),m[0]){for(var v=0,b=m[0].length;b>v;v++)g.push(c);m.push(g)}}return m}function a(t,e){for(var a,o=[],n=!1,l=0;l<t.length;l++){a=[];for(var i=0;i<t[l].length;i++)a.push(r(t[l][i],l,i));o.push(a)}if(t.length)for(var s=0;s<t[0].length-1;s++)for(var h=0;h<t.length;h++)t[h][s].isExpandable&&t[h][s+1].isTotal&&(n===t[h][s]?(o[h][s].isCollapsed=!1,o[h][s].isExpanded=!1):n=t[h][s]);return o}function o(t,e){var a,o=u.map(t,function(){return[]}),n=!1,l=e?"colspan":"rowspan";if(t.length)for(var i=0;i<t[0].length;i++)for(var s=0;s<t.length;s++)t[s][i]===n?(a[l]?a[l]++:a[l]=2,o[s].push(null)):(n=t[s][i],a=r(n,s,i),!e&&t[s][i].isExpandable&&t[s][i].isExpanded&&t[s][i+1]&&!t[s][i+1].childFirst&&(a.label=""),o[s].push(a));return o}function n(t){for(var e=t[0]?t[0].length:0,a=t.length,o=new Array(e),n=0;e>n;n++){o[n]=new Array(a);for(var r=0;a>r;r++)o[n][r]=t[r][n]}return o}function r(t,e,a){return{isExpanded:t.isExpandable&&t.isExpanded,isCollapsed:t.isExpandable&&!t.isExpanded,isMeasure:t.isMeasure,isTotal:t.isTotal||t.istotalCol,label:l(t.label,t),expId:t.isExpandable?e+"-"+a:void 0}}function l(t,e){var a=t;return"other_node"===t?a=f["adhoc.node.other.node"]:e.isTotal&&(a=f["adhoc.node.total.node"]),a}function i(t,e,a){var o,n;if(t.length){for(var r=t[0].length-1;r>0;r--)if(a.components.models[r]&&a.components.models[r].get("includeAll"))for(var l=0;l<t.length;l++)if((e[l][r].isTotal||e[l][r].isMeasure)&&(n=t[l][r])){for(var i=l;i>=0&&!o;i--)o=t[i][r-1];n.isExpanded=o.isExpanded,n.isCollapsed=o.isCollapsed,n.expId=o.expId,o=void 0}for(var s=0;s<e.length;s++)for(var h=0;h<e[s].length;h++)o=t[s][h],o&&o.expId&&!e[s][h].isTotal&&(o.isExpanded=void 0,o.isCollapsed=void 0,o.expId=void 0)}}function s(t,e,a){var o,n;if(e.length)for(var r=0;r<e[0].length;r++)if(e[0][r].isMeasure){o=u.reduce(a,function(t,e){return t[e.get("reference")]=e.label(!0),t},{});for(var l=0;l<e.length;l++)(n=t[l][r])&&(n.label=o[n.label])}}function h(t,e,a){for(var o=a.components.map(function(t){var e=t.level();return e?c(t.level().get("type")):void 0}),n=a.components.map(function(t){return{format:t.get("format"),categorizer:t.level()&&t.level().get("categorizer"),ignoreTimezone:!0}}),r=0;r<t.length;r++)for(var l=0;l<t[r].length;l++)t[r][l]&&o[l]&&!e[r][l].isTotal&&(t[r][l].label=o[l].format(t[r][l].label,n[l].format,n[l]))}function p(t,e,a,o,n){a.components.length||t[0]&&(t[0][0]={label:o?"":f["adhoc.node.rowgroup.node"]});for(var r=0;r<t.length;r++)for(var l=0;l<t[r].length;l++)!t[r].totalRow&&(t[r].totalRow|=e[r][l].isTotal),l+1===t[r].length&&l-1>=0&&e[r][l-1].isTotal&&(t[r][l].isTotal=!0);if(!o){for(var i=-1,r=0;r<t.length;r++){for(var s=!1,l=0;l<t[r].length;l++)if(null!==t[r][l]){if(void 0!==t[r][l].rowspan?s=!0:null,1===t[r].totalRow&&l-1>-1&&null!==t[r][l-1]&&t[r][l-1].isTotal===!0&&(t[r][l].isTotal=!0)&&-1===i&&(i=r)||null===t[r][l-1]&&-1!==i&&t[i][l-1]&&t[i][l-1].isTotal&&r-1>0&&t[r-1][l]&&t[r-1][l].isTotal&&(t[r][l].isTotal=!0),t[r][l].isTotal&&s&&null!==t[r]&&1===t[r].totalRow)for(var h=r+1;h<r+t[r][l].rowspan;h++)for(var p=l+1;p<t[r].length;p++)null!==t[r]&&1===t[r].totalRow&&null!==t[h][p]&&(t[h][p].isTotal=!0);t[r][l].rowspan>0?(t[r+t[r][l].rowspan-1].rowMemberLast=!0,null!==n&&(n.rows.range[r+t[r][l].rowspan-1].rowMemberLast=!0),t[r].rowMember?null:t[r].rowGroup=!0):t[r].rowGroup?null:t[r].rowMember=!0}!s&&r-1>0&&t[r-1].rowMemberLast===!0&&1!==t[r].totalRow&&(t[r].rowMemberLast=!0,null!==n&&(n.rows.range[r].rowMemberLast=!0)),r+1<t.length&&1!==t[r].totalRow&&1===t[r+1].totalRow&&(t[r].rowMemberLast=!0,null!==n&&(n.rows.range[r].rowMemberLast=!0))}for(var r=0;r<t.length;r++){for(var d=0,u=0,l=0;l<t[r].length;l++)null!==t[r][0]&&void 0===t[r][0].rowspan&&l+1===t[r].length&&r+1<t.length&&!t[r].rowGroup&&l>0&&null!==t[r+1][l-1]&&null!==t[r][l-1]&&t[r+1][l-1].label!==t[r][l-1].label&&(null!==n&&(n.rows.range[r].rowMemberLast=!0),t[r].rowMemberLast=!0),null===t[r][l]||t[r][l]&&t[r][l].rowspan>0?d++:u++;if(t[r]&&!t[r].isTotal&&d>=1&&t[r].rowGroup&&u>=2&&(t[r].rowSingleMember=!0,null!==n&&(n.rows.range[r].rowMemberLast=!0)),t[r]&&0===d&&1!==t[r].isTotal&&t[r].length>1&&r+1!==t[r].length&&t[r+1]&&t[r][0].label!==t[r+1][0].label&&(t[r].rowMemberLast=!0,null!==n&&(n.rows.range[r].rowMemberLast=!0)),1===d&&t[r][0]&&t[r][0].rowspan>0&&t[r].length>2)for(var p=r+1;p<=r+t[r][0].rowspan-1;p++){for(var m=0,h=0;h<t[p].length;h++)null===t[p][h]&&m++,t[p][h]&&t[p][h].rowspan>0&&m++;t[p]&&!t[p].rowGroup&&1===m&&(t[p].rowMemberLast=!0,null!==n&&(n.rows.range[p].rowMemberLast=!0))}}}}var d=t("backbone"),u=t("underscore"),m=t("jquery"),f=t("bundle!AdHocBundle"),c=t("../../model/factory/formattersFactory"),g=t("text!../template/crosstabRowsTemplate.htm"),v=t("text!../template/crosstabColumnsTemplate.htm"),b=d.View.extend({events:{"click .jr-isExpanded":"onClick","click .jr-isCollapsed":"onClick"},initialize:function(t){this.orientation=t.orientation||b.Orientation.HORIZONTAL,this.options=t,this.hyperlinkEnabledFor=[],this.orientation===b.Orientation.VERTICAL?(this.templateFn=u.template(g),this.itemsCollection=this.model.dataSet.query.rows.axis):this.orientation===b.Orientation.HORIZONTAL&&(this.templateFn=u.template(v),this.itemsCollection=this.model.dataSet.query.cols.axis),this.items=this.itemsCollection.toQueryMultiaxisAxisItems(),this.$viewport=this.$("table"),this.listenTo(this.model.dataSet.query,"query:componentsDataChange",function(){this.items=this.itemsCollection.toQueryMultiaxisAxisItems()},this)},render:function(){return this.renderData&&this.$viewport.html(this.templateFn({data:this.renderData,hyperlinks:this.hyperlinks})),this},acquireData:function(t){var a=this.model.component.getCrosstabComponent(),o=a.get("mergeCrosstabCells"),n=this.orientation===b.Orientation.HORIZONTAL,r=n?a.getColumnsComponent():a.getRowsComponent();n?(this.data=t.columns,this.renderData=e(this.model.component.getCrosstabComponent(),t.columns.range,n,o,r,null)):(this.data=t.rows,this.renderData=e(this.model.component.getCrosstabComponent(),t.rows.range,n,o,r,t))},onClick:function(t){t.stopPropagation();for(var e=t.target.getAttribute("data-expansion-id").split("-"),a=this.data.range[+e[0]],o={member:{expanded:!1,path:[]}},n=0;n<=+e[1];n++)o.member.path.push(a[n].isTotal?"All":a[n].value||"empty_node");if(o.member.expanded=!a[+e[1]].isExpanded,!o.member.expanded){this._collapseIndex=+e[1],this._collapseItem=a[this._collapseIndex];var r=m(t.target).parents(".jr-mDatatable-cell:first").position();this.orientation===b.Orientation.VERTICAL?this._collapseOffset=this.data.top-this.$el.scrollTop()+r.top:this._collapseOffset=this.data.top-this.$el.scrollLeft()+r.left}this.trigger("expansion",o)},validateViewport:function(t,e,a){var o,n=-1;if(this._collapseItem){for(var r=0;r<t.range.length&&!o;r++)o=t.range[r][this._collapseIndex]===this._collapseItem;o||(n=Math.max(0,e-Math.floor(a/2)))}return n},getRequiredScrollPosition:function(){var t,e=-1;if(this._collapseItem){for(var a=0;a<this.data.range.length&&!t;a++)t=this.data.range[a][this._collapseIndex]===this._collapseItem;if(t){for(var o=0,n=this.data.top;a-1>o;n+=this.data.resultPixels[o],o++);e=Math.max(0,n-this._collapseOffset)}}return e},onDone:function(){this._collapseIndex=void 0,this._collapseItem=void 0,this._collapseOffset=void 0},scrollTo:function(t){var e;return this.orientation===b.Orientation.VERTICAL?e=this.$el.scrollTop:this.orientation===b.Orientation.HORIZONTAL&&(e=this.$el.scrollLeft),e.call(this.$el,t)},enableHyperlinks:function(t){if(this.hyperlinks=!0,t.events){var e=this;for(var a in t.events)this.hyperlinkEnabledFor.push(a),this.$el.on(a,".jr-jHyperLink",function(t){var a=+t.currentTarget.getAttribute("data-local-index"),o=+t.currentTarget.getAttribute("data-local-depth");e.trigger("hyperlink",{context:this,event:t,data:e.getHyperlinkData(a,o)})})}},disableHyperlinks:function(){this.hyperlinks=!1;for(var t=0;t<this.hyperlinkEnabledFor;t++)this.$el.off(this.hyperlinkEnabledFor[t],".jr-jHyperLink")},getHyperlinkData:function(){var t,e=arguments[0],a=this.items,o={};t=arguments.length>1?Math.min(arguments[1],this.items.length-1):this.items.length-1;for(var n=0;t>=n;n++)a[n].aggregations?o.Measures=[this.data.range[e][n].isTotal?"total_node":this.data.range[e][n].label]:o[a[n].level.id||a[n].level.field]=this.data.range[e][n].isTotal?"total_node":this.data.range[e][n].label;return o},getHyperlinks:function(){var t,e,a,o,n,r={all:[],bottomDataRow:[]},l=this.items.length;if(0===l)r.bottomDataRow.push({});else{o=l-1,n=this.$(".jr-jHyperLink");for(var i=0,s=n.length;s>i;i++)e=+n[i].getAttribute("data-local-index"),a=+n[i].getAttribute("data-local-depth"),l>a&&(t=this.getHyperlinkData(e,a),r.all.push({element:n[i],data:t}),a===o&&r.bottomDataRow.push(t))}return r}},{Orientation:{VERTICAL:"rows",HORIZONTAL:"columns"}});return b});