define(["require","underscore","jquery","bundle!AdHocBundle","adhoc/api/model/factory/formattersFactory"],function(e){var t=e("underscore"),a=e("jquery"),o=e("bundle!AdHocBundle"),l=e("adhoc/api/model/factory/formattersFactory"),r=function(){this.totalsData={},this.totals=[],this.lastGroupLabel=null,this.lastRowIndex=0,this.grandTotalRow=null,this.nextRowClassName="jr-mDatatable-rowOdd"};return r.linkTypes={HEADER:"HEADER",DATA:"DATA",GROUP_LABEL:"GROUP_LABEL",GROUP_TOTAL:"GROUP_TOTAL",GRAND_TOTAL:"GRAND_TOTAL"},r.prototype.reset=function(){r.call(this)},r.prototype.convert=function(e,a){this.metadata=e,this.dataset=a;var o=[],l=this.hasGroups(a),r=this.hasTotals(a),s=this.getColumns(),n=r&&this.getTotals(a),i=this.getGroupLevels(),p=this.getTableProperties();return this.showDetails=p.showDetails,this.showTotals=p.showTotals,l||r?t.each(a.dataset.levelDataNodes&&a.dataset.levelDataNodes[0].all.children,function(e){this.processChild({child:e,data:o,label:"",levels:i,levelIdx:0,columns:s,totals:n,hyperlink:{}})},this):t.each(a.dataset.levelDataNodes,function(e){this.processChild({child:e,data:o,label:"",levels:i,levelIdx:0,columns:s,totals:n,hyperlink:{}})},this),r&&a.dataset.levelDataNodes&&!this.grandTotalRow?this.grandTotalRow=this.makeGrandTotalRow(a.dataset.levelDataNodes[0].all.data,n,o.length):this.grandTotalRow||(this.grandTotalRow=[]),this.parseOddEven(this.parseLinks(this.parseRows(o,a),s))},r.prototype.getTotals=function(e){return t.find(e.dataset.levels,function(e){return e.all}).all.aggregations},r.prototype.getColumns=function(){var e=this.metadata.component.findComponentDeep("column"),a=/^_spacer/;return t.map(e,function(e,o){return"_artificial"===e.get("detailFieldReference")||a.test(e.get("detailFieldReference"))?t.extend({},e.attributes,{index:o}):t.extend({},e.attributes,e.level().toJSON(),{index:o})})},r.prototype.getGroups=function(){var e=this.metadata.component.findComponentDeep("group");return t.map(e,function(e,a){return t.extend({},e.attributes,e.level().toJSON(),{index:a})})},r.prototype.makeGrandTotalRow=function(e,a,o){if(!o&&r.totalDataEqualsZero(e))return[];var s=0,n=this.getColumns(),i=this.getGroups(),p=t.pluck(a,"reference"),u=t.pluck(n,"reference"),h="";return t.map(u,function(a,o){return t.contains(p,a)?(h=n[o].showSummary?l(n[o].aggregationType).format(e[s],n[o].aggregationFormat):"",s++,{label:h,colspan:1,rowspan:1,className:"jrs-grid-group",hyperlink:{value:h,id:"f_"+o,linkType:r.linkTypes.GRAND_TOTAL,column:n[o],group:i,row:{relativeIndex:-1,cells:n}}}):{label:"",colspan:1,rowspan:1,className:"jrs-grid-group",hyperlink:{value:"",id:"f_"+o,linkType:r.linkTypes.GRAND_TOTAL,row:{relativeIndex:-1,cells:n},column:n[o],group:i}}})},r.prototype.makeGroupRow=function(e){return[{label:this.getGroupLabelParts(e.hyperlink.groupMembers).join(", "),colspan:e.columns.length,rowspan:1,className:"jr-mDatatable-rowGroup",hyperlink:{value:this.getRawGroupLabel(e.hyperlink.groupMembers),linkType:r.linkTypes.GROUP_LABEL,group:this.getGroupRow(e.hyperlink.groupMembers),row:{}}}]},r.prototype.getRawGroupLabel=function(e){var a=this.getGroupRow(e);return t.map(a,function(e){return e.value}).join(", ")},r.prototype.getGroupLabelParts=function(e){var a=this.getGroupRow(e);return t.map(a,function(e){return l(e.type).format(e.value,e.format)})},r.prototype.makeTotalRow=function(e){var a=0,s=this,n=[e.levels[e.levelIdx].group.members[e.child.group.memberIdx]].concat(e.child.group.data),i=this.getColumns(),p="",u=t.pluck(e.totals,"reference"),h=t.pluck(e.columns,"reference"),c=t.last(this.getGroupLabelParts(e.hyperlink.groupMembers));return t.map(h,function(h,d){return 0===d?(p=n[a++],{label:o["adhoc.node.total.node.table"].replace("{0}",c),colspan:1,rowspan:1,className:"jr-mDatatable-rowGrouptotal",hyperlink:{value:o["adhoc.node.total.node.table"].replace("{0}",p),linkType:r.linkTypes.GROUP_LABEL,group:s.getGroupRow(e.hyperlink.groupMembers),column:i[d],row:{cells:i}}}):t.contains(u,h)?(p=i[d].showSummary?l(i[d].aggregationType).format(n[a],i[d].aggregationFormat):"",a++,{label:p,colspan:1,rowspan:1,className:"jr-mDatatable-rowGrouptotal",hyperlink:{value:p,linkType:r.linkTypes.GROUP_TOTAL,group:s.getGroupRow(e.hyperlink.groupMembers),column:i[d],row:{cells:i}}}):{label:"",colspan:1,rowspan:1,className:"jr-mDatatable-rowGrouptotal",hyperlink:{value:"",linkType:r.linkTypes.GROUP_TOTAL,group:s.getGroupRow(e.hyperlink.groupMembers),column:i[d],row:{cells:i}}}})},r.prototype.makeDetailRow=function(e,a){var o=this,l=this.getDetailRow(e);return t.map(l,function(e){return{label:e.value,colspan:1,rowspan:1,hyperlink:{value:e.initialValue,linkType:r.linkTypes.DATA,group:o.getGroupRow(a.hyperlink.groupMembers),column:e,row:{cells:l}}}})},r.prototype.getPresentation=function(){function e(a,o){return o||(o=[]),t.each(a,function(t){t.group?e(t.group.elements,o):t.element&&o.push(t)}),o}return t.pluck(e(this.metadata.schema.attributes.presentation),"element")},r.prototype.getGroupRow=function(e){var a=this.getGroupLevels(),o=this.getGroups();return t.map(e,function(e,l){return t.extend({},o[l],{value:a[l].group.members[e]})})},r.prototype.getDetailRow=function(e){var a=0,o=/^_spacer/;return t.map(this.getColumns(),function(r,s){var n,i;return"_artificial"===r.reference||o.test(r.reference)?n=i="":(i=e[a++],n=l(r.type).format(i,r.format)),t.extend({},r,{value:n,initialValue:i})})},r.prototype.getGroupLevels=function(){return t.filter(this.dataset.dataset.levels,function(e){return e.group})},r.prototype.hasGroups=function(e){return!!this.getGroupLevels(e).length},r.prototype.hasTotals=function(e){var a=t.find(e.dataset.levels,function(e){return e.all});return!(!a||!a.all.aggregations)},r.prototype.getTableProperties=function(){return this.metadata.component.components.findComponentDeep("table")[0].attributes},r.prototype.hasDetails=function(e){return!!t.find(e.dataset.levels,function(e){return e.detail})},r.prototype.processChild=function(e){e.hyperlink.groupMembers||(e.hyperlink.groupMembers=[]),e.child.group&&(e.hyperlink.groupMembers.push(e.child.group.memberIdx),e.child.group.data&&this.getTableProperties().showTotals&&(!this.showDetails&&this.showTotals?(e.levelIdx===e.levels.length-1?e.data.push(this.makeTotalRow(e)):this.totalsData[e.levelIdx]&&this.totals.push(this.totalsData[e.levelIdx]),this.totalsData[e.levelIdx]=this.makeTotalRow(e)):(this.totalsData[e.levelIdx]&&this.totals.push(this.totalsData[e.levelIdx]),this.totalsData[e.levelIdx]=this.makeTotalRow(e))),!this.showDetails&&this.showTotals&&e.levelIdx===e.levels.length-2&&(t.each(this.totals.reverse(),function(t){e.data.push(t)},this),this.totals=[],e.data.push(this.makeGroupRow(e))),e.label=e.label.concat(e.label?", ":"",e.levels[e.levelIdx].group.members[e.child.group.memberIdx]),t.each(e.child.group.children,function(a){this.processChild({child:a,data:e.data,label:e.label,levels:e.levels,levelIdx:e.levelIdx+1,columns:e.columns,totals:e.totals,hyperlink:t.cloneDeep(e.hyperlink)})},this)),e.child.detail&&(e.levels.length&&(t.each(this.totals.reverse(),function(t){e.data.push(t)},this),this.totals=[],e.data.push(this.makeGroupRow(e))),t.each(e.child.detail.data,function(t){e.data.push(this.makeDetailRow(t,e))},this))},r.prototype.parseRows=function(e,a){return e.length&&e[0][0].label===this.lastGroupLabel&&(e=e.slice(1)),t.each(e,function(e){"jr-mDatatable-rowGroup"===e[0].className&&(this.lastGroupLabel=e[0].label)},this),a.params.pageSize[0]>a.dataset.counts&&(e=!this.showDetails&&this.showTotals?e.concat(t.values(this.totalsData).reverse().slice(1)):e.concat(t.values(this.totalsData).reverse())),e},r.prototype.parseLinks=function(e){var a=this.lastRowIndex;return t.each(e,function(e,o){t.each(e,function(e,t){e.hyperlink.id="".concat(a+o,"_",t),e.hyperlink.row.index=a+o},this)},this),this.lastRowIndex+=e.length,e},r.prototype.parseOddEven=function(e){return t.each(e,function(e){"jr-mDatatable-rowGroup"===e[0].className?this.nextRowClassName="jr-mDatatable-rowOdd":e[0].hyperlink.linkType===r.linkTypes.DATA&&(e.oddEvenClassName=this.nextRowClassName,this.nextRowClassName="jr-mDatatable-rowOdd"===this.nextRowClassName?"jr-mDatatable-rowEven":"jr-mDatatable-rowOdd")},this),e},r.totalDataEqualsZero=function(e){var o=!1;return t.each(e,function(e){a.isNumeric(e)&&0!==parseFloat(e)&&(o=!0)}),!o},r});