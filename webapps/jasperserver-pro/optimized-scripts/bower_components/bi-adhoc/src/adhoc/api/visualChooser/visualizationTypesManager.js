define(["require","exports","module","underscore","./collection/ChartTypeGroupCollection","./enum/visualizationTypes"],function(e,r,n){"use strict";function t(){this.collection=new g(h)}function i(e){var r,n=0,t=e.reduce(function(e,r){return r.isMeasure()?e+1:e},0),i=e.multiAxisMap(function(e){return e.isMeasure()?"m":(n++,"f")});if(t>1){r=[];for(var o=0;o<i.length;o++)if("m"===i[o])for(var u=0;t>u;u++)r.push("m");else r.push(i[o])}else r=i;return{fieldsCount:n,measureCount:t,placement:r.join("")}}function o(e,r,n){var t=e.requirements.categorizerAllowed&&d.difference(r,e.requirements.categorizerAllowed).length||e.requirements.categorizerForbidden&&d.difference(r,e.requirements.categorizerForbidden).length<r.length;return t||e.requirements.categorizerDefaultOnly&&!n}function u(e,r){return!(r||"Crosstab"===e.name||"Table"===e.name)}function s(e,r){var n=e.requirements;return n.measures?!d.isUndefined(n.measures.min)&&n.measures.min>r?!0:!d.isUndefined(n.measures.max)&&n.measures.max<r?!0:!1:void 0}function l(e,r){var n=e.requirements;if(n.fields){if(!d.isUndefined(n.fields.min)&&n.fields.min>r)return!0;if(!d.isUndefined(n.fields.max)&&n.fields.max<r)return!0}return!1}function a(e,r){var n=e.requirements;if(n.measures){if(n.measures.inRow===!1&&r.row.indexOf("m")>-1)return!0;if(n.measures.inColumn===!1&&r.column.indexOf("m")>-1)return!0}return!1}function c(e,r){var n=e.requirements;if(n.fields){if(n.fields.inRow===!1&&r.row.indexOf("f")>-1)return!0;if(n.fields.inColumn===!1&&r.column.indexOf("f")>-1)return!0}return!1}function f(e,r){var n=e.requirements;if(n.placement){if(n.placement.allowed)return!d.some(n.placement.allowed,function(e){return null!==r.column.match(new RegExp("^"+e.column+"$"))&&null!==r.row.match(new RegExp("^"+e.row+"$"))});if(n.placement.forbidden)return d.some(n.placement.forbidden,function(e){return null!==r.column.match(new RegExp("^"+e.column+"$"))&&null!==r.row.match(new RegExp("^"+e.row+"$"))})}return!1}function m(e,r){var n=e.requirements;if(e.isTimeSeries&&n.fields){if("time"===n.fields.type&&!r.isDateTime)return!0;if(n.fields.categorizer&&!d.contains(n.fields.categorizer,r.categorizer))return!0}return!1}var p,d=e("underscore"),g=e("./collection/ChartTypeGroupCollection"),h=e("./enum/visualizationTypes");return t.prototype.getAllTypes=function(){var e=this.collection.map(function(e){return e.chartTypesCollection.toJSON()});return d.flatten(e)},t.prototype.getAllGroups=function(){return this.collection.toJSON()},t.prototype.getAllTypesInGroup=function(e){return this.collection.findWhere({name:e}).chartTypesCollection.toJSON()},t.prototype.findType=function(e){return d.findWhere(this.getAllTypes(),e)},t.prototype.isTimeSeriesType=function(e){var r=this.findType({name:e});return r.isTimeSeries},t.prototype.getTimeseriesAttributes=function(e){var r=e.first();return{isDateTime:r&&r.isDateTime(),categorizer:r&&r.get("categorizer")}},t.prototype.getDisabledTypesList=function(e,r){var n=i(e),t=i(r),o=function(e){return e.isDefaultCategorizer()},u=d.compact(e.pluck("categorizer").concat(r.pluck("categorizer"))),s=d.reduce(e.map(o).concat(r.map(o)),function(e,r){return e&&r});return this.getDisabledChartTypes(n.measureCount+t.measureCount,n.fieldsCount+t.fieldsCount,{column:n.placement,row:t.placement},this.getTimeseriesAttributes(r),e.allHasSummaries()&&r.allHasSummaries(),u,s)},t.prototype.getAllowedTypesList=function(e,r){return d.difference(d.pluck(this.getAllTypes(),"name"),this.getDisabledTypesList(e,r))},t.prototype.getDisabledChartTypes=function(e,r,n,t,i,p,g){var h=this.getAllTypes(),y=[];return d.each(h,function(d){var h=o(d,p,g),T=u(d,i),v=s(d,e),w=a(d,n),C=l(d,r),z=c(d,n),x=f(d,n),b=m(d,t);(T||v||w||C||z||x||b||h)&&y.push(d.name)}),y},p=new t});