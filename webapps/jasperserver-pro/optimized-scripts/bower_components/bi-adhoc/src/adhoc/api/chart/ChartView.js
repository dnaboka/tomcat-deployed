define(["require","underscore","jquery","backbone","highcharts","bi/adhoc/error/biComponentErrorFactoryAdHocViewProxy","../visualChooser/visualizationTypesManager","bundle!AdHocBundle","./model/chartDataConverter","adhoc/api/chart/adhocToHighchartsAdapter","text!./template/chart.htm","./HyperlinkChartHelper"],function(e){function t(e){if("DualLevelPie"===e.component.get("visualizationType")){var t=e.dataSet.query,a=t.rows.axis.multiAxisMap(function(e){return e});if(a[0].isMeasure()){var i=t.rows.expansions.find(function(e){return e.get("level")&&e.get("level").aggregation&&!e.get("level").expanded});if(i){var n=r.clone(i.get("level"));n.expanded=!0,i.set({level:n})}}}}var r=e("underscore"),a=e("jquery"),i=e("backbone"),n=e("highcharts"),h=e("bi/adhoc/error/biComponentErrorFactoryAdHocViewProxy"),s=(e("../visualChooser/visualizationTypesManager"),e("bundle!AdHocBundle")),o=e("./model/chartDataConverter"),d=e("adhoc/api/chart/adhocToHighchartsAdapter"),c=e("text!./template/chart.htm"),l=e("./HyperlinkChartHelper");return i.View.extend({initialize:function(e){this.$el=a(r.template(c)({i18n:s})),this._initElements(),this.adHocModel=e.dataModel,this.options=e.options,this.hyperlinkService=new l},render:function(e){var i=a.Deferred(),n=this;e&&e.append(this.$el),this.adHocModel.trigger("component:busy",!0),this.adHocModel.dataSet.set({params:{offset:[0,0],pageSize:[2147483647,2147483647]}}),t(this.adHocModel);var s=this.adHocModel.dataSet.data().fail(r.bind(i.reject,i)),o=this.adHocModel.bundles.bundle().fail(r.bind(i.reject,i));return a.when(s,o).done(function(){try{n._checkData()&&n._renderChart(i),n.adHocModel.trigger("component:busy",!1),i.resolve()}catch(e){return i.reject(h.adHocViewRender(e))}}),i},_initElements:function(){this.$emptyMessage=this.$(".jr-jEmptyMessage"),this.$canvas=this.$(".jr-mChart")},_renderChart:function(e){var t,a=this,i=JSON.parse(JSON.stringify(this.adHocModel.toJSON())),h=JSON.parse(JSON.stringify(this.adHocModel.dataSet.toJSON())),c=this.options.linkOptions,l=o(i,h,this.adHocModel,this.hyperlinkService),g=d.generateOptions(l.queryData,l.chartState,{width:this._getContainerWidth()||400,height:this._getContainerHeight()||300,messages:{totalsLabelForChart:s["adhoc.node.total.node"],allLabelForChart:s["adhoc.node.total.node"]},isTimeSeries:this.adHocModel.component.getChartComponent().isTimeSeries()});this.hyperlinkService.perform(this,g);try{g.chart.renderTo=this.$(".jr-mChart")[0],g.chart.height||(g.chart.height=this._getContainerHeight()),g.chart.width||(g.chart.width=this._getContainerWidth()),c&&c.beforeRender&&c.beforeRender(a.hyperlinkService.getHyperlinks(g,a)),this.highchartsInstance=new n.Chart(g)}catch(p){throw r.each(n.charts,function(e){e&&a.$el===e.renderTo&&e.destroy()}),this.highchartsInstance&&this.highchartsInstance.destroy&&(this.highchartsInstance.destroy(),this.highchartsInstance=void 0),t=/\#19/.test(p)?s["adhoc.error.highcharts.19"]:/\#13/.test(p)?s["adhoc.error.highcharts.13"]:s["adhoc.error.highcharts.default"],{name:"error",type:"highchartsInternalError",data:{error:p,message:t}}}},_getContainerWidth:function(){return this.$el.parent().width()},_getContainerHeight:function(){return this.$el.parent().height()},_checkData:function(){var e=!this.adHocModel.dataSet.get("dataset").empty;return e?(this.$emptyMessage.addClass("jr-isHidden"),this.$canvas.removeClass("jr-isHidden")):(this.$emptyMessage.removeClass("jr-isHidden"),this.$canvas.addClass("jr-isHidden")),e},refresh:function(e){return this.adHocModel.dataSet.resetDataset(),this.render().done(r.bind(e.resolve,e)).fail(r.bind(e.reject,e)),e},resize:function(){this.highchartsInstance&&this.highchartsInstance.setSize(this._getContainerWidth(),this._getContainerHeight())},isAcceptable:function(e){return"Table"!==e&&"Crosstab"!==e}})});