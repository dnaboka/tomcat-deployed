define(["require","backbone","underscore","bundle!AdHocBundle","text!../template/crosstabHeaderTemplate.htm"],function(e){function n(e){var n=e.dataSet.query.groupByJSON(),a=[],l=e.component.getCrosstabComponent(),d=l.getColumnsComponent(),o=l.getRowsComponent(),s=l.getMeasuresComponent();return a.push(t(n.columns,[0],d,s)),a.push(t(n.rows,[1],o,s)),i(a,e),a}function t(e,n,t,i){for(var d,o,s,r,u=[],c=0;c<e.items.length;c++)d=e.items[c].level,s={isExpandable:a(e.items,c)},d?(r=d.id||d.field,o=t.findWhere({reference:r})||i.findWhere({reference:r}),s.name=r,s.label=o.label(),s.fieldRef=d.field):(s.label=p["adhoc.node.measures.node"],s.isMeasure=!0),s.isExpandable&&(s.expId=s.collapseId=n.concat([c]),s.isExpanded=l(e.expansions,d)),u.push(s);return u}function a(e,n){return e[n+1]&&!(e[n].level&&e[n+1].aggregations)}function l(e,n){if(e)for(var t=0,a=e.length;a>t;t++)if(e[t].level&&(!n&&r.isUndefined(e[t].level.fieldRef)||n&&e[t].level.fieldRef===n.id))return e[t].level.expanded;return!1}function i(e,n){for(var t={includeAll:!1},a=n.component.getColumnsComponent().where(t),l=n.component.getRowsComponent().where(t),i=r.reduce([].concat(a).concat(l),function(e,n){return e[n.get("dimension")]=!0,e},{}),d=0;d<e.length;d++){for(var o=e[d].length-1;o>0;o--)e[d][o].isExpandable=i[e[d][o].name]?!1:e[d][o-1].isExpandable,e[d][o].isExpanded=e[d][o-1].isExpanded,e[d][o].expId=e[d][o-1].expId,e[d][o].collapseId=e[d][o-1].collapseId;e[d].length&&(e[d][0].isExpandable=!1,e[d][0].expId=void 0,e[d][0].collapseId=void 0)}for(var d=0;d<e.length;d++)for(var o=0;o<e[d].length;o++)if(e[d][o].isExpandable){for(var s=o+1,p=e[d][e[d].length-1].isMeasure?e[d].length-1:e[d].length;p>s&&(e[d][s].isMeasure||i[e[d][s].name]);)s++;e[d][s-1].expId&&(e[d][o].expId=e[d][s-1].expId,e[d][o].isExpanded=e[d][s-1].isExpanded)}}function d(e,n){var t=e[0],a=e[1],l=r.reduce(t,function(e,t){return e.push([o(n,t,a.length)]),e},[]);return l.push(r.reduce(a,function(e,t){return e.push(o(n,t)),e},[])),l}function o(e,n,t){var a={label:n.label,isExpanded:n.isExpandable&&n.isExpanded,isCollapsed:n.isExpandable&&!n.isExpanded,isMeasure:n.isMeasure};return n.isExpandable&&(a.expId=n.expId.join("-")),n.isExpandable&&(a.colId=n.collapseId.join("-")),t&&(a.colspan=t),a}var s=e("backbone"),r=e("underscore"),p=e("bundle!AdHocBundle"),u=e("text!../template/crosstabHeaderTemplate.htm"),c=r.template(u),x=s.View.extend({events:{"click .jr-isExpanded":"onExpandClick","click .jr-isCollapsed":"onCollapseClick"},render:function(){return this.auxModel=n(this.model),this.$("table").html(c({data:d(this.auxModel,this.model)})),this},onCollapseClick:function(e){this._expand(e.target.getAttribute("data-expansion-id").split("-"),!0)},onExpandClick:function(e){this._expand(e.target.getAttribute("data-expansion-id").split("-"),!1)},_expand:function(e,n){for(var t=this.auxModel,a={level:{}},l=0;l<e.length;l++)t=t[e[l]];a.level.expanded=n,a.level.fieldRef=t.name,a.level.aggregation=!t.fieldRef,this.trigger(+e[0]?"expansion:row":"expansion:column",a),this.trigger("expansion",a)}});return x});