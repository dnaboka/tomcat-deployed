define(["require","exports","module","jquery","underscore","./view/designer/SidebarView","./DashboardViewer","./view/designer/DesignerCanvasView","common/component/dialog/Dialog","common/enum/httpStatusCodes","./view/designer/DesignerToolbarView","./view/base/CanvasView","./model/DashboardModel","./model/component/PropertiesDashboardComponentModel","./collection/DashboardStateCollection","./layout/GridLayoutStrategy","./dashboardMessageBus","./enum/dashboardMessageBusEvents","dashboard/enum/dashboardComponentTypes","./factory/sandboxFactory","text!dashboard/template/welcomeTextTemplate.htm","./dashboardSettings","bundle!DashboardBundle","css!dashboard/designer.css"],function(e,t,s){"use strict";var i=e("jquery"),o=e("underscore"),a=e("./view/designer/SidebarView"),n=e("./DashboardViewer"),r=e("./view/designer/DesignerCanvasView"),d=(e("common/component/dialog/Dialog"),e("common/enum/httpStatusCodes"),e("./view/designer/DesignerToolbarView")),h=e("./view/base/CanvasView"),l=e("./model/DashboardModel"),c=(e("./model/component/PropertiesDashboardComponentModel"),e("./collection/DashboardStateCollection")),u=e("./layout/GridLayoutStrategy"),g=e("./dashboardMessageBus"),v=e("./enum/dashboardMessageBusEvents"),m=(e("dashboard/enum/dashboardComponentTypes"),e("./factory/sandboxFactory")),b=e("text!dashboard/template/welcomeTextTemplate.htm"),p=e("./dashboardSettings"),w=e("bundle!DashboardBundle");return e("css!dashboard/designer.css"),n.extend({initialize:function(e){o.bindAll(this,"_onPageLeave","_onSessionExpired","_onUnload"),this.contextPath=e.contextPath||p.CONTEXT_PATH,this.model=new l({},{contextPath:this.contextPath}),this.dashboardId=this._generateDashboardId(),m.get(this.dashboardId).set("dashboardModel",this.model),this.state=new c([],{model:this.model}),this.strategy=new u(this.model),this.sidebar=new a({model:this.model,strategy:this.strategy,dashboardId:this.dashboardId}),this.designerCanvas=new r({model:this.model,strategy:this.strategy,state:this.state,dashboardId:this.dashboardId}),this.toolbar=new d({model:this.model,state:this.state,dashboardId:this.dashboardId}),this.canvas=new h({model:this.model,dashboardId:this.dashboardId}),this._initAdditionalVisualComponents(),this.canvas.stopListening(),this.canvas.$el.hide(),this.canvas.model=void 0,this.listenTo(this.toolbar,"preview:on",o.bind(function(){this.enterPreviewMode()},this)),this.listenTo(this.toolbar,"preview:off",o.bind(function(){this.exitPreviewMode()},this)),this.listenTo(this.toolbar,"grid:on",o.bind(function(){this.showLayoutGrid()},this)),this.listenTo(this.toolbar,"grid:off",o.bind(function(){this.hideLayoutGrid()},this)),this.listenTo(this.toolbar,"dashboard:save",this._onDashboardSave),this.listenTo(this.toolbar,"button:filterPopup",o.bind(function(){this.toggleFilterPopup()},this)),this.listenTo(this.toolbar,"button:undo",this.undoParameters,this),this.listenTo(this.toolbar,"button:undoAll",this.undoAllParameters,this),this.listenTo(this.toolbar,"button:redo",this.redoParameters,this),this.listenTo(this.model,"error:all",this._onAllModelErrors),this.listenTo(this.model,"propertiesAvailable",o.bind(this._onDashboardPropertiesAvailable,this)),this.listenTo(this.sidebar,"open",o.bind(this._onSidebarToggle,this,!1)),this.listenTo(this.sidebar,"close",o.bind(this._onSidebarToggle,this,!0)),this.listenTo(this.sidebar,"resize",o.bind(this._onSidebarResize,this)),this.listenTo(this.sidebar,"resizeStop",o.bind(this._resizeComponents,this)),this.listenTo(this.designerCanvas.model.currentFoundation,"open:filterDialog",this.openDesignerFilterDialog),this.listenTo(this.designerCanvas.model.currentFoundation,"close:filterDialog",this.closeFilterDialog),this.listenTo(g,v.SAVE_DASHBOARD_STATE,o.bind(this.state.saveState,this.state)),this.listenTo(g,v.SESSION_EXPIRED,this._onSessionExpired),this.listenTo(this.toolbar,"button:export",this.exportDashboard,this),this.render(),this._startHistory(),this._initPreventTextSelection("#banner","#frame"),this._checkPreviewMode(),i(window).on(window.onpagehide||null===window.onpagehide?"pagehide":"unload",this._onUnload),i(window).on("beforeunload",this._onPageLeave),i(window).on(v.SESSION_EXPIRED,this._onSessionExpired)},showInitialMessage:function(){this.designerCanvas.message.show(o.template(b,{i18n:w}))},hideMessageBox:function(){this.designerCanvas.message.hide()},enterPreviewMode:function(){var e=this.model.currentFoundation.wiring.hasUserWiring()&&this.model.currentFoundation.components.getValueProducers().length;m.get(this.getDashboardId()).set("previewMode",!0),this.$el.removeClass("twoColumn").addClass("oneColumn"),this.sidebar.$el.hide(),this.designerCanvas.filterDialog.close(),this.designerCanvas.$el.hide(),this.canvas.$el.show(),this.canvas.model=this.model.clone(this.dashboardId),e&&(this.canvas.model.currentFoundation.components.on("parametersState:canUndo",o.bind(this.canUndo,this)),this.canvas.model.currentFoundation.components.on("parametersState:canRedo",o.bind(this.canRedo,this)),this.canRedo(!1),this.canUndo(!1)),this.toolbar.setVisibility({undo:e,redo:e,undoAll:e}),this.canvas.render(),this.canvas.applyCanvasSize(),this.canvas.applyCanvasColor(),this.designerCanvas.$rootEl.addClass("previewMode"),this.canvas.model.currentFoundation.startLoadingSequence(),this._checkReadyness(),this._modifyUri()},exitPreviewMode:function(){m.get(this.getDashboardId()).set("previewMode",!1),this.$el.removeClass("oneColumn").addClass("twoColumn"),this.designerCanvas.$rootEl.removeClass("previewMode"),this.model.currentFoundation.wiring.hasUserWiring()||this.toolbar.setVisibility({undo:!0,redo:!0,undoAll:!0}),this.canvas.$el.removeClass("previewMode"),this.history.navigate(this.history.getFragment().replace(/previewMode&/g,"")),this.canvas.filterDialog.close(),this.canvas.$el.hide(),this.canvas.disableAutoRefresh(),this.canvas.removeAllComponentViews(),this.sidebar.$el.show(),this.designerCanvas.$el.show(),delete this.canvas.model,this._resizeComponents(),this.sidebar.accordion.fit()},isPreviewMode:function(){return m.get(this.getDashboardId()).get("previewMode")},showLayoutGrid:function(){this.designerCanvas.$el.find(".grid").show()},hideLayoutGrid:function(){this.designerCanvas.$el.find(".grid").hide()},toggleFilterPopup:function(){this.isPreviewMode()?this.canvas.filterDialog.isVisible()?this.canvas.filterDialog.close():this.canvas.filterDialog.open():this.designerCanvas.filterDialog.isVisible()?this.designerCanvas.filterDialog.close():this.designerCanvas.filterDialog.open()},openDesignerFilterDialog:function(){this.designerCanvas.filterDialog.isVisible()||(this.designerCanvas.filterDialog.open(),this.toolbar.trigger("filterButtonStyle:open"))},closeFilterDialog:function(){this.isPreviewMode()?this.canvas.filterDialog.close():this.designerCanvas.filterDialog.close(),this.toolbar.trigger("filterButtonStyle:close")},canUndo:function(e){this.toolbar&&this.toolbar.setEnabled({undo:e,undoAll:e}),this.toolbar&&e?this.toolbar.$("#undo, #undoAll").removeAttr("disabled").removeClass("over disabledButton"):this.toolbar&&!e&&this.toolbar.$("#undo, #undoAll").attr("disabled","disabled").addClass("disabledButton").removeClass("over")},canRedo:function(e){this.toolbar&&this.toolbar.setEnabled({redo:e}),this.toolbar&&e?this.toolbar.$("#redo").removeAttr("disabled").removeClass("over disabledButton"):this.toolbar&&!e&&this.toolbar.$("#redo").attr("disabled","disabled").addClass("disabledButton").removeClass("over")},undoParameters:function(){this.isPreviewMode()?(this.canvas.model.currentFoundation.components.popParametersState(-1),this.canvas.model.currentFoundation.components.getDashboardPropertiesComponent().applyParameters(!0)):this.state.setPreviousState()},undoAllParameters:function(){this.isPreviewMode()?(this.canvas.model.currentFoundation.components.resetParametersState(),this.canvas.model.currentFoundation.components.getDashboardPropertiesComponent().applyParameters(!0)):this.state.setFirstState()},redoParameters:function(){this.isPreviewMode()?(this.canvas.model.currentFoundation.components.popParametersState(1),this.canvas.model.currentFoundation.components.getDashboardPropertiesComponent().applyParameters(!0)):this.state.setNextState()},_onPageLeave:function(e){if(!this.sessionExpired){if(this.downloading)return void(this.downloading=!1);if(!m.get(this.getDashboardId()).get("disablePageLeaveConfirmation"))return!this.model.isNew()&&this.state.hasPreviousState()||this.model.isNew()&&this.model.currentFoundation.hasVisualComponents()?((e||window.event).returnValue=w["dashboard.dialog.unsaved.changes"],w["dashboard.dialog.unsaved.changes"]):void 0}},_onDashboardPropertiesAvailable:function(e){this.toolbar.setVisibility({filterPopup:e.get("dashletFilterShowPopup")})},_generateDashboardId:function(){return this.model.cid},getDashboardId:function(){return this.dashboardId},_onDashboardSave:function(){this.state.init(),this._updateLocationHash()},_updateLocationHash:function(){if(this.model.has("uri")){var e=encodeURIComponent(this.model.get("uri"));this.isPreviewMode()?this.history.navigate("previewMode&"+e,{trigger:!1,replace:!1}):this.history.navigate(e,{trigger:!1,replace:!1})}},_loadModelByUri:function(e){var t=this;try{e=decodeURIComponent(e)}catch(s){e=void 0}e&&0!==e.indexOf("/")&&(e="/"+e),e!=this.model.get("uri")&&(this.model.resetToInitialCondition(),e?(this.hideMessageBox(),this.model.set({uri:e}),this.model.fetch().fail(function(){t.model.currentFoundation.startLoadingSequence()}).always(function(){t.state.init()})):(this.showInitialMessage(),this.model.currentFoundation.startLoadingSequence(),this.state.init()))},_onLocationHashChange:function(e){var e=e.replace(/previewMode&/g,"");!this.model.isNew()&&this.state.hasPreviousState()||this.model.isNew()&&this.model.currentFoundation.hasVisualComponents()?window.confirm(w["dashboard.dialog.unsaved.changes"])?this._loadModelByUri(e):this.history.navigate(this.model.get("uri"),{trigger:!1,replace:!0}):this._loadModelByUri(e)},_modifyUri:function(){this.history.getFragment()&&this.history.navigate("previewMode&"+this.history.getFragment().replace(/previewMode&/g,""))},_checkPreviewMode:function(){function e(){t.model.currentFoundation.hasVisualComponents()?t.enterPreviewMode():setTimeout(e,100)}var t=this;/previewMode&/.test(this.history.getFragment())&&(t.toolbar.togglePreviewMode(),e())},_onAllModelErrors:function(e,t,s){this.model.unset("uri");var i=w["dashboard.canvas.error."+t.errorCode]||w[404===s.status?"dashboard.canvas.error.not.found":"dashboard.canvas.error.unexpected.error"];this.designerCanvas.message.show(i)},_onSidebarToggle:function(e){var t=this.designerCanvas.$el,s=this.sidebar.$contentContainer[e?"outerWidth":"width"]()-(e?parseInt(t.css("marginLeft"))/2:0);this.designerCanvas.$rootEl.css({left:s}),this.toolbar.$el.css({left:s}),this._resizeComponents()},_onSidebarResize:function(e,t){var s=t.size.width;this.designerCanvas.$rootEl.css({left:s}),this.toolbar.$el.css({left:s})},_onSessionExpired:function(){this.sessionExpired=!0,window.location.reload()},_onUnload:function(){var e=o.pick(this,"sessionExpired");this.designerCanvas.remove(e),this.canvas.remove(e)},_resizeComponents:function(){o.invoke(this.designerCanvas.componentViews,"resize")},_download:function(e){this.downloading=!0,n.prototype._download.call(this,e)},render:function(){return this.$el.empty(),this.designerCanvas.render().$rootEl.prepend(this.canvas.$el),this.$el.append(this.toolbar.render().$el),this.canvas.$el.addClass("column decorated primary"),this.$el.append(this.designerCanvas.$rootEl),this.$el.append(this.sidebar.render().$el),this},remove:function(){this.sidebar.remove(),this.strategy.remove(),this.designerCanvas.remove(),i(window).off(v.SESSION_EXPIRED,this._onSessionExpired),i(window).off("beforeunload",this._onPageLeave),i(window).off("pagehide unload"),n.prototype.remove.apply(this,arguments)}})});