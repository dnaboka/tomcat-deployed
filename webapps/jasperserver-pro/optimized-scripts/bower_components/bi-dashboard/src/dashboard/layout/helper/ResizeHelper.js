define(["require","jquery","underscore","dashboard/dashboardSettings","dashboard/dashboardMessageBus","dashboard/enum/dashboardMessageBusEvents","./BasicHelper","jquery-ui/jquery.ui.resizable"],function(e){"use strict";var i=e("jquery"),t=e("underscore"),s=e("dashboard/dashboardSettings"),a=e("dashboard/dashboardMessageBus"),n=e("dashboard/enum/dashboardMessageBusEvents"),o=e("./BasicHelper");return e("jquery-ui/jquery.ui.resizable"),o.extend({init:function(e){var a=this;this.container=e,t.bindAll(this,"_onWindowResize"),i(window).on("resize",this._onWindowResize),this.listenTo(this.strategy.model.currentFoundation.components.getDashboardPropertiesComponent(),"change:dashletMargin",function(){a.container.find("["+s.COMPONENT_ID_ATTRIBUTE+"]").each(function(){a._fixResizeHandlePositions(i(this))})}),this.listenTo(this.strategy.model.foundations,"addComponent moveComponent",function(e,i){t.defer(function(){var i=a.container.find("["+s.COMPONENT_ID_ATTRIBUTE+"="+e.id+"]");i.length&&a._initResizable(i)})}),this.listenTo(this.strategy.model.foundations,"removeComponent",function(e,i){a._destroyResizable(a.container.find("["+s.COMPONENT_ID_ATTRIBUTE+"="+e.id+"]"))}),this.container.find("["+s.COMPONENT_ID_ATTRIBUTE+"]").each(function(){a._initResizable(i(this))})},deinit:function(){var e=this;this.container.find("["+s.COMPONENT_ID_ATTRIBUTE+"]").each(function(){e._destroyResizable(i(this))}),i(window).off("resize",this._onWindowResize)},_onWindowResize:function(e){if(!e.target.tagName){var t=this;this.resizeTimer&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(function(){var e=t.strategy.gridSize(t.container);t.container.find("["+s.COMPONENT_ID_ATTRIBUTE+"]").each(function(){i(this).is(".ui-resizable")&&i(this).resizable("option",{minWidth:Math.floor(e.x),minHeight:Math.floor(e.y),grid:[Math.floor(e.x),Math.floor(e.y)]})})},300)}},_onDashletResizeStart:function(e,t){var a=i(e.target),n=a.attr(s.COMPONENT_ID_ATTRIBUTE),o=this.strategy.model.currentFoundation.components.get(n).getPositionObject(),r=this.strategy.gridSize(this.container),h=this.strategy.calculateEmptyArea(o,n),d=o.height,l=o.width,u=i(e.toElement||e.originalEvent.target);this.strategy.model.currentFoundation.components.selectComponent(n),(u.hasClass("ui-resizable-w")||u.hasClass("ui-resizable-nw")||u.hasClass("ui-resizable-sw"))&&(l=o.x+o.width-h.x),(u.hasClass("ui-resizable-e")||u.hasClass("ui-resizable-ne")||u.hasClass("ui-resizable-se"))&&(l=h.x+h.width-o.x),(u.hasClass("ui-resizable-n")||u.hasClass("ui-resizable-ne")||u.hasClass("ui-resizable-nw"))&&(d=o.y+o.height-h.y),(u.hasClass("ui-resizable-s")||u.hasClass("ui-resizable-se")||u.hasClass("ui-resizable-sw"))&&(d=h.y+h.height-o.y),a.resizable("option",{maxHeight:Math.ceil(d*r.y),maxWidth:Math.ceil(l*r.x)})},_onDashletResizeStop:function(e,t){var o=i(e.target).attr(s.COMPONENT_ID_ATTRIBUTE),r=this.strategy.model.currentFoundation.components.get(o),h=this.strategy.gridSize(this.container),d={x:Math.round(t.position.left/h.x),y:Math.round(t.position.top/h.y),width:Math.round(t.size.width/h.x),height:Math.round(t.size.height/h.y)};this.strategy.updateLayout(o,d),(r.hasChanged("width")||r.hasChanged("height"))&&a.trigger(n.SAVE_DASHBOARD_STATE),t.element.css(r.getCssPosition())},_initResizable:function(e){if(!e.hasClass("inputControlWrapper")){var i=this.strategy.gridSize(this.container);this._destroyResizable(e),e.resizable({handles:"all",containment:"parent",minWidth:Math.floor(i.x),minHeight:Math.floor(i.y),grid:[Math.floor(i.x),Math.floor(i.y)],start:t.bind(this._onDashletResizeStart,this),stop:t.bind(this._onDashletResizeStop,this)}).on("resize",function(e){e.stopPropagation()}),this._fixResizeHandlePositions(e)}},_destroyResizable:function(e){try{e.resizable("destroy")}catch(i){}},_fixResizeHandlePositions:function(e){var i=this.strategy.model.currentFoundation.components.getDashboardPropertiesComponent().get("dashletMargin")-3;e.find(".ui-resizable-n, .ui-resizable-ne, .ui-resizable-nw").css({top:i+"px"}),e.find(".ui-resizable-e, .ui-resizable-se, .ui-resizable-ne").css({right:i+"px"}),e.find(".ui-resizable-s, .ui-resizable-se, .ui-resizable-sw").css({bottom:i+"px"}),e.find(".ui-resizable-w, .ui-resizable-sw, .ui-resizable-nw").css({left:i+"px"})}})});