define(["require","jquery","underscore","dashboard/dashboardSettings","dashboard/enum/dashboardComponentTypes","bi/repository/enum/repositoryResourceTypes","./BasicHelper"],function(t){"use strict";var e=t("jquery"),i=t("underscore"),r=t("dashboard/dashboardSettings"),o=t("dashboard/enum/dashboardComponentTypes"),n=t("bi/repository/enum/repositoryResourceTypes"),s=t("./BasicHelper");return s.extend({placement:["bottom","left","right","top"],init:function(t){this.container=t,this.helper=e("<div>").addClass("helper split-drop").appendTo(t).hide(),this.helper.position={}},drag:function(t,i){var s,h=e(t.toElement||t.originalEvent.target);if(h.hasClass("dragHelper")?h=this.lastTarget:this.lastTarget=h,h=h[0]===this.helper[0]?this.helper.element:h.parents("["+r.COMPONENT_ID_ATTRIBUTE+"]"),!h||!h.length)return void this.helper.hide();if(h.hasClass("dashboardLevelPropertiesDialog")||h.parents(".dashboardLevelPropertiesDialog").length)return void this.helper.hide();var a=h.attr(r.COMPONENT_ID_ATTRIBUTE),d=this.strategy.model.currentFoundation.components.get(a);return d.get("type")===o.INPUT_CONTROL&&(d=d.getParent(),a=d.get("id"),h=this.container.find("["+r.COMPONENT_ID_ATTRIBUTE+'="'+a+'"]')),i.resourceType===o.INPUT_CONTROL&&this.strategy.model.currentFoundation.components.getDashboardPropertiesComponent().get("dashletFilterShowPopup")?void this.helper.hide():(d.get("type")===o.FILTER_GROUP&&i.resourceType===n.INPUT_CONTROL?s=d.getPositionObject():i.resourceType===n.INPUT_CONTROL&&d.get("type")!==o.FILTER_GROUP&&this.strategy.model.currentFoundation.components.findWhere({type:o.FILTER_GROUP})?s=this.strategy.model.currentFoundation.components.findWhere({type:o.FILTER_GROUP}).getPositionObject():(s=this.detectPosition(t,h[0]),s=this.adjustPlacement(this.getPosition(h),this.detectPlacement(s))),this.helper.element=h,void this.helper.css(this.strategy.cellCSS(s)).show())},stop:function(t){this.helper.hide()},drop:function(t,i,s){var h,a,d=e(t.toElement||t.originalEvent.target);if(d.hasClass("dragHelper")?d=this.lastTarget:this.lastTarget=d,d=d[0]===this.helper[0]?this.helper.element:d.parents("["+r.COMPONENT_ID_ATTRIBUTE+"]"),d&&d.length){var p=d.attr(r.COMPONENT_ID_ATTRIBUTE),l=this.strategy.model.currentFoundation.components.get(p),g=i.helper.data("data");if(l.get("type")===o.INPUT_CONTROL&&(l=l.getParent(),p=l.get("id"),d=this.container.find("["+r.COMPONENT_ID_ATTRIBUTE+'="'+p+'"]')),l.get("type")!==o.FILTER_GROUP||!g||g.resourceType!==n.INPUT_CONTROL){h=this.getPosition(d),a=this.detectPosition(t,d[0]),a=this.adjustPlacement(h,this.detectPlacement(a));for(var T in a)a.hasOwnProperty(T)&&(s[T]=a[T]);this.strategy.updateLayout(d.attr(r.COMPONENT_ID_ATTRIBUTE),h)}}},deinit:function(){this.helper.remove()},getPosition:function(t){var e=this.strategy.model.currentFoundation.components.get(t.attr(r.COMPONENT_ID_ATTRIBUTE));return e.getPositionObject()},detectPosition:function(t,e){var i=e.getBoundingClientRect();return{x:t.clientX-i.left,y:t.clientY-i.top,width:i.width||i.right-i.left,height:i.height||i.bottom-i.top}},detectPlacement:function(t){var e;return e=2*(t.x/t.y>t.width/t.height),e|=(t.width-t.x)/t.y>t.width/t.height,this.placement[e]},adjustPlacement:function(t,e){var r=i.clone(t);return("left"===e||"right"===e)&&(r.width=parseInt(r.width/2),t.width-=r.width),("top"===e||"bottom"===e)&&(r.height=parseInt(r.height/2),t.height-=r.height),"left"===e&&(t.x+=r.width),"right"===e&&(r.x+=t.width),"top"===e&&(t.y+=r.height),"bottom"===e&&(r.y+=t.height),r}})});