define(["require","exports","module","backbone","logger","underscore","jquery","../dashboardSettings","../model/component/DashletModel","../enum/dashboardComponentTypes","../factory/dashboardComponentModelFactory"],function(e,t,a){"use strict";function n(e){if(e.isVisualization()&&e.get("type")!==d.WEB_PAGE_VIEW&&e.get("type")!==d.IMAGE){var t=e.get("resource"),a=this.where({ownerResourceId:t}),n=this.where({resource:t,type:e.get("type")});o.each(a,function(e){n.length||this.remove(e)},this)}}function r(){this.find(function(e){return e.isValueDeferred&&e.isValueDeferred()})||this.trigger("parametersState:operationFinished",this)}var i=e("backbone"),s=e("logger").register(a),o=e("underscore"),c=e("jquery"),h=e("../dashboardSettings"),u=e("../model/component/DashletModel"),d=e("../enum/dashboardComponentTypes"),m=e("../factory/dashboardComponentModelFactory");return i.Collection.extend({model:m,initialize:function(){this.enableParametersStateStack(),this.on("remove",o.bind(n,this)),this.on("change:maximized",function(e){e.get("maximized")&&this.each(function(t){t!==e&&t.has("maximized")&&t.set("maximized",!1)})}),this.on("parametersState:deferredValueApplied",r,this),this.on("parametersState:operationFinished",function(){this.enableParametersStateStack(),this.trigger("parametersState:canUndo",this.canPopParametersState(-1)),this.trigger("parametersState:canRedo",this.canPopParametersState(1))},this)},pushParametersState:function(){this.isEnabledParametersStateStack()&&(this.invoke("pushParametersState"),this.trigger("parametersState:canUndo",!0),this.trigger("parametersState:canRedo",!1))},popParametersState:function(e){this.disableParametersStateStack(),this.invoke("popParametersState",e),r.call(this)},resetParametersState:function(){this.disableParametersStateStack(),this.invoke("resetParametersState"),r.call(this)},setCurrentParametersStateAsDefault:function(){this.invoke("setCurrentParametersStateAsDefault")},canPopParametersState:function(e){return this.reduce(function(t,a){return t||a.paramsModel.canPopState(e)},!1)},disableParametersStateStack:function(){this._enablePush=!1},enableParametersStateStack:function(){this._enablePush=!0},isEnabledParametersStateStack:function(){return this._enablePush},getValueProducers:function(){return this.filter(function(e){return e.isValueProducer()})},setMuteFilterPanels:function(e){this.each(function(t){t.get("type")==d.FILTER_GROUP&&(t.isMute=e)})},setEnabledCascading:function(e){this.each(function(t){t.get("type")==d.INPUT_CONTROL&&(t.isCascadeEnabled=e)})},getSelectedComponent:function(){return this.findWhere({selected:!0})},selectComponent:function(e){var t=this.get(e);this.forEach(function(e){e!==t&&e.set("selected",!1)}),t&&t.set("selected",!0)},setPositionFromHtml:function(e){try{var t=c("<div></div>").html(e),a=o.map(t.find("["+h.COMPONENT_ID_ATTRIBUTE+"]"),u.htmlToPositionObject);this.forEach(function(e){var t=o.findWhere(a,{id:e.id});t&&e.set(t,{silent:!0})})}catch(n){s.error(n)}},toHTML:function(e){var t="";return this.forEach(function(a){a instanceof u&&(t+=a.toHTML(e))}),t},getComponents:function(){return this.reduce(function(e,t){return t.toDashboardComponentObject&&t.get("type")!==d.DASHBOARD_PROPERTIES&&e.push(t.toDashboardComponentObject()),e},[])},getDashboardPropertiesComponent:function(){return this.findWhere({type:d.DASHBOARD_PROPERTIES})},isOutOfCanvasBounds:function(e){return e.x<0||e.y<0||e.x+e.width>h.GRID_WIDTH||e.y+e.height>h.GRID_HEIGHT},overlaps:function(e,t){return this.some(function(a){return a instanceof u?t===a.get("id")?!1:a.get("floating")?!1:!(a.get("x")>=e.x+e.width||a.get("x")+a.get("width")<=e.x||a.get("y")>=e.y+e.height||a.get("y")+a.get("height")<=e.y):!1})}})});