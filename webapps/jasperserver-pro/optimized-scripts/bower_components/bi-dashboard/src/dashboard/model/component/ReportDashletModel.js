define(["require","exports","module","jquery","underscore","request","bundle!DashboardBundle","common/util/i18nMessage","../../enum/dashboardComponentTypes","../../enum/dashboardWiringStandardIds","../../enum/dashletTechnicalOutputs","./DashletModel","../../collection/ReportsParametersCollection","dashboard/dashboardSettings","bi/report/enum/scaleStrategies"],function(e,r,t){"use strict";function n(e){var r=e.get("parameters"),t=e.get("outputParameters"),n={signals:i.pluck(t,"id"),slots:{}};return i.each(r.concat([{id:h.APPLY_SLOT},{id:h.REFRESH_SLOT}]),function(r){n.slots[r.id]=function(r){return function(t,n){(e.lastPayload||(e.lastPayload={}))[r]=t,(e.lastSender||(e.lastSender={}))[r]=n,e.trigger("signal",{name:r,value:t},n)}}(r.id)}),n}function s(e){return i.map(e||[],function(e){return{id:e.id,uri:e.uri,label:e.label}})}function a(e){return i.filter(e||[],function(e){return-1===i.indexOf(_,e.id)})}var o=e("jquery"),i=e("underscore"),d=(e("request"),e("bundle!DashboardBundle")),u=e("common/util/i18nMessage").extend({bundle:d}),l=e("../../enum/dashboardComponentTypes"),h=e("../../enum/dashboardWiringStandardIds"),c=e("../../enum/dashletTechnicalOutputs"),f=e("./DashletModel"),p=e("../../collection/ReportsParametersCollection").instance,m=e("dashboard/dashboardSettings"),T=e("bi/report/enum/scaleStrategies"),_=i.values(c);return f.extend({componentName:d["dashboard.component.report.component.name"],defaults:i.extend({},f.prototype.defaults,{type:l.REPORT,scaleToFit:m.DASHLET_SCALE_TO_FIT,autoRefresh:m.DASHLET_AUTO_REFRESH,refreshInterval:m.DASHLET_REFRESH_INTERVAL_TIME_UNIT_DEFAULT_MINUTES,refreshIntervalUnit:m.DASHBOARD_REFRESH_INTERVAL_UNIT,showTitleBar:m.DASHLET_SHOW_TITLE_BAR,showExportButton:m.DASHLET_SHOW_EXPORT_BUTTON,showRefreshButton:m.DASHLET_SHOW_REFRESH_BUTTON,showMaximizeButton:m.DASHLET_SHOW_MAXIMIZE_BUTTON,showPaginationControl:m.DASHLET_SHOW_PAGINATION_CONTROL}),validation:i.extend({},f.prototype.validation,{scaleToFit:[{required:!0,msg:new u("dashboard.component.error.scale.to.fit.required")},{oneOf:[1,T.HEIGHT,T.WIDTH,T.CONTAINER],msg:new u("dashboard.component.error.scale.to.fit.oneOf",d["dashboard.component.dialog.properties.scale.to.fit.no"],d["dashboard.component.dialog.properties.scale.to.fit.width"],d["dashboard.component.dialog.properties.scale.to.fit.height"],d["dashboard.component.dialog.properties.scale.to.fit.page"])}],refreshInterval:[{required:!0,msg:new u("dashboard.error.report.refreshInterval.required")},{integerNumber:!0,msg:new u("dashboard.error.report.refreshInterval.integer")},{fn:function(e,r,t){var n=t.refreshIntervalUnit,s={second:m.DASHLET_REFRESH_INTERVAL_TIME_UNIT_SECONDS,minute:m.DASHLET_REFRESH_INTERVAL_TIME_UNIT_MINUTES};return e<s[n]?"Value must be bigger than "+s[n]:void 0},msg:new u("dashboard.error.report.refreshInterval.min",m.DASHLET_REFRESH_INTERVAL_TIME_UNIT_MINUTES,m.DASHLET_REFRESH_INTERVAL_TIME_UNIT_SECONDS)}],refreshIntervalUnit:[{required:!0,msg:new u("dashboard.error.report.refreshIntervalUnit.required")},{oneOf:["second","minute"],msg:new u("dashboard.error.report.refreshIntervalUnit.oneOf",d["dashboard.dialog.properties.refresh.interval.second"],d["dashboard.dialog.properties.refresh.interval.minute"])}]}),initialize:function(){this.paramsDfd=new o.Deferred,this.componentInitializedDfd=new o.Deferred,f.prototype.initialize.apply(this,arguments),this.set("dataSourceUri",this._getDataSourceUri()),this.on("change:autoRefresh",function(){this.get("autoRefresh")||this.isValid(["refreshInterval","refreshIntervalUnit"])||this.set({refreshInterval:this.defaults.refreshInterval,refreshIntervalUnit:this.defaults.refreshIntervalUnit})},this)},getReportResourceUri:function(){return this.componentInitializedDfd.resolve(this.resource.resource.get("uri")).promise()},_getDataSourceUri:function(){return this.resource&&this.resource.resource&&this.resource.resource.get("uri")||this.get("dataSourceUri")},_getWiringMetadata:function(){var e=this,r=this.paramsDfd;if("pending"===this.paramsDfd.state()){if(!this.paramsDfd._running)if(this.get("parameters"))this.paramsDfd.resolve(this,n(this));else{this.paramsDfd._running=!0;var t=this.getReportResourceUri(),i=new o.Deferred;p.getReportParameters(this.resource.resource.get("uri")).done(function(r,t){e.set({outputParameters:s(a(t)),parameters:s(r)})}).fail(function(){e.set({outputParameters:[],parameters:[]})}).always(function(){i.resolve()}),o.when(t,i).then(function(){e.paramsDfd.resolve(e,n(e))})}}else r=new o.Deferred,r.resolve(this,n(this));return r.promise()}})});