define(["require","underscore","./ParameterGrammar"],function(e){"use strict";function n(e,r,u,o,s){var a=t(e,r);return a?(u.push(e.substring(r,a.begin)),u.push(i[a.type].resolve(e.substring(a.begin,a.end),o,s)),n(e,a.end,u,o,s)):u.push(e.substring(r)),u}function t(e,n){var t=r.reduce(u,function(t,r){var i=e.indexOf(r,n);return i>=0&&(!t||t.begin>i)&&(t={type:"{"===r[r.length-1]?r.substring(0,r.length-1):r,begin:i}),t},!1);if(t)if(i[t.type].hasDefaultResolution&&"{"!==e[t.begin+t.type.length])t.end=t.type.length+t.begin;else{var o=e.indexOf("}",t.begin);t.end=1+(0>o?e.length:o)}return t}var r=e("underscore"),i=e("./ParameterGrammar"),u=r.map(r.keys(i),function(e){return i[e].hasDefaultResolution?e:e+"{"});return{substitute:function(e,t,r){return n(e,0,[],t,r).join("")},completionOptions:function(e,n,t){var u;if(0===n)u=[];else{var o=[],u=r.reduce(i,function(r,i){return r.concat(i.getSubstitutionOptions(e,n,t))},[]);u.length||(r.each(r.keys(i),function(t){var r=t.toLowerCase().indexOf(e[n-1].toLowerCase()),i=n-1-r;if(-1!==r&&i>=0){for(var u=0;r>u;u++)if(t[u].toLowerCase()!==e[i+u].toLowerCase())return;o.push({begin:n-r-1,end:n,substitution:t,label:t,action:t,newCursorPos:n-r+t.length-1,removeIfSingle:r===t.length-1})}}),1===o.length&&o[0].removeIfSingle&&(o=[]),r.each(o,function(e){o.removeIfSingle=void 0,i[e.action].hasDefaultResolution&&u.push(r.clone(e)),e.label=e.label+"{ ... }",e.substitution=e.substitution+"{}",e.action=e.action+"{}",e.newCursorPos++,e.hasOptions=!0,u.push(e)}))}return u}}});