define(["require","backbone","../dashboardSettings","jquery","underscore"],function(t){"use strict";function e(t,e){var r;return t?(r=t,r.push.apply(r,n.filter(e,function(e){return!n.findWhere(t,{id:e.id})}))):r=e,r}var r=t("backbone"),s=t("../dashboardSettings"),a=t("jquery"),n=t("underscore");return r.Model.extend({idAttribute:"reportUri",defaults:{all:!1},initialize:function(t,e){var r=this;this.stateDfds={},e&&(e.knownIds&&n.each(e.knownIds,function(t){r.stateDfds[t]=new a.Deferred}),e.full?(this.allControlsDfd=new a.Deferred,this.fetch({full:!0,data:e.data&&n.without(n.values(e.data),void 0).length?e.data:void 0}).fail(n.bind(this.allControlsDfd.reject,this.allControlsDfd))):e.knownIds&&e.knownIds.length&&this.fetch({preload:e.knownIds,data:e.data&&n.without(n.values(e.data),void 0).length?e.data:void 0}).fail(function(){var t=arguments;n.each(e.knownIds,function(e){r.stateDfds[e].reject.apply(r.stateDfds[e],t)})})),this.on("change:all",function(){r.allControlsDfd.resolve(r.get("inputControl"))}),this.on("change:parameters",function(){r.allParametersDfd.resolve(r.get("parameters"),r.get("outputParameters"))})},url:function(){return s.CONTEXT_PATH+"/rest_v2/reports"+encodeURI(this.get("reportUri"))+"/inputControls"},parse:function(t){var r=this;if(t)if(t.inputControl){var s=!0;n.each(t.inputControl,function(t){"repo:"===t.uri.substr(0,5)&&(t.uri=t.uri.substr(5)),t.state&&(r.stateDfds[t.id]||(r.stateDfds[t.id]=new a.Deferred),r.stateDfds[t.id].resolve(t),s=!1)}),t={inputControl:e(this.get("inputControl"),t.inputControl),parameters:this.get("parameters"),outputParameters:this.get("outputParameters"),all:s||this.get("full")||this.get("all")}}else t={inputControl:this.get("inputControl"),parameters:t.parameters,outputParameters:t.outputParameters,all:this.get("all")};else t={inputControl:[],parameters:this.get("parameters"),outputParameters:this.get("outputParameters"),all:!0};return t},sync:function(t,e,s){return"read"==t&&(s.full?e.set("full",!0,{silent:!0}):s.preload&&(s.url=this.url()+"/"+s.preload.join(";")),s.data&&(n.isObject(s.data)&&(s.data=JSON.stringify(s.data)),s.type="POST",s.processData=!1,s.headers={"Content-Type":"application/json"})),r.Model.prototype.sync.call(this,t,e,s)},getReportControls:function(t){return(!this.allControlsDfd||t&&t.force)&&(this.allControlsDfd=new a.Deferred,this.stateDfds={},this.unset("inputControl",{silent:!0}),this.set("all",!1,{silent:!0}),this.fetch({url:this.url()+"?exclude=state"}).fail(n.bind(this.allControlsDfd.reject,this.allControlsDfd))),this.allControlsDfd.promise()},getReportParameters:function(t){return(!this.allParametersDfd||t&&t.force)&&(this.allParametersDfd=new a.Deferred,this.unset("parameters",{silent:!0}),this.unset("outputParameters",{silent:!0}),this.fetch({url:s.CONTEXT_PATH+"/rest_v2/discovery"+encodeURI(this.get("reportUri"))}).fail(n.bind(this.allParametersDfd.reject,this.allParametersDfd))),this.allParametersDfd.promise()},getInputControlAsParameter:function(t,e){var r=this.stateDfds[t];return(!r||e&&e.force)&&(r=this.stateDfds[t]=new a.Deferred,this.fetch({preload:[t],data:e&&e.params,full:e&&e.full}).fail(n.bind(this.stateDfds[t].reject,this.stateDfds[t]))),r.promise()}})});