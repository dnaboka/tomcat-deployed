define(["require","underscore","moment","momentTimezone","jrs.configs","dashboard/dashboardSettings","dashboard/enum/dashboardWiringStandardIds","jquery"],function(e){"use strict";function n(e,n,u){var o,i,s=t(e),a=e;return s.length&&(o=l.find(s,function(e){return'"'!==e.value[0]&&'"'!==e.value[e.value.length-1]}),i=o?n(o.value,u&&u.tolerateMissing):[""],a=l.reduce(i,function(e,n,t){return e.push(l.reduce(s,function(e,u){return u.optional&&t===i.length-1||e.push(o&&u.value===o.value?n:r(u.value)),e},[]).join("")),e},[]).join("")),a}function t(e){for(var n=!1,t=!1,r=!1,u=[],o=0,i=0;i<e.length;i++)"{"===e[i]&&(t=!0,o=i+1),"}"===e[i]&&(t=!1,o==i||u.push({value:c.trim(e.substring(o,i)),optional:r})),t&&(","!==e[i]&&"?"!==e[i]||n||(o==i||u.push({value:c.trim(e.substring(o,i)),optional:r}),r="?"===e[i],o=i+1),'"'===e[i]&&"\\"!==e[i-1]&&(n=!n));return u}function r(e){return e.substring(1,e.length-1)}function u(e,n,t){var r=e.substring(e.indexOf("{")+1,e.lastIndexOf("}"));return d().tz(f.userTimezone).format(r||"MMMM D, YYYY")}function o(e,n,t){var r=e.substring(e.indexOf("{")+1,e.lastIndexOf("}"));return d().tz(f.userTimezone).format(r||"h:mm a")}function i(e,n,t,r,u){var o=e,i=r.substring(0,u).lastIndexOf(n),s=r.indexOf(t,i);if(-1===i)o=[];else if(i+=n.length,u>=i&&(s>=u||-1===s)){for(s=u;" "===r[i]&&s>i;i++);for(var a=i;s>a;a++){for(var d=[],f=0;f<o.length;f++)o[f][a-i]==r[a]&&d.push(o[f]);o=d}1===o.length&&o[0].length===s-i&&(o=[])}else o=[];return l.map(o,function(e){return{begin:i,end:u,substitution:e,label:e,action:e,newCursorPos:u+e.length}})}function s(e,n,t){var r,u="$P{",o="}",i=e.substring(0,n).lastIndexOf(u),s=e.indexOf(o,i);if(-1===i)r=[];else if(i+=u.length,n>=i&&(s>=n||-1===s)){if(s=n,r=t.wiring.reduce(function(e,n){if(n.component.isValueProducer()&&l.indexOf(l.values(h),n.get("name"))<0){var t=a(n);e.push(l.extend({producer:n.get("producer"),label:t,substitution:t},n.attributes))}return e},[]),r.length){for(;" "===e[i]&&s>i;i++);e=e.toLowerCase();for(var d=i;s>d;d++){for(var f=[],g=0;g<r.length;g++)r[g].substitution[d-i].toLowerCase()==e[d]&&f.push(r[g]);r=f}1===r.length&&r[0].length===s-i&&(r=[])}}else r=[];return l.map(r,function(e){return l.extend(e,{begin:i,end:n,action:e.producer,newCursorPos:n+e.name.length})})}function a(e){var n;if(e.component.getParent())n=e.component.get("name");else{var t=e.get("name"),r=l.findWhere(e.component.get("outputParameters"),{id:t});n=r?r.label:t}return n}var l=e("underscore"),d=e("moment"),f=(e("momentTimezone"),e("jrs.configs")),g=e("dashboard/dashboardSettings"),h=e("dashboard/enum/dashboardWiringStandardIds"),c=e("jquery");return{$P:{resolve:n,getSubstitutionOptions:s,hasDefaultResolution:!1},$Date:{resolve:u,getSubstitutionOptions:l.bind(i,this,g.DEFAULT_DATE_FORMATS,"$Date{","}"),hasDefaultResolution:!0},$Time:{resolve:o,getSubstitutionOptions:l.bind(i,this,g.DEFAULT_TIME_FORMATS,"$Time{","}"),hasDefaultResolution:!0}}});