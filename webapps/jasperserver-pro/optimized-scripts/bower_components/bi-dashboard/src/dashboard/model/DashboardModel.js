define(["require","bi/repository/model/RepositoryResourceModel","dashboard/collection/DashboardFoundationCollection","dashboard/collection/DashboardResourceCollection","./DashboardResourceModel","./DashboardWiringModel","dashboard/model/DashboardFoundationModel","../factory/dashboardComponentModelFactory","./component/PropertiesDashboardComponentModel","../collection/DashboardComponentCollection","../collection/ReportsParametersCollection","dashboard/enum/dashboardResourceTypes","dashboard/enum/dashboardComponentTypes","bi/repository/enum/repositoryResourceTypes","common/enum/errorCodes","dashboard/enum/dashboardResourceReferenceTypes","../enum/dashboardWiringStandardIds","bundle!DashboardBundle","common/util/i18nMessage","jquery","underscore"],function(e){"use strict";function o(e,o){var t=v.where(e,{type:p.INPUT_CONTROL}),n=v.reduce(t,function(e,o){return(e[o.ownerResourceId]||(e[o.ownerResourceId]=[])).push(o),e},{});v.each(v.keys(n),function(e){h.add({reportUri:o[e]},{full:!!v.findWhere(n[e],{fullCollectionRequired:!0}),knownIds:v.pluck(n[e],"ownerResourceParameterName"),data:v.reduce(n[e],function(e,o){return e[o.ownerResourceParameterName]=o.value,e},{})})})}function t(e,o){try{var t=o.components.getDashboardPropertiesComponent().get("id"),n=v.find(e,function(e){return e.component===t&&e.name===b.APPLY_SIGNAL});n||e.push({component:t,consumers:[],name:b.APPLY_SIGNAL,producer:t+":"+b.APPLY_SIGNAL})}catch(r){}return e}var n=e("bi/repository/model/RepositoryResourceModel"),r=e("dashboard/collection/DashboardFoundationCollection"),s=e("dashboard/collection/DashboardResourceCollection"),i=e("./DashboardResourceModel"),a=e("./DashboardWiringModel"),c=(e("dashboard/model/DashboardFoundationModel"),e("../factory/dashboardComponentModelFactory")),u=e("./component/PropertiesDashboardComponentModel"),d=e("../collection/DashboardComponentCollection"),h=e("../collection/ReportsParametersCollection").instance,l=e("dashboard/enum/dashboardResourceTypes"),p=e("dashboard/enum/dashboardComponentTypes"),m=e("bi/repository/enum/repositoryResourceTypes"),f=e("common/enum/errorCodes"),g=e("dashboard/enum/dashboardResourceReferenceTypes"),b=e("../enum/dashboardWiringStandardIds"),C=e("bundle!DashboardBundle"),y=e("common/util/i18nMessage").extend({bundle:C}),R=e("jquery"),v=e("underscore");return n.extend({type:m.DASHBOARD,defaults:v.extend({},n.prototype.defaults,{label:C["dashboard.new.dashboard"],defaultFoundation:void 0,resources:void 0,foundations:void 0}),validation:v.extend({},n.prototype.validation,{label:[{required:!0,msg:new y("dashboard.error.label.required")},{maxLength:n.settings.LABEL_MAX_LENGTH,msg:new y("dashboard.error.label.maxLength",n.settings.LABEL_MAX_LENGTH)}],description:[{required:!1},{maxLength:n.settings.DESCRIPTION_MAX_LENGTH,msg:new y("dashboard.error.description.maxLength",n.settings.DESCRIPTION_MAX_LENGTH)}],parentFolderUri:[{required:!0,msg:new y("dashboard.error.parentFolderUri.required")}]}),initialize:function(e,o){n.prototype.initialize.apply(this,arguments),o||(o={}),o.dashboardId&&(this.dashboardId=o.dashboardId),this.resources=new s,this.foundations=new r,this.listenTo(this.foundations,"add",this._onFoundationAdd),this.listenTo(this.foundations,"addComponent",this._onComponentAdd),this.listenTo(this.foundations,"removeComponent",this._onComponentRemove),this.listenTo(this.foundations,"addComponent removeComponent moveComponent resizeComponent",this._onLayoutChange),this.listenTo(this.foundations,"changeProperties changedControlProperties",this._onComponentChange),this.listenTo(this.foundations,"changeWiring",this._onWiringChange),this.on("resourcesDataFetched",function(){this.listenTo(this.currentFoundation,"addComponent",this.addResourceReference),this.listenTo(this.currentFoundation.components,"change:url",this.updateResourceReference),this.listenTo(this.currentFoundation,"removeComponent",this.removeResourceReference)},this),this.on("change:defaultFoundation",this._onDefaultFoundationChange),this._initDefaultFoundation()},resetToInitialCondition:function(){var e=this.currentFoundation;this.set(v.omit(this.defaults,"defaultFoundation")),e.wiring.set([]),e.wiring.handlers={},e.components.set([]),e.components.add(new u({},{dashboardId:this.dashboardId||this.cid})),this.resources.set([this.resources.get(e.get("wiring")),this.resources.get(e.get("layout")),this.resources.get(e.get("components"))])},fetch:function(e){e||(e={}),v.defaults(e,{expanded:!0});var o=n.prototype.fetch.call(this,e),t=new R.Deferred,r=this;return o.done(function(){if(r.type!==m.DASHBOARD){var e={status:400,responseText:JSON.stringify({message:"Resource '"+r.get("uri")+"' is not of type '"+m.DASHBOARD+"'",errorCode:f.INVALID_RESOURCE_TYPE,parameters:[r.type]})};return r.set(v.omit(r.defaults,"defaultFoundation","foundations","resources")),r.trigger("error",r,e),void t.reject(e)}r.trigger("rawDataFetched",r),r.updateResourceCollection();var o=r.resources.chain().filter(function(e){return e.resource&&e.resource.fetchContent}).map(function(e){return e.resource instanceof n&&v.isUndefined(e.resource.contextPath)&&(e.resource.contextPath=r.contextPath),e.resource.fetchContent()}).value();R.when.apply(R,o).done(function(){r.trigger("resourcesDataFetched",r),r.updateFoundationCollection(),r.currentFoundation.startLoadingSequence(),r.trigger("propertiesAvailable",r.currentFoundation.components.getDashboardPropertiesComponent()),t.resolve()})}).fail(t.reject),t},toJSON:function(e){this.foundations.map(v.bind(this._onWiringChange,this,null));var o=n.prototype.toJSON.apply(this,arguments);return o.foundations=this.foundations.toJSON(),o.resources=this.resources.toJSON(e),o},_initDefaultFoundation:function(){var e=this.foundations.addDefaultFoundation();e.components.add(new u({},{dashboardId:this.dashboardId||this.cid})),this.set("defaultFoundation",this.foundations.getDefaultFoundation().get("id"))},_onDefaultFoundationChange:function(){this.currentFoundation!==this.foundations.get(this.get("defaultFoundation"))&&(this.currentFoundation=this.foundations.get(this.get("defaultFoundation")))},_onComponentAdd:function(e,o){var t=this.resources.get(o.get("components"));t.resource.setContent(o.components.toJSON());var n=e.resource;n&&!this.resources.get(n.id)&&this.resources.add(n)},_onComponentChange:function(e,o){var t=this.resources.get(o.get("components"));t.resource.setContent(o.components.toJSON())},_onComponentRemove:function(e,o){var t=this.resources.get(o.get("components"));t.resource.setContent(o.components.toJSON());var n=e.resource,r=!1;n&&(this.foundations.forEach(function(o){o.components.forEach(function(o){o!==e&&o.resource===n&&(r=!0)})}),r||this.resources.remove(n))},_onLayoutChange:function(e,o){var t=this.resources.get(o.get("layout"));t.resource.setContent(o.components.toHTML())},_onWiringChange:function(e,o){var t=this.resources.get(o.get("wiring"));t.resource.setContent(o.wiring.toJSON())},_onFoundationAdd:function(e){var o={};o[g.FILE]={label:e.get("components")};var t={};t[g.FILE]={label:e.get("layout")};var n={};n[g.FILE]={label:e.get("wiring")};var r=this.resources.add(new i({name:e.get("components"),type:l.COMPONENTS,resource:o},{contextPath:this.contextPath}));r.resource.setContent(e.components.toJSON());var s=this.resources.add(new i({name:e.get("layout"),type:l.LAYOUT,resource:t},{contextPath:this.contextPath}));s.resource.setContent(e.components.toHTML());var a=this.resources.add(new i({name:e.get("wiring"),type:l.WIRING,resource:n},{contextPath:this.contextPath}));a.resource.setContent(e.wiring.toJSON())},addResourceReference:function(e){e.get("type")===p.IMAGE&&/^repo:/.test(e.get("url"))&&this.resources.add({name:e.get("id"),type:e.get("type"),resource:{resourceReference:{uri:e.get("url").replace(/^repo:/,"")}}})},updateResourceReference:function(e){this.removeResourceReference(e),this.addResourceReference(e)},removeResourceReference:function(e){e.get("type")===p.IMAGE&&this.resources.remove(e.get("id"))},updateResourceCollection:function(){this.resources.set(this.get("resources"),{merge:!0,remove:!0,add:!0})},updateFoundationCollection:function(){var e=this;this.foundations.set(this.get("foundations"),{merge:!0,remove:!0,add:!0}),this.foundations.forEach(function(n){var r,s=e.resources.get(n.get("components")),i=e.resources.get(n.get("layout")),u=e.resources.get(n.get("wiring")),h=new d;if(u&&u.resource&&u.resource.content&&v.isArray(u.resource.content)&&(r=v.clone(u.resource.content)),s&&s.resource&&s.resource.content&&v.isArray(s.resource.content)){o(s.resource.content,e.resources.reduce(function(e,o){return e[o.id]=o.resource.get("uri"),e},{}));var l,m=s.resource.content,f=[],g=v.reject(m,function(e){return e.type===p.FILTER_GROUP?(l=e,!0):e.type===p.INPUT_CONTROL?(f.push(e),!0):!1});l&&f.length&&(f=v.sortBy(f,"position"),m=g.concat(l,f)),v.forEach(m,function(o){h.add(c(o,{resource:e.resources.get(o.resource),collection:n.components,dashboardId:e.dashboardId||e.cid}))}),i&&i.resource&&h.setPositionFromHtml(i.resource.content),n.components.set(h.models,{merge:!0,remove:!0,add:!0})}r&&(n.wiring.set(v.map(t(r,n),function(e){return new a(v.omit(e,"consumers"),{component:n.components.get(e.component),consumers:e.consumers})})),v.each(r,function(e){n.wiring.get(e.producer).consumers.set(e.consumers)}))})},clone:function(e){var o=new this.constructor({},{dashboardId:e});return o.applyJsonState(this.toJSON(!0)),o},applyJsonState:function(e){var o={};v.each(e.resources,function(e){"file"in e.resource&&(o[e.name]=e.resource.file.content,delete e.resource.file.content)}),this.set(e),v.each(e.resources,function(e){e.name in o&&(e.resource.file.content=o[e.name])}),this.updateResourceCollection(),this.resources.forEach(function(e){e.get("name")in o&&e.resource.set("content",o[e.get("name")])}),this.updateFoundationCollection()}})});