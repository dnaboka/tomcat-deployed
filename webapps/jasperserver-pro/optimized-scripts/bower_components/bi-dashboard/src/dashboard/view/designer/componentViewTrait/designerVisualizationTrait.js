define(["require","underscore","./designerAdhocViewTrait","dashboard/view/designer/AdhocDesignerIframeView","dashboard/mapper/adHocToDashboardTypeMapper","../../../collection/ReportsParametersCollection","../../../enum/dashboardComponentTypes","../../../enum/dashletTechnicalOutputs","bundle!DashboardBundle"],function(e){"use strict";function o(e){return t.map(e||[],function(e){return{id:e.id,uri:e.uri,label:e.label}})}function n(e){return t.filter(e||[],function(e){return-1===t.indexOf(l,e.id)})}var t=e("underscore"),r=e("./designerAdhocViewTrait"),i=e("dashboard/view/designer/AdhocDesignerIframeView"),d=e("dashboard/mapper/adHocToDashboardTypeMapper"),a=e("../../../collection/ReportsParametersCollection").instance,s=e("../../../enum/dashboardComponentTypes"),c=e("../../../enum/dashletTechnicalOutputs"),u=e("bundle!DashboardBundle"),l=t.values(c);return t.extend({},r,{additionalContextMenuOptions:[{label:u["dashboard.context.menu.option.edit"],action:"edit"}],_initComponentSpecificContextMenuEvents:function(){this.listenTo(this.contextMenu,"option:edit",this._editComponent)},_reInitDashlet:function(){this._removeComponent(),this.model.resetCaching(),this._initComponent()},_editComponent:function(){function e(){r.stopListening(c),c.remove()}var r=this,c=new i({model:this.model});r.listenTo(c,"close",function(){e()}),r.listenTo(c,"save",function(i,c){e(),r.model.changeType(d(c.type)),r._reInitDashlet(),r.listenTo(a,"change:inputControl",function(e){r.model.resource.resource.get("uri")===e.id&&(r.stopListening(a,"change:inputControl"),a.getReportParameters(r.model.resource.resource.get("uri"),{force:!0}).done(function(e,i){r.model.set({outputParameters:o(n(i)),parameters:o(e)}),r.model.getReportResourceUri().done(function(){r.paramsModel.paramsChanged||r.refresh(),t.invoke(r.model.collection.where({type:s.FILTER_GROUP}),"notify",!0)})}))}),a.getReportControls(r.model.resource.resource.get("uri"),{force:!0}).done(function(e){var o=t.pluck(r.model.get("parameters"),"id"),n=t.pluck(e,"id"),i=t.difference(o,n),d=r.model.collection.where({type:s.INPUT_CONTROL,ownerResourceId:r.model.resource.id});r.model.collection.remove(t.reduce(d,function(e,o){return t.indexOf(i,o.getOwnerParameterName())>=0&&e.push(o),e},[]))}),r.model.trigger("edit",r.model)}),c.render()}})});