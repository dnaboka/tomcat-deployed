define(["require","exports","module","jquery","underscore","bundle!CommonBundle","./DashboardOverlayDialog","common/component/dialog/Dialog","../base/CanvasView","text!../../template/designerCanvasTemplate.htm","./AdhocDesignerIframeView","../base/DashboardMessageView","dashboard/model/DashboardResourceModel","bi/repository/model/RepositoryResourceModel","dashboard/model/component/DashletModel","dashboard/view/designer/ParameterMenu","dashboard/factory/dashboardComponentModelFactory","dashboard/view/designer/AddDashboardComponentDialogController","../../factory/dashboardComponentViewFactory","dashboard/enum/dashboardComponentTypes","dashboard/dashboardSettings","dashboard/enum/dashboardResourceReferenceTypes","bi/repository/enum/repositoryResourceTypes","../../dashboardMessageBus","../../enum/dashboardMessageBusEvents","dashboard/mapper/adHocToDashboardTypeMapper","logger","jquery-ui/jquery.ui.droppable"],function(e,o,t){"use strict";function n(e){function o(e){delete e.version,s.each(s.keys(e),function(t){s.isObject(e[t])&&o(e[t])})}e.unset("version"),o(e.attributes)}function i(e,o,t){if(!s.isObject(e))return e;var n=s.keys(e)[0],i=e[n];return n==t||r(i,o)||(i=e[t]=s.pick(i,"uri"),delete e[n]),i}function r(e,o){return 0===(e.uri||"").indexOf(o)}var a=e("jquery"),s=e("underscore"),d=e("bundle!CommonBundle"),l=e("./DashboardOverlayDialog"),h=(e("common/component/dialog/Dialog"),e("../base/CanvasView")),p=e("text!../../template/designerCanvasTemplate.htm"),c=e("./AdhocDesignerIframeView"),u=e("../base/DashboardMessageView"),g=e("dashboard/model/DashboardResourceModel"),m=e("bi/repository/model/RepositoryResourceModel"),f=(e("dashboard/model/component/DashletModel"),e("dashboard/view/designer/ParameterMenu")),C=e("dashboard/factory/dashboardComponentModelFactory"),y=e("dashboard/view/designer/AddDashboardComponentDialogController"),b=(e("../../factory/dashboardComponentViewFactory"),e("dashboard/enum/dashboardComponentTypes")),D=e("dashboard/dashboardSettings"),v=e("dashboard/enum/dashboardResourceReferenceTypes"),T=e("bi/repository/enum/repositoryResourceTypes"),_=e("../../dashboardMessageBus"),w=e("../../enum/dashboardMessageBusEvents"),I=e("dashboard/mapper/adHocToDashboardTypeMapper"),R=e("logger").register(t);return e("jquery-ui/jquery.ui.droppable"),h.extend({isDesigner:!0,el:function(){return this.$rootEl=a(s.template(p,{i18n:d})),this.$rootEl.find(".dashboardCanvas")[0]},addComponentByTypeHandlerMap:function(){var e={};return e[b.WEB_PAGE_VIEW]=this._addWebPageView,e[b.FREE_TEXT]=this._addFreeText,e[b.IMAGE]=this._addImage,e[b.CHART]=this._addNewVisualization,e[b.CROSSTAB]=this._addNewVisualization,e[b.TABLE]=this._addNewVisualization,e[b.FILTER_GROUP]=this._addInputControl,e},initialize:function(e){s.bindAll(this,"_addWebPageView","_addFreeText","_addImage","_addNewVisualization","_addDefaultComponentType","_addInputControl"),h.prototype.initialize.apply(this,arguments),this.strategy=e.strategy,this.message=new u,this.$el.append(this.message.$el),this._initGrid(),this.strategy.initVisualHelpers(this.$el),this.$el.droppable({accept:".draggable",activeClass:"ui-dropping",tolerance:"pointer",drop:s.bind(this._onCanvasDrop,this)}),this.filterDialog.$el.droppable({accept:".draggable",activeClass:"ui-dropping",tolerance:"pointer"}),this.listenTo(this.model.currentFoundation,"addComponent",function(e){e.get("type")===b.DASHBOARD_PROPERTIES&&this.listenTo(e,"change:dashletFilterShowPopup",this.changeFloatingFilterGroup,this)},this),s.bindAll(this,"_onGlobalMousedown","_onGlobalKeydown"),a(document).on("mousedown",this._onGlobalMousedown),a(document).on("keydown",this._onGlobalKeydown),this.$overlay=new l({content:d["dialog.overlay.loading"]}),this.listenTo(this.model.currentFoundation,"addComponent",function(e){e.get("type")===b.DASHBOARD_PROPERTIES&&(this.listenTo(e,"change:useFixedSize change:fixedWidth change:fixedHeight",this.applyCanvasSize,this),this.listenTo(e,"change:canvasColor",this.applyCanvasColor,this))},this)},enableAutoRefresh:function(){},addComponentView:function(e){var o=h.prototype.addComponentView.call(this,e);return o&&this.listenTo(o,"delete",this.removeComponent),o},addFloatingGroupView:function(e){h.prototype.addFloatingGroupView.apply(this,arguments),this.listenTo(e.model,"change:floating",this.convertFloatingGroupView),this.listenTo(e.model,"change:name",this.updateFloatingGroupViewTitle),this.listenTo(e,"delete",this.removeComponent)},changeFloatingFilterGroup:function(e){!e.get("dashletFilterShowPopup")&&this.filterDialog.$el.is(":visible")&&this.filterDialog.close()},convertFloatingGroupView:function(e){e.get("floating")?this.dashletToPopup(e):this.popupToDashlet(e)},updateFloatingGroupViewTitle:function(e){this.filterDialog.updateTitle(e.get("name"))},popupToDashlet:function(e){if(e.get("type")===b.FILTER_GROUP){var o,t,n=this.getComponentViewByComponentId(e.id),i=a(".dashboardCanvas > div.content > div.body"),r=this.model.currentFoundation.components.get(e.id);if(o=this.model.currentFoundation.components.filter(function(o){return 0===o.get("x")&&0===o.get("y")&&o.get("type")!==e.get("type")}),o=1==o.length?o[0]:void 0,this.filterDialog.close(),o){var d=o.getPositionObject();t=s.clone(d),t.height>t.width?(t.height=parseInt(t.height/2),t.y+=t.height):(t.width=parseInt(t.width/2),t.x+=t.width),o.set(t)}else t=this.strategy.calculateEmptyArea({x:0,y:0,height:1,width:1},e.id);n&&this.filterDialog.$el.find(n.$el.parent()).length>0&&(i.append(n.$el.parent()),this.strategy.updateLayout(r.id,{x:0,y:0,height:t.height,width:t.width}),this.model.currentFoundation.trigger("moveComponent",r,this.model.currentFoundation),n._onComponentMove(),n.resizeContentContainer())}},dashletToPopup:function(e){if(e.get("type")===b.FILTER_GROUP){var o=this.getComponentViewByComponentId(e.id);o&&o.$el.parents().length>0&&(this.filterDialog.updateTitle(e.get("name")),this.filterDialog.$el.find(this.filterDialog.contentContainer).append(o.$el.parent()),this.listenTo(o.model,"change:name",this.updateFloatingGroupViewTitle))}},_onCanvasDrop:function(e,o){var t=a(e.originalEvent.target);if(t.hasClass("dashboardCanvas")||t.parents(".dashboardCanvas").length||t.hasClass(".filterGroup.dialog.open")||t.parents(".filterGroup.dialog.open").length||t.is(".helper.filter-dialog-drop")){var n=this,i=o.helper.data("data");if(i.componentId){var r=this.model.currentFoundation.components.get(i.componentId),d=r.getPositionObject();this.strategy.onDashletDrop(r,e,o,this.$el),s.isEqual(r.getPositionObject(),d)||_.trigger(w.SAVE_DASHBOARD_STATE)}else{if(i.resourceType===T.INPUT_CONTROL&&(this.model.currentFoundation.components.findWhere({resource:i.uri})||this.model.currentFoundation.components.find(function(e){return e.get("type")===T.INPUT_CONTROL&&e.getOwnerUri()===i.ownerResourceId&&e.getOwnerParameterName()===i.id})))return;this.$overlay.open(),this.addComponent(i).done(function(t){t.get("type")===b.FILTER_GROUP&&t.getChildren().length>=2||i.resourceType==b.INPUT_CONTROL&&n.model.currentFoundation.components.getDashboardPropertiesComponent().get("dashletFilterShowPopup")||n.strategy.onDashletDrop(t,e,o,n.$el),a.when(t.paramsDfd||{}).always(function(){n.$overlay.close()}).done(function(){_.trigger(w.SAVE_DASHBOARD_STATE)})})}}},_onGlobalMousedown:function(e){var o,t=this.model.currentFoundation.components,n=t.getSelectedComponent();if(n&&(o=n.get("id"))&&n.isVisible()){var i=this.getComponentViewByComponentId(o).$el,r=i.offset(),s=e.pageX-r.left,d=e.pageY-r.top;s>0&&s<i.width()&&d>0&&d<i.height()||a(e.target).closest("."+D.DASHLET_PROPERTIES_DIALOG_CLASS).length||a(e.target).closest("."+D.DELETE_CONFIRMATION_DIALOG_CLASS).length||a(e.target).closest("."+D.CONTEXT_MENU_CLASS).length||t.selectComponent(void 0)}},_onGlobalKeydown:function(e){46!==e.which||a(e.target).closest("."+D.DASHLET_PROPERTIES_DIALOG_CLASS).length||a(e.target).closest("."+D.SAVE_AS_DIALOG_CLASS).length||a(e.target).find("."+D.SAVE_AS_DIALOG_CLASS+":visible").length||this.removeComponent(this.model.currentFoundation.components.getSelectedComponent())},_initAddComponentDialogEvents:function(e,o,t){var n=this;this.listenTo(this.addComponentDialogController.dialog,"button:ok",function(){t&&t.call(n,e),n.closeAddComponentDialog(),n.model.currentFoundation.components.add(e),n.model.currentFoundation.components.selectComponent(e),o.resolve(e)}),this.listenTo(this.addComponentDialogController.dialog,"button:cancel",function(){n.closeAddComponentDialog(),o.reject(e)})},addComponent:function(e){var o,t,n=this.model.contextPath,i=this.model.currentFoundation.components,r=a.Deferred();if(e.resourceType===T.INPUT_CONTROL){var s=i.findWhere({type:b.FILTER_GROUP});t=s||C({type:b.FILTER_GROUP,name:d["dashboard.component.filter.group.component.name"]||"Filter Group"},{collection:i,dashboardId:this.dashboardId})}else e.uri&&e.resourceType&&(o=this.model.resources.get(e.uri),o||(o=g.createDashboardResource(e,n))),t=C(e,{resource:o,collection:i,dashboardId:this.dashboardId},{createComponentObj:!0});var l=this.addComponentByTypeHandlerMap()[t.get("type")]||this._addDefaultComponentType;return l(t,r,e),r.promise()},addInputControlToFilterGroup:function(e,o){var t=this.model.currentFoundation.components;if(!t.findWhere({resource:e.uri})){var n;e.uri&&e.resourceType&&(this.model.resources.get(e.ownerResourceId)||this.model.resources.each(function(o){o.resource.get("uri")===e.ownerResourceId&&(e.ownerResourceId=o.get("name"))}),n=this.model.resources.get(e.uri),n||(n=g.createDashboardResource(e,this.model.contextPath)));var i=t.get(o),r=i.getChildren(),a=r.length?Math.max.apply(null,s.map(r,function(e){return e.get("position")}))||0:0,d=C(e,{resource:n,collection:t,dashboardId:this.dashboardId},{createComponentObj:!0});return d.set({ownerResourceId:e.ownerResourceId,ownerResourceParameterName:e.ownerResourceParameterName,masterDependencies:e.masterDependencies,fullCollectionRequired:e.mandatory&&!!e.masterDependencies.length,parentId:o,position:a+1}),t.add(d)}},openAddComponentDialog:function(e){this.$overlay.close(),f.useModel(this.model),this.addComponentDialogController=new y(e),this.addComponentDialogController.dialog.open()},closeAddComponentDialog:function(){this.stopListening(this.addComponentDialogController.dialog),this.addComponentDialogController.dialog.close(),this.addComponentDialogController.remove()},openAdhocDesignerIframe:function(e){this.adhocDesigner&&this.removeAdhocDesignerIframe(),this.adhocDesigner=new c({model:e}),this.adhocDesigner.render()},removeAdhocDesignerIframe:function(){this.stopListening(this.adhocDesigner),this.adhocDesigner.remove()},hideAdhocDesignerIframe:function(){this.stopListening(this.adhocDesigner),this.adhocDesigner.hide(),this.adhocDesigner.removeSubComponents(),this.adhocDesigner.detachEvents()},remove:function(){try{this.$el.droppable("destroy")}catch(e){R.debug(e)}this.addComponentDialogController&&this.addComponentDialogController.remove(),this.adhocDesigner&&this.adhocDesigner.remove(),this.$overlay.remove(),this.message.remove(),a(document).off("mousedown",this._onGlobalMousedown),a(document).off("keydown",this._onGlobalKeydown),h.prototype.remove.apply(this,arguments)},removeComponent:function(e){if(e&&(this.model.currentFoundation.components.selectComponent(void 0),this.model.currentFoundation.components.remove(e),_.trigger(w.SAVE_DASHBOARD_STATE),e.get("type")===b.INPUT_CONTROL)){var o=this.getComponentViewByComponentId(e.get("parentId"));o&&o.refreshFilterGroup();var t=this.model.currentFoundation.components.findWhere({resource:e.get("ownerResourceId")});this.getComponentViewByComponentId(t.id).render()}},applyCanvasSize:function(){h.prototype.applyCanvasSize.apply(this,arguments),s.each(this.componentViews,function(e){var o=e.model.getParent();!o||o.get("floating")||e.render()})},_initGrid:function(){var e,o,t=a("<div>").addClass("grid").hide();for(e=1;e<D.GRID_WIDTH;e++)o=this.strategy.cellToCoord(e,0),a("<div>").appendTo(t).css({width:"1px",height:"100%",left:o.x+"%"});for(e=1;e<D.GRID_HEIGHT;e++)o=this.strategy.cellToCoord(0,e),a("<div>").appendTo(t).css({width:"100%",height:"1px",top:o.y+"%"});this.$el.append(t)},_addWebPageView:function(e,o){this.openAddComponentDialog(e),this.addComponentDialogController.dialog.disableButton("ok"),this._initAddComponentDialogEvents(e,o,function(e){e.set("name",e.generateName(e.get("url")))})},_addFreeText:function(e,o){this.openAddComponentDialog(e),this._initAddComponentDialogEvents(e,o)},_addImage:function(e,o){this.openAddComponentDialog(e),this.addComponentDialogController.dialog.disableButton("ok"),this._initAddComponentDialogEvents(e,o)},_addNewVisualization:function(e,o){var t=this,n=this.model.contextPath,i=this.model.currentFoundation.components;this.$overlay.close(),this.openAdhocDesignerIframe(e),this.listenTo(this.adhocDesigner,"close",function(){t.removeAdhocDesignerIframe(),o.reject(e)}),this.listenTo(this.adhocDesigner,"save",function(e,r){t.hideAdhocDesignerIframe(),r.type=I(r.type),r.resourceType=T.ADHOC_DATA_VIEW;var a=g.createDashboardResource(r,n),s=C(r,{resource:a,collection:i,dashboardId:t.dashboardId},{createComponentObj:!0});i.add(s),i.selectComponent(s),o.resolve(s)})},_addInputControl:function(e,o,t){var r=this,a=this.model.currentFoundation.components,d=function(){var n=r.addInputControlToFilterGroup(t,e.get("id"));n&&a.selectComponent(n),n&&n.set("label",n.get("name")),o.resolve(e)};if(-1===a.indexOf(e)&&a.add(e),t.ownerResourceId+"_files/"+t.ownerResourceParameterName==t.uri){var l=new m({uri:t.uri},{contextPath:r.model.contextPath});l.fetch({expanded:!0}).done(function(){var e=new g({},{contextPath:r.model.contextPath}),o={},a=l.get("uri");l.unset("uri"),l.set("label",r._generateControlId(t.id)),i(l.get("dataType"),a,"dataTypeReference"),i(l.get("listOfValues"),a,"listOfValuesReference");var s=i(l.get("query"),a,"queryReference");s&&i(s.dataSource,a,"dataSourceReference"),n(l),o[v.INPUT_CONTROL]=l.attributes,e.set({name:a,type:b.INPUT_CONTROL,resource:o}),e.resource.resource=l,r.model.resources.add(e),d()}).fail(s.bind(o.reject,o))}else d()},_addDefaultComponentType:function(e,o,t){var n=this.model.currentFoundation.components;-1===n.indexOf(e)&&n.add(e),n.selectComponent(e),o.resolve(e)},_generateControlId:function(e){function o(e){return!i.model.currentFoundation.components.find(function(o){return o.resource&&o.resource.resource.get("label")===e})}function t(e,n){var i=e+"_"+n;return o(i)?i:t(e,n+1)}var n=2,i=this;if(o(e))return e;if(/.*_\d+$/.match(e)){var r=e.lastIndexOf("_");n=+e.substring(r+1)+1,e=e.substring(0,r)}return t(e,n)}})});