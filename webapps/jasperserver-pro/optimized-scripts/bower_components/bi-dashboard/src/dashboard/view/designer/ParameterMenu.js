define(["require","underscore","jquery","dashboard/model/parameters/ParameterParser","text!dashboard/template/parameterMenuOptionTemplate.htm","bundle!DashboardBundle","../../enum/dashboardWiringStandardIds","common/component/menu/AttachableMenu"],function(e){"use strict";function t(e,t,n){return s.map(e,function(e){if(e.component){var s=t.get(e.component);e.consumer=n.id+":"+e.substitution,e.consumerApply=n.id+":"+c.APPLY_SLOT,s.getParent()&&(e.label=o(s.get("name")),s=s.getParent()),e.componentLabel=o(l["dashboard.context.menu.option.from"].replace("{0}",s.get("name")))}else e.componentLabel="";return e})}function o(e){return e.length>60&&(e=e.substring(e,57)+"..."),e}function n(e){var t=d.dashboardModel.currentFoundation.wiring,o=t.get(e.producer);o&&!o.consumers.get(e.consumer)&&(o.consumers.add({consumer:e.consumer}),o.component.get("parentId")?t.get(o.component.get("parentId")+":"+c.REFRESH_SIGNAL).consumers.add({consumer:e.consumerApply}):o.consumers.add({consumer:e.consumerApply}))}var s=e("underscore"),i=e("jquery"),r=e("dashboard/model/parameters/ParameterParser"),a=e("text!dashboard/template/parameterMenuOptionTemplate.htm"),l=e("bundle!DashboardBundle"),c=e("../../enum/dashboardWiringStandardIds"),h=e("common/component/menu/AttachableMenu"),d=h.extend({initialize:function(e,t){var o=this;e||(e={}),e.optionTemplate=a,h.prototype.initialize.call(this,e,t),s.bindAll(this,"onKey"),this.$attachTo.on("keydown",this.onKey),this.$el.on("scroll",function(){o.$attachTo.focus()}),this.on("all",function(e,t,s){if(0===e.indexOf("option")){var i=o.$attachTo.val(),r=s.get("newCursorPos");if(o.$attachTo.val(i.substring(0,s.get("begin"))+s.get("substitution")+i.substring(s.get("end"))),o.$attachTo[0].setSelectionRange)o.$attachTo[0].setSelectionRange(r,r);else if(o.$attachTo[0].createTextRange){var a=o.$attachTo[0].createTextRange();a.collapse(!0),a.moveEnd("character",r),a.moveStart("character",r),a.select()}s.has("consumer")&&s.has("producer")&&n(s.attributes),o.$attachTo.trigger("input",s.attributes)}}),this.on("mouseover",function(e){var t=this.collection.findWhere({over:!0});e.model!==t&&(t&&t.set({over:!1}),e.model.set({over:!0}))}),this.on("mouseout",function(e){e.model.set({over:!1})})},hide:function(){h.prototype.hide.apply(this,arguments),this.remove()},remove:function(){this.$attachTo.off("keydown",this.onKey),this.off("all"),h.prototype.remove.apply(this,arguments)},moveDown:function(){for(var e=!1,t=0;t<this.collection.models.length&&!e;t++)if(this.collection.models[t].get("over")&&(e=!0,t+1<this.collection.models.length&&(this.collection.models[t].set({over:!1}),this.collection.models[t+1].set({over:!0}),this.maxSize))){var o=this.options[0].$el.height();(t+1)*o>=this.el.scrollTop+this.maxSize*o&&(this.el.scrollTop+=o)}!e&&this.collection.models.length&&(this.collection.models[0].set({over:!0}),this.el.scrollTop=0)},moveUp:function(){for(var e=!1,t=0;t<this.collection.models.length&&!e;t++)if(this.collection.models[t].get("over")&&(e=!0,t-1>=0&&(this.collection.models[t].set({over:!1}),this.collection.models[t-1].set({over:!0}),this.maxSize))){var o=this.options[0].$el.height();(t-1)*o<=this.el.scrollTop&&(this.el.scrollTop=(t-1)*o)}!e&&this.collection.models.length&&(this.collection.models[this.collection.models.length-1].set({over:!0}),this.el.scrollTop=0)},onKey:function(e){27==e.keyCode?(this.hide(),e.stopPropagation()):40==e.keyCode?(this.moveDown(),e.preventDefault()):38==e.keyCode?(this.moveUp(),e.preventDefault()):13==e.keyCode&&(this._enter(),e.stopPropagation())},_enter:function(e){var t=s.find(this.options,function(e){return e.model.get("over")});t&&t.select(e)}},{open:function(e,t){d.close(),d.instance=new d(e,t,void 0,{menuOptionTemplate:a,maxSize:7}),d.instance.show()},close:function(){d.instance&&d.instance.hide()},useModel:function(e){d.dashboardModel=e},onInput:function(e,o){if(!o||o.hasOptions){var n,s=i(e.currentTarget).val(),a=+e.currentTarget.selectionStart,l=+e.currentTarget.selectionEnd,c=s.length-1;a>=0&&a===l&&(c=l),n=r.completionOptions(s,c,{wiring:d.dashboardModel.currentFoundation.wiring}),n.length?d.open(t(n,d.dashboardModel.currentFoundation.components,this.model),e.currentTarget):d.close()}else d.close()}});return d});