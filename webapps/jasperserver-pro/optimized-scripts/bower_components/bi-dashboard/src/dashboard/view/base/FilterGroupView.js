define(["require","jquery","underscore","backbone","bundle!CommonBundle","dashboard/dashboardSettings","text!../../template/filterGroupButtonsTemplate.htm","domReady"],function(t){"use strict";var e=t("jquery"),i=t("underscore"),s=t("backbone"),o=t("bundle!CommonBundle"),n=t("dashboard/dashboardSettings"),r=t("text!../../template/filterGroupButtonsTemplate.htm"),h=(t("domReady"),{APPLY:"applyButton",RESET:"resetButton",FILTERS_PER_ROW:"filtersPerRow",BUTTONS_POSITION:"buttonsPosition",FLOATING:"floating"}),l="filterRow",a="fluid",d="fixed",u="right",f="oneButton";return s.View.extend({initialize:function(){i.bindAll(this,"_onWindowResize"),this.listenTo(this.model,"change",this._onPropertiesChange),e(window).on("resize",this._onWindowResize)},render:function(){this.$footer=this.$el.parent().append(i.template(r,{i18n:o})).find(".filterGroupButtons"),this.$applyButton=this.$footer.find("[data-target='"+h.APPLY+"']"),this.$resetButton=this.$footer.find("[data-target='"+h.RESET+"']"),this.$applyButton.on("click",i.bind(this.model.notify,this.model,!0)),this.$resetButton.on("click",i.bind(this._onResetClick,this)),this._setButtonsVisibility()},remove:function(){return this.$applyButton&&this.$applyButton.off("click"),this.$resetButton&&this.$resetButton.off("click"),e(window).off("resize",this._onWindowResize),s.View.prototype.remove.apply(this,arguments)},resizeInputControlsWidth:function(t){if(0!==this.$el.width()){var e=this.$el.width()/this.$el.outerWidth()*100,i=Math.floor(e/(t||this.model.get(h.FILTERS_PER_ROW)))+"%";this.$el.find(".inputControlWrapper").css({width:i})}},wrapInputControls:function(){var t=this.model.get(h.FILTERS_PER_ROW),i=this.$el.find(".inputControlWrapper"),s=i.length;this.removeEmptyRows(),this.unwrapInputControls(i);for(var o=0;s>o;o+=t){var n=e("<div/>",{"class":l}),r=i.filter(function(e){return e>=o&&o+t>e});r.wrapAll(n)}},refresh:function(){this.wrapInputControls(),this.refreshFilterGroupLayout(this.model.get(h.BUTTONS_POSITION))},unwrapInputControls:function(t){t=t||this.$el.find(".inputControlWrapper"),i.each(t,function(t){e(t).parent().hasClass(l)&&e(t).unwrap()})},removeEmptyRows:function(){var t=this.$el.find("."+l);i.each(t,function(t){!e(t).children().length&&e(t).remove()})},refreshFilterGroupLayout:function(t){var e=this.$el.find("."+l),s=this.$el.parent().height(),o=this.$el.css("padding"),n=this;t===u&&(this.model.get("resetButton")||this.model.get("applyButton"))?(e.addClass(a),this.$footer.addClass(d),this.$el.css({"float":"left",height:this.isFloating()?"auto":s-2*o+"px"}),this.model.get(h.APPLY)&&this.model.get(h.RESET)?(this.$footer.removeClass(f),e.removeClass(f)):(this.$footer.addClass(f),e.addClass(f))):(e.length&&e.removeClass(a).removeClass(f),this.$footer&&this.$footer.removeClass(f).removeClass(d),this.$el.css({"float":"none",height:this.isFloating()?"auto":this.$footer.is(":visible")?s-this.$footer.outerHeight(!0)+"px":s})),this.isFloating()&&i.defer(i.bind(this.setFloatingStyle,n))},enableButtons:function(){this.$applyButton&&this.$applyButton.removeAttr("disabled"),this.$resetButton&&this.$resetButton.removeAttr("disabled")},disableButtons:function(){this.$applyButton&&this.$applyButton.attr("disabled","disabled"),this.$resetButton&&this.$resetButton.attr("disabled","disabled")},isFloating:function(){return this.model.get("floating")},setFloatingStyle:function(){var t=this.$el.parents("["+n.COMPONENT_ID_ATTRIBUTE+"='"+this.model.id+"']");t.css({height:"auto",width:"auto",position:""}),t.find(".dashletContent > .content").css({height:"100%",width:"100%"}),t.hasClass("ui-resizable")&&t.resizable("destroy")},_onResetClick:function(){this.model.isMute=!0;var t=this.model.id;i.each(this.componentViews,function(e){var i=e.model.getParent();i&&i.id===t&&e.reset()}),this.model.isMute=!1,this.model.notify(!0)},_onWindowResize:function(t){if(this.isFloating()){var i=this.$el.parents("["+n.COMPONENT_ID_ATTRIBUTE+"='"+this.model.id+"']");i.css({maxHeight:e(".dashboardContainer").height()})}},_onPropertiesChange:function(){var t=this.model.changedAttributes();t&&((h.APPLY in t||h.RESET in t)&&(this._setButtonsVisibility(),this.refreshFilterGroupLayout(this.model.get(h.BUTTONS_POSITION))),h.FILTERS_PER_ROW in t&&(this.resizeInputControlsWidth(),this.refresh()),h.BUTTONS_POSITION in t&&this.refreshFilterGroupLayout(t[h.BUTTONS_POSITION]),h.FLOATING in t&&(t[h.FLOATING]?(this.resizeInputControlsWidth(1),this.refresh(),this.refreshFilterGroupLayout("bottom"),this.setFloatingStyle()):(this.resizeInputControlsWidth(),this.refresh())))},_setButtonsVisibility:function(){i.each(h,function(t){this["$"+t]&&this._setButtonVisibility(t)},this),this.model.get(h.APPLY)||this.model.get(h.RESET)?this.$footer.show():this.$footer.hide()},_setButtonVisibility:function(t){var e=this["$"+t];this.model.get(t)?e.show():e.hide()}})});