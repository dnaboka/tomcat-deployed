define(["require","underscore","bundle!DashboardBundle","bundle!CommonBundle","bi/repository/model/RepositoryResourceModel","common/component/dialog/DialogWithModelInputValidation","common/component/dialog/ConfirmationDialog","dashboard/factory/repositoryFolderTreeFactory","dashboard/enum/dashboardResourceReferenceTypes","dashboard/dashboardSettings","bi/repository/enum/repositoryResourceTypes","text!dashboard/template/saveDialogContentTemplate.htm","text!dashboard/template/tooltip/saveDialogTooltipTemplate.htm","common/component/notification/Notification"],function(e){"use strict";function o(e){var o=e.toJSON();delete o.uri,delete o.permissionMask,delete o.updateDate,delete o.creationDate,delete o.version;var t=new s(o,{contextPath:e.contextPath,type:d.DASHBOARD});return t.validation=e.validation,t}var t=e("underscore"),a=e("bundle!DashboardBundle"),i=e("bundle!CommonBundle"),s=e("bi/repository/model/RepositoryResourceModel"),n=e("common/component/dialog/DialogWithModelInputValidation"),r=e("common/component/dialog/ConfirmationDialog"),l=e("dashboard/factory/repositoryFolderTreeFactory"),c=(e("dashboard/enum/dashboardResourceReferenceTypes"),e("dashboard/dashboardSettings")),d=e("bi/repository/enum/repositoryResourceTypes"),h=e("text!dashboard/template/saveDialogContentTemplate.htm"),m=e("text!dashboard/template/tooltip/saveDialogTooltipTemplate.htm"),u=e("common/component/notification/Notification");return n.extend({constructor:function(e){e||(e={}),n.prototype.constructor.call(this,{modal:!0,resizable:!0,minWidth:c.SAVE_AS_DIALOG_MIN_WIDTH,minHeight:c.SAVE_AS_DIALOG_MIN_HEIGHT,alsoResize:".treeBox",model:e.model,additionalCssClasses:"saveAs",title:a["dashboard.dialog.save.title"],content:t.template(h)({i18n:a}),buttons:[{label:i["button.save"],action:"save",primary:!0},{label:i["button.cancel"],action:"cancel",primary:!1}]}),this.on("button:save",t.bind(this._onSaveDialogSaveButtonClick,this)),this.on("button:cancel",t.bind(this._onSaveDialogCancelButtonClick,this))},initialize:function(e){var o=this;n.prototype.initialize.apply(this,arguments),this.disableButton("save"),this.foldersTree=l({contextPath:this.model.contextPath,tooltipContentTemplate:m}),this.notification=new u,this.listenTo(this.foldersTree,"selection:change",function(e){var a;e&&t.isArray(e)&&e[0]&&e[0].uri&&(a=e[0].uri),o.model.set("parentFolderUri",a),o.enableButton("save")}),this.$contentContainer.find(".control.groupBox .body").append(this.foldersTree.render().el),this.confirmationDialog=new r({title:a["dashboard.confirm.dialog.save.title"],text:a["dashboard.save.conflict"]}),this.listenTo(this.confirmationDialog,"button:yes",this._onSaveFromDialogConfirm)},open:function(){var e=this;this.enableButton("cancel"),this.original=this.model,this.model=o(this.model),this.bindValidation(),this.model&&t.each(this.model.attributes,function(o,t){e.$("[name="+t+"]").val(o)}),n.prototype.open.apply(this,arguments)},close:function(){this.foldersTree&&(this.foldersTree.collapse("@fakeRoot",{silent:!0}),this.foldersTree.collapse("/public",{silent:!0}),this.foldersTree.resetSelection()),this.original&&(this.model=this.original,this.original=void 0),this.unbindValidation(),this.clearValidationErrors(),this.disableButton("save"),n.prototype.close.apply(this,arguments)},save:function(){this.model.isNew()?this.saveAs():this.model.save({},{createFolders:!1,expanded:!0,success:t.bind(function(e,o){this._saveAjaxSuccessCallback(e,o)},this),error:t.bind(function(e,o,t){this._saveAjaxErrorCallback(e,o,t)},this)})},remove:function(){this.notification.remove(),this.foldersTree.remove(),this.confirmationDialog.remove(),n.prototype.remove.apply(this,arguments)},saveAs:function(){this.open()},_onSaveDialogCancelButtonClick:function(){this.close()},_onSaveDialogSaveButtonClick:function(){var e=this,o=this.model;o.isValid(!0)&&(o.set("name",s.generateResourceName(o.get("label"))),e.buttons.getOptionView("save").disable(),o.save({},{createFolders:!1,expanded:!0,success:t.bind(this._saveFromDialogAjaxSuccessCallback,this),error:function(o,t,a){409===t.status||400===t.status&&t.responseJSON&&"resource.already.exists"===t.responseJSON.errorCode?e.confirmationDialog.open():e._saveFromDialogAjaxErrorCallback(o,t,a),e.buttons.getOptionView("save").enable()}}))},_saveFromDialogAjaxErrorCallback:function(e,o,t){this._saveAjaxErrorCallback(e,o,t)},_saveAjaxErrorCallback:function(e,o,t){var i;switch(o.status){case 404:i=a["dashboard.notification.message.not.found"];break;case 403:i=a["dashboard.notification.message.access.denied"];break;case 401:i=a["dashboard.notification.message.not.authenticated"];break;default:i=a["dashboard.notification.message.unknown.error"]}this.notification.show({message:i})},_saveAjaxSuccessCallback:function(e,o){this.model.updateResourceCollection(),this.trigger("save",this),this.notification.show({message:a["dashboard.notification.message.saved"],type:"success"})},_saveFromDialogAjaxSuccessCallback:function(e,o){this.close(),this.model.set(this.model.parse(o)),this._saveAjaxSuccessCallback(e,o)},_onSaveFromDialogConfirm:function(){this.disableButton("save"),this.disableButton("cancel"),this.model.save({},{createFolders:!1,overwrite:!0,expanded:!0,success:t.bind(this._saveFromDialogAjaxSuccessCallback,this),error:t.bind(this._saveFromDialogAjaxErrorCallback,this)})}})});