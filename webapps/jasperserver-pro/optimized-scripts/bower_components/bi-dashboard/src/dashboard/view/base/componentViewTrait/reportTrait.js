define(["require","exports","module","underscore","jquery","bundle!jasperserver_messages","bundle!DashboardBundle","logger","bi/report/Report","common/component/menu/HoverMenu","common/component/notification/Notification","common/component/dialog/LoadingDialog","common/component/pagination/Pagination","common/component/webPageView/WebPageView","dashboard/enum/dashboardWiringStandardIds","../../../dashboardSettings","./dashletTrait","dashboard/hyperlink/defaultLinkOptions","bi/report/enum/scaleStrategies","bi/report/jive/enum/hyperlinkTypes","dashboard/factory/sandboxFactory","bi/report/enum/reportOutputFormats","common/util/browserDetection","text!dashboard/template/menuContainerTemplate.htm","text!dashboard/template/menuOptionTemplate.htm"],function(e,t,n){"use strict";function o(e,t,n,o,i){var r;if(e===M.WIDTH)r=o/t;else if(e===M.HEIGHT)r=i/n;else{var a=o/t,s=i/n;r=i>a*n?a:s}return r}function i(e){var t=this;this.component&&this.component["export"]({outputFormat:"html",pages:2}).done(function(){var n=t.component.data().totalPages;t.paginationView||0===n?n>1&&t._refreshPagination(n,e):(t._initPagination({total:n,silent:!0,validate:!1}),t.paginationView.$el.find(".next, .prev, .first").prop("disabled",!1))})}function r(e){return e.$("> .dashletContent > .content > ._jr_report_container_ > .highcharts_parent_container").length>0}function a(e,t){e.name===j.REFRESH_SLOT?(this.paramsModel.paramsChanged&&(this.paramsModel.paramsChanged=!1,this.component.params(s(this))),this.refresh()):e.name===j.APPLY_SLOT&&this.paramsModel.paramsChanged&&(this.paramsModel.paramsChanged=!1,this.component.params(s(this)),this.paginationView&&this.paginationView.model.set("current",this.paginationView.model.defaults.current),this.refresh())}function s(e){var t=b.reduce(e.model.get("parameters"),function(e,t){return t.parametrizeProperty&&e.push(t.id),e},[]);return b.omit(e.paramsModel.attributes,t)}function d(e){var t={};for(var n in e)t[n]=b.isArray(e[n])?e[n]:[e[n]];return t}function l(e){if(e){var t=this.dashboardId?S.get(this.dashboardId).get("linkOptions")||{}:{},n={events:{}},o=this;for(var i in t.events)n.events[i]=function(e,n){var i="jr_hyperlink_interception"===e.eventType?"click":e.type.toLowerCase();t.events[i]&&t.events[i].call(o.component,e,n,b.bind(k.events[i],o.component,e,n,o))};for(var i in k.events)n.events.hasOwnProperty(i)||(n.events[i]=function(e,t){var n="jr_hyperlink_interception"===e.eventType?"click":e.type.toLowerCase();k.events[n]&&k.events[n].call(o.component,e,t,o)});return n.beforeRender=function(e){k.discoverHyperlinkHandlers(e).done(function(){t.beforeRender?t.beforeRender.call(o.component,e,b.bind(k.beforeRender,o.component,e,o)):k.beforeRender.call(o.component,e,o)})},n}}function p(){this.drilldownComponent&&(this.drilldownComponent instanceof T?this.drilldownComponent.remove():this.drilldownComponent.destroy(),this.drilldownComponent=null)}function h(e){try{if(!b.isUndefined(this.pages())&&e&&e.model&&this.pages()!==e.model.get("current")){var t=parseInt(b.isObject(this.pages())?this.pages().pages:this.pages(),10);!isNaN(t)&&e.model.set("current",t)}}catch(n){"already.destroyed.error"!==n.errorCode&&P.error(n.toString())}}function c(e){e>1?this.paginationView?this._refreshPagination(e):this._initPagination({total:e}):this.paginationView&&this.paginationView.hide()}function m(e,t,n){var o=this,i=new R({resource:e,container:this.$content,params:t,autoresize:!1,server:F.CONTEXT_PATH,showAdhocChartTitle:!0,scale:this.model.get("scaleToFit"),pages:b.isObject(n)&&b.isUndefined(n.pages)&&b.isUndefined(n.anchor)||b.isUndefined(n)?1:n,events:{changeTotalPages:b.bind(c,o),changePagesState:function(e){o.paginationView?o.paginationView.model.set("current",e):!b.isUndefined(this.data().totalPages)&&this.data().totalPages>1&&o._initPagination({current:e});var t=this.pages(),n=b.isObject(t)?{pages:e}:e;b.isObject(t)&&!b.isUndefined(t.anchor)&&(n.anchor=t.anchor),this.pages(n)},reportCompleted:function(){h.call(this,o.paginationView)},beforeRender:function(){o.hideMessage(),o.component===this&&o.drilldownComponent&&(p.call(o),c.call(o,this.data().totalPages),h.call(this,o.paginationView))}},defaultJiveUi:{floatingTableHeadersEnabled:!0,floatingCrosstabHeadersEnabled:!0}});return this.dashboardId&&i.properties(S.get(this.dashboardId).get("reportSettings")||{}),i}function u(e){this.hideMessage(),e!==!1&&this.trigger("componentRendered",self),!r(this)&&this._resetContentOverflow(this._calculateContentOverflow(this)),!this.$content.find(".jrPage").length&&this.showMessage({errorCode:"report.empty.error"})}function g(e){"report.execution.cancelled"!==e.errorCode&&(this.paginationView&&this.paginationView.hide(),this.$content.empty(),this.showMessage(e),this.ready.resolve())}function f(e,t){b.isUndefined(t)||e.pages(t).run().done(b.bind(u,this)).fail(b.bind(g,this))}function w(e,t,n,o){var i=b.extend({},o),r=b.template("{{= contextPath }}/rest_v2/reports{{= resource }}.{{= output }}{{= params }}");return!b.isUndefined(n.pages)&&(i.pages=n.pages),!b.isUndefined(n.anchor)&&(i.anchor=n.anchor),"xlsNoPag"===t&&(i.ignorePagination=!0,t="xls"),"xlsxNoPag"===t&&(i.ignorePagination=!0,t="xlsx"),r({contextPath:F.CONTEXT_PATH,resource:e,output:t,params:b.isEmpty(i)?"":"?"+C.param(i,!0)})}function v(e,t){var n={outputFormat:e,pages:t};return"xlsNoPag"===e&&(n.outputFormat="xls"),"xlsxNoPag"===e&&(n.outputFormat="xlsx"),n}var b=e("underscore"),C=e("jquery"),x=b.extend(e("bundle!jasperserver_messages"),e("bundle!DashboardBundle")),P=e("logger").register(n),R=e("bi/report/Report"),_=e("common/component/menu/HoverMenu"),y=e("common/component/notification/Notification"),O=e("common/component/dialog/LoadingDialog"),V=e("common/component/pagination/Pagination"),T=e("common/component/webPageView/WebPageView"),j=e("dashboard/enum/dashboardWiringStandardIds"),F=e("../../../dashboardSettings"),k=(e("./dashletTrait"),e("dashboard/hyperlink/defaultLinkOptions")),M=e("bi/report/enum/scaleStrategies"),I=e("bi/report/jive/enum/hyperlinkTypes"),S=e("dashboard/factory/sandboxFactory"),E=e("bi/report/enum/reportOutputFormats"),L=e("common/util/browserDetection"),U=e("text!dashboard/template/menuContainerTemplate.htm"),H=e("text!dashboard/template/menuOptionTemplate.htm"),$=[{label:x["jasper.report.view.hint.export.pdf"],action:"pdf",params:{outputFormat:"pdf"}},{label:x["jasper.report.view.hint.export.excel"],action:"excel",params:{outputFormat:"xls"}},{label:x["jasper.report.view.hint.export.excel.nopag"],action:"excel.nopag",params:{outputFormat:"xls",ignorePagination:!0}},{label:x["jasper.report.view.hint.export.rtf"],action:"rtf",params:{outputFormat:"rtf"}},{label:x["jasper.report.view.hint.export.csv"],action:"csv",params:{outputFormat:"csv"}},{label:x["jasper.report.view.hint.export.odt"],action:"odt",params:{outputFormat:"odt"}},{label:x["jasper.report.view.hint.export.ods"],action:"ods",params:{outputFormat:"ods"}},{label:x["jasper.report.view.hint.export.docx"],action:"docx",params:{outputFormat:"docx"}},{label:x["jasper.report.view.hint.export.xlsx"],action:"xlsx",params:{outputFormat:"xlsx"}},{label:x["jasper.report.view.hint.export.xlsx.nopag"],action:"xlsx.nopag",params:{outputFormat:"xlsx",ignorePagination:!0}},{label:x["jasper.report.view.hint.export.pptx"],action:"pptx",params:{outputFormat:"pptx"}}],N=function(){var e={};return e["input.controls.validation.error"]=function(e){return[x["dashboard.dashlet.error."+e.errorCode]].concat(e.parameters).join("<br/>")},function(t){var n=e[t.errorCode];return n?n(t):x["dashboard.dashlet.error."+t.errorCode]||x["dashboard.dashlet.error.unexpected.error"]}}();return{_onViewInitialize:function(){var e=this;if(this.$el.addClass("dashboardVisualization"),this.paramsModel.on("change",function(t){var n=b.reduce(e.model.get("parameters"),function(e,t){return t.parametrizeProperty&&e.push(t.id),e},[]);b.difference(b.keys(t.changed),n).length&&(this.paramsChanged=!0)}),this.listenTo(this.model,"signal",b.bind(a,this)),this.model.lastPayload)for(var t in this.model.lastPayload)a.call(this,{name:t,value:this.model.lastPayload[t]},this.model.lastSender[t])},updateReportLinkOptions:function(){this.component&&this.component.linkOptions(l.call(this,this.component)||{}),this.drilldownComponent&&this.drilldownComponent instanceof R&&this.drilldownComponent.linkOptions(l.call(this,this.drilldownComponent)||{})},updateReportSettings:function(){this.component&&this.component.properties(S.get(this.dashboardId).get("reportSettings")||{}),this.drilldownComponent&&this.drilldownComponent instanceof R&&this.drilldownComponent.properties(S.get(this.dashboardId).get("reportSettings")||{})},exportAs:function(e){var t=this.drilldownComponent&&this.drilldownComponent instanceof R?this.drilldownComponent:this.component,n=new O({cancellable:!1});n.open(),t["export"](e).done(function(e){window.open(e.href)}).fail(function(){y.show({message:x["dashboard.dashlet.error.report.export.failed"]})}).always(function(){n.close(),n.remove()})},_initComponent:function(){var e=this;if(b.bindAll(this,"updateReportLinkOptions","updateReportSettings"),this.dashboardId){var t=S.get(this.dashboardId);t.on("linkOptions",this.updateReportLinkOptions),t.on("reportSettings",this.updateReportSettings)}this.model.getReportResourceUri().done(function(t,n){n?(e._broken=!0,g.call(e,n)):(e.component=m.call(e,t,{}),e.updateReportLinkOptions())})},_removeComponent:function(e){var t=e?e.sessionExpired:!1;if(!t&&this.isReportRan&&this.component.destroy(),this.component=null,p.call(this),this.isReportRan=!1,this.dashboardId){var n=S.get(this.dashboardId);n.off("linkOptions",this.updateReportLinkOptions),n.off("reportSettings",this.updateReportSettings)}this._removePagination(),this.exportMenu&&this.exportMenu.remove()},_renderComponent:function(){if(this.drilldownComponent&&this.drilldownComponent instanceof T?(this.paginationView&&(this.paginationView.hide(),this.resizeContentContainer()),this.drilldownComponent.render(this.$content),this.trigger("componentRendered",this)):this.drilldownComponent&&this.drilldownComponent instanceof R?(this.drilldownComponent.render(b.bind(this.trigger,this,"componentRendered",this)),!r(this)&&this._resetContentOverflow(this._calculateContentOverflow())):this.isReportRan&&(this.component.render(b.bind(this.trigger,this,"componentRendered",this)),!r(this)&&this._resetContentOverflow(this._calculateContentOverflow())),this.toolbar){var e=this;this.exportMenu=new _($,this.toolbar.getOptionView("export").$el,null,{menuContainerTemplate:U,menuOptionTemplate:H}),b.each($,function(t){e.listenTo(e.exportMenu,"option:"+t.action,function(){e.exportMenu.hide(),e.exportAs(t.params)})})}},_resizeComponent:function(){this.drilldownComponent?this.drilldownComponent instanceof R&&this.isReportRan&&(this.drilldownComponent.resize(),!r(this)&&this._resetContentOverflow(this._calculateContentOverflow())):this.component&&this.isReportRan&&(this.component.resize(),!r(this)&&this._resetContentOverflow(this._calculateContentOverflow()))},notify:function(e){var t=b.reduce(this.model.get("outputParameters"),function(t,n){var o=e[n.id];return o&&(t||(t={}),t[n.id]=b.isArray(o)?o:[o]),t},!1);t&&(this.model.notify(t),this.model.collection.getDashboardPropertiesComponent().applyParameters())},drilldown:function(e){var t,n=e.parameters?d(e.parameters):void 0,o=e.parameters&&!b.isUndefined(e.parameters._output)?e.parameters._output:void 0,i=this;if(b.isUndefined(e.pages)||(t={pages:e.pages}),b.isUndefined(e.anchor)||(t=b.extend({anchor:e.anchor},t)),e.type===I.REFERENCE){if(p.call(this),e.href.indexOf("javascript:")>-1)return;this.drilldownComponent=new T({url:e.href}),this.render()}else if(e.type===I.REPORT_EXECUTION)if(b.isUndefined(o)||o===E.HTML)e.resource===this.component.resource()?(p.call(this),n?(this.component.params(n),this.refresh().done(b.bind(f,this,this.component,t))):f.call(this,this.component,t)):this.drilldownComponent&&this.drilldownComponent instanceof R&&e.resource===this.drilldownComponent.resource()?n?this.drilldownComponent.params(n).refresh().done(b.bind(f,this,this.drilldownComponent,t)).fail(b.bind(g,this)):f.call(this,this.drilldownComponent,t):(p.call(this),this.paginationView&&this.paginationView.hide(),this.paginationView&&this.resizeContentContainer(),this.drilldownComponent=m.call(this,e.resource,n,t),this.updateReportLinkOptions(),this.drilldownComponent.run().done(b.bind(u,this)).fail(b.bind(g,this)));else if(b.isUndefined(t)&&(t={}),L.isIOS()){var r=document.createElement("a");r.setAttribute("href",w(e.resource,o,t,n)),r.setAttribute("target","_blank");var a=document.createEvent("HTMLEvents");a.initEvent("click",!0,!0),r.dispatchEvent(a)}else{var s=v(o,t),l=new R({resource:e.resource,params:n,server:F.CONTEXT_PATH,showAdhocChartTitle:!0,ignorePagination:"xlsNoPag"===o||"xlsxNoPag"===o,pages:b.isUndefined(t.pages)&&b.isUndefined(t.anchor)?1:t});l.run().done(function(){l["export"](s).done(function(e){var t=e.href||e;i.dashboardId&&S.get(i.dashboardId).get("previewMode")&&S.get(i.dashboardId).set("disablePageLeaveConfirmation",!0),window.location.href=t,i.dashboardId&&S.get(i.dashboardId).get("previewMode")&&b.defer(function(){S.get(i.dashboardId).set("disablePageLeaveConfirmation",!1)})}).always(function(){l.destroy()})})}},refresh:function(){this.toolbar&&this.toolbar.getOptionView("export").disable();var e=this,t=new C.Deferred,n=this.cancel();return n.always(function(){e.isReportRan?e.ready.done(function(){e.isReportRunning=!0,p.call(e),e.component.refresh().fail(t.reject).done(function(){i.call(e,{resetCurrent:!0}),u.call(e,!1),t.resolve()})}):(e.isReportRunning=!0,e.component?e.component.run().fail(t.reject).done(function(){e.isReportRan=!0,i.call(e),e.resizeContentContainer(),u.call(e),t.resolve()}):(e._broken||e.hideMessage(),t.resolve()))}),t.fail(b.bind(g,this)).always(b.bind(this._onReportRunFinished,this)),t},cancel:function(){return this.isReportRunning&&this.component?this.component.cancel():(new C.Deferred).resolve()},_initPagination:function(e){var t=this,n=this.paginationView=new V(e);this.listenTo(n,"pagination:change",function(e){var o=t.drilldownComponent&&t.drilldownComponent instanceof R?t.drilldownComponent:t.component;o.pages(e).run().done(b.bind(function(){n.options.silent&&n.$el.find(".current").val(e)},this)).fail(b.bind(function(){n.model.set("current",n.model.defaults.current)},this)).always(b.bind(this._onReportRunFinished,this))}),this.$content.before(n.render().$el),!this.model.get("showPaginationControl")&&n.hide()},_refreshPagination:function(e,t){var n={total:e};t&&t.resetCurrent&&(n.current=this.paginationView.model.defaults.current),this.paginationView.resetSetOptions(),this.paginationView.model.set(n),this.model.get("showPaginationControl")&&this.paginationView.show()},_resetContentOverflow:function(e){var e=e||{};this.$content.css({"overflow-x":e.overflowX||"auto","overflow-y":e.overflowY||"auto"})},_calculateContentOverflow:function(){var e="auto",t="auto",n=this.$content.find(".jrPage"),i=n.outerWidth(),r=n.outerHeight(),a=this.$content.outerWidth(),s=this.$content.outerHeight(),d=this.model.get("scaleToFit"),l=1!==d?o(d,i,r,a,s):1;return a>=Math.floor(i*l)&&(e="hidden"),s>=Math.floor(r*l)&&(t="hidden"),{overflowX:e,overflowY:t}},_removePagination:function(){this.paginationView&&(this.stopListening(this.paginationView),this.paginationView.remove(),this.paginationView=null)},_onComponentRendered:function(){this.model.set("isAdhocChart",r(this))},_onReportRunFinished:function(){this.isReportRunning=!1,this.$el.addClass("rendered"),this.toolbar&&this.toolbar.getOptionView("export").enable()},_onComponentPropertiesChange:function(){this.model.hasChanged("scaleToFit")&&(this.component.scale(this.model.get("scaleToFit")),this._renderComponent(),this._resetContentOverflow(this._calculateContentOverflow())),this.model.hasChanged("showPaginationControl")&&this.paginationView&&(this.model.get("showPaginationControl")&&this.paginationView.model.get("total")>1?(this.paginationView.show(),this.resizeContentContainer()):this.model.get("showPaginationControl")||(this.paginationView.hide(),this.resizeContentContainer()))},_errorMessageFactory:N}});