define(["require","exports","module","underscore","jquery","bundle!DashboardBundle","logger","text!../../../template/dashletTemplate.htm","../../../enum/dashboardWiringStandardIds","../../../enum/dashboardComponentTypes","common/component/base/OptionContainer","text!../../../template/dashletToolbarButtonTemplate.htm","text!../../../template/dashletToolbarTemplate.htm"],function(t,e,o){"use strict";function s(t){t.name===l.APPLY_SLOT?this.updateTitle():i.indexOf(i.values(l),t.name)<0&&(i.isUndefined(t.value)?this.paramsModel.unset(t.name):this.paramsModel.set(t.name,t.value))}var i=t("underscore"),a=t("jquery"),n=t("bundle!DashboardBundle"),h=t("logger").register(o),r=t("text!../../../template/dashletTemplate.htm"),l=t("../../../enum/dashboardWiringStandardIds"),d=t("../../../enum/dashboardComponentTypes"),c=t("common/component/base/OptionContainer"),p=t("text!../../../template/dashletToolbarButtonTemplate.htm"),m=t("text!../../../template/dashletToolbarTemplate.htm");return{template:i.template(r),_onViewInitialize:function(){var t=this.model.get("type");if(this.$dashlet=this.$("> .dashletContent"),this.$content=this.$("> .dashletContent > .content"),this.on("componentRendered",i.bind(this._toggleDashletToolbarButtons,this)),this.on("componentRendered",function(){this.ready.resolve()},this),this.paramsModel=this.model.paramsModel,this.listenTo(this.model,"signal",s),this.model.lastPayload)for(var e in this.model.lastPayload)s.call(this,{name:e,value:this.model.lastPayload[e]},this.model.lastSender[e]);(t===d.FREE_TEXT||t===d.IMAGE)&&(this.listenTo(this.model,"change:showDashletBorders",this._setDashletVisualAppearance),this.listenTo(this.model,"change:borderColor",this._setDashletVisualAppearance))},_onViewRender:function(){this._setDashletVisualAppearance(),this.model.isVisualization()&&(this._initToolbar(),this._setDashletToolbarVisualAppearance()),this.component&&this.component.isFloating&&this.component.isFloating()||i.defer(i.bind(this.resize,this))},_onViewResize:function(){this.component&&this.component.isFloating&&this.component.isFloating()||this.resizeContentContainer()},resizeContentContainer:function(){this.$content.height(this.$dashlet.height()-2*this.dashboardProperties.get("dashletPadding")-(this.toolbar&&this.toolbar.$el.is(":visible")?this.toolbar.$el.outerHeight(!0):0)-(this.paginationView&&this.paginationView.$el.is(":visible")?this.paginationView.$el.outerHeight(!0):0)-(this.component&&this.component.$footer&&this.component.$footer.is(":visible")?this.component.$footer.hasClass("fixed")?0:this.component.$footer.outerHeight(!0):0))},updateTitle:function(){this.toolbar&&this.toolbar.$(".innerLabel > p").text(this.model.getParametrizationResult("name",this.paramsModel.attributes,{tolerateMissing:!0}))},refresh:function(){return a.Deferred().resolve()},cancel:function(){return a.Deferred().resolve()},_initToolbar:function(){this.toolbar&&this.toolbar.remove(),this.toolbar=new c({options:[{cssClass:"maximizeDashletButton",action:"maximize",title:n["dashlet.toolbar.button.maximize"],text:"",disabled:!0,hidden:!1},{cssClass:"text cancelDashletButton",action:"cancel",title:n["dashlet.toolbar.button.cancel"],text:n["dashlet.toolbar.button.cancel"],hidden:!0},{cssClass:"refreshDashletButton",action:"refresh",title:n["dashlet.toolbar.button.refresh"],text:"",disabled:!0,hidden:!1},{cssClass:"exportDashletButton",action:"export",title:n["dashlet.toolbar.button.export"],text:"",disabled:!0,hidden:!1}],contextName:"button",contentContainer:".buttons",mainTemplate:m,optionTemplate:p}),this.updateTitle(),this.listenTo(this.toolbar,"button:refresh",this._onRefreshClick),this.listenTo(this.toolbar,"button:maximize",this._onMaximizeClick),this.listenTo(this.toolbar,"button:cancel",this._onCancelClick),this.listenTo(this.model,"change:name",this.updateTitle),this.$dashlet.prepend(this.toolbar.$el)},_setDashletToolbarVisualAppearance:function(t){this.toolbar&&(this.toolbar[this.model.get("showTitleBar")?"show":"hide"](),this.toolbar.getOptionView("refresh")[this.model.get("showRefreshButton")?"show":"hide"](),this.toolbar.getOptionView("maximize")[this.model.get("showMaximizeButton")?"show":"hide"](),this.toolbar.getOptionView("export")[this.model.get("showExportButton")?"show":"hide"](),t&&"showTitleBar"in t&&this.resize())},_setDashletVisualAppearance:function(){this._setColors(),this._setBorders()},_setBorders:function(){var t,e=this.model.get("type");switch(e){case d.FREE_TEXT:case d.IMAGE:t=this.model.get("showDashletBorders"),t&&this.$dashlet.css("border","1px solid "+this.model.get("borderColor"));break;default:t=this.dashboardProperties.get("showDashletBorders")}t?this.$dashlet.css("border-width","1px"):this.$dashlet.css("border-width","0");var o=this.dashboardProperties.get("dashletMargin");if(!t)try{var s=parseInt(this.$dashlet.css("border-width"),10);o-=isNaN(s)?0:s}catch(i){}this.$el.css("padding",o+"px"),this.$content.css("padding",this.dashboardProperties.get("dashletPadding")+"px")},_setColors:function(){var t=this.model.get("type"),e=this,o=(this.dashboardProperties.get("canvasColor"),this.dashboardProperties.get("titleBarColor")),s=this.dashboardProperties.get("titleTextColor");setTimeout(function(){switch(t){case d.REPORT:case d.ADHOC_VIEW:case d.WEB_PAGE_VIEW:case d.CHART:case d.TABLE:case d.IMAGE:case d.CROSSTAB:e.$dashlet.find(".dashletToolbar").css("background-color",o),e.$dashlet.find(".dashletToolbar p").css("color",s)}},0)},_onMaximizeClick:function(){this.model.isVisualization()&&this.model.set("maximized",!this.model.get("maximized"))},_toggleDashletToolbarButtons:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").enable(),this.toolbar.getOptionView("maximize").enable(),this.toolbar.getOptionView("export").enable())},_onRefreshClick:function(t){this._hideRefreshButton(),this.refresh().always(i.bind(this._showRefreshButton,this))},_onCancelClick:function(){var t=this;this.cancel().done(function(){h.debug("canceled dashlet refresh"),t._showRefreshButton()})},_enableRefreshButton:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").enable(),this.toolbar.getOptionView("cancel").hide())},_disableRefreshButton:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").disable(),this.toolbar.getOptionView("cancel").show())},_hideRefreshButton:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").hide(),this.toolbar.getOptionView("cancel").show())},_showRefreshButton:function(){this.toolbar&&(this.toolbar.getOptionView("refresh").show(),this.toolbar.getOptionView("cancel").hide())},_errorMessageFactory:function(t){return n["dashboard.dashlet.error."+t.errorCode]},_onPropertiesChange:function(){var t=this.model.changedAttributes();t&&("showTitleBar"in t||"showRefreshButton"in t||"showExportButton"in t||"showMaximizeButton"in t)&&this._setDashletToolbarVisualAppearance(t),this._onComponentPropertiesChange&&this._onComponentPropertiesChange(t)},showMessage:function(t){if(t&&t.errorCode){var e=this._errorMessageFactory(t);e?this.$(".nothingToDisplay").removeClass("hidden").show().find(".message").text(e):h.warn("Unhandled message: "+t.toString())}},hideMessage:function(){this.$(".nothingToDisplay").addClass("hidden").hide()},_onViewRemove:function(){this.toolbar&&this.toolbar.remove()},addOverlay:function(){this.$overlay||(this.$overlay=a("<div></div>").addClass("overlay"),this.$dashlet.prepend(this.$overlay),this.$content.on("mousedown",function(t){t.stopPropagation()}))}}});