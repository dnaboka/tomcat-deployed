define(["require","exports","module","./CollectionView","common/component/dialog/Dialog","../../../collection/filterManager/WiringProducerViewModelCollection","../../../model/filterManager/WiringProducerViewModel","../ParameterMenu","./WiringProducerView","../../../model/component/ValueDashboardComponentModel","../../../enum/dashboardComponentTypes","../../../enum/dashboardWiringStandardIds","underscore","text!../../../template/filterManager/filterManagerTemplate.htm","bundle!DashboardBundle","bundle!CommonBundle"],function(e,n,t){"use strict";function o(e){var n=e.filter(function(e){return e.isParametrized()});return h.map(n,function(e){return{name:e.get("name"),id:e.get("id"),parameters:e.get("parameters")}})}var i=e("./CollectionView"),r=e("common/component/dialog/Dialog"),a=e("../../../collection/filterManager/WiringProducerViewModelCollection"),c=e("../../../model/filterManager/WiringProducerViewModel"),l=e("../ParameterMenu"),s=e("./WiringProducerView"),d=e("../../../model/component/ValueDashboardComponentModel"),u=e("../../../enum/dashboardComponentTypes"),m=e("../../../enum/dashboardWiringStandardIds"),h=e("underscore"),p=e("text!../../../template/filterManager/filterManagerTemplate.htm"),f=e("bundle!DashboardBundle"),g=e("bundle!CommonBundle");return r.extend({events:h.extend({"click a.addNewFilter":"addNewFilter"},r.prototype.events),constructor:function(e){e||(e={}),this.foundation=e.model,this.dashboardId=e.dashboardId,r.prototype.constructor.call(this,{buttons:[{label:g["button.ok"],action:"ok",primary:!0},{label:g["button.cancel"],action:"cancel",primary:!1}],title:f["dashboard.filter.manager.title"],additionalCssClasses:"filterManagerDialog",additionalBodyCssClasses:"jr-uMaxheight-500px",modal:!0,resizable:!1,content:new i({template:p,templateOptions:{i18n:f},modelView:s,modelViewOptions:{consumers:o(this.foundation.components)},contentContainer:"tbody",collection:new a})}),this.on("button:ok",this.applyWiringChanges),this.on("button:cancel",this.close),this.on("open",h.bind(l.close,l)),this.listenTo(this.content.collection,"change:id",function(){this.content.collection.sort(),this.content.render()})},applyWiringChanges:function(){if(this.content.collection.isValid(!0)){var e=this,n=h.reduce(e.content.collection.models,function(e,n){return h.findWhere(e,{id:n.component.id})||e.push(n.component),e},[]),t=this.foundation.components.filter(function(e){return!e.isValueProducer()});this.foundation.components.set(n.concat(t)),this.foundation.wiring.each(function(n){n.component.isValueProducer()&&n.consumers.set(e.content.collection.get(n.id).consumers.map(function(e){return{consumer:e.get("id")+":"+e.get("parameter")}}))});var o=this.foundation.wiring.findWhere({name:m.REFRESH_SIGNAL}),i=[];o&&(e.content.collection.each(function(n){n.component.getParent()&&n.consumers.each(function(n){var t=e.foundation.components.get(n.get("id"));t.isParametrized()&&i.push(n.get("id"))})}),o.consumers.set(h.map(h.uniq(i),function(e){return{consumer:e+":"+m.APPLY_SLOT}}))),h.invoke(this.foundation.components.where({type:u.FILTER_GROUP}),"notify",!0),this.close()}},render:function(){return r.prototype.render.apply(this,arguments),this},open:function(){this.content.collection.reset(a.createFromDashboardWiringCollection(this.foundation.wiring,this.foundation.components).models),this.content._modelViewOptions={consumers:o(this.foundation.components)},this.content.collection.sort(),r.prototype.open.call(this,{renderContent:!0})},close:function(){this.content.collection.reset(),r.prototype.close.apply(this,arguments)},addNewFilter:function(e){e.stopPropagation(),e.preventDefault();var n=new c({group:f["dashboard.filter.manager.manually.created.filters"]||"Manually Created Filters"}),t=new d({},{dashboardId:this.dashboardId});t.collection=this.foundation.components,t.unset("id"),t.unset("name"),t.unset("label"),n.component=t,this.content.collection.add(n,{silent:!0,sort:!1}),this.content.collection.forEach(h.bind(function(e){e.collection=this.content.collection},this)),this.content.collection.sort(),this.content.render()}})});