define(["require","common/view/mixin/epoxyViewMixin","underscore","jquery","common/component/panel/Panel","bundle!DashboardBundle","bundle!CommonBundle","bi/report/enum/scaleStrategies","dashboard/enum/dashboardComponentTypes","common/component/dialog/ConfirmationDialog","dashboard/factory/propertiesDialogTabsFactory","text!dashboard/template/properties/propertiesPanelTemplate.htm","text!dashboard/template/properties/propertiesPanelTabButtonTemplate.htm","text!dashboard/template/properties/controls/availableParametersTemplate.htm","text!dashboard/template/tooltip/sideBarTreeLeafTooltipTemplate.htm","common/component/panel/trait/tabbedPanelTrait","bi/repository/enum/repositoryResourceTypes","dashboard/view/mixin/parameterExpressionAutocompletionMixin","dashboard/hyperlink/parameters/view/HyperlinkParametersSectionView","bi/repository/dialog/resourceChooser/RepositoryChooserDialogFactory"],function(e){"use strict";function o(e,t,i,r,s){var a=e.indexOf(i,t);return 0>a?s.push(e.substr(t)):(s.push(e.substring(t,a)),s.push(i),o(e,i.length+a,r,i,s)),s}function t(e,o,t,r){for(var s,n,l=2;l<e.length;l+=4){s=i(e[l]),n=!1;for(var h=0;!n&&h<o.length;h++)for(var p=0;!n&&p<s.length;p++)a.trim(s[p])===o[h][t]&&(s[p]=s[p].replace(o[h][t],o[h][r]),n=!0);e[l]=s.join("")}return e.join("")}function i(e){for(var o=[],t=[],i=!1,r=0;r<e.length;r++)'"'!==e[r]||e[r-1]&&"\\"===e[r-1]||(i=!i),i||","!==e[r]&&"?"!==e[r]?t.push(e[r]):(o.push(t.join("")),o.push(e[r]),t=[]);return o.push(t.join("")),o}var r=e("common/view/mixin/epoxyViewMixin"),s=e("underscore"),a=e("jquery"),n=e("common/component/panel/Panel"),l=e("bundle!DashboardBundle"),h=e("bundle!CommonBundle"),p=e("bi/report/enum/scaleStrategies"),d=e("dashboard/enum/dashboardComponentTypes"),m=e("common/component/dialog/ConfirmationDialog"),c=e("dashboard/factory/propertiesDialogTabsFactory"),u=e("text!dashboard/template/properties/propertiesPanelTemplate.htm"),g=e("text!dashboard/template/properties/propertiesPanelTabButtonTemplate.htm"),y=e("text!dashboard/template/properties/controls/availableParametersTemplate.htm"),b=e("text!dashboard/template/tooltip/sideBarTreeLeafTooltipTemplate.htm"),C=e("common/component/panel/trait/tabbedPanelTrait"),f=e("bi/repository/enum/repositoryResourceTypes"),T=e("dashboard/view/mixin/parameterExpressionAutocompletionMixin"),D=e("dashboard/hyperlink/parameters/view/HyperlinkParametersSectionView"),v=e("bi/repository/dialog/resourceChooser/RepositoryChooserDialogFactory"),x=function(){s.size(this.tabs)>1?(this.$contentContainer.addClass("bordered"),this.$("> .header").show()):(this.$contentContainer.removeClass("bordered"),this.$("> .header").hide())},P=n.extend({events:{"click button.showGoToFilterManagerConfirmationDialog":"showGoToFilterManagerConfirmationDialog","click button.showRepositoryChooserDialog":"showRepositoryChooserDialog","click button.showRepositoryChooserFileDialog":"showRepositoryChooserFileDialog"},bindingFilters:{scaleStrategy:function(e){var o=Number(e);return isNaN(o)?e:o}},computeds:{fitToDashlet:{deps:["scaleToFit"],get:function(e){return s.contains(s.values(p),e)}},parameters:{deps:["dashletHyperlinkUrl"],get:function(e){if(!s.isUndefined(e)){var i=o(e,0,"$P{","}",[]);return t(i,this.getBinding("outputParameters")||[],"id","label")}return""},set:function(e){var i,r={},a=this.model;s.isUndefined(e)?r.dashletHyperlinkUrl=e:(i=o(e,0,"$P{","}",[]),r.dashletHyperlinkUrl=t(i,this.getBinding("outputParameters")||[],"label","id")),this.setBinding("dashletHyperlinkUrl",r),a.validate&&a.validate(r)}},dashletHyperlinkUrlVisible:{deps:["exposeOutputsToFilterManager","dashletHyperlinkTarget"],get:function(e,o){var t=e&&""!==o;return t&&this.model.validate({dashletHyperlinkUrl:this.model.get("dashletHyperlinkUrl")}),t}},adHocChart:{get:function(){return s.contains([d.ADHOC_VIEW,d.CHART],this.model.get("type"))&&this.model.get("outputParameters")&&this.model.get("outputParameters").length}}},constructor:function(e){e||(e={}),n.call(this,s.extend({},e,{traits:[C],template:u,optionTemplate:g,tabHeaderContainerSelector:"> .header > .tabSet",toggleClass:"selected",tabs:c(e.model)}))},initialize:function(e){this.original=this.model,this.model=this.original.clone(),this.originalState=this.model.clone(),this.epoxifyView(),n.prototype.initialize.apply(this,arguments),this.listenTo(this.original,"change",this._onOriginalModelChange),this.listenTo(this.model,"change:outputParameters",this.renderAvailableParameters),this.renderAvailableParameters(),x.call(this),this.applyParameterExpressionAutocompletionMixin()},_onOriginalModelChange:function(){var e=this.original.changedAttributes();e&&(this.model.set(e),this.model.validate(e),"isAdhocChart"in e&&x.call(this))},open:function(){n.prototype.open.apply(this,arguments),this.applyEpoxyBindings()},renderAvailableParameters:function(){var e=this,o=this.model.get("type");o===d.FREE_TEXT||o===d.IMAGE?(this.hyperlinkParametersSectionView||(this.hyperlinkParametersSectionView=new D,this.$(".hyperlinkParametersContainer").html(this.hyperlinkParametersSectionView.render().$el),this.listenTo(this.hyperlinkParametersSectionView.collection,"add change remove",function(){e.model.set("outputParameters",e.hyperlinkParametersSectionView.toJSON(),{silent:!0})})),this.hyperlinkParametersSectionView.reset(this.model.get("outputParameters"))):this.$(".availableParametersList").html(s.template(y,{outputParameters:this.model.get("outputParameters")}))},showGoToFilterManagerConfirmationDialog:function(){this._goToFilterManagerConfirmationDialog||(this._goToFilterManagerConfirmationDialog=new m({text:l["dashboard.component.dialog.properties.hyperlinks.go.to.filter.manager.confirmation"]}),this.listenTo(this._goToFilterManagerConfirmationDialog,"button:yes",function(){this.trigger("saveAndGoToFilterManager",this)},this)),this._goToFilterManagerConfirmationDialog.open()},showRepositoryChooserDialog:function(){var e;this.repositoryChooserDialog||(e=v.getDialog("item"),this.repositoryChooserDialog=new e({title:l["dashboard.dialog.properties.repository.chooser.title"],resourcesTypeToSelect:[f.DASHBOARD,f.REPORT_UNIT,f.ADHOC_DATA_VIEW],tooltipTemplate:b,tooltipi18n:h,cssClassItemProcessor:function(e){switch(e.value.resourceType){case f.REPORT_UNIT:e.cssClass="dashboard-existingContent-report";break;case f.ADHOC_DATA_VIEW:e.cssClass="dashboard-existingContent-adhoc-wide";break;case f.DASHBOARD:e.cssClass="dashboard-existingContent-dashboard"}return e}}),this.listenTo(this.repositoryChooserDialog,"close",function(){if(this.repositoryChooserDialog.selectedResource&&this.repositoryChooserDialog.selectedResource.resourceUri){var e={dashletHyperlinkUrl:"repo:"+this.repositoryChooserDialog.selectedResource.resourceUri};this.model.set(e),this.model.validate(e)}},this)),this.repositoryChooserDialog.open()},showRepositoryChooserFileDialog:function(){if(!this.repositoryChooserFileDialog){var e=v.getDialog("item"),o=[".pdf",".docx",".html",".ods",".odt",".csv",".pptx",".rtf",".xls",".xlsx",".svg",".xml",".jar",".jrxml",".cur",".jrtx",".properties",".css",".eot",".ttf",".woff"];this.repositoryChooserFileDialog=new e({title:l["dashboard.dialog.properties.repository.chooser.title"],resourcesTypeToSelect:["img"],resourcesTypeToSelectTree:["file"],tooltipTemplate:b,tooltipi18n:h,cssClassItemProcessor:function(e){return e.value.resourceType!==f.FILE||s.find(o,function(o){return e.value.label.toLowerCase().endsWith(o)})||(e.cssClass="dashboard-newContent-image"),e}}),this.listenTo(this.repositoryChooserFileDialog,"close",function(){if(this.repositoryChooserFileDialog.selectedResource&&this.repositoryChooserFileDialog.selectedResource.resourceUri){var e={url:"repo:"+this.repositoryChooserFileDialog.selectedResource.resourceUri};this.model.set(e),this.model.validate(e)}},this)}this.repositoryChooserFileDialog.open()},remove:function(){this.removeEpoxyBindings(),this._goToFilterManagerConfirmationDialog&&this._goToFilterManagerConfirmationDialog.remove(),this.repositoryChooserDialog&&this.repositoryChooserDialog.remove(),this.repositoryChooserFileDialog&&this.repositoryChooserFileDialog.remove(),n.prototype.remove.apply(this,arguments)}});return s.extend(P.prototype,r,T),P});