define(["require","backbone","underscore","jquery","bi/control/collection/InputControlCollection","bi/control/view/InputControlCollectionView","../../../collection/ReportsParametersCollection","bi/control/model/InputControlPropertiesModel","text!dashboard/template/inputControlWrapperTemplate.htm","dashboard/dashboardSettings"],function(e){"use strict";function t(e){return e.options?i.reduce(e.options,function(e,t){return t.selected&&e.push(t.value),e},[]):e.value}function o(e,t){i.isUndefined(e.options)?e.value=t:(t=i.isArray(t)?t:[t],i.each(e.options,function(e){e.selected=i.contains(t,e.value)}))}function n(e,t){return!i.find(e,function(e){return-1===i.indexOf(t,e)})}var i=(e("backbone"),e("underscore")),s=e("jquery"),r=e("bi/control/collection/InputControlCollection"),l=e("bi/control/view/InputControlCollectionView"),a=e("../../../collection/ReportsParametersCollection").instance,d=e("bi/control/model/InputControlPropertiesModel"),c=e("text!dashboard/template/inputControlWrapperTemplate.htm"),h=e("dashboard/dashboardSettings");return{template:i.template(c),_onViewInitialize:function(){this.$el.attr(h.COMPONENT_ID_ATTRIBUTE,this.model.get("id")),this.paramsModel=this.model.paramsModel,this.paramsModel.set(this.model.get("params"),{silent:!0}),i.bindAll("notify"),this.listenTo(this.model,"change:value",function(){if(!this._skipUISync){var e=this.model.get("value"),t=this.inputControlCollection.at(0);t.changeState(t.state.isValue&&!i.isUndefined(e)?e[0]:e)}},this),this.listenTo(this.model,"signal",function(e){i.isUndefined(e.value)?this.paramsModel.unset(e.name,{trigger:!0}):(this.paramsModel.unset(e.name,{silent:!0}),this.paramsModel.set(e.name,e.value))}),this.listenTo(this.paramsModel,"change",function(e,t){this.model.isCascadeEnabled&&this._onInputParametersChange(e,t)})},_initComponent:function(){this.inputControlPropertiesModel=new d({resource:this.model.getOwnerUri(),server:h.CONTEXT_PATH}),this.inputControlCollection=new r([],{stateModel:this.inputControlPropertiesModel}),this.component=new l({collection:this.inputControlCollection,stateModel:this.inputControlPropertiesModel}),this.component.setContainer(this.$el),this.listenTo(this.inputControlCollection,"changeState change:state",this.notify);var e=this.inputControlCollection._parseState,t=this.model.getOwnerParameterName();this.inputControlCollection._parseState=function(o){o.id===t&&e.call(this,o)}},_onInputParametersChange:function(e,t){this.model.set("params",this.paramsModel.attributes),t&&t.trigger&&this.model.collection.trigger("changedControlProperties",this.model);var o=i.keys(e.changed),s=this.getDirectParameters(),r=this;if(n(o,s)){var l=i.difference([this.model.getOwnerParameterName()].concat(this.model.get("masterDependencies")),i.keys(this.paramsModel.attributes));this.model.getParent()&&this.model.getParent().trigger("beforeChildUpdate",this),this.inputControlCollection.updateState({params:this.paramsModel.attributes},l).done(function(){r.model.applyDeferredValue()}).always(function(){r.model.getParent()&&r.model.getParent().trigger("afterChildUpdate",r)})}},_resizeComponent:function(){if(this.inputControlCollection.length>0){var e=this.inputControlCollection.at(0).id,t=this.component.controlViews[e]||{};t.resize&&t.resize()}},_renderComponent:function(){this.reset()},_removeComponent:function(){this.component.remove()},reset:function(){var e=this.inputControlCollection,n=this,s=this.model;a.getInputControlAsParameter(this.model.getOwnerUri(),this.model.getOwnerParameterName(),{full:this.model.get("fullCollectionRequired")}).done(function(r){var l=e.findWhere({id:r.id}),a=e.models&&e.models.length>0,d=l&&r.type===l.get("type");if(a&&d){var c=e.models[0];!(c.state.isValue=!r.state.options)&&c.state.options.models&&c.state.options.models.length!==r.state.options.length&&c.state.set("options",r.state.options);var h=t(r.state);c.changeState(h)}else{var p=i.extend({},r,{label:s.get("label")||r.label,slaveDependencies:[]});n.model.has("value")&&o(p.state,n.model.get("value")),e.reset([p])}n.ready.resolve()}).fail(function(){n.ready.resolve()})},getDirectParameters:function(){var e=[].concat(this.model.get("masterDependencies")),t=this.model.getOwnerUri(),o=this.model.collection.filter(function(e){return e.getOwnerUri&&!i.isUndefined(t)&&e.getOwnerUri()===t});return i.each(this.model.get("masterDependencies"),function(t){var n=i.find(o,function(e){return e.getOwnerParameterName()===t});n&&(e=i.difference(e,n.get("masterDependencies")))}),e},notify:function(){this._skipUISync=!0,this.model.acceptControlState(this.inputControlCollection.models[0].state),this._skipUISync=!1},addOverlay:function(){this.$overlay||(this.$overlay=s("<div></div>").addClass("overlay"),this.$el.prepend(this.$overlay))}}});