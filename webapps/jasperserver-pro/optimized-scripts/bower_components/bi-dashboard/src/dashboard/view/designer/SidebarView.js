define(["require","underscore","jquery","bundle!DashboardBundle","bundle!CommonBundle","backbone","../../collection/ReportsParametersCollection","common/component/tree/Tree","common/component/tree/TreeDataLayer","common/component/tree/plugin/TooltipPlugin","common/component/tree/plugin/InfiniteScrollPlugin","common/component/menu/ContextMenu","common/component/tree/plugin/ContextMenuTreePlugin","common/component/tree/plugin/DragAndDropPlugin","common/component/tree/plugin/SearchPlugin","common/component/tree/plugin/HideEmptyNodesPlugin","common/component/panel/Panel","common/component/panel/trait/collapsiblePanelTrait","common/component/panel/trait/tabbedPanelTrait","common/component/panel/trait/menuPanelTrait","common/component/panel/trait/resizablePanelTrait","dashboard/factory/dashboardComponentModelFactory","dashboard/model/DashboardResourceModel","common/component/accordion/Accordion","dashboard/enum/dashboardComponentTypes","bi/repository/enum/repositoryResourceTypes","dashboard/dashboardSettings","text!dashboard/template/sidebarTemplate.htm","text!dashboard/template/sidebarTreeLeafTemplate.htm","text!dashboard/template/tooltip/sideBarTreeLeafTooltipTemplate.htm"],function(e){"use strict";function t(e){return e.i18n=h,e}function n(e){switch(e.cssClass="dashboard-existingContent-",e.value.resourceType){case E.REPORT_UNIT:e.cssClass+="report";break;case E.ADHOC_DATA_VIEW:e.cssClass+="adhoc";break;case E.INPUT_CONTROL:e.cssClass+="filter"}return e}function r(){var e=this.libraryPanel,t=e.$("> .subcontainer").height(),n=e.$(".searchLockup").filter(":visible").outerHeight(!0);e.$("> .subcontainer").css("overflow","hidden");var r=e.$(".j-view-port-chunk").closest(".hideRoot"),o=e.$(".j-view-port-chunk").parent();if(e.selectedTab===M.FOLDERS)o.css({"max-height":""}),r.css({"max-height":t-n+"px",overflow:"auto"});else{r.css({"max-height":""}),o.css({"max-height":t-n+"px",overflow:"auto"});var i=this;l.defer(function(){i.libraryView.recalcConstraints(),i.libraryView.fetchVisibleData()})}}function o(e){if(l.contains([L.ADHOC_VIEW,L.REPORT,L.CROSSTAB,L.CHART,L.TABLE],e.get("type"))&&-1===l.indexOf(this.addedParameterContainers,e.resource.resource.get("uri"))){this.reportParametersContentPanel.content.addItem("/",{id:e.resource.resource.get("uri"),i18n:d,cssClass:"dashboard-existingContent-"+(e.get("type")===L.ADHOC_VIEW?"adhoc":"report"),value:{label:e.get("name"),uri:e.resource.resource.get("uri")},_node:!0});var t=this.reportParametersTree.getLevel(e.resource.resource.get("uri"));t.hasItems()&&this.accordion.expand(this.reportParametersContentPanel),this.listenToOnce(t,"ready",function(e){e.hasItems()&&this.accordion.expand(this.reportParametersContentPanel)},this),this.addedParameterContainers.push(e.resource.resource.get("uri"))}}function i(e){var t=this.reportParametersContentPanel.content.getLevel(e.resource.resource.get("uri"));t||(t=this.reportParametersContentPanel.content.getLevel(e.resource.id)),this.listenToOnce(t,"ready",function(){var e=!1,t=this.reportParametersContentPanel.content.getLevel("/").items;for(var n in t)e|=t[n].hasItems();e?this.accordion.expand(this.reportParametersContentPanel):this.accordion.collapse(this.reportParametersContentPanel)},this),t.refresh()}function a(e){if(e.resource){var t=l.indexOf(this.addedParameterContainers,e.resource.resource.get("uri")),n=this;if(-1===t&&(t=l.indexOf(this.addedParameterContainers,e.get("resource"))),t>-1){var r=this.model.currentFoundation.components.findWhere({resource:e.resource.resource.get("uri")});if(r||(r=this.model.currentFoundation.components.findWhere({resource:e.get("resource")})),!r){this.addedParameterContainers.splice(t,1),(!this.addedParameterContainers.length||l.all(this.addedParameterContainers,function(e){return!n.reportParametersTree.getLevel(e).hasItems()}))&&this.accordion.collapse(this.reportParametersContentPanel);var o=this.reportParametersContentPanel.content.getLevel(e.resource.resource.get("uri"));o&&o.remove()}}}}function s(e){var t=new c.Deferred,n=this;return this.predefinedData&&this.predefinedData[e.id]?t.resolve({total:this.predefinedData[e.id].length,data:this.predefinedData[e.id]}):m.getReportControls(e.id).done(function(){t.resolve({total:n.getDataSize.apply(n,arguments),data:n._process.call(n,n.getDataArray.apply(n,arguments),e)})}).fail(l.bind(t.reject,t)),t}var l=e("underscore"),c=e("jquery"),d=e("bundle!DashboardBundle"),h=e("bundle!CommonBundle"),u=e("backbone"),m=e("../../collection/ReportsParametersCollection").instance,p=e("common/component/tree/Tree"),b=e("common/component/tree/TreeDataLayer"),g=e("common/component/tree/plugin/TooltipPlugin"),f=e("common/component/tree/plugin/InfiniteScrollPlugin"),P=e("common/component/menu/ContextMenu"),T=e("common/component/tree/plugin/ContextMenuTreePlugin"),C=e("common/component/tree/plugin/DragAndDropPlugin"),y=e("common/component/tree/plugin/SearchPlugin"),v=e("common/component/tree/plugin/HideEmptyNodesPlugin"),D=e("common/component/panel/Panel"),I=e("common/component/panel/trait/collapsiblePanelTrait"),w=e("common/component/panel/trait/tabbedPanelTrait"),R=e("common/component/panel/trait/menuPanelTrait"),x=e("common/component/panel/trait/resizablePanelTrait"),S=e("dashboard/factory/dashboardComponentModelFactory"),O=e("dashboard/model/DashboardResourceModel"),_=e("common/component/accordion/Accordion"),L=e("dashboard/enum/dashboardComponentTypes"),E=e("bi/repository/enum/repositoryResourceTypes"),A=e("dashboard/dashboardSettings"),H=e("text!dashboard/template/sidebarTemplate.htm"),z=e("text!dashboard/template/sidebarTreeLeafTemplate.htm"),F=e("text!dashboard/template/tooltip/sideBarTreeLeafTooltipTemplate.htm"),V=22,M={FOLDERS:"folders",LIST:"list"},N={VIEW:"view",VISUALIZATION:"visualization"},U={folders:{bufferSize:5e3},list:{bufferSize:100,cache:{searchKey:"searchString",pageSize:100}}};return D.extend({constructor:function(e){D.call(this,l.extend({title:d["dashboard.sidebar.title"],collapserSelector:"> .button.minimize",template:H,traits:[I,x],collapsed:!1,additionalCssClasses:"jr",contentContainer:".content",closedClass:"minimized",handles:"e",minWidth:A.SIDEBAR_MIN_WIDTH,maxWidth:A.SIDEBAR_MAX_WIDTH},e))},initialize:function(e){function u(){$&&B&&this.accordion.fit()}var m=this;D.prototype.initialize.apply(this,arguments),e||(e={}),e.strategy||(e.strategy={onDashletDragStart:function(){},onDashletDrag:function(){},onDashletDragStop:function(){}});var L={i18n:h,attachTo:this.$el,contentTemplate:F};this.dashboardId=e.dashboardId,this.addedParameterContainers=[],this.filterContextMenu=new P([{label:d["dashboard.context.menu.option.add.to.filter.manager"],action:"add"},{label:d["dashboard.context.menu.option.remove.from.filter.manager"],action:"remove","default":!0}],{toggle:!0}),this.listenTo(this.filterContextMenu,"option:add",function(e,t){var n=this.filterContextMenu.treeItem.value,r=O.createDashboardResource(n),o=this.model.currentFoundation.components,i=S(n,{resource:r,collection:o,dashboardId:m.dashboardId},{createComponentObj:!0});i.set({ownerResourceId:n.ownerResourceId,ownerResourceParameterName:n.ownerResourceParameterName,masterDependencies:n.masterDependencies,fullCollectionRequired:n.mandatory&&!!n.masterDependencies.length}),!o.findWhere({resource:n.uri})&&o.add(i)}),this.listenTo(this.filterContextMenu,"option:remove",function(e,t){var n=this.filterContextMenu.treeItem.value,r=this.model.currentFoundation.components,o=r.findWhere({resource:n.uri});o&&r.remove(o)});var H=p.use(g,L).use(T,{contextMenu:this.filterContextMenu,defaultSelectedItems:function(e,t){var n=l.find(m.model.currentFoundation.wiring.models,function(t){return t.component.get("resource")===e.value.uri});return n?t[0]:void 0},showContextMenuCondition:function(e){return"dashboard-existingContent-filter-invisible"===e.cssClass?this.contextMenu:void 0}}).use(v).use(C,{onDragStart:l.bind(e.strategy.onDashletDragStart,e.strategy),onDrag:l.bind(e.strategy.onDashletDrag,e.strategy),onDragStop:l.bind(e.strategy.onDashletDragStop,e.strategy)}).create(),W=p.use(g,L).use(f).use(y,{additionalParams:{type:[E.REPORT_UNIT,E.ADHOC_DATA_VIEW]}}).use(C,{onDragStart:l.bind(e.strategy.onDashletDragStart,e.strategy),onDrag:l.bind(e.strategy.onDashletDrag,e.strategy),onDragStop:l.bind(e.strategy.onDashletDragStop,e.strategy)}).create(),m=this;this.reportParametersTree=H.instance({itemsTemplate:z,listItemHeight:V,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,predefinedData:{"/":[]},processors:[{processItem:function(e,t){return e.value.ownerResourceId=t.id,e.value.ownerResourceParameterName=e.value.id,e.value.resourceType=E.INPUT_CONTROL,e}},{processItem:n},{processItem:t},{processItem:function(e,t){return e.value.visible||(e.dragDisabled=e.cssClass+="-invisible"),e}}],getDataArray:function(e,t,n){return l.clone(e)}}),this.reportParametersTree.defaultDataLayer.obtainData=s,this.newContentTree=H.instance({itemsTemplate:z,dataUriTemplate:this.model.contextPath+"/rest_v2/settings/dashboardSettings",selection:{allowed:!0,multiple:!1},listItemHeight:V,lazyLoad:!1,rootless:!0,processors:[{processItem:t},{processItem:function(e){return e.cssClass="dashboard-newContent-"+e.value.id,e}}],getDataArray:function(e){return l.map(e.newItemsRegistry,function(e){return e.label=d[e.label]?d[e.label]:e.label,e.description=d[e.description]?d[e.description]:e.description,e})}});var k=[{processItem:function(e){return e._node=e.value.resourceType===E.FOLDER,e}},{processItem:function(e){return"folder"!==e.value.resourceType||""!==e.value._links.content?(delete e.value._links,e):void 0}},{processItem:n},{processItem:t}];this.existingContentTreeView=p.use(g,L).use(f).use(C,{onDragStart:l.bind(e.strategy.onDashletDragStart,e.strategy),onDrag:l.bind(e.strategy.onDashletDrag,e.strategy),onDragStop:l.bind(e.strategy.onDashletDragStop,e.strategy)}).use(y,{additionalParams:{type:[E.REPORT_UNIT,E.ADHOC_DATA_VIEW]}}).create().instance(l.extend({},U[M.FOLDERS],{itemsTemplate:z,listItemHeight:V,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,additionalCssClasses:"folders",dataUriTemplate:e.model.contextPath+"/rest_v2/api/resources?{{print(id != '@fakeRoot' ? 'folderUri=' + id : '')}}&recursive=false&containerType="+E.FOLDER+"&excludeFolder=/temp&offset={{- offset }}&limit={{- limit }}&forceFullPage=true",levelDataId:"uri",customDataLayers:{"/":l.extend(new b({dataUriTemplate:e.contextPath+"/flow.html?_flowId=searchFlow&method=getNode&provider=repositoryExplorerTreeFoldersProvider&uri=/&depth=1",processors:k,getDataArray:function(e){e=JSON.parse(c(e).text());var t=l.find(e.children,function(e){return"/public"===e.uri}),n=[{id:"@fakeRoot",label:e.label,uri:"/",resourceType:"folder",_links:{content:"@fakeContentLink"}}];return t&&n.push({id:"/public",label:t.label,uri:"/public",resourceType:"folder",_links:{content:"@fakeContentLink"}}),n}}),{accept:"text/html",dataType:"text"})},processors:[{processItem:function(e){return"/public"!==e.value.uri?e:void 0}}].concat(k),getDataArray:function(e,t,n){return e&&e[E.RESOURCE_LOOKUP]?e[E.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,n){return+n.getResponseHeader("Total-Count")}})),this.libraryView=W.instance(l.extend({},U[M.LIST],{itemsTemplate:z,listItemHeight:V,selection:{allowed:!0,multiple:!1},rootless:!0,dataUriTemplate:e.model.contextPath+"/rest_v2/resources?offset={{- offset }}&limit={{- limit }}&forceTotalCount=true&excludeFolder=/temp&forceFullPage=true",levelDataId:"uri",processors:[{processItem:n},{processItem:t}],getDataArray:function(e,t,n){return e&&e[E.RESOURCE_LOOKUP]?e[E.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,n){return+n.getResponseHeader("Total-Count")}})),this.libraryPanel=new D({title:d["dashboard.sidebar.existing.content.library"],traits:[I,R,w,x],collapsed:!1,handles:"s",additionalCssClasses:"libraryPanel",resizableEl:".subcontainer",overflow:"hidden",tabs:[{action:M.LIST,content:this.libraryView,primary:!0,label:M.LIST,hidden:!0},{action:M.FOLDERS,content:this.existingContentTreeView,label:M.FOLDERS,hidden:!0}],menuOptionSelectable:!0,menuOptions:[{label:d["dashboard.sidebar.existing.content.list.view"],groupId:N.VIEW,action:M.LIST,"default":!0},{label:d["dashboard.sidebar.existing.content.folder.view"],groupId:N.VIEW,action:M.FOLDERS},{label:d["dashboard.sidebar.existing.content.all"],groupId:N.VISUALIZATION,action:"all","default":!0},{label:d["dashboard.sidebar.existing.content.reports"],groupId:N.VISUALIZATION,action:"report"},{label:d["dashboard.sidebar.existing.content.adhoc.views"],groupId:N.VISUALIZATION,action:"adhoc"}],onCollapseControlPressed:function(e){m._resetHeights(),m.accordion.toggle(m.libraryPanel)}}),this.newContentPanel=new D({title:d["dashboard.sidebar.new.content"],traits:[I,x],collapsed:!1,fixedHeight:!0,content:this.newContentTree,handles:"s",additionalCssClasses:"newContentPanel",resizableEl:".subcontainer",minHeight:A.PANELS_MIN_HEIGHT,onCollapseControlPressed:function(e){m._resetHeights(),m.accordion.toggle(m.newContentPanel)}}),this.reportParametersContentPanel=new D({title:d["dashboard.sidebar.report.parameters"],traits:[I],collapsed:!0,additionalCssClasses:"reportParametersContentPanel",silent:!1,content:this.reportParametersTree,onCollapseControlPressed:function(e){m._resetHeights(),m.accordion.toggle(m.reportParametersContentPanel)}}),this.accordion=new _({container:this.$("> .content > .body"),panels:[this.newContentPanel,this.libraryPanel,this.reportParametersContentPanel],allowMultiplePanelsOpen:!0}),this.windowHeight=c(window).height();var B=!1,$=!1;this.listenToOnce(this.newContentTree.getLevel("/"),"ready",function(){B=!0,u.call(this),this.newContentPanelDefaultHeight=this.newContentPanel.$el.outerHeight(!0)},this),this.listenToOnce(this.libraryView.getLevel("/"),"ready",function(){$=!0,u.call(this)},this),this.listenTo(this.accordion,"fit",l.bind(r,this)),this.listenTo(this.model.foundations,"addComponent",function(e,t){t===m.model.currentFoundation&&o.call(m,e)}),this.listenTo(this.model.foundations,"removeComponent",function(e,t){t===m.model.currentFoundation&&a.call(m,e)}),this.listenTo(this.model.foundations,"editComponent",function(e,t){t===m.model.currentFoundation&&i.call(m,e)}),this.listenTo(this.libraryPanel,"option:all",l.bind(function(e,t){this.libraryView.clearCache(),this._filterByResource()},this)),this.listenTo(this.libraryPanel,"option:report",l.bind(function(e,t){this.libraryView.clearCache(),this._filterByResource({type:[E.REPORT_UNIT]},"report")},this)),this.listenTo(this.libraryPanel,"option:adhoc",l.bind(function(e,t){this.libraryView.clearCache(),this._filterByResource({type:[E.ADHOC_DATA_VIEW]},"adhoc")},this)),this.listenTo(this.libraryPanel,"option:folders",l.bind(function(e,t){this.libraryPanel.openTab(M.FOLDERS),this._filterByResource(this.activeResourceFilterOptions),this.accordion.fit()},this)),this.listenTo(this.libraryPanel,"option:list",l.bind(function(e,t){this.libraryPanel.openTab(M.LIST),this._filterByResource(this.activeResourceFilterOptions),this.accordion.fit()},this)),this.listenTo(this.libraryPanel.tabs[M.FOLDERS].searchForm,"search",l.bind(function(e){var t=this.libraryPanel.tabs[M.LIST].searchForm,n=[{action:M.LIST,groupId:N.VIEW}];this.activeVisualization&&n.push({action:this.activeVisualization,groupId:"visualization"}),t.setSearchString(e.searchString),t.search(e),this.libraryPanel.filterMenu.resetSelection(n,!0)},this)),this.listenTo(this.libraryPanel.tabs[M.LIST].searchForm,"clear",l.bind(function(){this.libraryPanel.tabs[M.FOLDERS].searchForm.clear()},this)),this.listenTo(this.newContentPanel,"resize",l.bind(this._onPanelResize,this,this.newContentPanel)),this.listenTo(this.libraryPanel,"resize",l.bind(this._onPanelResize,this,this.libraryPanel)),l.bindAll(this,"_onWindowResize"),c(window).on("resize",this._onWindowResize)},_onPanelResize:function(e){var t=l.isEqual(e,this.libraryPanel);this.reportParametersContentPanel.fixedHeight=!t,this.libraryPanel.fixedHeight=t,this.accordion.fit()},_filterByResource:function(e,t){t&&this._setActiveVisualization(t),l.isEqual(e,this.activeResourceFilterOptions)&&this.selectedTabId===this.libraryPanel.selectedTab||(this.selectedTabId=this.libraryPanel.selectedTab,this.selectedTab=this.libraryPanel.tabs[this.selectedTabId],this.activeResourceFilterOptions=e||{},this.selectedTab.searchForm.search(this.activeResourceFilterOptions))},_setActiveVisualization:function(e){this.activeVisualization=e},_resetHeights:function(){this.libraryPanel.fixedHeight=!1,this.reportParametersContentPanel.fixedHeight=!1,this.newContentPanel.setHeight(this.newContentPanelDefaultHeight)},_onWindowResize:function(e){var t=c(window).height();e.target.tagName||this.windowHeight===t||(this.windowHeight=t,this._resetHeights(),this.resizeTimer&&clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(l.bind(function(){this.accordion.fit()},this),100))},render:function(){return this.$("> .content > .body").append(this.newContentPanel.$el).append(this.libraryPanel.$el).append(this.reportParametersContentPanel.$el),this.reportParametersContentPanel.content.expand("/",{depth:0,silent:!0}),this},remove:function(){c(window).off("resize",this._onWindowResize),this.newContentPanel.remove(),this.libraryPanel.remove(),this.reportParametersContentPanel.remove(),this.filterContextMenu.remove(),u.View.prototype.remove.apply(this,arguments)}})});