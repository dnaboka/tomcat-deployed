define(["require","exports","module","jquery","underscore","backbone","common/transport/request","common/util/browserDetection","common/component/dialog/LoadingDialog","common/component/notification/Notification","./view/viewer/ViewerToolbarView","./view/base/DashboardMessageView","./model/DashboardModel","bi/dashboard/Dashboard","dashboard/util/DashboardExportUtils","common/component/dialog/Dialog","./dashboardSettings","bundle!DashboardBundle","text!./template/viewerDashboardContainerTemplate.htm","css!dashboard/viewer.css"],function(t,e,o){"use strict";function i(t,e){var o=this;return p({url:this.contextPath+"/rest_v2/dashboardExecutions/"+t+"/status",headers:{Accept:"application/json"},dataType:"json"}).done(function(r){"execution"===r.status?(e.notifyWith(o,[r.progress]),setTimeout(c.bind(i,o,t,e),1e3)):e.resolve(r)}).fail(c.bind(e.reject,e)),e}function r(t){var e,o,i,r,h=d(),l=this.$(".dashboardCanvas:first");return a(),n(),x.prepareForExport(this),"pdf"==t?(r=l.children(".content"),x.applyReferenceSize(this,{width:r.width(),height:r.height()}),o=3508,i=2480):(o=l.width(),i=l.height()),e=l.parent().html(),h(),x.removeReferenceSize(this),{uri:this.model.get("uri"),width:o,height:i,format:t,markup:e,jrStyle:s()}}function a(){try{var t,e=document.createElement("canvas");e&&e.getContext&&l("img").each(function(o,i){if("data"!==i.src.substring(0,3)){e||(e=document.createElement("canvas"));try{e.width=i.naturalWidth,e.height=i.naturalHeight,t=e.getContext("2d"),t.drawImage(i,0,0),i.src=e.toDataURL("image/png")}catch(r){}e=null}})}catch(o){}}function n(){l("input").each(function(t,e){var o=l(e),i=o.attr("type");"text"==i?o.attr("value",o.val()):("radio"==i||"checkbox"==i)&&o.attr("checked",e.checked?"checked":null)})}function s(){return c.reduce(document.styleSheets,function(t,e){var o="/reportresource?",i=e.href?e.href.indexOf(o):-1;return i>=0&&t.push(e.href.substring(i+o.length)),t},[])}function d(){var t=l("#jive_overlay").css("display"),e=l("#jive_marker").css("display"),o=l("#jive_marker").css("display");return l("#jive_overlay").css("display","none"),l("#jive_marker").css("display","none"),l("#jive_foobar").css("display","none"),function(){l("#jive_overlay").css("display",t),l("#jive_marker").css("display",e),l("#jive_foobar").css("display",o)}}function h(){var t=!c.filter(this.$(".dashboardVisualization"),function(t){return!(l(t).hasClass("rendered")&&0===l(t).find(".fusionRendering").length)}).length;t?(this.toolbar?this.toolbar.setEnabled({"export":!0}):this._referenceSize&&x.prepareForExport(this),l(document.body).addClass("rendered")):setTimeout(c.bind(h,this),1e3)}var l=t("jquery"),c=t("underscore"),u=t("backbone"),p=t("common/transport/request"),b=t("common/util/browserDetection"),m=t("common/component/dialog/LoadingDialog"),f=t("common/component/notification/Notification"),g=t("./view/viewer/ViewerToolbarView"),v=t("./view/base/DashboardMessageView"),w=t("./model/DashboardModel"),y=t("bi/dashboard/Dashboard"),x=t("dashboard/util/DashboardExportUtils"),_=(t("common/component/dialog/Dialog"),t("./dashboardSettings")),D=t("bundle!DashboardBundle"),E=t("text!./template/viewerDashboardContainerTemplate.htm");t("css!dashboard/viewer.css");var P=u.View.extend({constructor:function(t){if(t||(t={}),!t.el||!l(t.el)[0]||!l(t.el)[0].tagName)throw new Error("Container for Dashboard is not specified");u.View.apply(this,arguments)},initialize:function(t){this.params=t.params||{},t.referenceWidth&&t.referenceHeight&&(this._referenceSize={width:t.referenceWidth,height:t.referenceHeight}),this.contextPath=t.contextPath||_.CONTEXT_PATH,(c.isUndefined(t.toolbar)||t.toolbar===!0)&&(this.toolbar=new g),this.toolbar&&(this.listenTo(this.toolbar,"button:undo",this.undoParameters,this),this.listenTo(this.toolbar,"button:undoAll",this.undoAllParameters,this),this.listenTo(this.toolbar,"button:redo",this.redoParameters,this),this.listenTo(this.toolbar,"button:export",this.exportDashboard,this),this.listenTo(this.toolbar,"button:back",this.goBack,this)),this.message=new v,this._initAdditionalVisualComponents(),this.render(),l(window).on(window.onpagehide||null===window.onpagehide?"pagehide":"unload",c.bind(this._stopHistory,this)),this._startHistory(),this._initPreventTextSelection("#banner","#frame")},render:function(){return this.$el.empty(),this.toolbar&&this.$el.append(this.toolbar.render().el),this.$el.append(E),this.$(".dashboardContainer").append(this.message.$el),this.showInitialMessage(),this},showInitialMessage:function(){this.message.show(D["dashboard.canvas.error.not.found"])},_initAdditionalVisualComponents:function(){this.exportLoading=new m({cancellable:!0}),this.initialLoading=new m({cancellable:!0}),this.exportLoading.on("button:cancel",this.cancelExportDashboard,this),this.initialLoading.on("button:cancel",function(){window.history.back()},this)},_handleDashboardError:function(t){var e=D["dashboard.canvas.error."+t.errorCode]||D[t.xmlHttpRequest&&404===t.xmlHttpRequest.status?"dashboard.canvas.error.not.found":"dashboard.canvas.error.unexpected.error"];this.message.show(e),this.initialLoading&&this.initialLoading.close()},_startHistory:function(){this.history=new u.History,this.history.route(/.*/,c.bind(this._onLocationHashChange,this)),this.history.start()},_stopHistory:function(){this.history&&this.history.stop()},_initDashboard:function(t,e){var o=this;this.message.hide(),this.model&&this.stopListening(this.model,"change:label");var i=w.prototype.initialize;w.prototype.initialize=function(){return o.model=this,i.apply(this,arguments)},this.dashboard=new y({server:this.contextPath,container:this.$(".dashboardContainer > .content > .body"),resource:t,params:e||this.params,report:{chart:{animation:!this._referenceSize}}}).events({canUndo:function(t){o.toolbar&&o.toolbar.setEnabled({undo:t,undoAll:t})},canRedo:function(t){o.toolbar&&o.toolbar.setEnabled({redo:t})},__canvasReady__:function(){o.initialLoading.close()}}),w.prototype.initialize=i,o.toolbar&&(this.listenTo(this.model,"change:label",function(){o.toolbar.setTitle(o.model.get("label"))}),this.listenTo(o.toolbar,"button:filterPopup",function(){this.model.currentFoundation.trigger("toggle:filterDialog")}),this.listenTo(this.model.currentFoundation,"close:filterDialog",function(){o.toolbar.closeFilterPopupDialog()})),this.initialLoading.open(),this.dashboard.run().done(function(){if(o.toolbar){o.toolbar.setTitle(o.model.get("label"));var t=o.model.currentFoundation.components.getDashboardPropertiesComponent(),e=o.model.currentFoundation.wiring.hasUserWiring()&&o.model.currentFoundation.components.getValueProducers().length;o.toolbar.setVisibility({"export":t.get("showExportButton"),filterPopup:t.get("dashletFilterShowPopup"),undo:e,undoAll:e,redo:e})}else o._referenceSize&&x.applyReferenceSize(o,o._referenceSize);h.call(o)}).fail(c.bind(this._handleDashboardError,this))},_initPreventTextSelection:function(){var t=Array.prototype.slice.call(arguments,0).join(",");(b.isIE8()||b.isIE9())&&l(t).on("selectstart",function(t){var e=t.target.tagName;return"INPUT"!=e&&"TEXTAREA"!=e?!1:void 0})},_onLocationHashChange:function(t){if(t){var e=c.extend({},this.params,P.parseDashboardParamsFromString(t)),o=t.split("&")[0];try{o=decodeURIComponent(o)}catch(i){o=void 0}o&&(0!==o.indexOf("/")&&(o="/"+o),this.dashboard?this.model.get("uri")!==o?this.dashboard.destroy().always(c.bind(this._initDashboard,this,o,e)):this.dashboard.params(e).run().fail(c.bind(this._handleDashboardError,this)):this._initDashboard(o,e))}},remove:function(){l(window).off("pagehide unload"),this._stopHistory(),this.dashboard&&this.dashboard.destroy(),this.message&&this.message.remove(),this.toolbar&&this.toolbar.remove(),u.View.prototype.remove.apply(this,arguments)},goBack:function(){window.history.back()},undoParameters:function(){this.dashboard.undoParams()},undoAllParameters:function(){this.dashboard.undoAllParams()},redoParameters:function(){this.dashboard.redoParams()},exportDashboard:function(t){var e=this,o=new l.Deferred;return this.exportLoading.open(),o.progress(this.exportLoading.progress),p({url:this.contextPath+"/rest_v2/dashboardExecutions",method:"POST",headers:{Accept:"application/json"},contentType:"application/json",processData:!1,dataType:"json",data:JSON.stringify(r.call(this,t))}).done(function(t){e.currentExportId=t.id,i.call(e,t.id,o).done(function(t){e.exportLoading.close(),"ready"===t.status?e._download(e.contextPath+"/rest_v2/dashboardExecutions/"+t.id+"/outputResource"):f.show({message:D["dashboard.export.unexpected.error"]}),e.currentExportId=void 0})}).fail(function(t){e.exportLoading.close(),f.show({message:D["dashboard.export.renderer.fail"],delay:5e3})}),o},cancelExportDashboard:function(){return this.currentExportId?p({url:this.contextPath+"/rest_v2/dashboardExecutions/"+this.currentExportId,method:"DELETE"}).done(function(){this.currentExportId=void 0}).fail(function(){this.currentExportId=void 0}):(new l.Deferred).resolve()},_checkReadyness:h,_download:function(t){window.location.href=t}},{parseDashboardParamsFromString:function(t){var e,o=t,i=o.split("&");if(window.dashboardParams)e=JSON.parse(window.dashboardParams);else{e={};for(var r=0;r<i.length;r++){var a=decodeURIComponent(i[r].split("=")[0]),n=decodeURIComponent(i[r].split("=")[1]);e.hasOwnProperty(a)?e[a].push(n):e[a]=[c.isUndefined(n)?"":n]}}return e}});return P});