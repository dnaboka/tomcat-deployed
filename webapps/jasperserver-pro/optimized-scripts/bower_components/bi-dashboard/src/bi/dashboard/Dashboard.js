define(["require","exports","module","underscore","jquery","backbone","logger","common/bi/component/util/biComponentUtil","common/bi/error/biComponentErrorFactory","common/bi/error/SchemaValidationBiComponentError","common/bi/component/BiComponent","./model/DashboardBiComponentStateModel","dashboard/collection/filterManager/WiringProducerViewModelCollection","dashboard/dashboardSettings","dashboard/view/base/CanvasView","common/enum/httpStatusCodes","dashboard/enum/dashboardComponentTypes","dashboard/model/DashboardModel","dashboard/factory/sandboxFactory","text!./schema/Dashboard.json","text!./schema/DashboardComponent.json"],function(e,n,t){"use strict";function r(e,n){var t=C(n).first();if(!t.length||"1"!=t[0].nodeType){var r=_.containerNotFoundError(n);return D.error(r.toString()),e.reject(r),!1}return t}function o(e,n,t,o,a){var i=r(e,n.properties.container);if(i){var s=t.$el;s.addClass("jr"),i.empty(),!i.height()&&s.height(E.DASHBOARD_CONTAINER_HEIGHT),i.html(s);for(var d=0;d<t.componentViews.length;d++)t.componentViews[d].trigger("componentAttached",t.componentViews[d]);a.set("_rendered",!0),o&&e.resolve(o)}}function a(e,n){e.data.parameters=b.map(n.currentFoundation.wiring.filter(function(e){return e.component.isValueProducer()}),function(e){return{id:e.component.get("type")===P.INPUT_CONTROL||e.component.get("type")===P.VALUE?e.component.id:e.id,value:e.value}})}function i(e,n,t,i,d,c){var p,u=this.validate(),m=this,l=t.cid;if(u)return p=_.validationError(u),D.error(p.toString()),void e.reject(p);if(d.state.set(d.toJSON()),d.get("_fetched")){var f=d.state.changedAttributes(),g={setParams:new C.Deferred,runReports:new C.Deferred,render:new C.Deferred};if(f&&"params"in f){var v,y=n.data.parameters,w=[],A={};v=b.reduce(y,function(e,t){return t.id in n.properties.params&&(e[t.id]=n.properties.params[t.id]),e},{});for(var R in v){var O=t.currentFoundation.components.get(R);O&&O.prepareForAcquire(v)}t.currentFoundation.components.setMuteFilterPanels(!0);for(var R in v){var O=t.currentFoundation.components.get(R);if(O)w.push(O.acquireValue(v));else if(b.isString(R)&&R.indexOf(":")>-1){var S,P=R.split(":");O=t.currentFoundation.components.get(P[0]),O&&O.has("outputParameters")&&(S=b.findWhere(O.get("outputParameters"),{id:P[1]}),S&&(A[O.id]||(A[O.id]={model:O,signals:{}}),A[O.id].signals[S.id]=v[R]))}}b.forEach(b.values(A),function(e){e.model.notify(e.signals)}),g.runReports.done(function(){C.when.apply(C,w).done(function(){t.currentFoundation.components.setMuteFilterPanels(!1),t.currentFoundation.components.getDashboardPropertiesComponent().applyParameters(),g.setParams.resolve()}).fail(function(){t.currentFoundation.components.setMuteFilterPanels(!1)})}).fail(function(){t.currentFoundation.components.setMuteFilterPanels(!1)})}else g.setParams.resolve();return f&&("linkOptions"in f||"report"in f)?("linkOptions"in f&&h(n.properties.linkOptions,l),"report"in f&&N.get(l).set("reportSettings",F.cloneDeep(n.properties.report)),C.when.apply(this,s(i,n)).done(g.runReports.resolve).fail(g.runReports.reject)):g.runReports.resolve(),f&&"container"in f?C.when(g.setParams,g.runReports).done(function(){o(g.render,n,i,!0,d)}):g.render.resolve(),C.when.apply(C,b.values(g)).done(function(){e.resolve(m.data())}).fail(e.reject),e}(!n.properties.container||r(e,n.properties.container))&&(E.CONTEXT_PATH=n.properties.server,t.set("uri",n.properties.resource),t.contextPath=n.properties.server,F.createReadOnlyProperty(this,"server",n,!0,d),F.createReadOnlyProperty(this,"resource",n,!0,d),t.once("resourcesDataFetched",function(){var e=b.findWhere(t.get("foundations"),{id:t.get("defaultFoundation")}),r=t.resources.get(e.components).resource.content;for(var o in n.properties.params)if(n.properties.params.hasOwnProperty(o)){var a=b.findWhere(r,{id:o});if(a)a.value=n.properties.params[o];else if(b.isString(o)&&o.indexOf(":")>-1){var i,s=o.split(":");a=b.findWhere(r,{id:s[0]}),a&&a.outputParameters&&(i=b.findWhere(a.outputParameters,{id:s[1]}),i&&(i.value=n.properties.params[o]))}}}),t.fetch().done(function(){d.set("_fetched",!0),i.componentViews.length&&C.when.apply(C,b.pluck(i.componentViews,"ready")).then(function(){i.ready.resolve(),d.set("_canvasReady",!0)}),i.enableAutoRefresh(),a(n,t),n.data.components=t.currentFoundation.components.getComponents(),c.listenTo(t.currentFoundation.components,"change add reset remove paramsModelChanged",function(){n.data.components=t.currentFoundation.components.getComponents()}),n.properties.linkOptions&&h(n.properties.linkOptions,t.cid),N.get(l).set("reportSettings",F.cloneDeep(n.properties.report)),n.properties.container?o(e,n,i,m.data(),d):e.resolve(m.data())}).fail(function(n){p=_.requestError(n),D.error(p.toString()),e.reject(p)}))}function s(e,n){var t=e.componentViews.filter(function(e){return e.model.isVisualization()&&e.model.get("type")!==P.WEB_PAGE_VIEW});return b.map(t,function(e){return e.component.run()})}function d(e,n,t,r){o(e,n,t,t.$el[0],r)}function c(e,n,t,r,o){o.stopListening(),t.remove(),N.get(n).set("linkOptions",null),r.set("_destroyed",!0),e.resolve()}function p(e,n,t,r,o,a,s){if(b.isUndefined(e)){var d=t.get("_fetched")?r.refresh():i.call(this,n,o,a,r,t,s);d.done(n.resolve).fail(n.reject)}else{if(!t.get("_fetched"))throw new Error("Cannot refresh dashboard component without running dashboard");var c,p=b.findWhere(a.currentFoundation.components.getComponents(),{id:e});if(!p)throw new Error("Component with id '"+e+"' was not found");c=r.getComponentViewByComponentId(e),c&&c.refresh?c.refresh().then(n.resolve,n.reject):n.resolve()}}function u(e,n,t,r,o,a,i){if(b.isUndefined(e))t.get("_fetched")?r.cancel().done(n.resolve).fail(n.reject):n.resolve();else if(t.get("_fetched")){var s,d=b.findWhere(a.currentFoundation.components.getComponents(),{id:e});if(!d)throw new Error("Component with id '"+e+"' was not found");s=r.getComponentViewByComponentId(e),s&&s.cancel?s.cancel().then(n.resolve,n.reject):n.resolve()}else n.resolve()}function m(e,n,t,r,o,a){return function(i){var s,d,c,p,u=new C.Deferred;if(t.get("_destroyed"))s=_.alreadyDestroyedError(),D.error(s.toString()),u.reject(s);else try{b.isString(arguments[0])?(d=arguments[1],c=arguments[2],p=arguments[3]):(d=arguments[0],c=arguments[1],p=arguments[2]),d&&b.isFunction(d)&&u.done(d),c&&b.isFunction(c)&&u.fail(c),p&&b.isFunction(p)&&u.always(p),e.call(this,i,u,t,n,r,o,a)}catch(m){s=_.javaScriptException(m),D.error(s.toString()),u.reject(s)}return u}}function l(e,n){return function(){var t,r,o,a,i,s=new C.Deferred,d=!1;if(n.get("_destroyed"))t=_.alreadyDestroyedError(),D.error(t.toString()),s.reject(t);else if(n.get("_rendered"))try{if(b.isArray(arguments[0]))r=arguments[0],o=arguments[1],a=arguments[2],i=arguments[3];else if(b.isString(arguments[0]))d=!0,r=[b.extend({},arguments[1],{id:arguments[0]})],o=arguments[2],a=arguments[3],i=arguments[4];else{if(b.isFunction(arguments[0])||b.isUndefined(arguments[0]))throw new Error("Invalid arguments supplied. No component to update");d=!0,r=[arguments[0]],o=arguments[1],a=arguments[2],i=arguments[3]}o&&b.isFunction(o)&&s.done(o),a&&b.isFunction(a)&&s.fail(a),i&&b.isFunction(i)&&s.always(i);var c,p=b.map(r,function(n){return f(e,n)}),u=b.find(p,function(e){return e instanceof A});u?s.reject(u):(c=b.map(p,function(n){var t=e.currentFoundation.components.get(n.id);return t.updateFromDashboardComponentObject(n),t.toDashboardComponentObject()}),d&&(c=c[0]),s.resolve(c))}catch(m){t=_.javaScriptException(m),D.error(t.toString()),s.reject(t)}else t=_.notYetRenderedError(),D.error(t.toString()),s.reject(t);return s}}function f(e,n){var t=b.findWhere(e.currentFoundation.components.getComponents(),{id:n.id});if(!t)throw new Error("Component with such name or id '"+n.id+"' was not found");var r=b.omit(b.extend(t,n),"id","type","name","position"),o=F.validateObject(V,r);return o?_.validationError(o):b.extend(r,{id:n.id})}function h(e,n){e&&N.get(n).set("linkOptions",F.cloneDeep(e))}function g(e,n,t,r,o,a,i){return o.prevUndoRedoOp.always(function(){t.currentFoundation.components.once("parametersState:operationFinished",function(){e.resolve()}),i?t.currentFoundation.components.resetParametersState():t.currentFoundation.components.popParametersState(-1),t.currentFoundation.components.getDashboardPropertiesComponent().applyParameters(!0)}),o.prevUndoRedoOp=e,e.promise()}function v(e,n,t,r,o,a){return o.prevUndoRedoOp.always(function(){t.currentFoundation.components.once("parametersState:operationFinished",function(){e.resolve()}),t.currentFoundation.components.popParametersState(1),t.currentFoundation.components.getDashboardPropertiesComponent().applyParameters(!0)}),o.prevUndoRedoOp=e,e.promise()}function y(e,n,t,r){return function(t){if(r.get("_destroyed"))throw _.alreadyDestroyedError();var o=this;return t&&b.isObject(t)&&b.keys(t).length?(e.events||(e.events={}),b.each(e.events,function(e,t){b.isFunction(e)&&(t===M.CAN_REDO?n.stopListening(r,"change:_canRedo"):t===M.CAN_UNDO?n.stopListening(r,"change:_canRedo"):t===M.CANVAS_READY&&n.stopListening(r,"change:_canvasReady"))}),b.each(t,function(n,t){b.isFunction(n)&&(t===M.CAN_UNDO?e.events[t]=function(){n.call(o,r.get("_canUndo"))}:t===M.CAN_REDO?e.events[t]=function(){n.call(o,r.get("_canRedo"))}:t===M.CANVAS_READY&&(e.events[t]=function(){n.call(o,r.get("_canvasReady"))}))}),b.each(e.events,function(e,t){b.isFunction(e)&&(t===M.CAN_REDO?n.listenTo(r,"change:_canRedo",e):t===M.CAN_UNDO?n.listenTo(r,"change:_canUndo",e):t===M.CANVAS_READY&&n.listenTo(r,"change:_canvasReady",e))}),o):o}}var b=e("underscore"),C=e("jquery"),w=e("backbone"),D=e("logger").register(t),F=e("common/bi/component/util/biComponentUtil"),_=e("common/bi/error/biComponentErrorFactory"),A=e("common/bi/error/SchemaValidationBiComponentError"),R=e("common/bi/component/BiComponent"),O=e("./model/DashboardBiComponentStateModel"),E=(e("dashboard/collection/filterManager/WiringProducerViewModelCollection"),e("dashboard/dashboardSettings")),S=e("dashboard/view/base/CanvasView"),P=(e("common/enum/httpStatusCodes"),e("dashboard/enum/dashboardComponentTypes")),j=e("dashboard/model/DashboardModel"),N=e("dashboard/factory/sandboxFactory"),T=JSON.parse(e("text!./schema/Dashboard.json")),V=JSON.parse(e("text!./schema/DashboardComponent.json")),U=b.keys(T.properties),x=["properties"],I=["data"],M={CAN_UNDO:"canUndo",CAN_REDO:"canRedo",CANVAS_READY:"__canvasReady__"},W=function(e){e||(e={});var n,t={properties:b.extend({report:{chart:{},loadingOverlay:!0}},e),data:{components:[],parameters:[]}},r=new O(F.cloneDeep(t.properties)),o=new j,s=b.extend({},w.Events),f=o.cid,h=new S({model:o,dashboardId:f});r.prevUndoRedoOp=(new C.Deferred).resolve(),F.createInstancePropertiesAndFields(this,t,U,x,I,r),s.listenTo(o.currentFoundation.components,"parametersState:canUndo",b.bind(r.set,r,"_canUndo")),s.listenTo(o.currentFoundation.components,"parametersState:canRedo",b.bind(r.set,r,"_canRedo")),n=this.data,b.extend(this,{validate:F.createValidateAction(t,T,r),run:F.createDeferredAction(i,r,t,o,h,r,s),render:F.createDeferredAction(d,r,t,h,r),refresh:m(p,h,r,t,o,s),cancel:m(u,h,r,t,o,s),destroy:F.createDeferredAction(c,r,f,h,r,s),updateComponent:l(o,r),undoParams:F.createDeferredAction(g,r,t,o,h,r,s),undoAllParams:F.createDeferredAction(g,r,t,o,h,r,s,!0),redoParams:F.createDeferredAction(v,r,t,o,h,r,s),events:y(t,s,o,r),data:function(){return a(t,o),n.apply(this,arguments)}})};return W.prototype=new R,b.extend(W,{componentTypes:b.without(b.values(P),P.DASHBOARD_PROPERTIES),componentIdDomAttribute:E.COMPONENT_ID_ATTRIBUTE,canvas:{width:E.GRID_WIDTH,height:E.GRID_HEIGHT}}),W});