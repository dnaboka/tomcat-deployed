define(["require","exports","module","underscore","backbone","../model/InputControlModel","logger"],function(t,e,n){"use strict";var r=t("underscore"),s=t("backbone"),a=t("../model/InputControlModel"),i=t("logger").register(n);return s.Collection.extend({model:a,_slaveICs:[],url:function(){var t=this.stateModel.get("resource"),e=this.stateModel.get("server");if(!t)throw new Error("Resource URI is not specified.");var n=e?"/"===e[e.length-1]?e:e+"/":"";return n+="rest_v2/reports",n+="/"===t[0]?t:"/"+t,n+="/"===t[t.length-1]?"inputControls":"/inputControls"},initialize:function(t,e){e||(e={}),this.stateModel=e.stateModel,this.on("all",i.debug,i),this.on("changeState",this.onControlChange,this)},onControlChange:function(t){var e={params:{}},n=!!t.get("slaveDependencies").length;if(n){var s=this._getAllSlaveControlIds(t.get("id"));this._slaveICs=s,this._disableSlaveICs();var a=this._getParentControlIds(s),i=r.union(s,a);this.each(function(t){r.contains(i,t.get("id"))&&t.changed&&(e.params[t.get("id")]=t.getData())}),s=r.union(s,t.get("id")),this.updateState(e,s)}else this.callCustomerChangeCallback()},callCustomerChangeCallback:function(){var t=this.stateModel.get("events");!r.isUndefined(t)&&r.isFunction(t.change)&&t.change(this.getState(),this.validate())},_getAllSlaveControlIds:function(t){var e=[],n=this.get(t);return r.each(n.get("slaveDependencies"),function(t){e.push(t),e.push.apply(e,this._getAllSlaveControlIds(t))},this),r.uniq(e)},_getParentControlIds:function(t){var e=[];return r.each(t,function(t){var n=this.get(t);e.push.apply(e,n.get("masterDependencies"))},this),r.uniq(e)},parse:function(t){if(!t)return[];if(t.inputControl&&r.isArray(t.inputControl))return t.inputControl;throw new Error("Unable to parse response from server.")},fetch:function(t){return t||(t={}),r.extend(t,{url:this.url(),reset:!0}),t.excludeState&&(t.url+="?exclude=state"),s.Collection.prototype.fetch.call(this,t)},update:function(t){if(t||(t={}),r.isEmpty(t.params))throw new Error("Cannot update input controls without passed params");return r.extend(t,{type:"POST",contentType:"application/json",data:JSON.stringify(t.params),reset:!0}),s.Collection.prototype.fetch.call(this,t)},updateState:function(t,e){return t||(t={}),e=e||r.keys(t.params),t.url=this.url()+"/"+e.join(";")+"/values",r.extend(t,{type:"POST",contentType:"application/json",data:JSON.stringify(t.params),reset:!1,success:r.bind(this.parseUpdateState,this),error:r.bind(this._enableSlaveICs,this)}),s.sync.call(this,"read",this,t)},parseUpdateState:function(t){if(!t||!t.inputControlState||!r.isArray(t.inputControlState))throw new Error("Unable to parse response from server.");r.each(t.inputControlState,this._parseState,this),this._enableSlaveICs(),this.callCustomerChangeCallback()},getState:function(){var t={};return this.forEach(function(e){t[e.get("id")]=e.getData()}),t},validate:function(){var t={};return this.forEach(function(e){e.state.get("error")&&(t[e.get("id")]=e.state.get("error"))}),r.size(t)?t:!1},_disableSlaveICs:function(){this.trigger("disableICs",this._slaveICs)},_enableSlaveICs:function(){this.trigger("enableICs",this._slaveICs)},_parseState:function(t){var e=this.get(t.id);e&&e.set("state",t)}})});