define(["require","exports","module","../BaseInputControlView","components/sizer/Sizer","jquery","underscore","logger","mustache","bundle!js-sdk/ScalableInputControlsBundle","common/util/browserDetection","components/scalableList/util/domAndCssUtil","../../util/inputControlHelpers","text!../../template/checkboxInputItemTemplate.htm","text!../../template/multiSelectCheckboxTemplate.htm"],function(e,t,i){"use strict";var n=e("../BaseInputControlView"),s=e("components/sizer/Sizer"),o=e("jquery"),c=e("underscore"),l=(e("logger").register(i),e("mustache")),h=e("bundle!js-sdk/ScalableInputControlsBundle"),r=e("common/util/browserDetection"),a=e("components/scalableList/util/domAndCssUtil").doCalcOnVisibleNodeClone,u=e("../../util/inputControlHelpers"),d=e("text!../../template/checkboxInputItemTemplate.htm"),m=e("text!../../template/multiSelectCheckboxTemplate.htm"),p=3,f=5,g=2,b=[{selector:".jr-jSelectAll",strings:[h["sic.multiselect.selectAll"],h["sic.multiselect.all"],""]},{selector:".jr-jSelectNone",strings:[h["sic.multiselect.deselectAll"],h["sic.multiselect.none"],""]},{selector:".jr-jInvert",strings:[h["sic.multiselect.inverse"],""]}];return n.extend({events:{"click .jr-jSelectAll":"onSelectAll","click .jr-jSelectNone":"onSelectNone","click .jr-jInvert":"onInvertSelection"},template:m,initialize:function(){this._debouncedOnResize=c.debounce(c.bind(this.onResize,this),500),n.prototype.initialize.call(this)},renderStructure:function(){return this.setElement(o(l.to_html(this.template||"",c.extend({selectAllMsg:h["sic.multiselect.selectAll"],selectNoneMsg:h["sic.multiselect.deselectAll"],selectInverseMsg:h["sic.multiselect.inverse"]},this.model.toJSON())))),this.$checkboxContainer=this.$el.find(".jr-mInput-set"),this.updateOptionsSelection(),this.once("attached",this._checkForRealAttachedToDOM,this),this},updateOptionsSelection:function(){var e=c.map(this.model.state.options.toJSON(),function(e){var t=c.clone(e);return t.readOnly=this.model.get("readOnly"),t.uuid="jr-label-id-"+c.uniqueId(this.model.get("id")),t},this),t=this.$checkboxContainer.find("ul")[0];u.setInnerHtml(t,function(e){return l.to_html(d,e)},{data:e}),this._handleHeight()},_checkForRealAttachedToDOM:function(){this.$checkboxContainer.find("li").height()>0?(this.attached=!0,this.$checkboxContainer.height(this._calcHeightByItemsCount(f)),this._initSizer(),this.setBulkSelectionText()):c.delay(c.bind(this._checkForRealAttachedToDOM,this),500)},_initSizer:function(){this.sizer=new s({container:this.$checkboxContainer}),this.$el.append(this.sizer.$el),this._handleHeight()},_handleHeight:function(){var e=this.model.state.options.length,t=this.$checkboxContainer.height(),i=t;if(this.attached&&e){var n=this._calcHeightByItemsCount(p),s=this._calcHeightByItemsCount(e)+g;f>=e?n=s=i=this._calcHeightByItemsCount(Math.max(p,e)):t>s&&(i=this._calcHeightByItemsCount(e)),this.$checkboxContainer.height(i),this.sizer.updateMinMax({minHeight:n,maxHeight:s}),n===s?(this.sizer.hide(),this.$checkboxContainer.css("overflow-y","auto")):(this.sizer.show(),this.$checkboxContainer.css("overflow-y","scroll"))}},_calcHeightByItemsCount:function(e){var t=this.$checkboxContainer.find("li").outerHeight(),i=Math.round(parseFloat(this.$checkboxContainer.find("ul").css("margin-top"))||0);return e*t+i},getSelection:function(){var e=this.$el.find(":checkbox").filter(":checked");return c.map(e,function(e){return o(e).val()})},bindCustomEventListeners:function(){var e=this;this.model.get("readOnly")||this.$el.on("change","input",c.bind(function(t){var i=this.getSelection();setTimeout(function(){e.model.changeState(i)})},this)),this.model.state.options.on("reset",this.updateOptionsSelection,this),this.model.state.options.on("change:selected",this.updateOptionsSelection,this),o(window).on("resize",this._debouncedOnResize)},onSelectAll:function(){if(!this.model.get("readOnly")){var e=this.$checkboxContainer.find("input");c.each(e,function(e){e.checked=!0}),e.change()}},onSelectNone:function(){if(!this.model.get("readOnly")){var e=this.$checkboxContainer.find("input");c.each(e,function(e){e.checked=!1}),e.change()}},onInvertSelection:function(){if(!this.model.get("readOnly")){var e=this.$checkboxContainer.find("input");c.each(e,function(e){e.checked=!e.checked}),e.change()}},setBulkSelectionText:function(){if(this.$el.is(":visible")){var e=this.$el.outerWidth();if(e!==this._componentWidth){this._componentWidth=e;var t=this.$el.find(".jr-mInput-buttonContainer"),i=t.outerWidth();a({el:t,css:{left:0-2*i+"px",width:i+"px"},classes:"jr "+(r.isIPad()?"ipad":""),alwaysClone:!0,callback:function(e){c.each(b,function(i){var n=!1;c.each(i.strings,function(s){if(!n){var o=e.find(i.selector),c=o.find(".jr-mItemselector-button-label span").text(s),l=o[0].getBoundingClientRect().right,h=c[0].getBoundingClientRect().right;(l-h>=3||""===s)&&(n=!0,t.find(i.selector+" .jr-mItemselector-button-label span").text(s))}})})}})}}},onResize:function(){this.setBulkSelectionText()},remove:function(){this.$el.off("change","input"),this.$el.off("click","a"),this.multiSelect&&this.multiSelect.remove(),this.sizer&&this.sizer.remove(),this.model.state.options.off("reset",this.updateOptionsSelection,this),this.model.state.options.off("change:selected",this.updateOptionsSelection,this),n.prototype.remove.call(this)}})});