define(["require","jquery","underscore","common/util/datetime/RelativeDate","common/util/datetime/RelativeTime","common/util/datetime/RelativeTimestamp","text!./template/calendar2Template.htm","components/dateAndTime/DateAndTimePicker","bundle!calendar","config/dateAndTimeSettings"],function(e){"use strict";var t=e("jquery"),n=e("underscore"),i=e("common/util/datetime/RelativeDate"),a=e("common/util/datetime/RelativeTime"),r=e("common/util/datetime/RelativeTimestamp"),d=e("text!./template/calendar2Template.htm"),o=e("components/dateAndTime/DateAndTimePicker"),l=e("bundle!calendar");e("config/dateAndTimeSettings");var s={evaluate:/\{\{([\s\S]+?)\}\}/g,interpolate:/\{\{=([\s\S]+?)\}\}/g,escape:/\{\{-([\s\S]+?)\}\}/g},c=function(e){return e=null==e?"":String(e),e=e.toLowerCase(),e.charAt(0).toUpperCase()+e.slice(1)},u=n.template(d,null,s),h={counter:0,activeMark:"activeCalendar2",hasActiveCalendar:function(e){return t(e).hasClass(this.activeMark)},instance:function(e){e=e||{};var d=this,s="hidden",h="calendar2_"+ ++this.counter,m={calContainer:!1,tabs:[],tabButtons:[],rdFunction:void 0,build:function(){e.calendarType=e.calendarType||"datetime",e.disabled=e.disabled||!1,e.relativeTime=e.relativeTime||!1,e.inputField=t(e.inputField),"date"==e.calendarType?m.rdFunction=i:"datetime"==e.calendarType?m.rdFunction=r:"time"==e.calendarType&&(m.rdFunction=a);var d=n.map(n.keys(m.rdFunction.PATTERNS),function(e){return{label:c(e)+"(s)",value:e}});e.inputField.addClass("hasCalendar2"),m.calContainer=t(u({uniqueId:h,i18n:l,rdWords:d,calendarType:e.calendarType})),m.calContainer.appendTo("body"),t("<button type='button' class='ui-datepicker-trigger button picker'></button>").insertAfter(e.inputField),m.initTabs(),m.attachListeners(),e.disabled&&m.calContainer.addClass("disabled"),this.RD.init(m.rdFunction),this.Calendar.init()},attachListeners:function(){m.tabButtons.each(function(e,n){t(n).bind("click",function(){m.activateTab(e)})}),e.inputField.next(".ui-datepicker-trigger").bind("click",m.show),m.calContainer.find(".closeButton").bind("click",m.hide),m.calContainer.find(".nowButton").bind("click",n.bind(m.Calendar.setCurrent,m.Calendar)),t(document).bind("mousedown",m.checkExternalClick)},removeListeners:function(){m.tabButtons.each(function(e,n){t(n).unbind("click",function(){m.activateTab(e)})}),e.inputField.next(".ui-datepicker-trigger").unbind("click",m.show),m.calContainer.find(".closeButton").unbind("click",m.hide),m.calContainer.find(".nowButton").unbind("click",n.bind(m.Calendar.setCurrent,m.Calendar)),t(document).unbind("mousedown",m.checkExternalClick)},checkExternalClick:function(e){"shown"==s&&0===t(e.target).parents("#"+h).length&&m.hide()},initTabs:function(){m.tabs=m.calContainer.find(".tabs > div"),m.tabButtons=m.calContainer.find(".tabsControl > .tabSelect"),"time"!==e.calendarType||e.relativeTime||(m.tabs[1].remove(),m.tabButtons[1].remove(),m.calContainer.find(".tabsControl").hide()),m.activateTab(0)},activateTab:function(e){e>=m.tabs.length||(m.tabButtons.removeClass("opened"),m.tabs.removeClass("opened"),t(m.tabs[e]).addClass("opened"),t(m.tabButtons[e]).addClass("opened"),m.calContainer.find(".nowButton")[1===e?"hide":"show"]())},destroy:function(){e.inputField.removeClass("hasCalendar2"),m.removeListeners(),m.RD.destroy(),m.calContainer.remove()},show:function(){e.inputField.attr("readonly","readonly");var t=e.inputField.val(),n=m.rdFunction.isValid(t);m.activateTab(n?1:0),m.calContainer.show(),m.Calendar.create(),n?m.RD.setValue(t):m.Calendar.setValue(t),m.adjustPosition(),s="shown";var i=e.inputField;i.length&&i.addClass(d.activeMark)},adjustPosition:function(){var n=e.inputField,i=n.offset(),a=m.calContainer.width(),r=m.calContainer.height(),d=t(window),o=d.width(),l=d.height();i.top+25+r<=l||i.top-r-5<0?i.top+=25:i.top=i.top-r-5,i.left+a>o&&(i.left=Math.max(o-(a+20),50)),m.calContainer.offset(i)},hide:function(){e.inputField.removeAttr("readonly"),m.calContainer.hide(),m.Calendar.destroy(),s="hidden";var t=e.inputField;t.length&&t.removeClass(d.activeMark)},RD:{possibleValues:[],holder:!1,date:{},init:function(e){this.date=new e("","+",""),this.holder=m.calContainer.find(".relativeDates > .dates"),this.attachEventListeners()},attachEventListeners:function(){this.holder.find(".measure select, .sign select").bind("change",this.onSelect),this.holder.find(".amount input").bind("keyup",this.onSelect)},removeEventListeners:function(){this.holder.find(".measure select, .sign select").unbind("change",this.onSelect),this.holder.find(".amount input").unbind("keyup",this.onSelect)},onSelect:function(){e.inputField.val(m.RD.getValue()),e.inputField.trigger("change")},destroy:function(){this.removeEventListeners()},getValue:function(){return this.date.setKeyword(this.holder.find(".measure select").val()),this.date.setSign(this.holder.find(".sign select").val()),this.date.setNumber(this.holder.find(".amount input").val()),this.date.toString()},setValue:function(e){var t=m.rdFunction.parse(e);t?this.date=t:(this.date.setKeyword(""),this.date.setSign("+"),this.date.setNumber("")),this.holder.find(".measure select").val(this.date.keyword),this.holder.find(".sign select").val(this.date.sign),this.holder.find(".amount input").val(this.date.number)}},Calendar:{jqueryCalendar:!1,jqueryCalendarConfig:{},jqueryCalendarType:!1,init:function(){this.jqueryCalendarType="datetimepicker","time"==e.calendarType?this.jqueryCalendarType="timepicker":"date"==e.calendarType&&(this.jqueryCalendarType="datepicker"),this.jqueryCalendarConfig={dateFormat:"yy-mm-dd",timeFormat:"HH:mm:ss",showHour:!1,showMinute:!1,showSecond:!1,showTime:!1,constrainInput:!1,showButtonPanel:!1,onSelect:function(t,n){e.inputField.val(t),e.inputField.trigger("change")}},("datetime"==e.calendarType||"date"==e.calendarType)&&(this.jqueryCalendarConfig=n.extend(this.jqueryCalendarConfig,{changeYear:!0,changeMonth:!0})),("datetime"==e.calendarType||"time"==e.calendarType)&&(this.jqueryCalendarConfig=n.extend(this.jqueryCalendarConfig,{showTime:!0,showHour:!0,showMinute:!0,showSecond:!0})),this.jqueryCalendarConfig=n.extend(this.jqueryCalendarConfig,e.jqueryPickerOptions||{}),"time"==e.calendarType?delete this.jqueryCalendarConfig.dateFormat:"date"==e.calendarType&&delete this.jqueryCalendarConfig.timeFormat,this.jqueryCalendarConfig.disabled=e.disabled,this.jqueryCalendar=m.calContainer.find("#"+h+"_calendar"),this.jqueryCalendarConfig.el=this.jqueryCalendar},destroy:function(){this.picker.remove()},create:function(){this.picker=new o(this.jqueryCalendarConfig)},getValue:function(){return this.picker.getDate()},setCurrent:function(){this.picker.setDate(new Date),this.jqueryCalendar.find(".ui-datepicker-today").click()},setValue:function(e){this.picker.setDate(e)}}};return m.build(),m}};return window.Calendar2=h,h});